<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iWATCH TV - Professional Streaming</title>
    <meta name="description" content="Professional IPTV streaming service with live TV, movies, and sports content">
    <meta name="author" content="MiniMax Agent">
    <meta name="keywords" content="IPTV, streaming, live TV, movies, sports, entertainment">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0057FF">
    <meta name="background-color" content="#000000">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192x192.png">
    
    <!-- Apple PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iWATCH TV">
    <link rel="apple-touch-startup-image" href="./icons/icon-512x512.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#0057FF">
    <meta name="msapplication-TileImage" content="./icons/icon-144x144.png">
    
    <!-- Remote Update System -->
    <script>
        // App Version Management
        const APP_CONFIG = {
            VERSION: '2.1.0',
            UPDATE_CHECK_INTERVAL: 60000, // Check for updates every 1 minute
            AUTO_UPDATE_ENABLED: true
        };

        // Remote Update System
        const updateSystem = {
            currentVersion: APP_CONFIG.VERSION,
            latestVersion: null,
            updateAvailable: false,
            updateData: null,
            
            // Check for updates
            async checkForUpdates() {
                try {
                    // Simulate checking for updates from admin panel
                    const updateManifest = this.getUpdateManifest();
                    
                    if (updateManifest && updateManifest.version !== this.currentVersion) {
                        this.latestVersion = updateManifest.version;
                        this.updateAvailable = true;
                        this.updateData = updateManifest;
                        
                        this.showUpdateNotification(updateManifest);
                        console.log(`üì± Update available: ${this.currentVersion} ‚Üí ${updateManifest.version}`);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Update check failed:', error);
                    return false;
                }
            },
            
            // Get update manifest (simulates fetching from admin server)
            getUpdateManifest() {
                const savedManifest = localStorage.getItem('updateManifest');
                if (savedManifest) {
                    try {
                        return JSON.parse(savedManifest);
                    } catch (e) {
                        console.error('Invalid update manifest');
                    }
                }
                return null;
            },
            
            // Show update notification
            showUpdateNotification(manifest) {
                // Create update notification element
                const notification = document.createElement('div');
                notification.className = 'update-notification';
                notification.innerHTML = `
                    <div class="update-content">
                        <div class="update-icon">üì±</div>
                        <div class="update-info">
                            <h3>Update Available</h3>
                            <p>Version ${manifest.version} is ready to install</p>
                            <p class="update-description">${manifest.description || 'New features and improvements available'}</p>
                        </div>
                        <div class="update-actions">
                            <button onclick="updateSystem.installUpdate()" class="btn-update">Update Now</button>
                            <button onclick="updateSystem.dismissUpdate()" class="btn-dismiss">Later</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-show update after 3 seconds if major update
                if (manifest.mandatory) {
                    setTimeout(() => {
                        notification.classList.add('show');
                    }, 3000);
                } else {
                    notification.classList.add('show');
                }
            },
            
            // Install update
            async installUpdate() {
                try {
                    const updateBtn = document.querySelector('.btn-update');
                    updateBtn.textContent = 'Installing...';
                    updateBtn.disabled = true;
                    
                    // Simulate update installation
                    await this.simulateUpdateInstallation();
                    
                    // Show success message
                    this.showUpdateSuccess();
                    
                    // Reload the page after successful update
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Update installation failed:', error);
                    this.showUpdateError();
                }
            },
            
            // Simulate update installation
            async simulateUpdateInstallation() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Update local storage to mark as updated
                        localStorage.setItem('lastUpdateCheck', Date.now().toString());
                        localStorage.setItem('appVersion', this.updateData.version);
                        resolve();
                    }, 2000);
                });
            },
            
            // Dismiss update notification
            dismissUpdate() {
                const notification = document.querySelector('.update-notification');
                if (notification) {
                    notification.remove();
                }
                
                // Remind in 30 minutes for non-mandatory updates
                if (!this.updateData.mandatory) {
                    setTimeout(() => {
                        this.checkForUpdates();
                    }, 30 * 60 * 1000);
                }
            },
            
            // Show update success message
            showUpdateSuccess() {
                const notification = document.querySelector('.update-notification');
                if (notification) {
                    notification.innerHTML = `
                        <div class="update-success">
                            <div class="success-icon">‚úÖ</div>
                            <h3>Update Successful!</h3>
                            <p>Restarting application...</p>
                        </div>
                    `;
                    notification.classList.add('success');
                }
            },
            
            // Show update error message
            showUpdateError() {
                const updateBtn = document.querySelector('.btn-update');
                if (updateBtn) {
                    updateBtn.textContent = 'Update Failed';
                    updateBtn.disabled = false;
                }
                
                console.error('Update installation failed. Please try again.');
            },
            
            // Start automatic update checking
            startAutoUpdateCheck() {
                // Check immediately on startup
                this.checkForUpdates();
                
                // Set up periodic checking
                setInterval(() => {
                    this.checkForUpdates();
                }, APP_CONFIG.UPDATE_CHECK_INTERVAL);
            },
            
            // Manual update check (for settings menu)
            manualUpdateCheck() {
                return this.checkForUpdates();
            }
        };

        // Password Management System
        const passwordManager = {
            passwords: {
                // AUTO-LOGIN REMOVED - Each client must enter their own credentials
                'adminLogin': '',  // REMOVED: 'admin123'
                'resellerLogin': '',  // REMOVED: 'reseller123'
                'clientAdult': '1818',
                'panelAccess': '000000',
                'masterAdult': '123789' // Master password for admin emergency access to adult content
            },
            verifyPassword: function(key, input) {
                return this.passwords[key] === input;
            },
            authenticateUser: function(username, password) {
                // AUTO-LOGIN REMOVED - No hardcoded credentials
                // Each customer must subscribe and enter their own credentials

                // Load customer data
                const customers = loadCustomersFromAdmin();
                
                // Find customer by username
                const customer = customers.find(c => c.username === username);
                
                // Check if customer exists and password matches
                if (customer && customer.password === password) {
                    // Check if customer has active subscription
                    if (customer.status === 'active') {
                        // Return customer object with subscription info
                        return {
                            username: customer.username,
                            fullName: customer.fullName,
                            role: 'customer',
                            customerId: customer.id,
                            subscribedPackages: customer.subscribedPackages || [],
                            subscriptionExpiry: customer.subscriptionExpiry,
                            permissions: ['basic_access'] // Customer has basic access
                        };
                    }
                }
                
                // Admin access removed
                // Reseller access removed
                
                return null; // No automatic authentication
            }
        };
    </script>
    
    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.12.0/video-js.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --accent-blue: #667eea;
            --accent-purple: #764ba2;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --focus-color: #667eea;
            --adult-color: #ff4757;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-gradient);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* Enable input field interaction */
        input, textarea, select {
            user-select: text !important;
            pointer-events: auto !important;
        }

        /* Keep UI elements non-selectable */
        .header, .sidebar, .player-area, .content-list, .category-grid {
            user-select: none;
            pointer-events: auto;
        }

        /* Allow text selection for input fields */
        input, textarea, select {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        /* Restrict selection for UI elements only */
        .header, .sidebar, .player-area, .content-list, .category-grid {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Header Styles - TV Fixed Positioning */
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 80px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        /* User Status Styles */
        .user-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--glass-bg);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .user-status:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .subscription-expiry {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .subscription-expiry.warning {
            color: var(--warning-color);
            font-weight: 600;
        }

        .subscription-expiry.expired {
            color: var(--error-color);
            font-weight: 600;
        }

        /* Time Display */
        .time-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .current-time {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .current-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Main Layout - TV Optimized */
        .main-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
            padding: 30px;
            margin-top: 80px; /* Account for fixed header */
            min-height: calc(100vh - 80px);
            position: relative;
            z-index: 1;
        }

        /* Sidebar Styles */
        .sidebar {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            height: fit-content;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Source Selection */
        .source-selector {
            margin-bottom: 25px;
        }

        .source-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .source-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .source-tab.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .source-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .source-tab.active:hover {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--focus-color);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Categories */
        .categories {
            margin-bottom: 30px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .category-btn {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .category-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-color: transparent;
            color: white;
            font-weight: 600;
        }

        .category-btn.adult {
            border-color: var(--adult-color);
        }

        .category-btn.adult:hover {
            background: rgba(255, 71, 87, 0.2);
            border-color: var(--adult-color);
        }

        .category-btn.adult.active {
            background: linear-gradient(135deg, var(--adult-color), #ff6b7a);
            color: white;
        }

        /* Adult Tab Styling */
        .source-tab.adult-tab {
            background: rgba(255, 71, 87, 0.1);
            border-color: var(--adult-color);
            color: var(--adult-color);
        }

        .source-tab.adult-tab:hover {
            background: rgba(255, 71, 87, 0.2);
            border-color: var(--adult-color);
        }

        .source-tab.adult-tab.active {
            background: linear-gradient(135deg, var(--adult-color), #ff6b7a);
            color: white;
        }

        /* Content List */
        .content-section {
            height: 400px;
            overflow: hidden;
        }

        .content-list {
            height: 100%;
            overflow-y: auto;
            padding-right: 10px;
        }

        .content-list::-webkit-scrollbar {
            width: 6px;
        }

        .content-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .content-list::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.6);
            border-radius: 3px;
        }

        .content-list::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        .content-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Color-coded content types */
        .content-item.live-tv {
            border-left: 4px solid var(--warning-color);
        }

        .content-item.vod {
            border-left: 4px solid var(--success-color);
        }

        .content-item.internet {
            border-left: 4px solid var(--accent-blue);
        }

        /* Color-coded badges */
        .content-type-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-live {
            background: var(--warning-color);
            color: white;
        }

        .badge-movies {
            background: var(--accent-purple);
            color: white;
        }

        .badge-vod {
            background: var(--success-color);
            color: white;
        }

        .badge-basic {
            background: var(--accent-blue);
            color: white;
        }

        .badge-addon {
            background: var(--focus-color);
            color: white;
        }

        .badge-internet {
            background: var(--accent-blue);
            color: white;
        }

        .content-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-blue);
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .content-item.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-color: transparent;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .content-item.adult-content {
            border-color: var(--adult-color);
        }

        .content-item.adult-content:hover {
            background: rgba(255, 71, 87, 0.1);
            border-color: var(--adult-color);
        }

        .content-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .content-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--glass-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .content-info {
            flex: 1;
        }

        .content-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 3px;
        }

        .content-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .content-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            margin-top: 5px;
        }

        .live-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        /* Streaming Mode Indicators */
        .streaming-indicator {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .streaming-indicator.always {
            background: #ff4444;
            color: white;
        }

        .streaming-indicator.on-demand {
            background: #666;
            color: white;
        }

        /* Main Player Area */
        .player-area {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        /* Video Container */
        .video-container {
            width: 100%;
            height: 500px;
            background: #000;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .video-player {
            width: 100%;
            height: 100%;
        }

        .video-js {
            border-radius: 15px;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9), rgba(15, 52, 96, 0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 15px;
        }

        .video-overlay.show {
            opacity: 1;
        }

        .play-button {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .play-button:hover {
            transform: scale(1.1);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.6);
        }

        .play-icon {
            width: 0;
            height: 0;
            border-left: 35px solid white;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            margin-left: 8px;
        }

        .overlay-info {
            text-align: center;
        }

        .overlay-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #ffffff, #b0b0b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .overlay-description {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Now Playing Section */
        .now-playing {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            margin-bottom: 25px;
        }

        .now-playing-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .now-playing-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .quality-badge {
            background: linear-gradient(135deg, var(--success-color), #66bb6a);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .now-playing-content {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 15px;
            align-items: center;
        }

        .content-avatar {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .content-details {
            flex: 1;
        }

        .content-current {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .content-meta {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }

        /* Video Controls */
        .video-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--glass-bg);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .volume-slider {
            width: 80px;
        }

        .volume-display {
            min-width: 35px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Login Modal - TV Interface Enhanced */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000; /* Higher z-index for TV interface */
            animation: fadeIn 0.3s ease;
        }

        .login-modal.show {
            display: flex;
        }

        .login-content {
            background: var(--primary-gradient);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--accent-blue);
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            padding: 12px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            pointer-events: auto !important;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--focus-color);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .login-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Adult Content Modal */
        .adult-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            animation: fadeIn 0.3s ease;
            pointer-events: none;
        }
        
        .adult-modal.show {
            display: flex;
            pointer-events: auto;
        }

        .adult-modal:not(.show) {
            pointer-events: none;
        }

        .adult-content {
            background: linear-gradient(135deg, #2c1810 0%, #1a0e08 50%, #0d0604 100%);
            border: 2px solid var(--adult-color);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 71, 87, 0.3);
            animation: slideUp 0.3s ease;
        }

        .adult-header {
            margin-bottom: 30px;
        }

        .adult-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--adult-color);
            margin-bottom: 10px;
        }

        .adult-warning {
            color: #ff9999;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .adult-input {
            width: 200px;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--adult-color);
            border-radius: 10px;
            color: var(--adult-color);
            font-weight: bold;
            letter-spacing: 4px;
        }

        .adult-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .adult-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .adult-btn.confirm {
            background: var(--adult-color);
            color: white;
        }

        .adult-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Adult Content Indicator */
        .adult-indicator {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .adult-indicator.locked {
            border-color: var(--adult-color);
        }

        .adult-indicator.unlocked {
            border-color: var(--success-color);
            background: rgba(76, 175, 80, 0.2);
        }

        .adult-icon {
            font-size: 18px;
        }

        .adult-status {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .adult-indicator.locked .adult-status {
            color: var(--adult-color);
        }

        .adult-indicator.unlocked .adult-status {
            color: var(--success-color);
        }

        /* Responsive Design - TV Interface Optimized */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
                margin-top: 80px; /* Keep header spacing */
            }
            
            .header {
                padding: 15px 20px;
                height: 70px; /* Smaller header on mobile/TV */
            }
            
            .logo-text {
                font-size: 2rem;
            }
            
            .header-info {
                gap: 15px;
            }
            
            .category-grid {
                grid-template-columns: 1fr;
            }
            
            /* TV Screen Specific Fixes */
            .header {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1000 !important;
            }
        }
        
        /* TV Large Screen Optimizations */
        @media (min-width: 1920px) {
            .main-container {
                max-width: 1600px;
                margin: 0 auto;
                margin-top: 80px;
            }
            
            .header {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1000 !important;
            }
        }
            
            .video-container {
                height: 300px;
            }
            
            .now-playing-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .video-controls {
                flex-wrap: wrap;
            }
            
            .volume-control {
                order: 3;
                width: 100%;
                justify-content: center;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid var(--error-color);
            color: var(--error-color);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .empty-message {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--success-color);
            color: var(--success-color);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body onload="initApp()">
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo-icon">üì∫</div>
            <div class="logo-text">iWATCH TV</div>
        </div>
        
        <div class="header-info">
            <!-- Time Display -->
            <div class="time-display">
                <div class="current-time" id="timeDisplay">12:00:00</div>
                <div class="current-date" id="dateDisplay">Monday, November 17, 2025</div>
            </div>
            
            <!-- User Status -->
            <div class="user-status" onclick="showLoginModal()" id="userStatus">
                <div class="user-avatar">üë§</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Guest</div>
                    <div class="subscription-expiry" id="subscriptionExpiry">Please Login</div>
                </div>
            </div>
            
            <!-- Adult Content Indicator -->
            <div class="adult-indicator locked" id="adultIndicator" style="display: none;" onclick="exitAdultContent()">
                <div class="adult-icon">üîí</div>
                <div class="adult-status">Locked</div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2 class="section-title">
                <span>üé¨</span>
                Content Library
            </h2>
            
            <!-- Source Selection -->
            <div class="source-selector">
                <div class="source-tabs">
                    <button class="source-tab active" onclick="switchSource('live')" data-source="live">
                        üì∫ Live TV
                    </button>
                    <button class="source-tab" onclick="switchSource('movies')" data-source="movies">
                        üé¨ Movies
                    </button>
                    <button class="source-tab" onclick="switchSource('vod')" data-source="vod">
                        üìÄ VOD
                    </button>
                    <button class="source-tab" onclick="switchSource('basic')" data-source="basic">
                        üè† Basic
                    </button>
                    <button class="source-tab" onclick="switchSource('addon')" data-source="addon">
                        üì¶ Addon
                    </button>
                </div>
                    <!-- Adult tab - hidden by default, appears only when password is entered -->
                    <button class="source-tab adult-tab" onclick="switchSource('adult')" data-source="adult" id="adultTab" style="display: none;">
                        üîû Adult
                    </button>
                    <button class="source-tab" onclick="switchSource('internet')" data-source="internet">
                        üåê Videos
                    </button>
                </div>
            </div>
            
            <!-- Search -->
            <div class="search-container">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search content..."
                    autocomplete="off"
                >
                <div class="search-icon">üîç</div>
            </div>
            
            <!-- Categories -->
            <div class="categories">
                <h3 class="section-title">
                    <span>üìã</span>
                    Categories
                </h3>
                <div class="category-grid" id="categoryGrid">
                    <!-- Categories will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Content List -->
            <div class="content-section">
                <div class="content-list" id="contentList">
                    <!-- Content items will be populated by JavaScript -->
                </div>
            </div>
        </aside>
        
        <!-- Player Area -->
        <section class="player-area">
            <!-- Video Player -->
            <div class="video-container">
                <video 
                    id="videoPlayer" 
                    class="video-player video-js vjs-default-skin" 
                    controls 
                    preload="auto"
                    poster=""
                ></video>
                
                <div class="video-overlay show" id="videoOverlay">
                    <div class="play-button" onclick="startPlaying()">
                        <div class="play-icon"></div>
                    </div>
                    <div class="overlay-info">
                        <h2 class="overlay-title">Welcome to iWATCH TV</h2>
                        <p class="overlay-description">Login and select content to start streaming</p>
                    </div>
                </div>
            </div>
            
            <!-- Now Playing -->
            <div class="now-playing">
                <div class="now-playing-header">
                    <h3 class="now-playing-title">Now Playing</h3>
                    <div class="quality-badge">HD Quality</div>
                </div>
                <div class="now-playing-content" id="nowPlayingContent">
                    <div class="content-avatar">üì∫</div>
                    <div class="content-details">
                        <div class="content-current">No content selected</div>
                        <div class="content-meta">Login and select content to start watching</div>
                    </div>
                </div>
            </div>
            
            <!-- Video Controls -->
            <div class="video-controls">
                <button class="control-btn" onclick="togglePlay()">‚ñ∂Ô∏è Play/Pause</button>
                <button class="control-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                <button class="control-btn" onclick="toggleMute()">üîä Mute/Unmute</button>
                <button class="control-btn" onclick="stopStream()">‚èπÔ∏è Stop</button>
                
                <div class="volume-control">
                    <span>üîä</span>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                    <span class="volume-display" id="volumeDisplay">50%</span>
                </div>
            </div>
        </section>
    </main>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <div class="login-header">
                <h2 class="login-title">üîê Login</h2>
                <p class="login-subtitle">Access your iWATCH TV account</p>
            </div>
            
            <form class="login-form" id="loginForm" autocomplete="off">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" required autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" required autocomplete="off">
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">Login</button>
            </form>
            
            <div class="error-message" id="errorMessage" style="display: none;">
                Invalid username or password. Please try again.
            </div>
        </div>
    </div>

    <!-- Adult Content Modal -->
    <div class="adult-modal" id="adultModal">
        <div class="adult-content">
            <div class="adult-header">
                <h2 class="adult-title">üîû</h2>
                <p class="adult-warning">Adult Content Verification Required</p>
                <p class="adult-warning">You must be 18+ to access this content</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; color: var(--text-primary);">Enter Password:</label>
                <input type="password" class="adult-input" id="adultPassword" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <div class="adult-buttons">
                <button class="adult-btn confirm" onclick="verifyAdultPassword()">‚úÖ Verify</button>
                <button class="adult-btn cancel" onclick="hideAdultModal()">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Video.js JavaScript -->
    <script src="https://vjs.zencdn.net/8.12.0/video.min.js"></script>
    
    <!-- HLS.js for live streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        // Global Variables
        let player = null;
        let hls = null;
        let isLoggedIn = false;
        let currentUser = null;
        let currentSource = 'live';
        let currentCategory = 'all';
        let adultUnlocked = false;
        let currentContent = null;
        let adultTypingSequence = '';
        let typingTimeout = null;
        let adminCustomers = [];

        // Load packages from admin panel localStorage
        function loadPackagesFromAdmin() {
            try {
                const adminPackages = localStorage.getItem('adminPackages');
                if (adminPackages) {
                    const packages = JSON.parse(adminPackages);
                    return packages.filter(pkg => pkg.type === 'addon'); // Only add-on packages
                }
            } catch (e) {
                console.error('Error loading packages from admin:', e);
            }
            return [];
        }

        // Load all packages from admin panel (including libraries)
        function loadAllPackagesFromAdmin() {
            try {
                const adminPackages = localStorage.getItem('adminPackages');
                if (adminPackages) {
                    return JSON.parse(adminPackages);
                }
            } catch (e) {
                console.error('Error loading packages from admin:', e);
            }
            return [];
        }

        // Load customers from admin panel
        function loadCustomersFromAdmin() {
            try {
                const adminCustomers = localStorage.getItem('adminCustomers');
                if (adminCustomers) {
                    return JSON.parse(adminCustomers);
                }
            } catch (e) {
                console.error('Error loading customers from admin:', e);
            }
            return [];
        }

        // Check if customer has access to specific package
        function customerHasPackageAccess(packageId) {
            if (!currentUser || !currentUser.customerId) return false;

            const customers = loadCustomersFromAdmin();
            const customer = customers.find(c => c.id === currentUser.customerId || c.username === currentUser.username);
            
            if (!customer) return false;

            // Check if customer has subscription to this package
            return customer.subscribedPackages.includes(packageId);
        }

        // Filter content based on customer subscription
        function filterContentBySubscription() {
            adminPackages = loadAllPackagesFromAdmin();
            adminCustomers = loadCustomersFromAdmin();

            // Get customer's subscribed packages
            let subscribedPackages = [];
            let hasBasicPackage = false;
            
            if (currentUser && adminCustomers.length > 0) {
                const customer = adminCustomers.find(c => 
                    c.username === currentUser.username || c.id === currentUser.customerId
                );
                if (customer) {
                    subscribedPackages = customer.subscribedPackages || [];
                    // Check if customer has at least one basic package
                    hasBasicPackage = subscribedPackages.some(packageId => {
                        const pkg = adminPackages.find(p => p.id === packageId);
                        return pkg && pkg.type === 'basic';
                    });
                }
            }

            // BUSINESS RULE: Customer MUST have basic package first
            // Additional packages are only available if basic package is subscribed
            const availablePackages = adminPackages.filter(pkg => {
                // Basic packages are available if subscribed
                if (pkg.type === 'basic') {
                    return subscribedPackages.includes(pkg.id);
                }

                // Adult packages require basic + adult subscription + password
                if (pkg.type === 'adult' || pkg.adult === true) {
                    return hasBasicPackage && adultUnlocked && subscribedPackages.includes(pkg.id);
                }

                // Additional and addon packages require:
                // 1. Customer must have basic package
                // 2. Customer must have subscription to this specific package
                if (!hasBasicPackage) {
                    console.log(`üö´ Customer ${currentUser?.username} cannot access ${pkg.name} - no basic package`);
                    return false;
                }

                const hasSubscription = subscribedPackages.includes(pkg.id);
                if (!hasSubscription) {
                    console.log(`üö´ Customer ${currentUser?.username} cannot access ${pkg.name} - no subscription`);
                }
                
                return hasSubscription;
            });

            console.log('üîç Customer subscription filtering:', {
                customer: currentUser?.username,
                hasBasicPackage,
                subscribedPackages,
                availablePackages: availablePackages.map(p => p.name),
                message: hasBasicPackage ? '‚úÖ Basic package confirmed' : '‚ùå No basic package - add-ons blocked'
            });

            return availablePackages;
        }

        // Load adult packages from admin panel
        function loadAdultPackagesFromAdmin() {
            try {
                const adminPackages = localStorage.getItem('adminPackages');
                if (adminPackages) {
                    const packages = JSON.parse(adminPackages);
                    return packages.filter(pkg => pkg.type === 'adult' || pkg.adult === true);
                }
            } catch (e) {
                console.error('Error loading adult packages from admin:', e);
            }
            return [];
        }

        // Get user's assigned package with Plex libraries and streaming mode
        function getUserAssignedPackage() {
            if (!currentUser) return null;
            
            const allPackages = loadAllPackagesFromAdmin();
            
            // Find package based on user plan
            const userPackage = allPackages.find(pkg => {
                // Match by package name or plan type
                return pkg.name.toLowerCase().includes(currentUser.plan.toLowerCase()) ||
                       pkg.type === 'basic' ||
                       (currentUser.plan.includes('Basic') && pkg.type === 'basic') ||
                       (currentUser.plan.includes('Premium') && pkg.type === 'additional');
            });
            
            return userPackage || null;
        }

        // Get streaming mode for content
        function getContentStreamingMode(content) {
            // Determine streaming mode based on content type and source
            if (content.streamingMode) {
                return content.streamingMode; // Use explicitly set mode
            }
            
            // Auto-detect based on content characteristics
            const contentName = content.name.toLowerCase();
            const contentDescription = content.description.toLowerCase();
            const category = content.category.toLowerCase();
            
            // Always-streaming content: News, Sports, Movies, Live TV
            const alwaysStreamingKeywords = ['news', 'sport', 'movie', 'cinema', 'film', 'live'];
            const isAlwaysStreaming = alwaysStreamingKeywords.some(keyword => 
                contentName.includes(keyword) || 
                contentDescription.includes(keyword) || 
                category.includes(keyword)
            );
            
            if (isAlwaysStreaming) {
                return 'always-streaming';
            }
            
            // Check source-based streaming mode
            const sourceStreamingModes = {
                'live': 'always-streaming',
                'movies': 'always-streaming',
                'vod': 'on-demand',
                'basic': 'on-demand',
                'addon': 'on-demand',
                'adult': 'on-demand',
                'internet': 'on-demand'
            };
            
            return sourceStreamingModes[currentSource] || 'on-demand';
        }

        // Check if content should preload (for always-streaming)
        function shouldPreloadContent(content) {
            const streamingMode = getContentStreamingMode(content);
            return streamingMode === 'always-streaming';
        }

        // Filter content based on user's package and assigned Plex libraries
        function filterContentByPackage() {
            const userPackage = getUserAssignedPackage();
            
            if (!userPackage || !userPackage.libraries || userPackage.libraries.length === 0) {
                // If no package or no libraries assigned, show limited content
                console.log('No package libraries assigned, showing basic content only');
                return;
            }

            console.log('üì¶ User package:', userPackage.name);
            console.log('üìö Assigned libraries:', userPackage.libraries);
            
            // Update content based on assigned libraries
            updateContentByLibraries(userPackage.libraries);
        }

        // Plex API Manager for Client Interface
        class ClientPlexAPI {
            constructor() {
                this.servers = [];
                this.connectedServers = new Map();
                this.loadServerConfigs();
            }
            
            loadServerConfigs() {
                const configs = localStorage.getItem('plexServerConfigs');
                if (configs) {
                    this.servers = JSON.parse(configs);
                    console.log('üì° Loaded Plex server configs:', this.servers.length);
                }
            }
            
            async testConnection(server) {
                try {
                    const response = await fetch(`${server.url}/identity?X-Plex-Token=${server.token}`);
                    if (response.ok) {
                        const data = await response.json();
                        this.connectedServers.set(server.id, {
                            ...server,
                            deviceName: data.MediaContainer.deviceName,
                            platform: data.MediaContainer.platform,
                            version: data.MediaContainer.version
                        });
                        return { success: true, data };
                    }
                } catch (error) {
                    console.warn('Plex connection failed for server:', server.name, error);
                    return { success: false, error: error.message };
                }
            }
            
            async getContentFromLibrary(serverId, libraryId, limit = 50) {
                const server = this.connectedServers.get(serverId);
                if (!server) return [];
                
                try {
                    const response = await fetch(`${server.url}/library/sections/${libraryId}/all?X-Plex-Token=${server.token}&limit=${limit}`);
                    if (response.ok) {
                        const data = await response.json();
                        return data.MediaContainer.Metadata?.map(item => ({
                            id: `plex_${serverId}_${libraryId}_${item.ratingKey}`,
                            name: item.title,
                            description: item.summary || 'No description available',
                            category: this.getCategoryFromType(item.type),
                            type: 'mp4',
                            thumb: `${server.url}${item.thumb}?X-Plex-Token=${server.token}`,
                            art: `${server.url}${item.art}?X-Plex-Token=${server.token}`,
                            url: `${server.url}/library/metadata/${item.ratingKey}/children?X-Plex-Token=${server.token}`,
                            streamingMode: this.getStreamingMode(item.type),
                            year: item.year,
                            duration: item.duration,
                            viewCount: item.viewCount || 0,
                            plexData: {
                                ratingKey: item.ratingKey,
                                libraryId: libraryId,
                                serverId: serverId,
                                serverName: server.name
                            }
                        })) || [];
                    }
                } catch (error) {
                    console.error('Failed to fetch Plex content:', error);
                    return [];
                }
            }
            
            getCategoryFromType(type) {
                switch (type) {
                    case 'movie': return 'movie';
                    case 'show': return 'series';
                    case 'episode': return 'episode';
                    default: return 'content';
                }
            }
            
            getStreamingMode(type) {
                // Movies and episodes are always-streaming, shows are on-demand
                return type === 'movie' || type === 'episode' ? 'always-streaming' : 'on-demand';
            }
            
            async getContentFromAssignedLibraries(libraryIds) {
                console.log('üîÑ Fetching content from assigned Plex libraries:', libraryIds);
                
                if (!libraryIds || libraryIds.length === 0) {
                    console.log('‚ö†Ô∏è No libraries assigned, using default content');
                    return this.getDefaultContent();
                }
                
                let allContent = [];
                
                // Process each library assignment
                for (const libraryAssignment of libraryIds) {
                    const [serverId, libraryId] = libraryAssignment.split('_');
                    
                    // Test connection first
                    const server = this.servers.find(s => s.id == serverId);
                    if (server) {
                        const connectionResult = await this.testConnection(server);
                        if (connectionResult.success) {
                            const content = await this.getContentFromLibrary(serverId, libraryId, 50);
                            allContent = allContent.concat(content);
                            console.log(`‚úÖ Fetched ${content.length} items from ${server.name}`);
                        } else {
                            console.warn(`‚ùå Failed to connect to server: ${server.name}`);
                        }
                    }
                }
                
                if (allContent.length === 0) {
                    console.log('‚ö†Ô∏è No content retrieved, using default content');
                    return this.getDefaultContent();
                }
                
                console.log(`üì∫ Total Plex content loaded: ${allContent.length} items`);
                return this.organizeContentByType(allContent);
            }
            
            organizeContentByType(content) {
                const organized = {
                    movies: [],
                    series: [],
                    vod: [],
                    live: []
                };
                
                content.forEach(item => {
                    switch (item.category) {
                        case 'movie':
                            organized.movies.push(item);
                            break;
                        case 'series':
                        case 'episode':
                            organized.series.push(item);
                            break;
                        default:
                            organized.vod.push(item);
                            break;
                    }
                });
                
                return organized;
            }
            
            getDefaultContent() {
                // Fallback content when no Plex libraries are assigned
                return {
                    movies: [
                        {
                            id: 'demo_movie_1',
                            name: 'Welcome to iWATCH TV',
                            description: 'Enjoy your streaming experience! Contact support for premium content.',
                            category: 'movie',
                            type: 'mp4',
                            url: '#',
                            streamingMode: 'on-demand'
                        }
                    ],
                    series: [],
                    vod: [],
                    live: []
                };
            }
        }
        
        // Initialize Client Plex API
        window.clientPlexAPI = new ClientPlexAPI();

        // Update content based on assigned Plex libraries
        async function updateContentByLibraries(libraryIds) {
            console.log('üîß updateContentByLibraries called with library IDs:', libraryIds);
            
            // Show loading state
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'plexLoadingIndicator';
            loadingIndicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 20px;
                border-radius: 12px;
                z-index: 10000;
                text-align: center;
            `;
            loadingIndicator.innerHTML = `
                <div style="margin-bottom: 15px;">üì∫</div>
                <div>Loading Plex content...</div>
            `;
            document.body.appendChild(loadingIndicator);
            
            try {
                const plexContent = await window.clientPlexAPI.getContentFromAssignedLibraries(libraryIds);
                
                // Clear existing content
                contentData.movies.content = [];
                contentData.vod.content = [];
                contentData.series.content = [];
                
                // Update with Plex content
                if (plexContent.movies.length > 0) {
                    contentData.movies.content = plexContent.movies;
                    console.log(`üé¨ Loaded ${plexContent.movies.length} movies`);
                }
                
                if (plexContent.series.length > 0) {
                    contentData.series.content = plexContent.series;
                    console.log(`üì∫ Loaded ${plexContent.series.length} series/episodes`);
                }
                
                if (plexContent.vod.length > 0) {
                    contentData.vod.content = plexContent.vod;
                    console.log(`üìÄ Loaded ${plexContent.vod.length} VOD items`);
                }
                
                // Update tab labels with real counts
                const moviesTab = document.getElementById('moviesTab');
                const vodTab = document.getElementById('vodTab');
                if (moviesTab) moviesTab.textContent = `Movies (${contentData.movies.content.length})`;
                if (vodTab) vodTab.textContent = `VOD (${contentData.vod.content.length})`;
                
                console.log('‚úÖ Content updated from Plex libraries');
                
                // Refresh display if currently viewing affected sections
                if (['movies', 'vod', 'series'].includes(currentSource)) {
                    displayContent(currentSource);
                }
                
                // Show success message
                if (libraryIds && libraryIds.length > 0) {
                    showSuccess(`Loaded ${plexContent.movies.length + plexContent.series.length + plexContent.vod.length} items from your Plex libraries`);
                }
                
            } catch (error) {
                console.error('Error loading Plex content:', error);
                showError('Failed to load Plex content. Using default content.');
                // Fall back to default content
                const defaultContent = window.clientPlexAPI.getDefaultContent();
                contentData.movies.content = defaultContent.movies;
                displayContent('movies');
            } finally {
                // Remove loading indicator
                const indicator = document.getElementById('plexLoadingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }

        // Content Data
        const contentData = {
            live: {
                name: 'Live TV',
                content: [],
                streamingMode: 'always-streaming' // Live TV always streams
            },
            movies: {
                name: 'Movies',
                content: [],
                streamingMode: 'always-streaming' // Movies always stream for better UX
            },
            vod: {
                name: 'VOD Library',
                content: [
                    {
                        id: 'vod_demo_1',
                        name: 'Featured TV Show 1',
                        description: 'Premium series content - Available on-demand',
                        category: 'series',
                        type: 'mp4',
                        url: '#',
                        streamingMode: 'on-demand'
                    },
                    {
                        id: 'vod_demo_2',
                        name: 'Popular Series Episode',
                        description: 'Latest episode from popular TV series',
                        category: 'series',
                        type: 'mp4',
                        url: '#',
                        streamingMode: 'on-demand'
                    },
                    {
                        id: 'vod_demo_3',
                        name: 'Classic Movies Collection',
                        description: 'Timeless movies available on-demand',
                        category: 'movie',
                        type: 'mp4',
                        url: '#',
                        streamingMode: 'on-demand'
                    }
                ],
                streamingMode: 'on-demand' // VOD streams on-demand
            },
            basic: {
                name: 'Basic Package',
                content: [],
                streamingMode: 'on-demand' // Basic packages on-demand
            },
            addon: {
                name: 'Add-on Packages',
                content: loadPackagesFromAdmin(), // Load from admin panel
                streamingMode: 'mixed' // Mixed - depends on package
            },
            adult: {
                name: 'Adult Content',
                content: loadAdultPackagesFromAdmin(), // Load adult packages
                streamingMode: 'on-demand' // Adult content on-demand
            },
            internet: {
                name: 'Internet Videos',
                content: [],
                streamingMode: 'on-demand' // Internet videos on-demand
            }
        };

        // Helper Functions for Content Display
        function getSourceIcon(source) {
            switch(source) {
                case 'live': return 'üî¥';
                case 'movies': return 'üé¨';
                case 'vod': return 'üìÄ';
                case 'basic': return 'üè†';
                case 'addon': return 'üîß';
                case 'internet': return 'üåê';
                default: return 'üì∫';
            }
        }

        function getBadgeClass(source) {
            switch(source) {
                case 'live': return 'badge-live';
                case 'movies': return 'badge-movies';
                case 'vod': return 'badge-vod';
                case 'basic': return 'badge-basic';
                case 'addon': return 'badge-addon';
                case 'internet': return 'badge-internet';
                default: return 'badge-internet';
            }
        }

        function getBadgeText(source) {
            switch(source) {
                case 'live': return 'LIVE';
                case 'movies': return 'MOVIE';
                case 'vod': return 'VOD';
                case 'basic': return 'BASIC';
                case 'addon': return 'ADDON';
                case 'internet': return 'NET';
                default: return 'NET';
            }
        }

        // Authentication Functions
        function hasAddonAccess(addonName) {
            // Check if user has required addon subscription
            if (!currentUser || !currentUser.permissions) {
                return false;
            }
            
            // Admin and reseller always have access
            if (currentUser.role === 'admin' || currentUser.role === 'reseller') {
                return true;
            }
            
            // Check if user has specific addon subscription
            return currentUser.permissions.includes(addonName) || currentUser.permissions.includes('full_access');
        }

        function loginUser(username, password) {
            const user = passwordManager.authenticateUser(username, password);
            
            if (user) {
                isLoggedIn = true;
                currentUser = user;
                updateUserInterface();
                hideLoginModal();
                showSuccess(`Welcome back, ${user.username}!`);
                
                // Initialize content preloading for better UX
                initializeContentPreloading();
                
                return true;
            }
            
            return false;
        }

        function logoutUser() {
            isLoggedIn = false;
            currentUser = null;
            adultUnlocked = false;
            stopStream();
            updateUserInterface();
            showLoginModal();
        }

        function updateUserInterface() {
            const userStatus = document.getElementById('userStatus');
            const userName = document.getElementById('userName');
            const subscriptionExpiry = document.getElementById('subscriptionExpiry');
            
            if (isLoggedIn && currentUser) {
                userName.textContent = currentUser.username;
                const expiryDate = new Date(currentUser.expiryDate);
                const daysRemaining = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                
                if (daysRemaining > 0) {
                    subscriptionExpiry.textContent = `${daysRemaining} days remaining`;
                    subscriptionExpiry.className = 'subscription-expiry';
                } else {
                    subscriptionExpiry.textContent = 'Expired';
                    subscriptionExpiry.className = 'subscription-expiry expired';
                }
                
                userStatus.onclick = logoutUser;
            } else {
                userName.textContent = 'Guest';
                subscriptionExpiry.textContent = 'Please Login';
                subscriptionExpiry.className = 'subscription-expiry';
                userStatus.onclick = showLoginModal;
            }
        }

        // Adult Content Management
        function hideAdultIndicator() {
            const indicator = document.getElementById('adultIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function showAdultIndicator() {
            const indicator = document.getElementById('adultIndicator');
            if (indicator) {
                indicator.style.display = 'flex';
            }
        }

        function showAdultModal() {
            document.getElementById('adultModal').classList.add('show');
            document.getElementById('adultPassword').focus();
        }

        // Global function for hiding adult modal - defined early for onclick access
        window.hideAdultModal = function() {
            document.getElementById('adultModal').classList.remove('show');
            document.getElementById('adultPassword').value = '';
        }

        // Global function for adult password verification - defined early for onclick access
        window.verifyAdultPassword = function() {
            const password = document.getElementById('adultPassword').value;
            
            if (passwordManager.verifyPassword('clientAdult', password)) {
                adultUnlocked = true;
                showAdultIndicator();
                showAdultTab(); // Show adult tab when password is correct
                updateAdultIndicator();
                hideAdultModal();
                showSuccess('Adult content unlocked');
                renderContent();
            } else {
                showError('Invalid password. Please try again.');
            }
        }

        function updateAdultIndicator() {
            const indicator = document.getElementById('adultIndicator');
            if (!indicator) return;
            
            const icon = indicator.querySelector('.adult-icon');
            const status = indicator.querySelector('.adult-status');
            
            if (adultUnlocked) {
                indicator.classList.remove('locked');
                indicator.classList.add('unlocked');
                icon.textContent = 'üîì';
                status.textContent = 'Click to Exit';
            } else {
                indicator.classList.remove('unlocked');
                indicator.classList.add('locked');
                icon.textContent = 'üîí';
                status.textContent = 'Locked';
            }
        }

        // Global function for exiting adult content - defined early for onclick access
        window.exitAdultContent = function() {
            adultUnlocked = false;
            hideAdultIndicator();
            hideAdultTab(); // Hide adult tab when exiting adult content
            updateAdultIndicator();
            renderContent();
            showSuccess('Adult content locked');
        }

        // Adult Tab Management
        function showAdultTab() {
            const adultTab = document.getElementById('adultTab');
            if (adultTab) {
                adultTab.style.display = 'block';
            }
        }

        function hideAdultTab() {
            const adultTab = document.getElementById('adultTab');
            if (adultTab) {
                adultTab.style.display = 'none';
                // If currently viewing adult content, switch to basic tab
                if (currentSource === 'adult') {
                    switchSource('basic');
                }
            }
        }

        // Content Management
        // Global function for source switching - defined early for onclick access
        window.switchSource = function(source) {
            if (currentSource === source) return;
            
            currentSource = source;
            currentCategory = 'all';
            
            // Update tab active state
            document.querySelectorAll('.source-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-source="${source}"]`).classList.add('active');
            
            renderContent();
        }

        // Display content for specific source (alias for renderContent)
        function displayContent(source) {
            switchSource(source);
        }

        function renderCategories() {
            const categories = ['all', ...new Set(contentData[currentSource].content
                .filter(item => {
                    const isAdultContent = item.adult || item.category === 'adult';
                    const canViewAdult = adultUnlocked || !isAdultContent;
                    return canViewAdult;
                })
                .map(item => item.category)
            )];
            
            const categoryGrid = document.getElementById('categoryGrid');
            categoryGrid.innerHTML = categories.map(category => {
                const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                const isAdult = category === 'adult';
                const className = `category-btn ${isAdult ? 'adult' : ''} ${currentCategory === category ? 'active' : ''}`;
                
                return `<button class="${className}" onclick="selectCategory('${category}')">${categoryName}</button>`;
            }).join('');
        }

        // Global function for category selection - defined early for onclick access
        window.selectCategory = function(category) {
            currentCategory = category;
            renderContent();
        }

        function renderContent() {
            renderCategories();
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Apply customer subscription filtering
            const availablePackages = filterContentBySubscription();
            
            let filteredContent = contentData[currentSource].content;
            
            // Apply subscription-based filtering
            if (['movies', 'vod'].includes(currentSource)) {
                console.log(`üîç Filtering ${currentSource} content - current content count: ${filteredContent.length}`);
                const userPackage = getUserAssignedPackage();
                console.log(`üì¶ User package found:`, userPackage);
                
                if (userPackage && userPackage.libraries && userPackage.libraries.length > 0) {
                    // Content is already filtered by updateContentByLibraries function
                    console.log(`üì∫ Showing content from assigned libraries for ${currentSource}`);
                } else {
                    // No libraries assigned, keep default content for VOD so section is visible
                    if (currentSource === 'vod') {
                        console.log('üìÄ VOD: No libraries assigned, keeping default content');
                        console.log(`üìÄ VOD: Content array length: ${filteredContent.length}`);
                        // Keep the default VOD content for demo purposes
                    } else {
                        // For movies, clear content if no libraries
                        console.log('üé¨ Movies: No libraries assigned, clearing content');
                        filteredContent = [];
                    }
                }
                console.log(`‚úÖ ${currentSource} final content count: ${filteredContent.length}`);
            }
            
            // Additional subscription filtering for other sections
            if (currentSource === 'addon') {
                // For addon section, only show packages customer has access to
                const customerAccess = filterContentBySubscription();
                filteredContent = filteredContent.filter(item => {
                    if (item.type === 'package') {
                        return customerAccess.some(pkg => pkg.id === item.packageId);
                    }
                    return true;
                });
            }
            
            const availableContent = filteredContent.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) || 
                                    item.description.toLowerCase().includes(searchTerm);
                const matchesCategory = currentCategory === 'all' || item.category === currentCategory;
                const isAdultContent = item.adult || item.category === 'adult';
                const canViewAdult = adultUnlocked || !isAdultContent;
                
                // Check addon access for addon section
                let canViewAddon = true;
                if (currentSource === 'addon' && item.requiresAddon) {
                    canViewAddon = hasAddonAccess(item.requiresAddon);
                }
                
                return matchesSearch && matchesCategory && canViewAdult && canViewAddon;
            });
            
            const contentList = document.getElementById('contentList');
            
            // Add refresh button for addon section
            if (currentSource === 'addon' && availableContent.length > 0) {
                contentList.innerHTML = `
                    <div style="text-align: right; margin-bottom: 15px;">
                        <button onclick="refreshAddonPackages()" style="background: var(--accent-color, #0057FF); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            üîÑ Refresh Packages
                        </button>
                    </div>
                `;
            }
            
            if (availableContent.length === 0) {
                const refreshButton = currentSource === 'addon' ? 
                    '<div style="text-align: center; margin: 15px 0;"><button onclick="refreshAddonPackages()" style="background: var(--accent-color, #0057FF); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">üîÑ Check for Packages</button></div>' : '';
                contentList.innerHTML = '<div class="empty-message">No content available in this section.</div>' + refreshButton;
                return;
            }
            
            contentList.innerHTML = availableContent.map((item, index) => {
                const typeIcon = getSourceIcon(currentSource);
                const typeBadge = getBadgeClass(currentSource);
                const contentType = getBadgeText(currentSource);
                const isAdult = item.adult || item.category === 'adult';
                const className = `content-item ${currentSource} ${isAdult ? 'adult-content' : ''}`;
                
                return `
                    <div class="${className}" onclick="playContent('${item.id}')">
                        <div class="content-type-badge ${typeBadge}">${contentType}</div>
                        <div class="content-header">
                            <div class="content-icon">${typeIcon}</div>
                            <div class="content-info">
                                <div class="content-name">${item.name}</div>
                                <div class="content-description">${item.description}</div>
                                <div class="content-status">
                                    ${currentSource === 'live' ? '<div class="live-indicator"></div>' : ''}
                                    <span>${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</span>
                                    ${(() => {
                                        const streamingMode = getContentStreamingMode(item);
                                        return streamingMode === 'always-streaming' ? 
                                            '<span class="streaming-indicator always">üî¥ Always On</span>' :
                                            '<span class="streaming-indicator on-demand">‚è∏Ô∏è On-Demand</span>';
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Video Player Functions
        function initializePlayer() {
            player = videojs('videoPlayer', {
                controls: true,
                responsive: true,
                fluid: true,
                playbackRates: [0.5, 1, 1.25, 1.5, 2],
                sources: []
            });

            player.ready(() => {
                console.log('Video.js player ready');
            });
        }

        // Global function for playing content - defined early for onclick access
        window.playContent = function(contentId) {
            if (!isLoggedIn) {
                showError('Please login to start watching');
                return;
            }
            
            const content = contentData[currentSource].content.find(item => item.id === contentId);
            if (!content) return;
            
            // Check adult content access
            if (content.adult || content.category === 'adult') {
                if (!adultUnlocked) {
                    showAdultModal();
                    return;
                }
            }
            
            currentContent = content;
            
            // Hide overlay
            document.getElementById('videoOverlay').classList.remove('show');
            
            // Update now playing
            updateNowPlaying(content);
            
            // Handle different content types with streaming mode optimization
            const streamingMode = getContentStreamingMode(content);
            
            if (streamingMode === 'always-streaming') {
                // Always-streaming content: start immediately without delay
                console.log('üî¥ Playing always-streaming content:', content.name);
                if (content.type === 'hls') {
                    handleHLSContent(content);
                } else if (content.type === 'mp4') {
                    handleMP4Content(content);
                } else {
                    showError('Unsupported content type');
                }
            } else {
                // On-demand content: show loading indicator for 2 seconds, then stream
                console.log('‚è∏Ô∏è Loading on-demand content:', content.name);
                showLoadingIndicator(content.name, streamingMode);
                
                setTimeout(() => {
                    if (content.type === 'hls') {
                        handleHLSContent(content);
                    } else if (content.type === 'mp4') {
                        handleMP4Content(content);
                    } else {
                        showError('Unsupported content type');
                    }
                }, 2000); // 2-second delay as specified
            }
        }

        function handleHLSContent(content) {
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy();
                }
                
                hls = new Hls();
                hls.loadSource(content.url);
                hls.attachMedia(player.el().querySelector('video'));
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    player.play().catch(e => {
                        showError('Failed to start playback. Please try again.');
                    });
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                showError('Network error occurred');
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                showError('Media error occurred');
                                break;
                            default:
                                showError('Unknown error occurred');
                                break;
                        }
                    }
                });
            } else if (player.tech().isSupported()) {
                player.src({
                    src: content.url,
                    type: 'application/x-mpegURL'
                });
                
                player.ready(() => {
                    player.play().catch(e => {
                        showError('Failed to start playback. Please try again.');
                    });
                });
            } else {
                showError('HLS is not supported in this browser');
            }
        }

        // Show loading indicator for on-demand content
        function showLoadingIndicator(contentName, streamingMode) {
            const overlay = document.getElementById('videoOverlay');
            const title = overlay.querySelector('.overlay-title');
            const description = overlay.querySelector('.overlay-description');
            
            title.textContent = `Loading ${contentName}`;
            description.textContent = streamingMode === 'on-demand' ? 
                'On-demand streaming - please wait 2 seconds' : 
                'Starting stream...';
            
            overlay.classList.add('show');
        }

        // Preload always-streaming content
        function preloadAlwaysStreamingContent() {
            console.log('üîÑ Preloading always-streaming content...');
            
            // Preload content from always-streaming sources
            const alwaysStreamingSources = ['live', 'movies'];
            
            alwaysStreamingSources.forEach(source => {
                const sourceData = contentData[source];
                if (sourceData && sourceData.content.length > 0) {
                    // Find first content item from this source
                    const contentToPreload = sourceData.content[0];
                    if (contentToPreload && shouldPreloadContent(contentToPreload)) {
                        console.log(`üì∫ Preloading ${contentToPreload.name} from ${source}`);
                        
                        // Create a hidden video element for preloading
                        const preloadVideo = document.createElement('video');
                        preloadVideo.preload = 'auto';
                        preloadVideo.style.display = 'none';
                        preloadVideo.muted = true;
                        
                        if (contentToPreload.type === 'hls' && Hls.isSupported()) {
                            const preloadHls = new Hls();
                            preloadHls.loadSource(contentToPreload.url);
                            preloadHls.attachMedia(preloadVideo);
                        } else if (contentToPreload.type === 'mp4') {
                            preloadVideo.src = contentToPreload.url;
                        }
                        
                        document.body.appendChild(preloadVideo);
                        
                        // Remove preloaded video after 10 seconds to prevent memory issues
                        setTimeout(() => {
                            if (preloadVideo.parentNode) {
                                preloadVideo.parentNode.removeChild(preloadVideo);
                            }
                        }, 10000);
                    }
                }
            });
        }

        // Initialize preloading after login
        function initializeContentPreloading() {
            if (isLoggedIn && currentUser) {
                setTimeout(preloadAlwaysStreamingContent, 2000); // Wait 2 seconds after login
            }
        }

        // Handle MP4 content playback
        function handleMP4Content(content) {
            player.src({
                src: content.url,
                type: 'video/mp4'
            });
            
            player.ready(() => {
                player.play().catch(e => {
                    showError('Failed to start playback. Please try again.');
                });
            });
        }

        function updateNowPlaying(content) {
            const container = document.getElementById('nowPlayingContent');
            const icon = getSourceIcon(currentSource);
            
            container.innerHTML = `
                <div class="content-avatar">${icon}</div>
                <div class="content-details">
                    <div class="content-current">${content.name}</div>
                    <div class="content-meta">
                        ${content.description}<br>
                        <span style="color: var(--success-color);">
                            ${content.type === 'hls' ? 'üî¥ Live' : 
                              currentSource === 'movies' ? 'üé¨ Movies' :
                              currentSource === 'vod' ? 'üìÄ VOD' :
                              currentSource === 'basic' ? 'üè† Basic' :
                              currentSource === 'addon' ? 'üîß Addon' :
                              currentSource === 'internet' ? 'üåê Videos' : 
                              'üì∫ Live TV'} ‚Ä¢ ${content.type.toUpperCase()} ‚Ä¢ ${
                                (() => {
                                    const streamingMode = getContentStreamingMode(content);
                                    return streamingMode === 'always-streaming' ? 
                                        '<span style="color: #ff4444;">üî¥ Always-Streaming</span>' :
                                        '<span style="color: #666;">‚è∏Ô∏è On-Demand</span>';
                                })()
                              }
                        </span>
                    </div>
                </div>
            `;
        }

        // Global function for starting playback - defined early for onclick access
        window.startPlaying = function() {
            if (!isLoggedIn) {
                showError('Please login to start watching');
                return;
            }
            
            const content = contentData[currentSource].content[0];
            if (content) {
                playContent(content.id);
            } else {
                showError('No content available. Please check your subscription.');
            }
        }

        // Global function for video play/pause - defined early for onclick access
        window.togglePlay = function() {
            if (!player || !currentContent) return;
            
            if (player.paused()) {
                player.play();
            } else {
                player.pause();
            }
        }

        // Global function for fullscreen toggle - defined early for onclick access
        window.toggleFullscreen = function() {
            if (!player) return;
            
            if (player.isFullscreen()) {
                player.exitFullscreen();
            } else {
                player.requestFullscreen();
            }
        }

        // Global function for mute toggle - defined early for onclick access
        window.toggleMute = function() {
            if (!player) return;
            
            player.muted(!player.muted());
        }

        // Global function for stopping stream - defined early for onclick access
        window.stopStream = function() {
            if (!player) return;
            
            player.pause();
            player.src('');
            
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            // Show overlay
            document.getElementById('videoOverlay').classList.add('show');
            
            // Reset now playing
            const container = document.getElementById('nowPlayingContent');
            container.innerHTML = `
                <div class="content-avatar">üì∫</div>
                <div class="content-details">
                    <div class="content-current">No content selected</div>
                    <div class="content-meta">Login and select content to start watching</div>
                </div>
            `;
            
            // Remove active content
            document.querySelectorAll('.content-item').forEach(item => {
                item.classList.remove('active');
            });
            
            currentContent = null;
        }

        // Modal Management
        // Global function for showing login modal - defined early for onclick access
        window.showLoginModal = function() {
            if (!isLoggedIn) {
                document.getElementById('loginModal').classList.add('show');
                document.getElementById('username').focus();
            }
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        // Event Listeners
        function setupEventListeners() {
            // Login form
            if (document.getElementById('loginForm')) {
                document.getElementById('loginForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const loginBtn = document.getElementById('loginBtn');
                    
                    if (!username || !password) {
                        console.log('Username and password are required');
                        return;
                    }
                    
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Logging in...';
                    
                    setTimeout(() => {
                        const loginSuccess = loginUser(username, password);
                        console.log('Login attempt result:', loginSuccess);
                        
                        if (loginSuccess) {
                            document.getElementById('username').value = '';
                            document.getElementById('password').value = '';
                        }
                        
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Login';
                    }, 1000);
                });
            }

            // Adult password
            document.getElementById('adultPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyAdultPassword();
                }
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', function() {
                renderContent();
            });

            // Volume control
            document.getElementById('volumeSlider').addEventListener('input', function(e) {
                const volume = parseInt(e.target.value);
                if (player) {
                    player.volume(volume / 100);
                }
                document.getElementById('volumeDisplay').textContent = volume + '%';
            });

            // Close modal when clicking outside
            document.getElementById('loginModal').addEventListener('click', function(e) {
                if (e.target.id === 'loginModal') {
                    hideLoginModal();
                }
            });
        }

        // Time Display
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('timeDisplay').textContent = timeString;
            document.getElementById('dateDisplay').textContent = dateString;
        }

        // Utility Functions
        function showError(message) {
            console.log('Error:', message);
            alert(message);
        }

        function showError(message) {
            console.log('Error:', message);
            alert(message);
        }

        function showSuccess(message) {
            console.log('Success:', message);
            alert(message);
        }

        // Global function for app initialization - defined early for onload access
        window.initApp = function() {
            // Initialize player
            initializePlayer();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load customer subscription data
            adminCustomers = loadCustomersFromAdmin();
            console.log('üë• Loaded customer data:', adminCustomers.length, 'customers');
            
            // Apply subscription filtering
            const availablePackages = filterContentBySubscription();
            
            // Initialize adult content system
            hideAdultIndicator();
            
            // Check if this is a fresh visit (adult content should be hidden)
            const isFreshVisit = !sessionStorage.getItem('app_visited');
            if (isFreshVisit) {
                adultUnlocked = false;
                hideAdultIndicator();
                sessionStorage.setItem('app_visited', 'true');
            }
            
            // Reset adult visibility on page load if not logged in
            if (!isLoggedIn) {
                adultUnlocked = false;
                hideAdultIndicator();
            }
            
            updateAdultIndicator();
            
            // Initial render
            renderContent();
            
            // Update time display
            updateTime();
            setInterval(updateTime, 1000);
            
            // Update user interface
            updateUserInterface();
            
            // Load packages from admin panel
            refreshAddonPackages();
            
            // Apply package-based content filtering
            filterContentByPackage();
            
            // Safety check: Ensure VOD always has content even if filtering failed
            if (contentData.vod.content.length === 0) {
                contentData.vod.content = [
                    {
                        id: 'vod_demo_1',
                        name: 'Featured TV Show 1',
                        description: 'Premium series content - Available on-demand',
                        category: 'series',
                        type: 'mp4',
                        url: '#',
                        streamingMode: 'on-demand'
                    },
                    {
                        id: 'vod_demo_2',
                        name: 'Popular Series Episode',
                        description: 'Latest episode from popular TV series',
                        category: 'series',
                        type: 'mp4',
                        url: '#',
                        streamingMode: 'on-demand'
                    },
                    {
                        id: 'vod_demo_3',
                        name: 'Classic Movies Collection',
                        description: 'Timeless movies available on-demand',
                        category: 'movie',
                        type: 'mp4',
                        url: '#',
                        streamingMode: 'on-demand'
                    }
                ];
                console.log('üîß VOD: Reset content with default items - safety check');
            }
            
            // Listen for package updates from admin panel
            window.addEventListener('storage', function(e) {
                if (e.key === 'adminPackages') {
                    console.log('üîÑ Packages updated in admin panel, refreshing client...');
                    refreshAddonPackages();
                    // Apply new package-based filtering
                    filterContentByPackage();
                }
                if (e.key === 'adminCustomers') {
                    console.log('üë• Customer data updated in admin panel, refreshing client...');
                    adminCustomers = loadCustomersFromAdmin();
                    // Re-apply subscription filtering
                    const availablePackages = filterContentBySubscription();
                    renderContent();
                }
            });
            
            console.log('iWATCH TV Client initialized successfully');
        }
        
        // Global function for refreshing addon packages - defined early for onclick access
        window.refreshAddonPackages = function() {
            contentData.addon.content = loadPackagesFromAdmin();
            console.log(`üì¶ Loaded ${contentData.addon.content.length} add-on packages from admin panel`);
            
            // Refresh the display if addon tab is currently active
            if (activeTab === 'addon') {
                displayContent('addon');
            }
        }

        // Adult Content Keyboard Sequence Detection
        document.addEventListener('keydown', function(e) {
            const key = e.key;
            
            // Clear existing timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Build the sequence for "1818"
            if (/[0-9]/.test(key)) {
                adultTypingSequence += key;
                
                // Keep only the last 4 digits
                if (adultTypingSequence.length > 4) {
                    adultTypingSequence = adultTypingSequence.slice(-4);
                }
                
                // Reset timeout for sequence detection
                typingTimeout = setTimeout(() => {
                    adultTypingSequence = '';
                }, 2000); // 2 second timeout
                
                // Check if sequence matches "1818"
                if (adultTypingSequence === '1818' && !adultUnlocked) {
                    showAdultModal();
                    adultTypingSequence = '';
                    if (typingTimeout) {
                        clearTimeout(typingTimeout);
                    }
                }
            }
            
            // Handle other keyboard shortcuts only when not in input fields
            if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                switch(e.key) {
                    case 'Escape':
                        if (player && player.isFullscreen()) {
                            player.exitFullscreen();
                        } else if (document.getElementById('loginModal').classList.contains('show')) {
                            hideLoginModal();
                        } else if (document.getElementById('adultModal').classList.contains('show')) {
                            hideAdultModal();
                        }
                        break;
                        
                    case 'l':
                    case 'L':
                        e.preventDefault();
                        if (!isLoggedIn) {
                            showLoginModal();
                        } else {
                            logoutUser();
                        }
                        break;
                        
                    case 'a':
                    case 'A':
                        e.preventDefault();
                        showAdultModal();
                        break;
                        
                    case 'x':
                    case 'X':
                        e.preventDefault();
                        if (adultUnlocked) {
                            exitAdultContent();
                        }
                        break;
                }
            }
        });

        // Start update system
        updateSystem.startAutoUpdateCheck();
        
        // Initialize when DOM is ready (fallback)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // DOM is already loaded
            setTimeout(initApp, 100);
        }
    </script>
    
    <!-- Update Notification Styles -->
    <style>
        .update-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #0057FF, #0073FF);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 87, 255, 0.3);
            transform: translateX(400px);
            transition: all 0.3s ease;
            z-index: 9999;
            max-width: 400px;
            min-width: 350px;
            font-family: 'Arial', sans-serif;
        }
        
        .update-notification.show {
            transform: translateX(0);
        }
        
        .update-content {
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .update-icon {
            font-size: 24px;
            margin-top: 5px;
        }
        
        .update-info {
            flex: 1;
        }
        
        .update-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .update-info p {
            margin: 0 0 5px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .update-description {
            font-size: 12px;
            opacity: 0.7;
            line-height: 1.4;
        }
        
        .update-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn-update, .btn-dismiss {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-update {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-update:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn-dismiss {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-dismiss:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .update-success {
            text-align: center;
            padding: 30px 20px;
        }
        
        .success-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .update-success h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        
        .update-success p {
            margin: 0;
            opacity: 0.8;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .update-notification {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                min-width: auto;
            }
        }
    </style>
</body>
</html>
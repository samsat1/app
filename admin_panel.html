<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Admin Panel - iWATCH TV</title>
    <meta name="author" content="MiniMax Agent">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iWATCH Admin">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#4caf50">
    <meta name="msapplication-TileColor" content="#4caf50">
    
    <!-- Prevent zoom on input focus -->
    <style>
        input, select, textarea {
            font-size: 16px !important;
        }
    </style>
    
    <!-- Enhanced Password Management System -->
    <script>
        const passwordManager = {
            passwords: {
                'adminLogin': 'admin123',
                'masterPassword': 'master2025' // Master password to access any reseller panel
            },
            resellerCredentials: {}, // Store reseller credentials by ID
            currentSession: null,
            
            initialize: function() {
                console.log('üîß PasswordManager initializing...');
                this.initializeCredentials();
                console.log('‚úÖ PasswordManager initialized');
            },
            
            initializeCredentials: function() {
                // Load existing credentials
                const savedCredentials = localStorage.getItem('resellerCredentials');
                if (savedCredentials) {
                    try {
                        this.resellerCredentials = JSON.parse(savedCredentials);
                    } catch (e) {
                        console.error('Error loading reseller credentials:', e);
                        this.resellerCredentials = {};
                    }
                } else {
                    // Create default reseller
                    this.resellerCredentials['reseller'] = {
                        username: 'reseller',
                        password: 'reseller123',
                        createdAt: new Date().toISOString()
                    };
                    this.saveCredentials();
                }
            },
            
            saveCredentials: function() {
                try {
                    console.log('üíæ Saving credentials to localStorage...');
                    localStorage.setItem('resellerCredentials', JSON.stringify(this.resellerCredentials));
                    localStorage.setItem('adminPasswords', JSON.stringify(this.passwords));
                    
                    // Verify save
                    const testRead = localStorage.getItem('resellerCredentials');
                    console.log('‚úÖ Credentials saved successfully', testRead ? 'and verified' : 'but verification failed');
                } catch (e) {
                    console.error('‚ùå Error saving credentials:', e);
                    throw e;
                }
            },
            
            verifyPassword: function(key, input) {
                return this.passwords[key] === input;
            },
            
            authenticateUser: function(username, password) {
                // Admin authentication
                if (username === 'admin' && password === this.passwords.adminLogin) {
                    this.currentSession = {
                        id: 'admin_' + Date.now(),
                        username: 'admin',
                        role: 'admin',
                        plan: 'Admin Access',
                        expiryDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),
                        status: 'active',
                        permissions: ['admin', 'full_control']
                    };
                    return this.currentSession;
                }
                
                // Master password access to reseller panels
                if (password === this.passwords.masterPassword && username.startsWith('reseller_')) {
                    const resellerId = username.replace('reseller_', '');
                    if (this.resellerCredentials[resellerId]) {
                        return {
                            id: 'master_' + resellerId + '_' + Date.now(),
                            username: 'reseller_' + resellerId,
                            role: 'reseller',
                            resellerId: resellerId,
                            plan: 'Master Access',
                            expiryDate: new Date(Date.now() + 24 * 60 * 60 * 1000),
                            status: 'active',
                            permissions: ['reseller', 'master_access']
                        };
                    }
                }
                
                // Regular reseller authentication
                if (this.resellerCredentials[username]) {
                    const reseller = this.resellerCredentials[username];
                    if (reseller.password === password) {
                        this.currentSession = {
                            id: 'reseller_' + username + '_' + Date.now(),
                            username: username,
                            role: 'reseller',
                            resellerId: username,
                            plan: 'Reseller Access',
                            expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                            status: 'active',
                            permissions: ['reseller']
                        };
                        return this.currentSession;
                    }
                }
                
                return null;
            },
            
            changeAdminPassword: function(currentPassword, newPassword) {
                if (currentPassword !== this.passwords.adminLogin) {
                    return { success: false, message: 'Current password is incorrect' };
                }
                
                if (!newPassword || newPassword.length < 6) {
                    return { success: false, message: 'New password must be at least 6 characters' };
                }
                
                this.passwords.adminLogin = newPassword;
                this.saveCredentials(); // Save to localStorage
                return { success: true, message: 'Admin password updated successfully!' };
            },
            
            changeMasterPassword: function(currentPassword, newPassword) {
                if (currentPassword !== this.passwords.masterPassword) {
                    return { success: false, message: 'Current master password is incorrect' };
                }
                
                if (!newPassword || newPassword.length < 6) {
                    return { success: false, message: 'New master password must be at least 6 characters' };
                }
                
                this.passwords.masterPassword = newPassword;
                this.saveCredentials(); // Save to localStorage
                return { success: true, message: 'Master password updated successfully!' };
            },
            
            createReseller: function(resellerId, username, password) {
                console.log('üîß Creating reseller:', { resellerId, username, password });
                
                if (!resellerId || !username || !password) {
                    console.log('‚ùå Missing required fields');
                    return { success: false, message: 'All fields are required' };
                }
                
                if (this.resellerCredentials[resellerId]) {
                    console.log('‚ùå Reseller ID already exists:', resellerId);
                    return { success: false, message: 'Reseller ID already exists' };
                }
                
                if (password.length < 6) {
                    console.log('‚ùå Password too short');
                    return { success: false, message: 'Password must be at least 6 characters' };
                }
                
                this.resellerCredentials[resellerId] = {
                    username: username,
                    password: password,
                    createdAt: new Date().toISOString()
                };
                
                console.log('üíæ Saving credentials...', this.resellerCredentials[resellerId]);
                this.saveCredentials();
                
                // Verify saving worked
                const saved = localStorage.getItem('resellerCredentials');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed[resellerId]) {
                            console.log('‚úÖ Credentials saved and verified');
                        } else {
                            console.error('‚ùå Credentials not found after save');
                        }
                    } catch (e) {
                        console.error('‚ùå Error verifying saved credentials:', e);
                    }
                } else {
                    console.error('‚ùå localStorage save failed');
                }
                
                return { success: true, message: `Reseller "${resellerId}" created successfully!` };
            },
            
            getAllResellers: function() {
                return Object.keys(this.resellerCredentials);
            }
        };
        
        // Initialize password system
        passwordManager.initializeCredentials();
        
        // ========================================
        // REAL PLEX API INTEGRATION
        // ========================================
        
        const plexAPIClient = {
            baseURL: null,
            token: null,
            headers: {},
            
            // Initialize Plex API client
            init: function(plexUrl, plexToken) {
                this.baseURL = plexUrl.replace(/\/$/, ''); // Remove trailing slash
                this.token = plexToken;
                this.headers = {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-Plex-Token': this.token
                };
                console.log('üîß PlexAPIClient initialized:', this.baseURL);
            },
            
            // Test connection to Plex server
            async testConnection() {
                try {
                    const response = await fetch(`${this.baseURL}/?X-Plex-Token=${this.token}`);
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            success: true,
                            server: data.MediaContainer?.size ? 'Connected' : 'No Content',
                            serverName: data.MediaContainer?.friendlyName || 'Unknown'
                        };
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                } catch (error) {
                    console.error('Plex connection test failed:', error);
                    return { success: false, error: error.message };
                }
            },
            
            // Get all libraries from Plex server
            async getLibraries() {
                try {
                    const response = await fetch(`${this.baseURL}/library/sections?X-Plex-Token=${this.token}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    return data.MediaContainer?.Directory || [];
                } catch (error) {
                    console.error('Failed to fetch libraries:', error);
                    throw error;
                }
            },
            
            // Get content from a specific library
            async getLibraryContent(sectionId, limit = 50) {
                try {
                    const response = await fetch(`${this.baseURL}/library/sections/${sectionId}/all?X-Plex-Token=${this.token}&limit=${limit}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    return data.MediaContainer?.Metadata || [];
                } catch (error) {
                    console.error(`Failed to fetch content for section ${sectionId}:`, error);
                    throw error;
                }
            },
            
            // Search for specific content
            async searchContent(query, sectionId = null) {
                try {
                    let searchUrl = `${this.baseURL}/search?X-Plex-Token=${this.token}&query=${encodeURIComponent(query)}`;
                    if (sectionId) searchUrl += `&section=${sectionId}`;
                    
                    const response = await fetch(searchUrl);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    return data.MediaContainer?.Metadata || [];
                } catch (error) {
                    console.error('Failed to search content:', error);
                    throw error;
                }
            },
            
            // Get detailed information about a specific media item
            async getMediaInfo(ratingKey) {
                try {
                    const response = await fetch(`${this.baseURL}/library/metadata/${ratingKey}?X-Plex-Token=${this.token}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    return data.MediaContainer?.Metadata?.[0];
                } catch (error) {
                    console.error(`Failed to fetch media info for ${ratingKey}:`, error);
                    throw error;
                }
            },
            
            // Get Plex server status
            async getServerStatus() {
                try {
                    const response = await fetch(`${this.baseURL}/updater/landing?X-Plex-Token=${this.token}`);
                    const data = await response.json();
                    
                    return {
                        status: 'online',
                        updated: data.MediaContainer?.Status,
                        message: 'Plex server is online and responding'
                    };
                } catch (error) {
                    return {
                        status: 'offline',
                        message: 'Plex server is not responding',
                        error: error.message
                    };
                }
            },
            
            // Check if a content item requires authentication (adult content)
            async checkAdultContent(ratingKey) {
                try {
                    const mediaInfo = await this.getMediaInfo(ratingKey);
                    return {
                        isAdult: mediaInfo?.contentRating?.includes('18') || 
                               mediaInfo?.contentRating?.includes('XXX') ||
                               mediaInfo?.contentRating?.includes('X'),
                        contentRating: mediaInfo?.contentRating,
                        ratingKey: ratingKey
                    };
                } catch (error) {
                    console.error('Failed to check adult content:', error);
                    return { isAdult: false, error: error.message };
                }
            }
        };
        
        // Enhanced Plex Library Management
        const plexLibraryManager = {
            // Get Plex configuration from local storage
            getPlexConfig() {
                const config = localStorage.getItem('plexConfig');
                return config ? JSON.parse(config) : {
                    servers: [],
                    activeServer: null
                };
            },
            
            // Save Plex configuration
            savePlexConfig(config) {
                localStorage.setItem('plexConfig', JSON.stringify(config));
            },
            
            // Add a new Plex server
            async addPlexServer(serverName, serverUrl, token, isAdult = false) {
                try {
                    // Test connection first
                    plexAPIClient.init(serverUrl, token);
                    const connectionTest = await plexAPIClient.testConnection();
                    
                    if (!connectionTest.success) {
                        throw new Error(`Connection failed: ${connectionTest.error}`);
                    }
                    
                    const config = this.getPlexConfig();
                    const newServer = {
                        id: Date.now().toString(),
                        name: serverName,
                        url: serverUrl,
                        token: token,
                        isAdult: isAdult,
                        connected: true,
                        serverInfo: {
                            name: connectionTest.serverName || serverName,
                            connected: connectionTest.server
                        },
                        libraries: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    config.servers.push(newServer);
                    if (!config.activeServer) config.activeServer = newServer.id;
                    
                    this.savePlexConfig(config);
                    
                    // Fetch libraries immediately
                    await this.refreshLibraries(newServer.id);
                    
                    console.log('‚úÖ Plex server added successfully');
                    return { success: true, server: newServer };
                } catch (error) {
                    console.error('Failed to add Plex server:', error);
                    return { success: false, error: error.message };
                }
            },
            
            // Remove a Plex server
            removePlexServer(serverId) {
                const config = this.getPlexConfig();
                config.servers = config.servers.filter(s => s.id !== serverId);
                
                if (config.activeServer === serverId) {
                    config.activeServer = config.servers.length > 0 ? config.servers[0].id : null;
                }
                
                this.savePlexConfig(config);
                return { success: true };
            },
            
            // Set active server
            setActiveServer(serverId) {
                const config = this.getPlexConfig();
                config.activeServer = serverId;
                this.savePlexConfig(config);
                
                // Update API client
                const server = config.servers.find(s => s.id === serverId);
                if (server) {
                    plexAPIClient.init(server.url, server.token);
                }
                
                return { success: true };
            },
            
            // Refresh libraries from a server
            async refreshLibraries(serverId) {
                try {
                    const config = this.getPlexConfig();
                    const server = config.servers.find(s => s.id === serverId);
                    
                    if (!server) throw new Error('Server not found');
                    
                    // Update API client
                    plexAPIClient.init(server.url, server.token);
                    
                    // Fetch libraries
                    const libraries = await plexAPIClient.getLibraries();
                    server.libraries = libraries.map(lib => ({
                        id: lib.key,
                        name: lib.title,
                        type: lib.type,
                        isAdult: server.isAdult,
                        contentCount: lib.childCount || 0,
                        path: lib.key
                    }));
                    
                    // Update library content for each library
                    for (const lib of server.libraries) {
                        try {
                            const content = await plexAPIClient.getLibraryContent(lib.id, 20);
                            lib.recentContent = content.map(item => ({
                                ratingKey: item.ratingKey,
                                title: item.title,
                                year: item.year,
                                thumb: item.thumb,
                                type: item.type,
                                duration: item.duration,
                                isAdult: this.checkContentRating(item)
                            }));
                        } catch (error) {
                            console.warn(`Failed to fetch content for library ${lib.name}:`, error);
                            lib.recentContent = [];
                        }
                    }
                    
                    this.savePlexConfig(config);
                    console.log('‚úÖ Libraries refreshed successfully');
                    return { success: true, libraries: server.libraries };
                } catch (error) {
                    console.error('Failed to refresh libraries:', error);
                    return { success: false, error: error.message };
                }
            },
            
            // Check if content is adult based on rating
            checkContentRating(mediaItem) {
                const rating = mediaItem.contentRating;
                return rating && (rating.includes('18') || rating.includes('XXX') || rating.includes('X'));
            },
            
            // Get all libraries from all servers
            getAllLibraries() {
                const config = this.getPlexConfig();
                const allLibraries = [];
                
                config.servers.forEach(server => {
                    if (server.libraries) {
                        server.libraries.forEach(lib => {
                            allLibraries.push({
                                ...lib,
                                serverId: server.id,
                                serverName: server.name,
                                serverUrl: server.url
                            });
                        });
                    }
                });
                
                return allLibraries;
            },
            
            // Get libraries filtered by adult content preference
            getLibrariesByAdultPreference(includeAdult = false) {
                const allLibraries = this.getAllLibraries();
                
                if (!includeAdult) {
                    return allLibraries.filter(lib => !lib.isAdult);
                }
                
                return allLibraries;
            }
        };
        
        // Package to Plex Library Mapping
        const packageLibraryMapper = {
            // Map package to Plex libraries
            mapPackageToLibraries(packageId, libraryIds) {
                const mappings = this.getAllMappings();
                mappings[packageId] = libraryIds;
                localStorage.setItem('packageLibraryMappings', JSON.stringify(mappings));
                return { success: true };
            },
            
            // Get libraries mapped to a package
            getLibrariesForPackage(packageId) {
                const mappings = this.getAllMappings();
                return mappings[packageId] || [];
            },
            
            // Get all mappings
            getAllMappings() {
                const mappings = localStorage.getItem('packageLibraryMappings');
                return mappings ? JSON.parse(mappings) : {};
            },
            
            // Remove library from all package mappings
            removeLibraryFromAllMappings(libraryId) {
                const mappings = this.getAllMappings();
                Object.keys(mappings).forEach(packageId => {
                    mappings[packageId] = mappings[packageId].filter(id => id !== libraryId);
                });
                localStorage.setItem('packageLibraryMappings', JSON.stringify(mappings));
            }
        };
        
        // Sync Plex libraries with admin panel content library
        function syncPlexWithContentLibrary() {
            if (!window.contentLibrary) window.contentLibrary = {};
            if (!window.contentLibrary.plex) window.contentLibrary.plex = [];
            
            const allLibraries = plexLibraryManager.getAllLibraries();
            
            // Clear existing Plex entries
            window.contentLibrary.plex = [];
            
            // Add each library from Plex servers
            allLibraries.forEach(lib => {
                const plexEntry = {
                    name: `${lib.serverName} - ${lib.name}`,
                    url: `${lib.serverUrl}/library/sections/${lib.id}`,
                    type: lib.type,
                    isAdult: lib.isAdult,
                    serverInfo: {
                        serverId: lib.serverId,
                        serverName: lib.serverName,
                        serverUrl: lib.serverUrl,
                        libraryId: lib.id,
                        libraryName: lib.name,
                        contentCount: lib.contentCount
                    },
                    status: 'Active',
                    lastUpdated: new Date().toISOString()
                };
                
                window.contentLibrary.plex.push(plexEntry);
            });
            
            saveContentLibrary();
            console.log('‚úÖ Plex libraries synced with content library');
        }
        
        let isLoggedIn = false;
        let currentUser = null;
        
        function showLogin() {
            const overlay = document.getElementById('adminOverlay');
            const modal = document.getElementById('loginModal');
            overlay.style.display = 'flex';
            modal.style.display = 'block';
            document.getElementById('adminUsername').focus();
        }
        
        function hideLogin() {
            document.getElementById('adminOverlay').style.display = 'none';
            document.getElementById('loginModal').style.display = 'none';
        }
        
        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            const user = passwordManager.authenticateUser(username, password);
            if (user) {
                isLoggedIn = true;
                currentUser = user;
                hideLogin();
                showSuccess(`Login successful! Welcome ${user.role === 'admin' ? 'Admin' : 'Master'} ${user.username}`);
            } else {
                showError('Invalid credentials');
                document.getElementById('adminPassword').value = '';
            }
        }
        
        function logout() {
            isLoggedIn = false;
            currentUser = null;
            showLogin();
        }
        
        function changeAdminPassword() {
            const currentPassword = prompt('Enter current admin password:');
            if (!currentPassword) return;
            
            const newPassword = prompt('Enter new admin password:');
            if (!newPassword || newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            const confirmPassword = prompt('Confirm new password:');
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            const result = passwordManager.changeAdminPassword(currentPassword, newPassword);
            if (result.success) {
                showSuccess(result.message);
            } else {
                showError(result.message);
            }
        }
        
        function changeMasterPassword() {
            const currentPassword = prompt('Enter current master password:');
            if (!currentPassword) return;
            
            const newPassword = prompt('Enter new master password:');
            if (!newPassword || newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            const confirmPassword = prompt('Confirm new master password:');
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            const result = passwordManager.changeMasterPassword(currentPassword, newPassword);
            if (result.success) {
                showSuccess(result.message);
            } else {
                showError(result.message);
            }
        }
        
        function createReseller() {
            // Get next available panel automatically
            const assignedPanel = getNextAvailablePanel();
            if (!assignedPanel) {
                showError('All 12 reseller panels are already assigned. Please remove a reseller first.');
                return;
            }
            
            const resellerId = `reseller_${assignedPanel}`;
            console.log(`üîß Auto-assigning reseller to Panel #${assignedPanel} (${resellerId})`);
            
            const username = prompt(`Creating reseller for Panel #${assignedPanel}\n\nEnter reseller username:`);
            if (!username) return;
            
            const password = prompt('Enter reseller password (min 6 characters):');
            if (!password) return;
            
            const result = passwordManager.createReseller(resellerId, username, password);
            if (result.success) {
                // Set panel assignment
                localStorage.setItem(`reseller_${resellerId}_panel`, assignedPanel);
                localStorage.setItem(`reseller_${assignedPanel}_assigned`, 'true');
                
                console.log(`‚úÖ Reseller ${resellerId} assigned to Panel #${assignedPanel}`);
                showSuccess(result.message);
                
                // Show access instructions with panel info
                setTimeout(() => {
                    showResellerAccessInstructions(resellerId, username, password, assignedPanel);
                }, 1500);
                
                showCreditSection(); // Refresh the credit section
                showResellersSection(); // Refresh the reseller list
            } else {
                showError(result.message);
            }
        }

        function getNextAvailablePanel() {
            for (let i = 1; i <= 12; i++) {
                const panelNum = String(i).padStart(3, '0');
                const resellerId = `reseller_${panelNum}`;
                
                if (!passwordManager.resellerCredentials[resellerId]) {
                    console.log(`üìã Found available panel: #${panelNum}`);
                    return panelNum;
                }
            }
            console.log('‚ùå No available panels found (001-012 all assigned)');
            return null; // All panels assigned
        }

        function showPanelAssignments() {
            const assignments = [];
            
            for (let i = 1; i <= 12; i++) {
                const panelNum = String(i).padStart(3, '0');
                const resellerId = `reseller_${panelNum}`;
                const assignedPanel = localStorage.getItem(`reseller_${resellerId}_panel`);
                
                if (passwordManager.resellerCredentials[resellerId]) {
                    const reseller = passwordManager.resellerCredentials[resellerId];
                    assignments.push(`Panel #${panelNum}: ${reseller.username} (${resellerId})`);
                } else {
                    assignments.push(`Panel #${panelNum}: AVAILABLE`);
                }
            }
            
            alert(`üìä PANEL ASSIGNMENTS STATUS\n\n${assignments.join('\n')}\n\nTotal: 12 panels (${assignments.filter(a => a.includes('AVAILABLE')).length} available)`);
        }

        function validatePanelAssignments() {
            console.log('üîç Validating panel assignments...');
            const resellers = passwordManager.getAllResellers();
            const assignments = [];
            
            resellers.forEach(resellerId => {
                const assignedPanel = localStorage.getItem(`reseller_${resellerId}_panel`);
                if (assignedPanel) {
                    assignments.push({ resellerId, assignedPanel });
                    console.log(`‚úÖ ${resellerId} ‚Üí Panel #${assignedPanel}`);
                } else {
                    console.log(`‚ùå ${resellerId} ‚Üí NO PANEL ASSIGNED`);
                }
            });
            
            return assignments;
        }

        function showResellerAccessInstructions(resellerId, username, password, assignedPanel) {
            const panelFile = `reseller_${assignedPanel}_panel.html`;
            const instructions = `
üéØ RESELLER ACCESS INSTRUCTIONS

üìã NEW RESELLER DETAILS:
‚Ä¢ Reseller ID: ${resellerId}
‚Ä¢ Username: ${username}
‚Ä¢ Password: ${password}
‚Ä¢ Assigned Panel: #${assignedPanel}
‚Ä¢ Panel File: ${panelFile}

üåê ACCESS YOUR PANEL:
‚Ä¢ Open: ${panelFile} (in your file browser)
‚Ä¢ Login with credentials above
‚Ä¢ Each panel works independently

‚úÖ FEATURES AVAILABLE:
‚Ä¢ Full customer management
‚Ä¢ Device selection (Basic TV, 2nd TV, 3rd TV)
‚Ä¢ Business rules validation
‚Ä¢ Automatic pricing calculation
‚Ä¢ Credit tracking
‚Ä¢ Package & add-on management

üìû IMPORTANT:
‚Ä¢ Your panel is unique to you (Panel #${assignedPanel})
‚Ä¢ Only you have access to your customer data
‚Ä¢ Admin manages all packages centrally

üîß ADMIN ACCESS:
‚Ä¢ Panel: admin_panel.html
‚Ä¢ Login: admin / [admin password]
‚Ä¢ Can change your credentials anytime

Press OK to close this window.
`;
            
            alert(instructions);
        }
        
        function showResellerAccessInstructions(resellerId, username, password) {
            const panelFile = `${resellerId}_panel.html`;
            const instructions = `
üéØ RESELLER ACCESS INSTRUCTIONS

üìã NEW RESELLER DETAILS:
‚Ä¢ Reseller ID: ${resellerId}
‚Ä¢ Username: ${username}
‚Ä¢ Password: ${password}
‚Ä¢ Panel File: ${panelFile}

üåê ACCESS PANEL:
‚Ä¢ Open: ${panelFile}
‚Ä¢ Login with the credentials above

‚úÖ FEATURES INCLUDED:
‚Ä¢ Full customer management
‚Ä¢ Device selection (Basic TV, 2nd TV, 3rd TV)
‚Ä¢ Business rules validation
‚Ä¢ Automatic pricing calculation
‚Ä¢ Credit tracking
‚Ä¢ Package & add-on management
‚Ä¢ Connected to admin system for packages/prices

üìû NEXT STEPS:
1. Share credentials with your reseller
2. Reseller opens ${panelFile}
3. Login with provided username/password
4. Start managing customers immediately!

üîó Your panel is ready: ${panelFile}
            `;
            
            alert(instructions);
            
            // Also update the reseller credentials section
            updateResellerCredentialsDisplay();
        }
        
        function showResellerCredentials() {
            const resellers = passwordManager.getAllResellers();
            let info = 'üîê RESELLER CREDENTIALS & ACCESS GUIDE\n\n';
            info += 'üåê RESELLER PANEL ACCESS:\n';
            info += 'File: reseller_panel_fixed.html\n\n';
            info += 'üë§ ADMIN ACCESS:\n';
            info += 'Admin Login: admin / [current admin password]\n\n';
            info += 'üìã EXISTING RESELLERS:\n';
            
            resellers.forEach(resellerId => {
                const reseller = passwordManager.resellerCredentials[resellerId];
                info += `\n${resellerId}:\n`;
                info += `  Username: ${reseller.username}\n`;
                info += `  Password: ${reseller.password}\n`;
                info += `  Created: ${new Date(reseller.createdAt).toLocaleDateString()}\n`;
                info += `  Panel: ${resellerId}_panel.html\n`;
            });
            
            info += '\nüìù INSTRUCTIONS FOR RESELLERS:\n';
            info += '1. Open your specific panel file (e.g., reseller_001_panel.html)\n';
            info += '2. Login with provided credentials\n';
            info += '3. Access all features including device selection\n';
            info += '4. Manage customers and track credits\n';
            
            alert(info);
        }
        
        function updateResellerCredentialsDisplay() {
            // This function can be expanded to update a dedicated UI section
            // showing all reseller information and access details
            const resellers = passwordManager.getAllResellers();
            if (resellers.length > 0) {
                showResellerCredentials();
            }
        }
        
        function manageResellerCredentials() {
            const resellers = passwordManager.getAllResellers();
            if (resellers.length === 0) {
                showError('No resellers found. Create a reseller first.');
                return;
            }
            
            let options = 'Select reseller to manage:\n';
            resellers.forEach((resellerId, index) => {
                options += `${index + 1}. ${resellerId}\n`;
            });
            
            const choice = prompt(options + '\nEnter number (or Cancel):');
            if (!choice) return;
            
            const index = parseInt(choice) - 1;
            if (index < 0 || index >= resellers.length) {
                showError('Invalid selection');
                return;
            }
            
            const resellerId = resellers[index];
            const reseller = passwordManager.resellerCredentials[resellerId];
            
            const choice2 = prompt(`\nWhat do you want to do with ${resellerId}?\n1. Update Username\n2. Update Password\n3. Reset Both\n4. Delete Reseller\n\nEnter choice (1-4):`);
            
            if (!choice2) return;
            
            switch(choice2) {
                case '1':
                    const newUsername = prompt(`Current username: ${reseller.username}\nEnter new username:`);
                    if (newUsername && newUsername.trim()) {
                        reseller.username = newUsername.trim();
                        passwordManager.saveCredentials();
                        showSuccess(`Username updated for ${resellerId}`);
                    }
                    break;
                    
                case '2':
                    const newPassword = prompt(`Enter new password for ${reseller.username}:`);
                    if (newPassword && newPassword.length >= 6) {
                        reseller.password = newPassword;
                        passwordManager.saveCredentials();
                        showSuccess(`Password updated for ${resellerId}`);
                    } else {
                        showError('Password must be at least 6 characters');
                    }
                    break;
                    
                case '3':
                    const username = prompt(`Current username: ${reseller.username}\nEnter new username:`);
                    const password = prompt(`Enter new password for ${username}:`);
                    if (username && password && password.length >= 6) {
                        reseller.username = username.trim();
                        reseller.password = password;
                        passwordManager.saveCredentials();
                        showSuccess(`Credentials updated for ${resellerId}`);
                    } else {
                        showError('Invalid username or password too short');
                    }
                    break;
                    
                case '4':
                    const confirm = prompt(`Are you sure you want to delete ${resellerId}? This cannot be undone.\nType 'YES' to confirm:`);
                    if (confirm === 'YES') {
                        delete passwordManager.resellerCredentials[resellerId];
                        passwordManager.saveCredentials();
                        showSuccess(`Reseller ${resellerId} deleted`);
                    }
                    break;
                    
                default:
                    showError('Invalid choice');
            }
        }
        
        function showSuccess(message) {
            showNotification(message, 'success');
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transition: all 0.3s ease;
                ${type === 'success' ? 'background: #4caf50;' : 'background: #f44336;'}
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --accent-blue: #667eea;
            --accent-purple: #764ba2;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --focus-color: #667eea;
            --admin-color: #4caf50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .admin-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 100vh;
        }

        .admin-sidebar {
            background: rgba(0, 0, 0, 0.8);
            padding: 30px 20px;
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
        }

        .admin-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .admin-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--admin-color), #66bb6a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            margin: 0 auto 15px;
            box-shadow: 0 15px 35px rgba(76, 175, 80, 0.4);
        }

        .admin-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--admin-color);
            margin-bottom: 5px;
        }

        .admin-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .admin-nav {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-btn {
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
        }

        .nav-btn:hover {
            background: rgba(76, 175, 80, 0.2);
            border-color: var(--admin-color);
            transform: translateX(5px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--admin-color), #66bb6a);
            border-color: transparent;
            color: white;
        }

        .nav-icon {
            font-size: 18px;
        }

        .admin-main {
            padding: 40px;
            overflow-y: auto;
        }

        .dashboard-header {
            margin-bottom: 40px;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stat-icon.users {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-icon.revenue {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
        }

        .stat-icon.content {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        .stat-icon.system {
            background: linear-gradient(135deg, #9c27b0, #ba68c8);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .section-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(20px);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--admin-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Content Management Styles */
        .content-tab {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .content-tab.active {
            color: var(--admin-color);
            border-bottom-color: var(--admin-color);
        }

        .content-tab:hover {
            color: rgba(255,255,255,0.9);
        }

        .content-tab-content {
            animation: fadeIn 0.3s ease;
        }

        .content-item {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .content-item:hover {
            background: rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .content-thumbnail {
            flex-shrink: 0;
        }

        .content-details {
            flex: 1;
            min-width: 0;
        }

        .content-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .content-meta {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }

        .content-url {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .content-description {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            margin-top: 4px;
            line-height: 1.3;
        }

        .content-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-icon {
            font-size: 1.8rem;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--admin-color), #66bb6a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-details h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-details p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .user-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
        }

        .status-expiring {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-expired {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error-color);
        }

        .action-btn {
            background: var(--admin-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #66bb6a;
            transform: scale(1.05);
        }

        /* Delete button styling */
        .action-btn-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn-delete:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .content-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .content-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
        }

        .content-thumbnail {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .content-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .content-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--admin-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-btn:hover {
            background: #66bb6a;
            transform: scale(1.05);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--admin-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #66bb6a;
        }

        /* Mobile App Specific Styles */
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Hide scrollbars but keep functionality */
        ::-webkit-scrollbar {
            display: none;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* App-like container */
        .app-container {
            max-width: 100vw;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            position: relative;
        }

        /* Standalone app look */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            * {
                box-sizing: border-box;
            }

            body {
                margin: 0;
                padding: 0;
                font-size: 14px;
            }

            /* Fix admin-container grid layout for mobile */
            .admin-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .admin-sidebar {
                padding: 15px;
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
                max-height: auto;
                overflow: visible;
            }

            .admin-header {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }

            .container {
                padding: 10px;
            }

            .tabs {
                flex-direction: column;
                gap: 0;
            }

            .tab {
                padding: 12px 15px;
                font-size: 13px;
                border-radius: 0;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                border-right: none;
            }

            .tab.active {
                border-bottom: 1px solid #4caf50;
                background: rgba(76, 175, 80, 0.1);
            }

            .tab-content {
                margin-top: 0;
                padding: 15px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 15px;
            }

            .header-info {
                font-size: 13px;
            }

            .header-buttons {
                width: 100%;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .header-buttons button {
                padding: 8px 12px;
                font-size: 12px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 5px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px;
                font-size: 14px;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .form-row .form-group {
                width: 100%;
            }

            button {
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 6px;
            }

            /* Mobile user list styling */
            .user-item {
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 8px;
                background: rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.1);
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .user-info {
                display: flex;
                gap: 12px;
                align-items: flex-start;
            }

            .user-avatar {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                background: #4caf50;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 16px;
                flex-shrink: 0;
            }

            .user-details {
                flex: 1;
                min-width: 0;
            }

            .user-details h4 {
                color: white;
                margin: 0 0 5px 0;
                font-size: 16px;
                font-weight: 600;
                word-wrap: break-word;
            }

            .user-details p {
                color: rgba(255,255,255,0.7);
                margin: 0;
                font-size: 13px;
                line-height: 1.4;
            }

            .user-status {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                margin-bottom: 10px;
                width: fit-content;
            }

            .status-active {
                background: rgba(76, 175, 80, 0.2);
                color: #4caf50;
            }

            .status-expiring {
                background: rgba(255, 193, 7, 0.2);
                color: #ffc107;
            }

            .status-expired {
                background: rgba(244, 67, 54, 0.2);
                color: #f44336;
            }

            .action-btn {
                background: rgba(255,255,255,0.1);
                border: 1px solid rgba(255,255,255,0.2);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 11px;
                margin-right: 5px;
                margin-bottom: 5px;
                transition: all 0.2s;
            }

            .action-btn:hover {
                background: rgba(255,255,255,0.2);
                transform: translateY(-1px);
            }

            table {
                font-size: 12px;
                overflow-x: auto;
                display: block;
            }

            table thead {
                display: none;
            }

            table tbody,
            table tr,
            table td {
                display: block;
                width: 100%;
            }

            table tr {
                border: 1px solid rgba(255,255,255,0.1);
                margin-bottom: 15px;
                border-radius: 8px;
                padding: 10px;
                background: rgba(255,255,255,0.05);
            }

            table td {
                border: none;
                padding: 8px 0;
                text-align: left;
            }

            table td:before {
                content: attr(data-label) ": ";
                font-weight: bold;
                color: #4caf50;
            }

            .actions {
                display: flex;
                gap: 5px;
                margin-top: 10px;
                flex-wrap: wrap;
            }

            .actions button {
                padding: 6px 10px;
                font-size: 11px;
                flex: 1;
                min-width: 0;
            }

            .modal {
                padding: 10px;
                margin: 0;
                height: 100vh;
                width: 100vw;
                border-radius: 0;
                overflow-y: auto;
            }

            .modal-content {
                width: 100%;
                max-width: none;
                margin: 0;
                padding: 15px;
                border-radius: 0;
                min-height: 100vh;
            }

            .modal-header h2 {
                font-size: 18px;
                margin-bottom: 10px;
            }

            .price-display {
                padding: 15px;
                font-size: 16px;
            }

            .section-title {
                font-size: 16px;
                margin-bottom: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 11px;
            }

            .device-options,
            .addon-list {
                padding: 10px;
            }

            .device-option,
            .addon-item {
                padding: 10px;
                font-size: 13px;
            }

            /* Better touch targets for mobile */
            input[type="checkbox"],
            input[type="radio"] {
                min-width: 18px;
                min-height: 18px;
            }

            select {
                padding: 12px 8px;
            }

            /* Fix modal button positioning on mobile */
            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .modal-buttons button {
                width: 100%;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            /* Even better mobile handling */
            .admin-sidebar {
                padding: 10px;
            }

            .admin-header h1 {
                font-size: 18px;
            }

            .tab {
                padding: 10px 12px;
                font-size: 12px;
            }

            .header-buttons button {
                padding: 6px 8px;
                font-size: 11px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 10px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            button {
                padding: 14px 16px;
                font-size: 15px;
            }

            .user-item {
                padding: 12px;
            }

            .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .user-details h4 {
                font-size: 15px;
            }

            .action-btn {
                padding: 10px 12px;
                font-size: 12px;
            }
        }

        /* Landscape mobile optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            .modal {
                padding: 5px;
            }

            .modal-content {
                padding: 10px;
            }

            .form-row {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <button class="back-btn" onclick="window.location.href='CLIENT_INTERFACE.html'">‚Üê Back to Client</button>
        
        <div class="admin-container">
        <div class="admin-sidebar">
            <div class="admin-header">
                <div class="admin-logo">üîß</div>
                <div class="admin-title">Admin Panel</div>
                <div class="admin-subtitle">System Management</div>
            </div>
            
            <ul class="admin-nav">
                <li class="nav-item">
                    <button class="nav-btn active" onclick="showSection('dashboard')">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="showSection('users')">
                        <span class="nav-icon">üë•</span>
                        User Management
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="showSection('content')">
                        <span class="nav-icon">CONTENT</span>
                        Content Management
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="showSection('packages')">
                        <span class="nav-icon">üì¶</span>
                        Package Management
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="showSection('resellers')">
                        <span class="nav-icon">üè¢</span>
                        Reseller Management
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="showSection('credit')">
                        <span class="nav-icon">üí≥</span>
                        Credit Manager
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="showSection('analytics')">
                        <span class="nav-icon">üìà</span>
                        Analytics
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="showSection('settings')">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        System Settings
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="changeAdminPassword()">
                        <span class="nav-icon">üîê</span>
                        Change Password
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" onclick="showSection('logs')">
                        <span class="nav-icon">üìã</span>
                        System Logs
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="admin-main">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Admin Dashboard</h1>
                <p class="dashboard-subtitle">Complete system overview and management</p>
            </div>
            
            <!-- Dashboard Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon users">üë•</div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon revenue">üí∞</div>
                    <div class="stat-value">$0</div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon content">CONTENT</div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Content Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon system">üñ•Ô∏è</div>
                    <div class="stat-value">99.9%</div>
                    <div class="stat-label">System Uptime</div>
                </div>
            </div>
            
            <!-- Dynamic Content Sections -->
            <div id="dashboard-section" class="section-grid">
                <!-- Users Section -->
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="section-title" style="margin: 0;">
                            <span class="section-icon">üë•</span>
                            Recent Users
                        </h3>
                        <button onclick="showSection('users'); showUsersSection();" style="background: linear-gradient(135deg, #2196f3, #42a5f5); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">View All</button>
                    </div>
                    <div class="user-list" id="dashboard-users">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 10px;">üë•</div>
                            <div>No users found.</div>
                            <button onclick="showSection('users'); showUsersSection();" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px;">‚ûï Add Customers</button>
                        </div>
                    </div>
                </div>
                
                <!-- Content Section -->
                <div class="section-card">
                    <h3 class="section-title">
                        <span class="section-icon">CONTENT</span>
                        Popular Content
                    </h3>
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">No content available. Add content to get started.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showSection(section) {
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all sections
            const allSections = document.querySelectorAll('.section-card');
            allSections.forEach(sec => {
                sec.style.display = 'none';
            });
            
            // Show specific sections based on selection
            const dashboardSection = document.getElementById('dashboard-section');
            
            switch(section) {
                case 'dashboard':
                    dashboardSection.style.display = 'grid';
                    initializeAdminCustomers(); // Ensure fresh data
                    updateDashboardUsers(); // Load customers to dashboard
                    break;
                case 'users':
                    showUsersSection();
                    break;
                case 'content':
                    showContentSection();
                    break;
                case 'packages':
                    showPackagesSection();
                    break;
                case 'resellers':
                    showResellersSection();
                    break;
                case 'analytics':
                    showAnalyticsSection();
                    break;
                case 'settings':
                    showSettingsSection();
                    break;
                case 'credit':
                    showCreditSection();
                    break;
                case 'logs':
                    showLogsSection();
                    break;
            }
        }
        
        function refreshUsersDisplay() {
            // Force sync data first, then refresh display
            forceSyncCustomerData();
            // Refresh the users section if currently visible
            const currentSection = document.querySelector('.dashboard-title');
            if (currentSection && currentSection.textContent.includes('User Management')) {
                showUsersSection();
            }
        }

        function showUsersSection() {
            initializeAdminCustomers(); // Ensure fresh data
            const mainContent = document.querySelector('.admin-main');
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üë• User Management</h1>
                    <p class="dashboard-subtitle">Manage user accounts and subscriptions</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon users">üë•</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon users">‚úÖ</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Active Subscribers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon users">‚è∞</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Expiring Soon</div>
                    </div>
                </div>
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="section-title">User Accounts</h3>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
                            <button onclick="quickAddCustomers()" style="background: linear-gradient(135deg, #e91e63, #f06292); color: white; border: none; padding: 10px 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px;">‚ö° Quick Add</button>
                            <button onclick="addNewCustomer()" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; border: none; padding: 10px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px;">‚ûï Add New</button>
                        </div>
                    </div>
                    <div class="user-list">
                        ${generateUserList()}
                    </div>
                </div>
            `;
        }
        
        function loadContentLibrary() {
            try {
                const savedContent = localStorage.getItem('adminContentLibrary');
                if (savedContent) {
                    window.contentLibrary = JSON.parse(savedContent);
                    console.log('‚úÖ Content library loaded from localStorage');
                    return true;
                }
            } catch (e) {
                console.error('Error loading content library:', e);
            }
            return false;
        }
        
        // Adult Content Access System
        function initializeAdultContentAccess() {
            // Initialize showAdultContent as false on app start
            window.showAdultContent = false;
            window.adultAccessSession = false;
            
            // Check for existing session on page load (but auto-hide anyway for security)
            window.showAdultContent = false;
            
            // Add keyboard listener for 1818 sequence
            document.addEventListener('keydown', function(e) {
                const key = e.key;
                const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                
                if (allowedKeys.includes(key)) {
                    if (!window.keySequence) {
                        window.keySequence = '';
                    }
                    window.keySequence += key;
                    
                    // Keep only last 4 digits
                    if (window.keySequence.length > 4) {
                        window.keySequence = window.keySequence.slice(-4);
                    }
                    
                    // Check for 1818 sequence
                    if (window.keySequence === '1818') {
                        window.keySequence = ''; // Reset sequence
                        showAdultPasswordModal();
                        e.preventDefault();
                    }
                }
            });
        }
        
        function showAdultPasswordModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 10002; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 400px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üîê</div>
                    <h2 style="color: white; margin-bottom: 15px;">Adult Content Access</h2>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 25px; font-size: 14px;">Enter 6-digit password to access adult content</p>
                    
                    <form id="adultPasswordForm">
                        <div style="margin-bottom: 20px;">
                            <input type="password" id="adultPassword" maxlength="6" style="width: 200px; padding: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 20px; text-align: center; letter-spacing: 5px;" placeholder="------" autofocus>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="button" onclick="closeAdultPasswordModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ff5722, #ff7043); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Unlock</button>
                        </div>
                        
                        <div id="passwordError" style="color: #ff5722; margin-top: 15px; font-size: 14px; display: none;">‚ùå Invalid password</div>
                    </form>
                    
                    <div style="margin-top: 25px; padding: 15px; background: rgba(255,87,34,0.1); border-radius: 8px; border: 1px solid rgba(255,87,34,0.3);">
                        <p style="color: rgba(255,255,255,0.6); font-size: 12px; margin: 0;">
                            ‚ö†Ô∏è Adult content is restricted. This access will be automatically removed when the app is restarted.
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('adultPassword').focus();
            
            modal.querySelector('#adultPassword').addEventListener('input', function(e) {
                // Only allow numbers and limit to 6 digits
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 6) value = value.slice(0, 6);
                e.target.value = value;
            });
            
            modal.querySelector('#adultPasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('adultPassword').value;
                
                // Validate 6-digit password (you can change this to any 6-digit code)
                if (password === '123456') {
                    closeAdultPasswordModal();
                    accessAdultContent();
                } else {
                    const errorElement = document.getElementById('passwordError');
                    errorElement.style.display = 'block';
                    document.getElementById('adultPassword').style.borderColor = '#ff5722';
                    document.getElementById('adultPassword').value = '';
                    document.getElementById('adultPassword').focus();
                    
                    // Hide error after 3 seconds
                    setTimeout(() => {
                        errorElement.style.display = 'none';
                        document.getElementById('adultPassword').style.borderColor = 'rgba(255,255,255,0.2)';
                    }, 3000);
                }
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeAdultPasswordModal();
                }
            });
            
            // Handle escape key
            document.addEventListener('keydown', function escapeHandler(e) {
                if (e.key === 'Escape') {
                    closeAdultPasswordModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            });
        }
        
        function closeAdultPasswordModal() {
            const modal = document.querySelector('div[style*="z-index: 10002"]');
            if (modal) {
                modal.remove();
            }
            window.keySequence = ''; // Reset key sequence
        }
        
        function accessAdultContent() {
            window.showAdultContent = true;
            window.adultAccessSession = true;
            
            // Add exit adult mode button
            addExitAdultModeButton();
            
            // Refresh content to show adult content
            if (typeof showContentSection === 'function') {
                showContentSection();
            }
            
            // Show confirmation message
            showSuccess('üîì Adult content unlocked. Use "Exit Adult Mode" to hide content again.');
        }
        
        function addExitAdultModeButton() {
            // Remove existing exit button if any
            const existingButton = document.getElementById('exitAdultModeBtn');
            if (existingButton) {
                existingButton.remove();
            }
            
            // Add exit button to the content section header
            const contentHeader = document.querySelector('.dashboard-header, .content-header, .section-header');
            if (contentHeader) {
                const exitButton = document.createElement('button');
                exitButton.id = 'exitAdultModeBtn';
                exitButton.innerHTML = 'üîí Exit Adult Mode';
                exitButton.style.cssText = `
                    background: linear-gradient(135deg, #ff5722, #ff7043); 
                    color: white; 
                    border: none; 
                    padding: 8px 16px; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    font-size: 12px; 
                    font-weight: 600;
                    margin-left: 15px;
                    animation: pulse 2s infinite;
                `;
                
                exitButton.onclick = function() {
                    exitAdultMode();
                };
                
                // Add pulse animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.05); }
                        100% { transform: scale(1); }
                    }
                `;
                document.head.appendChild(style);
                
                contentHeader.appendChild(exitButton);
            }
        }
        
        function exitAdultMode() {
            window.showAdultContent = false;
            window.adultAccessSession = false;
            
            // Remove exit button
            const exitButton = document.getElementById('exitAdultModeBtn');
            if (exitButton) {
                exitButton.remove();
            }
            
            // Refresh content to hide adult content
            if (typeof showContentSection === 'function') {
                showContentSection();
            }
            
            showSuccess('üîí Adult content hidden. Enter 1818 + password to access again.');
        }
        
        function toggleAdultContent() {
            // Check if adult mode is active
            if (window.adultAccessSession) {
                window.showAdultContent = !window.showAdultContent;
                showContentSection(); // Refresh to apply filtering
            } else {
                showAdultPasswordModal();
            }
        }
        
        function showContentSection() {
            const mainContent = document.querySelector('.admin-main');
            
            // Load content library from localStorage or initialize with defaults
            if (!window.contentLibrary) {
                if (!loadContentLibrary()) {
                    // Initialize with defaults if no saved data
                    window.contentLibrary = {
                        channels: [],
                        basicChannels: [],
                        vod: [],
                        plex: [],
                        tvPlatforms: [
                            {
                                name: "IMDb TV",
                                logo: "tv_platform_icon.png",
                                category: "Streaming Platform",
                                compatiblePlatforms: "Android TV, LG WebOS, Samsung Tizen, Roku, iOS",
                                status: "Active",
                                description: "Free streaming service with movies and TV shows"
                            }
                        ]
                    };
                }
            }
            
            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon content">CONTENT</div>
                        <div class="stat-value">${window.contentLibrary.channels.length}</div>
                        <div class="stat-label">Live Channels</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon content">MOVIE</div>
                        <div class="stat-value">${window.contentLibrary.vod.length}</div>
                        <div class="stat-label">VOD Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon content">MOBILE</div>
                        <div class="stat-value">${window.contentLibrary.plex.length}</div>
                        <div class="stat-label">Plex Libraries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon content">DEVICES</div>
                        <div class="stat-value">${window.contentLibrary.tvPlatforms.length}</div>
                        <div class="stat-label">TV Platforms</div>
                    </div>
                </div>
            `;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Content Management</h1>
                    <p class="dashboard-subtitle">Manage streaming content and categories</p>
                </div>
                
                ${stats}
                
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="section-title">Content Library</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="addChannelModal()" style="background: #2196f3; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">Add Channel</button>
                            <button onclick="addBasicChannelModal()" style="background: #e91e63; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">Add Basic Channel</button>
                            <button onclick="addVODModal()" style="background: #ff9800; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">Add VOD</button>
                            <button onclick="addPlexModal()" style="background: #4caf50; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">Add Plex</button>
                            <button onclick="addTVPlatformModal()" style="background: #9c27b0; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">Add TV Platform</button>
                        </div>
                    </div>
                    
                    <!-- Content Tabs -->
                    <div style="display: flex; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px;">
                        <button onclick="showContentTab('channels')" id="channelsTab" class="content-tab active">Live Channels (${window.contentLibrary.channels.length})</button>
                        <button onclick="showContentTab('basicChannels')" id="basicChannelsTab" class="content-tab">üì∫ Basic Channels (${(window.contentLibrary.basicChannels || []).length})</button>
                        <button onclick="showContentTab('vod')" id="vodTab" class="content-tab">VOD Content (${window.contentLibrary.vod.length})</button>
                        <button onclick="showContentTab('plex')" id="plexTab" class="content-tab">Plex Libraries (${window.contentLibrary.plex.length})</button>
                        <button onclick="showContentTab('tvPlatforms')" id="tvPlatformsTab" class="content-tab">TV Platforms (${window.contentLibrary.tvPlatforms.length})</button>
                    </div>
                    
                    <!-- Channels Content -->
                    <div id="channelsContent" class="content-tab-content">
                        ${window.contentLibrary.channels.length === 0 ? 
                            '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No channels added yet. Click "Add Channel" to get started.</div>' :
                            window.contentLibrary.channels.map(channel => `
                                <div class="content-item">
                                    <div class="content-thumbnail">
                                        <img src="${channel.logo || ''}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #333; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                    </div>
                                    <div class="content-details">
                                        <div class="content-name">${channel.name}</div>
                                        <div class="content-meta">
                                            <span>${channel.category || 'General'}</span> ‚Ä¢ 
                                            <span>${channel.language || 'English'}</span> ‚Ä¢ 
                                            <span>${channel.status || 'Active'}</span>
                                        </div>
                                        <div class="content-url">${channel.url || 'No URL'}</div>
                                    </div>
                                    <div class="content-actions">
                                        <button onclick="editContent('channels', ${window.contentLibrary.channels.indexOf(channel)})" style="background: #2196f3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteContent('channels', ${window.contentLibrary.channels.indexOf(channel)})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                    
                    <!-- VOD Content -->
                    <div id="vodContent" class="content-tab-content" style="display: none;">
                        ${(window.contentLibrary.vod || []).filter(vod => !vod.isAdult || window.showAdultContent).length === 0 ? 
                            '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No public VOD content. Toggle "View Adult Content" to see all content.</div>' :
                            (window.contentLibrary.vod || []).filter(vod => !vod.isAdult || window.showAdultContent).map((vod, filteredIndex) => {
                                const originalIndex = window.contentLibrary.vod.indexOf(vod);
                                return `
                                <div class="content-item">
                                    <div class="content-thumbnail">
                                        <img src="${vod.thumbnail || ''}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #333; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                    </div>
                                    <div class="content-details">
                                        <div class="content-name">${vod.title}</div>
                                        <div class="content-meta">
                                            <span>${vod.category || 'Movie'}</span> ‚Ä¢ 
                                            <span>${vod.year || 'N/A'}</span> ‚Ä¢ 
                                            <span>${vod.duration || 'N/A'}</span> ‚Ä¢ 
                                            <span>${vod.status || 'Active'}</span>
                                        </div>
                                        <div class="content-url">${vod.url || 'No URL'}</div>
                                    </div>
                                    <div class="content-actions">
                                        <button onclick="editContent('vod', ${originalIndex})" style="background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteContent('vod', ${originalIndex})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                    
                    <!-- Plex Content -->
                    <div id="plexContent" class="content-tab-content" style="display: none;">
                        <!-- Adult Content Toggle -->
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                            <button onclick="toggleAdultContent()" id="adultToggleBtn" style="background: #ff5722; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                üîí ${window.showAdultContent && window.adultAccessSession ? 'Hide Adult Content' : 'View Adult Content'} (${window.contentLibrary.plex.filter(p => p.isAdult).length})
                            </button>
                            <span style="color: rgba(255,255,255,0.7); margin-left: 15px; font-size: 14px;">
                                Adult content is hidden by default. Click to toggle visibility.
                            </span>
                        </div>
                        
                        ${window.contentLibrary.plex.filter(plex => !plex.isAdult).length === 0 && window.contentLibrary.plex.filter(p => p.isAdult).length === 0 ?
                            '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No Plex libraries added yet. Click "Add Plex" to get started.</div>' :
                            window.contentLibrary.plex.filter(plex => !plex.isAdult).length === 0 ?
                                '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No public Plex libraries. Toggle "View Adult Content" to see all servers.</div>' :
                                window.contentLibrary.plex.filter(plex => !plex.isAdult).map(plex => `
                                <div class="content-item">
                                    <div class="content-thumbnail">
                                        <img src="${plex.logo || ''}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #333; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                    </div>
                                    <div class="content-details">
                                        <div class="content-name">${plex.name}</div>
                                        <div class="content-meta">
                                            <span>${plex.type || 'Library'}</span> ‚Ä¢ 
                                            <span>${plex.server || 'Unknown'}</span> ‚Ä¢ 
                                            <span>${plex.status || 'Active'}</span>
                                        </div>
                                        <div class="content-url">${plex.url || 'No URL'}</div>
                                    </div>
                                    <div class="content-actions">
                                        <button onclick="editContent('plex', ${window.contentLibrary.plex.indexOf(plex)})" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteContent('plex', ${window.contentLibrary.plex.indexOf(plex)})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </div>
                                </div>
                            `).join('')
                        }
                        
                        <!-- Protected Adult Content Section (Hidden by default) -->
                        <div id="adultPlexSection" style="display: none; margin-top: 30px; padding: 20px; background: rgba(255, 87, 34, 0.1); border: 2px solid #ff5722; border-radius: 10px;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="color: #ff5722; margin: 0;">üîí ADULT CONTENT SECTION</h3>
                                <p style="color: rgba(255,255,255,0.7); margin: 5px 0;">Protected Plex Libraries - Restricted Access</p>
                            </div>
                            
                            ${window.contentLibrary.plex.filter(plex => plex.isAdult).length === 0 ?
                                '<div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">No adult content Plex libraries.</div>' :
                                window.contentLibrary.plex.filter(plex => plex.isAdult).map(plex => `
                                <div class="content-item" style="border-left: 4px solid #ff5722;">
                                    <div class="content-thumbnail">
                                        <img src="${plex.logo || ''}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #333; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                    </div>
                                    <div class="content-details">
                                        <div class="content-name" style="color: #ff5722;">üîí ${plex.name} (ADULT)</div>
                                        <div class="content-meta">
                                            <span style="color: #ff5722; font-weight: 600;">${plex.type || 'Adult Library'}</span> ‚Ä¢ 
                                            <span>${plex.server || 'Unknown'}</span> ‚Ä¢ 
                                            <span>${plex.status || 'Active'}</span>
                                        </div>
                                        <div class="content-url">${plex.url || 'No URL'}</div>
                                    </div>
                                    <div class="content-actions">
                                        <button onclick="editContent('plex', ${window.contentLibrary.plex.indexOf(plex)})" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteContent('plex', ${window.contentLibrary.plex.indexOf(plex)})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </div>
                                </div>
                            `).join('')
                            }
                        </div>
                    </div>
                    
                    <!-- Basic Channels Content -->
                    <div id="basicChannelsContent" class="content-tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="section-title">üì∫ Basic Channels</h3>
                            <button onclick="addBasicChannelModal()" style="background: linear-gradient(135deg, #2196f3, #42a5f5); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ûï Add Channel</button>
                        </div>
                        <div id="basicChannelsList" class="content-grid">
                            ${(window.contentLibrary.basicChannels || []).filter(channel => !channel.isAdult || window.showAdultContent).length === 0 ? 
                                '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No public basic channels. Toggle "View Adult Content" to see all content.</div>' :
                                (window.contentLibrary.basicChannels || []).filter(channel => !channel.isAdult || window.showAdultContent).map((channel, filteredIndex) => {
                                    const originalIndex = (window.contentLibrary.basicChannels || []).indexOf(channel);
                                    return `
                                        <div class="content-item">
                                            <div class="content-thumbnail">
                                                <img src="${channel.logo || ''}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #333; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                            </div>
                                            <div class="content-details">
                                                <div class="content-name">${channel.name}</div>
                                                <div class="content-meta">
                                                    <span>${channel.category || 'Basic'}</span> ‚Ä¢ 
                                                    <span>${channel.number || 'N/A'}</span> ‚Ä¢ 
                                                    <span>${channel.status || 'Active'}</span>
                                                    ${channel.isAdult ? '<span> ‚Ä¢ üîû Adult</span>' : ''}
                                                </div>
                                                <div class="content-url">${channel.streamUrl || 'No URL'}</div>
                                            </div>
                                            <div class="content-actions">
                                                <button onclick="editContent('basicChannels', ${originalIndex})" style="background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                                <button onclick="deleteContent('basicChannels', ${originalIndex})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    </div>
                    
                    <!-- TV Platforms Content -->
                    <div id="tvPlatformsContent" class="content-tab-content" style="display: none;">
                        ${window.contentLibrary.tvPlatforms.length === 0 ? 
                            '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No TV platforms added yet. Click "Add TV Platform" to get started.</div>' :
                            window.contentLibrary.tvPlatforms.map(platform => `
                                <div class="content-item">
                                    <div class="content-thumbnail">
                                        <img src="${platform.logo || ''}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #333; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                    </div>
                                    <div class="content-details">
                                        <div class="content-name">${platform.name}</div>
                                        <div class="content-meta">
                                            <span>${platform.category || 'Streaming Platform'}</span> ‚Ä¢ 
                                            <span>${platform.compatiblePlatforms || 'Universal'}</span> ‚Ä¢ 
                                            <span>${platform.status || 'Active'}</span>
                                        </div>
                                        <div class="content-description">${platform.description || 'No description available'}</div>
                                    </div>
                                    <div class="content-actions">
                                        <button onclick="editContent('tvPlatforms', ${window.contentLibrary.tvPlatforms.indexOf(platform)})" style="background: #9c27b0; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Edit</button>
                                        <button onclick="deleteContent('tvPlatforms', ${window.contentLibrary.tvPlatforms.indexOf(platform)})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }
        
        // Content management functions
        function showContentTab(tab) {
            // Hide all content
            document.querySelectorAll('.content-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.content-tab').forEach(el => el.classList.remove('active'));
            
            // Show selected content
            document.getElementById(tab + 'Content').style.display = 'block';
            document.getElementById(tab + 'Tab').classList.add('active');
        }
        
        function addChannelModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 0; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px; height: 600px; display: flex; flex-direction: column;">
                    <div style="padding: 20px 40px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <h2 style="color: white; margin: 0; text-align: center;">Add Live Channel</h2>
                    </div>
                    
                    <div style="flex: 1; padding: 20px 40px; overflow-y: auto;">
                        <form id="addChannelForm" style="height: 100%;">
                            <div style="display: flex; flex-direction: column; height: 100%;">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Channel Name *</label>
                                        <input type="text" id="channelName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Stream URL *</label>
                                        <input type="url" id="channelUrl" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="http://example.com/stream.m3u8">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Category</label>
                                        <select id="channelCategory" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            <option value="News">News</option>
                                            <option value="Sports">Sports</option>
                                            <option value="Entertainment">Entertainment</option>
                                            <option value="Movies">Movies</option>
                                            <option value="Music">Music</option>
                                            <option value="Kids">Kids</option>
                                            <option value="Documentary">Documentary</option>
                                            <option value="General">General</option>
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Language</label>
                                        <select id="channelLanguage" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            <option value="English">English</option>
                                            <option value="Spanish">Spanish</option>
                                            <option value="French">French</option>
                                            <option value="German">German</option>
                                            <option value="Arabic">Arabic</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Logo URL (Optional)</label>
                                        <input type="url" id="channelLogo" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="http://example.com/logo.png">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                                        <select id="channelStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 20px;">
                                    <button type="button" onclick="closeModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                                    <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #2196f3, #42a5f5); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Add Channel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('channelName').focus();
            
            modal.querySelector('#addChannelForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newChannel = {
                    name: document.getElementById('channelName').value,
                    url: document.getElementById('channelUrl').value,
                    category: document.getElementById('channelCategory').value,
                    language: document.getElementById('channelLanguage').value,
                    logo: document.getElementById('channelLogo').value,
                    status: document.getElementById('channelStatus').value
                };
                
                window.contentLibrary.channels.push(newChannel);
                closeModal();
                showContentSection();
                showSuccess(`Channel "${newChannel.name}" added successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
        
        function addBasicChannelModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 0; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px; height: 650px; display: flex; flex-direction: column;">
                    <div style="padding: 20px 40px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <h2 style="color: white; margin: 0; text-align: center;">Add Basic Channel</h2>
                    </div>
                    
                    <div style="flex: 1; padding: 20px 40px; overflow-y: auto;">
                        <form id="addBasicChannelForm" style="height: 100%;">
                            <div style="display: flex; flex-direction: column; height: 100%;">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Channel Name *</label>
                                        <input type="text" id="basicChannelName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Stream URL *</label>
                                        <input type="url" id="basicChannelUrl" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="http://example.com/stream.m3u8">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Logo URL</label>
                                        <input type="url" id="basicChannelLogo" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="http://example.com/logo.png">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Category</label>
                                        <select id="basicChannelCategory" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            <option value="News">News</option>
                                            <option value="Sports">Sports</option>
                                            <option value="Entertainment">Entertainment</option>
                                            <option value="Movies">Movies</option>
                                            <option value="Music">Music</option>
                                            <option value="Kids">Kids</option>
                                            <option value="Documentary">Documentary</option>
                                            <option value="General">General</option>
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                                        <select id="basicChannelStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: flex; align-items: center; gap: 8px; color: white; font-weight: 500;">
                                            <input type="checkbox" id="basicChannelIsAdult" style="width: 16px; height: 16px; margin: 0;">
                                            <span>üîû Adult Content (requires password)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 20px;">
                                    <button type="button" onclick="closeModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                                    <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #e91e63, #f06292); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Add Basic Channel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('basicChannelName').focus();
            
            modal.querySelector('#addBasicChannelForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newChannel = {
                    name: document.getElementById('basicChannelName').value,
                    streamUrl: document.getElementById('basicChannelUrl').value,
                    logo: document.getElementById('basicChannelLogo').value,
                    category: document.getElementById('basicChannelCategory').value,
                    status: document.getElementById('basicChannelStatus').value,
                    isAdult: document.getElementById('basicChannelIsAdult').checked,
                    number: (window.contentLibrary.basicChannels?.length || 0) + 1
                };
                
                // Initialize array if not exists
                if (!window.contentLibrary.basicChannels) {
                    window.contentLibrary.basicChannels = [];
                }
                
                window.contentLibrary.basicChannels.push(newChannel);
                saveContentLibrary();
                closeModal();
                showContentSection();
                showSuccess(`Basic Channel "${newChannel.name}" added successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
        
        function addVODModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 0; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px; height: 600px; display: flex; flex-direction: column;">
                    <div style="padding: 20px 40px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <h2 style="color: white; margin: 0; text-align: center;">Add VOD Content</h2>
                    </div>
                    
                    <div style="flex: 1; padding: 20px 40px; overflow-y: auto;">
                        <form id="addVODForm" style="height: 100%;">
                            <div style="display: flex; flex-direction: column; height: 100%;">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Title *</label>
                                        <input type="text" id="vodTitle" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Content URL *</label>
                                        <input type="url" id="vodUrl" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="http://example.com/video.mp4">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Category</label>
                                        <select id="vodCategory" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            <option value="Movie">Movie</option>
                                            <option value="TV Series">TV Series</option>
                                            <option value="Documentary">Documentary</option>
                                            <option value="Sports">Sports</option>
                                            <option value="Kids">Kids</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Year</label>
                                        <input type="number" id="vodYear" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="2024">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Duration (minutes)</label>
                                        <input type="number" id="vodDuration" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="120">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Thumbnail URL (Optional)</label>
                                        <input type="url" id="vodThumbnail" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="http://example.com/thumbnail.jpg">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                                        <select id="vodStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: flex; align-items: center; color: white; font-weight: 500; cursor: pointer;">
                                            <input type="checkbox" id="vodIsAdult" style="margin-right: 10px; cursor: pointer;">
                                            Mark as Adult Content (18+)
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 20px;">
                                    <button type="button" onclick="closeModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                                    <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ff9800, #ffb74d); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Add VOD</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('vodTitle').focus();
            
            modal.querySelector('#addVODForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newVOD = {
                    title: document.getElementById('vodTitle').value,
                    url: document.getElementById('vodUrl').value,
                    category: document.getElementById('vodCategory').value,
                    year: document.getElementById('vodYear').value,
                    duration: document.getElementById('vodDuration').value,
                    thumbnail: document.getElementById('vodThumbnail').value,
                    status: document.getElementById('vodStatus').value,
                    isAdult: document.getElementById('vodIsAdult').checked
                };
                
                window.contentLibrary.vod.push(newVOD);
                closeModal();
                showContentSection();
                showSuccess(`VOD "${newVOD.title}" added successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
        
        function addPlexModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px;">
                    <h2 style="color: white; margin-bottom: 20px; text-align: center;">Add Plex Library</h2>
                    
                    <form id="addPlexForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Library Name *</label>
                            <input type="text" id="plexName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Plex URL *</label>
                            <input type="url" id="plexUrl" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="http://plex-server:32400">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Library Type</label>
                            <select id="plexType" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="Movies">Movies</option>
                                <option value="TV Shows">TV Shows</option>
                                <option value="Music">Music</option>
                                <option value="Photos">Photos</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Server Name</label>
                            <input type="text" id="plexServer" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="My Plex Server">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Token (Optional)</label>
                            <input type="text" id="plexToken" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="Plex authentication token">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                            <select id="plexStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; color: white; font-weight: 500; cursor: pointer;">
                                <input type="checkbox" id="plexIsAdult" style="margin-right: 10px; cursor: pointer;">
                                Mark as Adult Content (18+)
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button type="button" onclick="closeModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50, #66bb6a); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Add Plex</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('plexName').focus();
            
            modal.querySelector('#addPlexForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Connecting...';
                submitBtn.disabled = true;
                
                try {
                    const serverName = document.getElementById('plexServer').value;
                    const serverUrl = document.getElementById('plexUrl').value;
                    const token = document.getElementById('plexToken').value;
                    const isAdult = document.getElementById('plexIsAdult').checked;
                    
                    // Add server using real API
                    const result = await plexLibraryManager.addPlexServer(serverName, serverUrl, token, isAdult);
                    
                    if (result.success) {
                        // Sync with content library
                        syncPlexWithContentLibrary();
                        
                        closeModal();
                        showContentSection();
                        showSuccess(`‚úÖ Plex server "${result.server.name}" added successfully! ${result.server.libraries.length} libraries found.`);
                    } else {
                        showError(`Failed to add Plex server: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error adding Plex server:', error);
                    showError(`Error adding Plex server: ${error.message}`);
                } finally {
                    // Restore button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
        
        function addTVPlatformModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px;">
                    <h2 style="color: white; margin-bottom: 20px; text-align: center;">Add TV Platform</h2>
                    
                    <form id="addTVPlatformForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Platform Name *</label>
                            <input type="text" id="platformName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="e.g., Netflix, Disney+, Prime Video">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Logo URL *</label>
                            <input type="url" id="platformLogo" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="https://example.com/logo.png">
                            <small style="color: rgba(255,255,255,0.7); font-size: 12px;">Recommended size: 512x512px or 300x300px for optimal display on TV platforms</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Compatible TV Platforms</label>
                            <input type="text" id="platformCompatibility" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="Android TV, LG WebOS, Samsung Tizen, Roku, iOS">
                            <small style="color: rgba(255,255,255,0.7); font-size: 12px;">Comma-separated list of compatible TV platforms</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Category</label>
                            <select id="platformCategory" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="Streaming Platform">Streaming Platform</option>
                                <option value="Free TV">Free TV</option>
                                <option value="Premium">Premium</option>
                                <option value="Sports">Sports</option>
                                <option value="Movies">Movies</option>
                                <option value="TV Shows">TV Shows</option>
                                <option value="Kids">Kids</option>
                                <option value="Music">Music</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Description</label>
                            <textarea id="platformDescription" rows="3" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="Brief description of the streaming platform..."></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Platform URL (Optional)</label>
                            <input type="url" id="platformUrl" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="https://platform-website.com">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                            <select id="platformStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Coming Soon">Coming Soon</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button type="button" onclick="closeModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #9c27b0, #ba68c8); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Add TV Platform</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('platformName').focus();
            
            modal.querySelector('#addTVPlatformForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newPlatform = {
                    name: document.getElementById('platformName').value,
                    logo: document.getElementById('platformLogo').value,
                    category: document.getElementById('platformCategory').value,
                    compatiblePlatforms: document.getElementById('platformCompatibility').value,
                    description: document.getElementById('platformDescription').value,
                    url: document.getElementById('platformUrl').value,
                    status: document.getElementById('platformStatus').value
                };
                
                window.contentLibrary.tvPlatforms.push(newPlatform);
                closeModal();
                showContentSection();
                showSuccess(`TV Platform "${newPlatform.name}" added successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
        
        function editContent(type, index) {
            const content = window.contentLibrary[type][index];
            
            // Special handling for TV Platforms
            if (type === 'tvPlatforms') {
                editTVPlatformModal(index);
                return;
            }
            
            // Special handling for Plex content
            if (type === 'plex') {
                editPlexModal(index);
                return;
            }
            
            // Special handling for Basic Channels
            if (type === 'basicChannels') {
                editBasicChannelModal(index);
                return;
            }
            
            // For other content types, show a simple alert for now
            alert(`Edit functionality for ${type}: ${content.name || content.title}\n\nThis would open an edit modal with the current values populated.`);
        }
        
        function editTVPlatformModal(index) {
            const platform = window.contentLibrary.tvPlatforms[index];
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px;">
                    <h2 style="color: white; margin-bottom: 20px; text-align: center;">Edit TV Platform</h2>
                    
                    <form id="editTVPlatformForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Platform Name *</label>
                            <input type="text" id="editPlatformName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${platform.name}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Logo URL *</label>
                            <input type="url" id="editPlatformLogo" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${platform.logo}">
                            <small style="color: rgba(255,255,255,0.7); font-size: 12px;">Recommended size: 512x512px or 300x300px for optimal display on TV platforms</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Compatible TV Platforms</label>
                            <input type="text" id="editPlatformCompatibility" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${platform.compatiblePlatforms || ''}">
                            <small style="color: rgba(255,255,255,0.7); font-size: 12px;">Comma-separated list of compatible TV platforms</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Category</label>
                            <select id="editPlatformCategory" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="Streaming Platform" ${platform.category === 'Streaming Platform' ? 'selected' : ''}>Streaming Platform</option>
                                <option value="Free TV" ${platform.category === 'Free TV' ? 'selected' : ''}>Free TV</option>
                                <option value="Premium" ${platform.category === 'Premium' ? 'selected' : ''}>Premium</option>
                                <option value="Sports" ${platform.category === 'Sports' ? 'selected' : ''}>Sports</option>
                                <option value="Movies" ${platform.category === 'Movies' ? 'selected' : ''}>Movies</option>
                                <option value="TV Shows" ${platform.category === 'TV Shows' ? 'selected' : ''}>TV Shows</option>
                                <option value="Kids" ${platform.category === 'Kids' ? 'selected' : ''}>Kids</option>
                                <option value="Music" ${platform.category === 'Music' ? 'selected' : ''}>Music</option>
                                <option value="Other" ${platform.category === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Description</label>
                            <textarea id="editPlatformDescription" rows="3" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">${platform.description || ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Platform URL (Optional)</label>
                            <input type="url" id="editPlatformUrl" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${platform.url || ''}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                            <select id="editPlatformStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="Active" ${platform.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${platform.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                <option value="Coming Soon" ${platform.status === 'Coming Soon' ? 'selected' : ''}>Coming Soon</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button type="button" onclick="closeModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #9c27b0, #ba68c8); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Update Platform</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('editPlatformName').focus();
            
            modal.querySelector('#editTVPlatformForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const updatedPlatform = {
                    name: document.getElementById('editPlatformName').value,
                    logo: document.getElementById('editPlatformLogo').value,
                    category: document.getElementById('editPlatformCategory').value,
                    compatiblePlatforms: document.getElementById('editPlatformCompatibility').value,
                    description: document.getElementById('editPlatformDescription').value,
                    url: document.getElementById('editPlatformUrl').value,
                    status: document.getElementById('editPlatformStatus').value
                };
                
                window.contentLibrary.tvPlatforms[index] = updatedPlatform;
                closeModal();
                showContentSection();
                showSuccess(`TV Platform "${updatedPlatform.name}" updated successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
        
        function editPlexModal(index) {
            const plex = window.contentLibrary.plex[index];
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px;">
                    <h2 style="color: white; margin-bottom: 20px; text-align: center;">Edit Plex Library</h2>
                    
                    <form id="editPlexForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Library Name *</label>
                            <input type="text" id="editPlexName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${plex.name}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Plex URL *</label>
                            <input type="url" id="editPlexUrl" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${plex.url}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Library Type</label>
                            <select id="editPlexType" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="Movies" ${plex.type === 'Movies' ? 'selected' : ''}>Movies</option>
                                <option value="TV Shows" ${plex.type === 'TV Shows' ? 'selected' : ''}>TV Shows</option>
                                <option value="Music" ${plex.type === 'Music' ? 'selected' : ''}>Music</option>
                                <option value="Photos" ${plex.type === 'Photos' ? 'selected' : ''}>Photos</option>
                                <option value="Other" ${plex.type === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Server Name</label>
                            <input type="text" id="editPlexServer" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${plex.server || ''}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Token (Optional)</label>
                            <input type="text" id="editPlexToken" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${plex.token || ''}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                            <select id="editPlexStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="Active" ${plex.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${plex.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; color: white; font-weight: 500; cursor: pointer;">
                                <input type="checkbox" id="editPlexIsAdult" style="margin-right: 10px; cursor: pointer;" ${plex.isAdult ? 'checked' : ''}>
                                Mark as Adult Content (18+)
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button type="button" onclick="closeModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #9c27b0, #ba68c8); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Update Plex</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('editPlexName').focus();
            
            modal.querySelector('#editPlexForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const updatedPlex = {
                    name: document.getElementById('editPlexName').value,
                    url: document.getElementById('editPlexUrl').value,
                    type: document.getElementById('editPlexType').value,
                    server: document.getElementById('editPlexServer').value,
                    token: document.getElementById('editPlexToken').value,
                    status: document.getElementById('editPlexStatus').value,
                    isAdult: document.getElementById('editPlexIsAdult').checked
                };
                
                window.contentLibrary.plex[index] = updatedPlex;
                saveContentLibrary(); // Save to localStorage so mobile app can access
                closeModal();
                showContentSection();
                showSuccess(`Plex library "${updatedPlex.name}" updated successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
        
        function editBasicChannelModal(index) {
            const channel = window.contentLibrary.basicChannels[index];
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
                align-items: center; justify-content: center; backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px; height: 650px; display: flex; flex-direction: column;">
                    <h2 style="color: white; margin-bottom: 20px; text-align: center;">Edit Basic Channel</h2>
                    
                    <form id="editBasicChannelForm" style="flex: 1; overflow-y: auto;">
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Channel Name *</label>
                                <input type="text" id="editBasicChannelName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${channel.name}">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Stream URL *</label>
                                <input type="url" id="editBasicChannelUrl" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${channel.streamUrl}">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Logo URL</label>
                                <input type="url" id="editBasicChannelLogo" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${channel.logo || ''}">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Category</label>
                                <select id="editBasicChannelCategory" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    <option value="News" ${channel.category === 'News' ? 'selected' : ''}>News</option>
                                    <option value="Sports" ${channel.category === 'Sports' ? 'selected' : ''}>Sports</option>
                                    <option value="Entertainment" ${channel.category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
                                    <option value="Movies" ${channel.category === 'Movies' ? 'selected' : ''}>Movies</option>
                                    <option value="Music" ${channel.category === 'Music' ? 'selected' : ''}>Music</option>
                                    <option value="Kids" ${channel.category === 'Kids' ? 'selected' : ''}>Kids</option>
                                    <option value="Documentary" ${channel.category === 'Documentary' ? 'selected' : ''}>Documentary</option>
                                    <option value="General" ${channel.category === 'General' ? 'selected' : ''}>General</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                                <select id="editBasicChannelStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    <option value="Active" ${channel.status === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="Inactive" ${channel.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: flex; align-items: center; gap: 8px; color: white; font-weight: 500;">
                                    <input type="checkbox" id="editBasicChannelIsAdult" style="width: 16px; height: 16px; margin: 0;" ${channel.isAdult ? 'checked' : ''}>
                                    <span>üîû Adult Content (requires password)</span>
                                </label>
                            </div>
                            
                            <div style="display: flex; gap: 15px; margin-top: 20px;">
                                <button type="button" onclick="closeModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                                <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #e91e63, #f06292); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Update Channel</button>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('editBasicChannelName').focus();
            
            modal.querySelector('#editBasicChannelForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const updatedChannel = {
                    name: document.getElementById('editBasicChannelName').value,
                    streamUrl: document.getElementById('editBasicChannelUrl').value,
                    logo: document.getElementById('editBasicChannelLogo').value,
                    category: document.getElementById('editBasicChannelCategory').value,
                    status: document.getElementById('editBasicChannelStatus').value,
                    isAdult: document.getElementById('editBasicChannelIsAdult').checked,
                    number: channel.number || (index + 1)
                };
                
                window.contentLibrary.basicChannels[index] = updatedChannel;
                saveContentLibrary();
                closeModal();
                showContentSection();
                showSuccess(`Basic Channel "${updatedChannel.name}" updated successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }
        
        function deleteContent(type, index) {
            const content = window.contentLibrary[type][index];
            const contentName = content.name || content.title;
            
            if (confirm(`Are you sure you want to delete "${contentName}"?`)) {
                window.contentLibrary[type].splice(index, 1);
                saveContentLibrary(); // Save to localStorage so mobile app can access
                showContentSection();
                showSuccess(`Content "${contentName}" deleted successfully!`);
            }
        }
        
        function closeModal() {
            // Handle transfer modal specifically
            if (window.currentTransferModal) {
                document.body.removeChild(window.currentTransferModal);
                window.currentTransferModal = null;
                return;
            }
            
            // Handle general modals by z-index
            const modal = document.querySelector('div[style*="z-index: 10001"]');
            if (modal) {
                modal.remove();
            }
        }
        
        function showPackagesSection() {
            const mainContent = document.querySelector('.admin-main');
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üì¶ Package Management</h1>
                    <p class="dashboard-subtitle">Manage packages, addons, and pricing</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon revenue">üì¶</div>
                        <div class="stat-value">${window.packages ? window.packages.length : 0}</div>
                        <div class="stat-label">Active Packages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue">üîß</div>
                        <div class="stat-value">${window.addons ? window.addons.length : 0}</div>
                        <div class="stat-label">Addons Available</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue">DEVICES</div>
                        <div class="stat-value">3</div>
                        <div class="stat-label">Device Tiers</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    <!-- Package Management -->
                    <div class="section-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="section-title">üì¶ Packages</h3>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="debugSaveAllPackages()" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">üêõ Debug Save</button>
                                <button onclick="addNewPackage()" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ûï Add Package</button>
                            </div>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${generatePackageList()}
                        </div>
                    </div>
                    
                    <!-- Addon Management -->
                    <div class="section-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="section-title">üîß Addons</h3>
                            <button onclick="addNewAddon()" style="background: linear-gradient(135deg, #ff9800, #ffb74d); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ûï Add Addon</button>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${generateAddonList()}
                        </div>
                    </div>
                </div>
                
                <!-- Device Pricing -->
                <div class="section-card" style="margin-top: 25px;">
                    <h3 class="section-title">Additional Device Pricing</h3>
                    <div style="text-align: center; margin-bottom: 15px; color: rgba(255,255,255,0.7); font-size: 14px;">1st TV is included in base subscription</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="color: white; margin-bottom: 10px;">2nd TV</h4>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #ff9800; margin-bottom: 10px;">$${window.devicePricing?.secondTV || 0}/month</div>
                            <button onclick="editDevicePrice('secondTV')" style="background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit Price</button>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="color: white; margin-bottom: 10px;">3rd TV</h4>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #ff5722; margin-bottom: 10px;">$${window.devicePricing?.thirdTV || 0}/month</div>
                            <button onclick="editDevicePrice('thirdTV')" style="background: #ff5722; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">Edit Price</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showResellersSection() {
            const mainContent = document.querySelector('.admin-main');
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üè¢ Reseller Management</h1>
                    <p class="dashboard-subtitle">Manage reseller accounts and commissions</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon revenue">üè¢</div>
                        <div class="stat-value">${Object.keys(creditSystem.resellerCredits).length}</div>
                        <div class="stat-label">Active Resellers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue">üí∞</div>
                        <div class="stat-value">$${getTotalResellerCredits()}</div>
                        <div class="stat-label">Total Credits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon users">üë•</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Customers</div>
                    </div>
                </div>
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="section-title">Reseller Accounts</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="manageResellerCredentials()" style="background: linear-gradient(135deg, #ff9800, #ffb74d); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">‚öôÔ∏è Manage Credentials</button>
                            <button onclick="showPanelAssignments()" style="background: linear-gradient(135deg, #9c27b0, #ba68c8); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">üìä View Panels</button>
                            <button onclick="createReseller()" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">‚ûï Create New Reseller</button>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 15px; margin-bottom: 15px; font-size: 13px; color: rgba(255,255,255,0.8);">
                        <strong>üìã RESELLER SYSTEM:</strong><br>
                        ‚úÖ Each reseller gets their own panel file (reseller_XXX_panel.html)<br>
                        ‚úÖ All panels are exactly the same but work independently<br>
                        ‚úÖ Admin can change username/password for any reseller<br>
                        ‚úÖ Centralized package and pricing management
                    </div>
                    <div class="user-list">
                        ${generateResellerList()}
                    </div>
                </div>
            `;
        }
        
        function showAnalyticsSection() {
            const mainContent = document.querySelector('.admin-main');
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üìà Analytics Dashboard</h1>
                    <p class="dashboard-subtitle">System performance and usage analytics</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon users">üë•</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Monthly Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon content">‚è∞</div>
                        <div class="stat-value">0h</div>
                        <div class="stat-label">Avg. Watch Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon system">üìä</div>
                        <div class="stat-value">94.2%</div>
                        <div class="stat-label">Streaming Quality</div>
                    </div>
                </div>
                <div class="section-card">
                    <h3 class="section-title">Performance Metrics</h3>
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìà</div>
                        <div style="font-size: 18px; font-weight: 500;">Analytics Dashboard</div>
                        <div style="font-size: 14px; margin-top: 5px;">Detailed analytics and reporting features</div>
                    </div>
                </div>
            `;
        }
        
        function showSettingsSection() {
            const mainContent = document.querySelector('.admin-main');
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">‚öôÔ∏è System Settings</h1>
                    <p class="dashboard-subtitle">Configure system parameters and preferences</p>
                </div>
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">General Settings</h3>
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">System Name</label>
                                <input type="text" value="iWATCH TV" style="width: 100%; padding: 10px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Default Adult Password</label>
                                <input type="password" value="1818" style="width: 100%; padding: 10px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Session Timeout</label>
                                <select style="width: 100%; padding: 10px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                                    <option>30 minutes</option>
                                    <option>1 hour</option>
                                    <option>2 hours</option>
                                    <option>4 hours</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="section-card">
                        <h3 class="section-title">Security Settings</h3>
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" checked> Enable adult content protection
                                </label>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" checked> Require password change
                                </label>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" checked> Enable session logging
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showLogsSection() {
            const mainContent = document.querySelector('.admin-main');
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üìã System Logs</h1>
                    <p class="dashboard-subtitle">Monitor system activity and errors</p>
                </div>
                <div class="section-card">
                    <h3 class="section-title">Recent Activity</h3>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                        ${generateSystemLogs()}
                    </div>
                </div>
            `;
        }
        
let customerIdCounter = 1;
        
        // Data Sync Functions for Mobile-PC synchronization
        // SUPER SIMPLE: Quick Add - Paste customer data directly
        function quickAddCustomers() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); width: 600px; max-height: 90vh; overflow-y: auto;">
                    <h2 style="color: white; margin-bottom: 15px; text-align: center;">‚ö° Quick Add Customers</h2>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.2);">
                        <h4 style="color: #ffeb3b; margin: 0 0 10px 0;">üìã Format Example:</h4>
                        <div style="font-family: monospace; color: #e0e0e0; font-size: 12px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
                            John Doe, +1234567890, Basic Plan, 2025-12-01<br>
                            Jane Smith, +0987654321, Premium Plan, 2025-12-15<br>
                            Mike Johnson, +1555123456, Standard Plan, 2026-01-01
                        </div>
                        <p style="color: #b0b0b0; font-size: 12px; margin: 10px 0 0 0;">
                            <strong>Format:</strong> Name, Phone, Plan, Expiry Date (YYYY-MM-DD)
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <textarea id="quickCustomerData" style="width: 100%; height: 200px; padding: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-family: monospace; font-size: 12px;" placeholder="Paste your customer data here..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="processQuickCustomers()" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600;">‚úÖ Add Customers</button>
                        <button onclick="closeQuickAddModal()" style="background: linear-gradient(135deg, #757575, #9e9e9e); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600;">‚ùå Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Make modal closable
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeQuickAddModal();
                }
            };
            
            window.closeQuickAddModal = function() {
                document.body.removeChild(modal);
            };
        }
        
        function processQuickCustomers() {
            const data = document.getElementById('quickCustomerData').value.trim();
            if (!data) {
                alert('‚ùå Please paste customer data!');
                return;
            }
            
            const lines = data.split('\n');
            const newCustomers = [];
            let added = 0;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 3) {
                    const [name, phone, plan, expiryDate] = parts;
                    
                    const customer = {
                        id: 'customer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: name || 'Unknown Customer',
                        phone: phone || '',
                        plan: plan || 'Basic Plan',
                        avatar: name ? name.charAt(0).toUpperCase() : '?',
                        status: 'Active',
                        createdAt: new Date().toLocaleDateString(),
                        addons: [],
                        devices: [],
                        endDate: expiryDate || new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0]
                    };
                    
                    newCustomers.push(customer);
                    added++;
                }
            });
            
            // Add to existing customers
            if (!window.adminUsers) {
                window.adminUsers = [];
            }
            
            window.adminUsers = [...window.adminUsers, ...newCustomers];
            localStorage.setItem('adminCustomers', JSON.stringify(window.adminUsers));
            
            // Update dashboard display
            updateDashboardUsers();
            
            closeQuickAddModal();
            showUsersSection();
            
            alert(`‚úÖ Successfully added ${added} customers!\n\nCustomers are now visible on both PC and Mobile!`);
        }
        
        function updateDashboardUsers() {
            const dashboardUsersDiv = document.getElementById('dashboard-users');
            if (!dashboardUsersDiv) return;
            
            // Ensure we have the latest customer data
            const saved = localStorage.getItem('adminCustomers');
            if (saved) {
                try {
                    const customers = JSON.parse(saved);
                    if (customers.length > 0) {
                        const recentCustomers = customers.slice(0, 3); // Show only 3 recent
                        
                        dashboardUsersDiv.innerHTML = recentCustomers.map(customer => `
                            <div style="display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #2196f3, #42a5f5); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 15px;">
                                    ${customer.avatar}
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: white; font-weight: 600;">${customer.name}</div>
                                    <div style="color: rgba(255,255,255,0.7); font-size: 12px;">${customer.phone || 'No phone'} ‚Ä¢ ${customer.plan}</div>
                                </div>
                                <div style="color: #4caf50; font-size: 12px; font-weight: 600;">Active</div>
                            </div>
                        `).join('');
                        
                        if (customers.length > 3) {
                            dashboardUsersDiv.innerHTML += `
                                <div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 12px;">
                                    And ${customers.length - 3} more customers...
                                </div>
                            `;
                        }
                        
                        return;
                    }
                } catch(e) {
                    console.error('Error loading customers for dashboard:', e);
                }
            }
            
            // If no customers, show empty state
            dashboardUsersDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 10px;">üë•</div>
                    <div>No users found.</div>
                    <button onclick="showSection('users'); showUsersSection();" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px;">‚ûï Add Customers</button>
                </div>
            `;
        }
        
        function exportCustomerData() {
            try {
                const data = localStorage.getItem('adminCustomers');
                if (!data) {
                    alert('‚ùå No customer data found to export!');
                    return;
                }
                
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `iwatch-customers-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Customer data exported successfully');
                alert('‚úÖ Customer data exported successfully!\n\nSend this file to other devices and use Import to load it.');
                
            } catch (error) {
                console.error('‚ùå Export failed:', error);
                alert('‚ùå Export failed! ' + error.message);
            }
        }
        
        function importCustomerData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate data structure
                        if (!Array.isArray(data)) {
                            throw new Error('Invalid data format. Expected array.');
                        }
                        
                        // Confirm import
                        if (confirm(`‚ö†Ô∏è Import ${data.length} customers?\n\nThis will REPLACE all existing customer data!`)) {
                            localStorage.setItem('adminCustomers', JSON.stringify(data));
                            window.adminUsers = data;
                            
                            // Refresh display
                            showUsersSection();
                            
                            console.log('‚úÖ Customer data imported successfully');
                            alert(`‚úÖ Successfully imported ${data.length} customers!\n\nCustomer data is now synced.`);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Import failed:', error);
                        alert('‚ùå Import failed! ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function generateUserList() {
            // Debug: Check if adminUsers exists and has data
            console.log('üì± Mobile - Checking adminUsers:', window.adminUsers);
            console.log('üì± Mobile - AdminUsers length:', window.adminUsers ? window.adminUsers.length : 'undefined');
            console.log('üì± Mobile - LocalStorage key "adminCustomers":', localStorage.getItem('adminCustomers'));
            
            // Always reload from localStorage to ensure fresh data
            const saved = localStorage.getItem('adminCustomers');
            if (saved) {
                try {
                    window.adminUsers = JSON.parse(saved);
                    console.log('üì± Mobile - Fresh loaded adminUsers:', window.adminUsers);
                } catch(e) {
                    console.error('üì± Mobile - Error parsing customers:', e);
                    window.adminUsers = [];
                }
            } else {
                window.adminUsers = [];
                console.log('üì± Mobile - No saved customers found');
            }
            
            if (!window.adminUsers || window.adminUsers.length === 0) {
                console.log('üì± Mobile - Still no customers, showing empty message');
                return '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">üë• No customers found. Click "Add New Customer" to get started.</div>';
            }
            
            console.log('üì± Mobile - Rendering', window.adminUsers.length, 'customers');
            return window.adminUsers.map(customer => {
                // Calculate days until expiry
                const statusInfo = calculateCustomerStatus(customer);
                const statusClass = statusInfo.className;
                const statusText = statusInfo.text;
                
                return `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">${customer.avatar}</div>
                        <div class="user-details">
                            <h4>${customer.name}</h4>
                            <p>${customer.phone || 'No phone'} ‚Ä¢ ${customer.plan} Plan/month</p>
                            ${customer.addons && customer.addons.length > 0 ? `<p style="color: rgba(255,255,255,0.6); font-size: 11px; margin-top: 2px;">Addons: ${customer.addons.join(', ')}</p>` : ''}
                        </div>
                    </div>
                    <div>
                        <div class="user-status ${statusClass}">${statusText}</div>
                        <button class="action-btn" onclick="editUser('${customer.id}')">Edit</button>
                        <button class="action-btn" onclick="renewCustomerSubscription('${customer.id}')">Renew</button>
                        <button class="action-btn" onclick="changeUserPassword('${customer.id}')">Change Password</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function calculateCustomerStatus(customer) {
            if (!customer.endDate) {
                return { className: 'status-active', text: 'Active' };
            }
            
            const endDate = new Date(customer.endDate);
            const today = new Date();
            const timeDiff = endDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff < 0) {
                return { className: 'status-expired', text: 'Expired' };
            } else if (daysDiff <= 3) {
                return { className: 'status-expiring', text: `Expiring (${daysDiff}d)` };
            } else {
                return { className: 'status-active', text: 'Active' };
            }
        }

        function initializeDateDropdowns() {
            const monthSelect = document.getElementById('endMonth');
            const dateSelect = document.getElementById('endDate');
            const yearSelect = document.getElementById('endYear');
            
            if (!monthSelect || !dateSelect || !yearSelect) return;
            
            // Clear existing options
            monthSelect.innerHTML = '<option value="">Month</option>';
            dateSelect.innerHTML = '<option value="">Date</option>';
            yearSelect.innerHTML = '<option value="">Year</option>';
            
            // Populate months
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = `${(index + 1).toString().padStart(2, '0')} - ${month}`;
                monthSelect.appendChild(option);
            });
            
            // Populate dates (1-31)
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                dateSelect.appendChild(option);
            }
            
            // Populate years (current year + 5 years)
            const currentYear = new Date().getFullYear();
            for (let i = 0; i <= 5; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Set default date (30 days from today)
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            
            monthSelect.value = defaultDate.getMonth() + 1;
            dateSelect.value = defaultDate.getDate();
            yearSelect.value = defaultDate.getFullYear();
        }

        function initializeEditDateDropdowns(customer) {
            const monthSelect = document.getElementById('editEndMonth');
            const dateSelect = document.getElementById('editEndDate');
            const yearSelect = document.getElementById('editEndYear');
            
            if (!monthSelect || !dateSelect || !yearSelect) return;
            
            // Clear existing options
            monthSelect.innerHTML = '<option value="">Month</option>';
            dateSelect.innerHTML = '<option value="">Date</option>';
            yearSelect.innerHTML = '<option value="">Year</option>';
            
            // Populate months
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = `${(index + 1).toString().padStart(2, '0')} - ${month}`;
                monthSelect.appendChild(option);
            });
            
            // Populate dates (1-31)
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                dateSelect.appendChild(option);
            }
            
            // Populate years (current year + 5 years)
            const currentYear = new Date().getFullYear();
            for (let i = 0; i <= 5; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Set customer's current end date or default to 30 days from today
            let customerDate;
            if (customer.endDate) {
                customerDate = new Date(customer.endDate);
            } else {
                customerDate = new Date();
                customerDate.setDate(customerDate.getDate() + 30);
            }
            
            monthSelect.value = customerDate.getMonth() + 1;
            dateSelect.value = customerDate.getDate();
            yearSelect.value = customerDate.getFullYear();
        }
        
        function generateResellerList() {
            const resellers = Object.keys(creditSystem.resellerCredits);
            if (resellers.length === 0) {
                return '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">üè¢ No resellers found. Transfer credits to create reseller accounts.</div>';
            }
            
            return resellers.map(resellerId => {
                const balance = creditSystem.getResellerBalance(resellerId);
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-avatar">R</div>
                            <div class="user-details">
                                <h4>${resellerId}</h4>
                                <p>Credit Balance: $${balance}</p>
                            </div>
                        </div>
                        <div>
                            <div class="user-status status-active">Active</div>
                            <button class="action-btn" onclick="editReseller('${resellerId}')">Edit</button>
                            <button class="action-btn" onclick="changeResellerPassword('${resellerId}')">Change Password</button>
                            <button class="action-btn-delete" onclick="deleteReseller('${resellerId}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getTotalResellerCredits() {
            return Object.values(creditSystem.resellerCredits).reduce((total, balance) => total + balance, 0);
        }

        function deleteReseller(resellerId) {
            const reseller = passwordManager.resellerCredentials[resellerId];
            if (!reseller) {
                showError('Reseller not found');
                return;
            }

            // Get assigned panel number
            const assignedPanel = localStorage.getItem(`reseller_${resellerId}_panel`);
            
            const confirmation = confirm(
                `‚ö†Ô∏è DELETE RESELLER CONFIRMATION\n\n` +
                `Are you sure you want to delete reseller:\n` +
                `‚Ä¢ ID: ${resellerId}\n` +
                `‚Ä¢ Username: ${reseller.username}\n` +
                `‚Ä¢ Panel: ${assignedPanel || 'None'}\n\n` +
                `This will:\n` +
                `‚Ä¢ Remove the reseller account\n` +
                `‚Ä¢ Free up panel #${assignedPanel || 'None'} for reuse\n` +
                `‚Ä¢ Delete all customer data\n` +
                `‚Ä¢ Cannot be undone!\n\n` +
                `Type "DELETE" to confirm:`
            );

            if (!confirmation) return;

            const deleteConfirm = prompt('Type "DELETE" to confirm:');
            if (deleteConfirm !== 'DELETE') {
                showError('Deletion cancelled - wrong confirmation text');
                return;
            }

            try {
                // Remove from password manager
                delete passwordManager.resellerCredentials[resellerId];
                passwordManager.saveCredentials();

                // Remove from credit system
                delete creditSystem.resellerCredits[resellerId];
                creditSystem.saveCredits();

                // Clear panel assignment
                if (assignedPanel) {
                    localStorage.removeItem(`reseller_${resellerId}_panel`);
                    localStorage.removeItem(`reseller_${assignedPanel}_assigned`);
                }

                // Clear customer data
                localStorage.removeItem(`resellerCustomers_${reseller.username}`);
                localStorage.removeItem(`resellerWallet_${reseller.username}`);

                console.log('üóëÔ∏è Reseller deleted:', resellerId);
                showSuccess(`Reseller ${resellerId} deleted successfully. Panel #${assignedPanel || 'None'} is now available for new reseller.`);
                
                // Refresh the reseller list
                showResellersSection();
                showCreditSection();
                
            } catch (error) {
                console.error('Error deleting reseller:', error);
                showError('Failed to delete reseller: ' + error.message);
            }
        }
        
        function generateSystemLogs() {
            const logs = [
                '[2025-11-13 09:22:51] INFO: Admin panel initialized',
                '[2025-11-13 09:22:51] INFO: Clean admin panel loaded - ready for production',
                '[2025-11-13 09:22:51] INFO: Credit system initialized - unlimited transfers enabled'
            ];
            
            return logs.join('<br>');
        }
        
        function editUser(customerId) {
            const customer = window.adminUsers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Create edit customer modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 0; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px; height: 600px; display: flex; flex-direction: column;">
                    <div style="padding: 20px 40px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <h2 style="color: white; margin: 0; text-align: center;">‚úèÔ∏è Edit Customer</h2>
                    </div>
                    
                    <div style="flex: 1; padding: 20px 40px; overflow-y: auto;">
                        <form id="editCustomerForm" style="height: 100%;">
                            <div style="display: flex; flex-direction: column; height: 100%;">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Customer Name *</label>
                                        <input type="text" id="editCustomerName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${customer.name}">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Phone Number</label>
                                        <input type="tel" id="editCustomerPhone" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" value="${customer.phone || ''}">
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Subscription Plan *</label>
                                        <select id="editCustomerPlan" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            ${generateEditPackageOptions(customer.plan)}
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Status</label>
                                        <select id="editCustomerStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                            <option value="Active" ${customer.status === 'Active' ? 'selected' : ''}>Active</option>
                                            <option value="Expired" ${customer.status === 'Expired' ? 'selected' : ''}>Expired</option>
                                            <option value="Suspended" ${customer.status === 'Suspended' ? 'selected' : ''}>Suspended</option>
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Subscription End Date *</label>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="editEndMonth" required style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                                <option value="">Month</option>
                                            </select>
                                            <select id="editEndDate" required style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                                <option value="">Date</option>
                                            </select>
                                            <select id="editEndYear" required style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                                <option value="">Year</option>
                                            </select>
                                        </div>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">Select when the subscription expires</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Addon Packages (Optional)</label>
                                        <div id="editAddonSelection" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                            ${generateEditAddonOptions(customer.addons || [])}
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Current Devices (Locked)</label>
                                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                                <label style="color: rgba(255,255,255,0.6); display: flex; align-items: center; cursor: not-allowed;">
                                                    <input type="checkbox" name="editCustomerDevices" value="basicTV" checked disabled style="margin-right: 8px;">
                                                    Basic TV Package (+$25.00/month) - Required
                                                </label>
                                                <label style="color: ${customer.devices?.includes('secondTV') ? 'rgba(255,255,255,0.6)' : 'white'}; display: flex; align-items: center; cursor: ${customer.devices?.includes('secondTV') ? 'not-allowed' : 'pointer'};">
                                                    <input type="checkbox" name="editCustomerDevices" value="secondTV" ${customer.devices?.includes('secondTV') ? 'checked disabled' : ''} style="margin-right: 8px;">
                                                    2nd TV (+$${window.devicePricing?.secondTV || 0}/month) ${customer.devices?.includes('secondTV') ? '- Current (Locked)' : '(Available to Add)'}
                                                </label>
                                                <label style="color: ${customer.devices?.includes('thirdTV') ? 'rgba(255,255,255,0.6)' : 'white'}; display: flex; align-items: center; cursor: ${customer.devices?.includes('thirdTV') ? 'not-allowed' : 'pointer'};">
                                                    <input type="checkbox" name="editCustomerDevices" value="thirdTV" ${customer.devices?.includes('thirdTV') ? 'checked disabled' : ''} style="margin-right: 8px;">
                                                    3rd TV (+$${window.devicePricing?.thirdTV || 0}/month) ${customer.devices?.includes('thirdTV') ? '- Current (Locked)' : '(Available to Add)'}
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 20px;">
                                    <button type="button" onclick="closeEditCustomerModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                                    <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50, #66bb6a); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Update Customer</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('editCustomerName').focus();
            
            // Initialize edit date dropdowns with customer's current end date
            initializeEditDateDropdowns(customer);
            
            // Handle form submission
            modal.querySelector('#editCustomerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                customer.name = document.getElementById('editCustomerName').value;
                customer.phone = document.getElementById('editCustomerPhone').value;
                customer.plan = document.getElementById('editCustomerPlan').value;
                customer.status = document.getElementById('editCustomerStatus').value;
                
                // Get subscription end date from edit fields
                const editEndMonth = document.getElementById('editEndMonth').value;
                const editEndDate = document.getElementById('editEndDate').value;
                const editEndYear = document.getElementById('editEndYear').value;
                
                // Validate required fields
                if (!editEndMonth || !editEndDate || !editEndYear) {
                    showError('Please select subscription end date');
                    return;
                }
                
                // Update customer's end date
                const newEndDate = new Date(parseInt(editEndYear), parseInt(editEndMonth) - 1, parseInt(editEndDate));
                customer.endDate = newEndDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // Get selected addons
                const selectedAddons = Array.from(document.querySelectorAll('input[name="editCustomerAddons"]:checked'))
                    .map(checkbox => checkbox.value);
                customer.addons = selectedAddons;
                
                // Get selected devices
                const selectedDevices = Array.from(document.querySelectorAll('input[name="editCustomerDevices"]:checked'))
                    .map(checkbox => checkbox.value);
                customer.devices = selectedDevices;
                
                saveAdminCustomers(); // Save changes to localStorage
                
                closeEditCustomerModal();
                showUsersSection(); // Refresh the user list
                showSuccess(`Customer "${customer.name}" updated successfully!`);
            });
            
            // Handle click outside modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeEditCustomerModal();
                }
            });
        }
        
        function closeEditCustomerModal() {
            const modal = document.querySelector('div[style*="z-index: 10001"]');
            if (modal) {
                modal.remove();
            }
        }
        
        function changeUserPassword(customerId) {
            const customer = window.adminUsers.find(c => c.id === customerId);
            if (!customer) return;
            
            const newPassword = prompt(`Change password for ${customer.name}\n\nEnter new password:`);
            if (newPassword && newPassword.trim()) {
                customer.password = newPassword.trim();
                saveAdminCustomers(); // Save changes to localStorage
                showSuccess(`Password updated for "${customer.name}"`);
            }
        }

        function renewCustomerSubscription(customerId) {
            const customer = window.adminUsers.find(c => c.id === customerId);
            if (!customer) {
                showError('Customer not found');
                return;
            }

            // Ask for renewal period
            const months = prompt(`Renew subscription for ${customer.name}\n\nEnter number of months to extend (default: 1 month):`, '1');
            if (months === null) return; // User cancelled
            
            const extendMonths = parseInt(months);
            if (isNaN(extendMonths) || extendMonths <= 0 || extendMonths > 24) {
                showError('Please enter a valid number of months (1-24)');
                return;
            }

            // Get current end date or default to today if no end date
            let currentEndDate = customer.endDate ? new Date(customer.endDate) : new Date();
            const today = new Date();
            
            // If no end date or end date is in the past, start from today
            if (!customer.endDate || currentEndDate < today) {
                currentEndDate = today;
            }

            // Add months to current end date
            const newEndDate = new Date(currentEndDate);
            newEndDate.setMonth(newEndDate.getMonth() + extendMonths);
            
            // Update customer record
            customer.endDate = newEndDate.toISOString().split('T')[0]; // YYYY-MM-DD format
            customer.status = 'Active'; // Set status to Active when renewed
            
            saveAdminCustomers(); // Save changes to localStorage
            showUsersSection(); // Refresh the user list
            
            showSuccess(`Subscription renewed for "${customer.name}" - Extended ${extendMonths} month(s) until ${newEndDate.toLocaleDateString()}`);
        }

        function changeResellerPassword(resellerId) {
            const reseller = passwordManager.resellerCredentials[resellerId];
            if (!reseller) return;
            
            const newPassword = prompt(`Change password for reseller "${resellerId}"\n\nEnter new password (min 6 characters):`);
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            const confirmPassword = prompt('Confirm new password:');
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            reseller.password = newPassword;
            passwordManager.saveCredentials();
            showSuccess(`Password updated for reseller "${resellerId}"`);
            showResellersSection(); // Refresh the reseller list
        }
        
        function editReseller(resellerId) {
            console.log('Opening edit modal for reseller:', resellerId);
            
            // Get current reseller data
            const resellerData = passwordManager.resellerCredentials[resellerId] || {};
            const currentBalance = creditSystem.getResellerBalance(resellerId);
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.id = 'editResellerModal';
            modal.className = 'modal active';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80%; overflow-y: auto;">
                    <h2>Edit Reseller: ${resellerId}</h2>
                    
                    <form id="editResellerForm">
                        <div style="margin-bottom: 15px;">
                            <label>Username:</label>
                            <input type="text" id="editUsername" value="${resellerData.username || ''}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>Panel Assignment:</label>
                            <select id="editPanelAssignment" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select Panel</option>
                                ${Array.from({length: 12}, (_, i) => `<option value="${String(i + 1).padStart(3, '0')}" ${getResellerPanelAssignment(resellerId) === String(i + 1).padStart(3, '0') ? 'selected' : ''}>Panel #${String(i + 1).padStart(3, '0')}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>Status:</label>
                            <select id="editStatus" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>Commission Rate (%):</label>
                            <input type="number" id="editCommission" value="15" min="0" max="100" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>Current Balance:</label>
                            <input type="text" value="$${currentBalance.toFixed(2)}" readonly style="width: 100%; padding: 8px; background: #f8f9fa; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label>Notes:</label>
                            <textarea id="editNotes" placeholder="Internal notes about this reseller..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 80px;"></textarea>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" onclick="closeEditResellerModal()" style="padding: 10px 20px; margin-right: 10px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            const editForm = document.getElementById('editResellerForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('üìù Edit form submitted for:', resellerId);
                    
                    const updatedData = {
                        username: document.getElementById('editUsername').value,
                        panelAssignment: document.getElementById('editPanelAssignment').value,
                        status: document.getElementById('editStatus').value,
                        commission: parseFloat(document.getElementById('editCommission').value),
                        notes: document.getElementById('editNotes').value
                    };
                    
                    console.log('üìù Updated data:', updatedData);
                    
                    // Update reseller data
                    updateResellerData(resellerId, updatedData);
                    
                    closeEditResellerModal();
                    showResellersSection(); // Refresh the list
                });
                
                console.log('‚úÖ Edit form event listener attached');
            } else {
                console.error('‚ùå Edit form not found!');
            }
        }

        function closeEditResellerModal() {
            const modal = document.getElementById('editResellerModal');
            if (modal) {
                modal.remove();
            }
        }

        function updateResellerData(resellerId, data) {
            // Update in password manager
            if (passwordManager.resellerCredentials[resellerId]) {
                Object.assign(passwordManager.resellerCredentials[resellerId], {
                    username: data.username,
                    status: data.status,
                    commission: data.commission,
                    notes: data.notes
                });
                passwordManager.saveCredentials();
            }
            
            // Update panel assignment
            if (data.panelAssignment) {
                localStorage.setItem(`reseller_${resellerId}_panel`, data.panelAssignment);
            }
            
            console.log('Updated reseller data for:', resellerId, data);
            showSuccess(`Reseller ${resellerId} updated successfully`);
        }

        function getResellerPanelAssignment(resellerId) {
            return localStorage.getItem(`reseller_${resellerId}_panel`) || '';
        }
        
        // Device and Addon Price Calculation
        function updatePriceCalculation() {
            const priceDisplay = document.getElementById('priceDisplay');
            if (!priceDisplay) return;
            
            // Get selected devices
            const selectedDevices = Array.from(document.querySelectorAll('input[name="customerDevices"]:checked'))
                .map(cb => cb.value);
            
            // Get selected addons
            const selectedAddons = Array.from(document.querySelectorAll('input[name="customerAddons"]:checked'))
                .map(cb => cb.value);
            
            // Calculate total price
            let totalPrice = 0;
            
            // Use dynamic device pricing
            selectedDevices.forEach(device => {
                if (device === 'basicTV') {
                    totalPrice += 25.00; // Basic TV price is fixed
                } else if (device === 'secondTV') {
                    totalPrice += (window.devicePricing?.secondTV || 15.00); // Use dynamic pricing
                } else if (device === 'thirdTV') {
                    totalPrice += (window.devicePricing?.thirdTV || 12.00); // Use dynamic pricing
                }
            });
            
            // Calculate addon prices
            selectedAddons.forEach(addonName => {
                const addon = window.addons.find(a => a.name === addonName);
                if (addon) {
                    totalPrice += addon.price;
                }
            });
            
            if (selectedDevices.length === 0 && selectedAddons.length === 0) {
                priceDisplay.style.display = 'none';
                return;
            }
            
            // Update price display
            priceDisplay.style.display = 'block';
            document.getElementById('totalPrice').textContent = `Total Monthly: $${totalPrice.toFixed(2)}`;
            
            // Show breakdown
            const breakdownParts = [];
            
            // Add devices to breakdown
            selectedDevices.forEach(device => {
                const deviceName = device === 'basicTV' ? 'Basic TV' : 
                                 device === 'secondTV' ? '2nd TV' : '3rd TV';
                
                let devicePrice = 0;
                if (device === 'basicTV') {
                    devicePrice = 25.00;
                } else if (device === 'secondTV') {
                    devicePrice = window.devicePricing?.secondTV || 15.00;
                } else if (device === 'thirdTV') {
                    devicePrice = window.devicePricing?.thirdTV || 12.00;
                }
                
                breakdownParts.push(`${deviceName}: $${devicePrice.toFixed(2)}/month`);
            });
            
            // Add addons to breakdown
            selectedAddons.forEach(addonName => {
                const addon = window.addons.find(a => a.name === addonName);
                if (addon) {
                    breakdownParts.push(`${addon.name}: +$${addon.price}/month`);
                }
            });
            
            document.getElementById('priceBreakdown').textContent = breakdownParts.join(' + ');
        }

        // Device Selection Business Rules - Basic ‚Üí 2nd TV ‚Üí 3rd TV
        function updateDeviceSelection() {
            const basicCheckbox = document.getElementById('basicTVCheckbox');
            const secondTVCheckbox = document.getElementById('secondTVCheckbox');
            const thirdTVCheckbox = document.getElementById('thirdTVCheckbox');
            
            if (!basicCheckbox || !secondTVCheckbox || !thirdTVCheckbox) {
                return; // Function called before DOM elements are ready
            }
            
            // Basic package rules
            if (basicCheckbox.checked) {
                // Enable 2nd TV when Basic is selected
                secondTVCheckbox.disabled = false;
                secondTVCheckbox.parentElement.style.opacity = '1';
            } else {
                // Disable and uncheck 2nd TV when Basic is deselected
                secondTVCheckbox.disabled = true;
                secondTVCheckbox.checked = false;
                secondTVCheckbox.parentElement.style.opacity = '0.5';
            }
            
            // 2nd TV rules
            if (secondTVCheckbox.checked) {
                // Enable 3rd TV when 2nd TV is selected
                thirdTVCheckbox.disabled = false;
                thirdTVCheckbox.parentElement.style.opacity = '1';
            } else {
                // Disable and uncheck 3rd TV when 2nd TV is deselected
                thirdTVCheckbox.disabled = true;
                thirdTVCheckbox.checked = false;
                thirdTVCheckbox.parentElement.style.opacity = '0.5';
            }
            
            // Update visual feedback
            if (basicCheckbox.checked) {
                basicCheckbox.parentElement.style.background = 'rgba(76, 175, 80, 0.2)';
                basicCheckbox.parentElement.style.border = '1px solid #4caf50';
            } else {
                basicCheckbox.parentElement.style.background = 'transparent';
                basicCheckbox.parentElement.style.border = '1px solid rgba(255,255,255,0.2)';
            }
            
            if (secondTVCheckbox.checked && !secondTVCheckbox.disabled) {
                secondTVCheckbox.parentElement.style.background = 'rgba(76, 175, 80, 0.2)';
                secondTVCheckbox.parentElement.style.border = '1px solid #4caf50';
            } else {
                secondTVCheckbox.parentElement.style.background = 'transparent';
                secondTVCheckbox.parentElement.style.border = '1px solid rgba(255,255,255,0.2)';
            }
            
            if (thirdTVCheckbox.checked && !thirdTVCheckbox.disabled) {
                thirdTVCheckbox.parentElement.style.background = 'rgba(76, 175, 80, 0.2)';
                thirdTVCheckbox.parentElement.style.border = '1px solid #4caf50';
            } else {
                thirdTVCheckbox.parentElement.style.background = 'transparent';
                thirdTVCheckbox.parentElement.style.border = '1px solid rgba(255,255,255,0.2)';
            }
        }

        // Customer Management
        function addNewCustomer() {
            // Create customer form modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h2 style="color: white; margin-bottom: 20px; text-align: center;">‚ûï Add New Customer</h2>
                    
                    <form id="customerForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Customer Name *</label>
                            <input type="text" id="customerName" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="Enter full name">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Phone Number</label>
                            <input type="tel" id="customerPhone" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="+1234567890">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Subscription Plan *</label>
                            <select id="customerPlan" required onchange="updatePlexAccessPreview(); updatePriceCalculation()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <option value="">Select a plan</option>
                                ${generatePackageOptions()}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Additional Devices (Optional)</label>
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 15px;">
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <label style="color: white; display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="customerDevices" value="basicTV" id="basicTVCheckbox" style="margin-right: 8px;" onchange="updateDeviceSelection(); updatePriceCalculation()">
                                        Basic TV Package (+$25.00/month) - REQUIRED FIRST
                                    </label>
                                    <label style="color: white; display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="customerDevices" value="secondTV" id="secondTVCheckbox" style="margin-right: 8px;" onchange="updateDeviceSelection(); updatePriceCalculation()" disabled>
                                        2nd TV (+$${window.devicePricing?.secondTV || 15.00}/month) - Available after Basic
                                    </label>
                                    <label style="color: white; display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="customerDevices" value="thirdTV" id="thirdTVCheckbox" style="margin-right: 8px;" onchange="updateDeviceSelection(); updatePriceCalculation()" disabled>
                                        3rd TV (+$${window.devicePricing?.thirdTV || 12.00}/month) - Available after 2nd TV
                                    </label>
                                </div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">Basic package must be selected first, then 2nd TV, then 3rd TV</div>
                                
                                <!-- Price Calculation Display -->
                                <div id="priceDisplay" style="margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border: 1px solid #4caf50; border-radius: 8px; display: none;">
                                    <h4 style="color: #4caf50; margin: 0 0 10px 0;">üí∞ Subscription Cost</h4>
                                    <div style="color: white; font-size: 16px; font-weight: 600;" id="totalPrice">Total Monthly: $0.00</div>
                                    <div style="color: rgba(255,255,255,0.7); font-size: 12px;" id="priceBreakdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Addons (Optional)</label>
                            <div id="addonSelection" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 15px; max-height: 120px; overflow-y: auto;">
                                ${generateAddonOptions()}
                            </div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">Select any additional packages you want to include</div>
                        </div>
                        
                        <!-- Plex Library Access Preview -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">üìö Plex Library Access Preview</label>
                            <div id="plexAccessPreview" style="background: rgba(33, 150, 243, 0.1); border: 1px solid #2196f3; border-radius: 8px; padding: 15px; max-height: 150px; overflow-y: auto;">
                                <div style="color: rgba(255,255,255,0.7); font-size: 14px; text-align: center; padding: 20px;">
                                    üì∫ Select a plan to see available Plex libraries
                                </div>
                            </div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">
                                <span style="color: #ff5722;">üîû</span> = Adult content (18+) 
                                <span style="margin-left: 15px; color: #4caf50;">üì∫</span> = General content
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Subscription End Date *</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="endMonth" required style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    <option value="">Month</option>
                                </select>
                                <select id="endDate" required style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    <option value="">Date</option>
                                </select>
                                <select id="endYear" required style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    <option value="">Year</option>
                                </select>
                            </div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">Select when the subscription expires</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 500;">Password *</label>
                            <input type="password" id="customerPassword" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" placeholder="Auto-generated password" value="customer123">
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50, #66bb6a); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Add Customer</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('customerName').focus();
            
            // Initialize date dropdowns with default values (30 days from today)
            initializeDateDropdowns();
            
            // Initialize device selection business rules
            updateDeviceSelection();
            
            // Initialize Plex library preview
            updatePlexAccessPreview();
            
            // Handle form submission
            modal.querySelector('#customerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('customerName').value;
                const phone = document.getElementById('customerPhone').value;
                const plan = document.getElementById('customerPlan').value;
                const password = document.getElementById('customerPassword').value;
                
                // Get subscription end date
                const endMonth = document.getElementById('endMonth').value;
                const endDate = document.getElementById('endDate').value;
                const endYear = document.getElementById('endYear').value;
                
                // Get selected addons
                const selectedAddons = Array.from(document.querySelectorAll('input[name="customerAddons"]:checked'))
                    .map(checkbox => checkbox.value);
                
                // Get selected devices
                const selectedDevices = Array.from(document.querySelectorAll('input[name="customerDevices"]:checked'))
                    .map(checkbox => checkbox.value);
                
                // Validate business rules
                if (selectedDevices.includes('secondTV') && !selectedDevices.includes('basicTV')) {
                    showError('2nd TV can only be added after Basic TV Package is selected');
                    return;
                }
                if (selectedDevices.includes('thirdTV') && !selectedDevices.includes('secondTV')) {
                    showError('3rd TV can only be added after 2nd TV is selected');
                    return;
                }
                
                if (!name || !plan || !password || !endMonth || !endDate || !endYear) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                // Create subscription end date from selected values
                const subscriptionEndDate = new Date(parseInt(endYear), parseInt(endMonth) - 1, parseInt(endDate));
                const formattedEndDate = subscriptionEndDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                const newCustomer = {
                    id: 'customer_' + Date.now(),
                    name: name,
                    phone: phone,
                    plan: plan,
                    addons: selectedAddons,
                    devices: selectedDevices,
                    password: password,
                    status: 'Active',
                    avatar: name.charAt(0).toUpperCase(),
                    createdAt: new Date().toLocaleDateString(),
                    endDate: formattedEndDate // YYYY-MM-DD format from user selection
                };
                
                window.adminUsers.push(newCustomer);
                saveAdminCustomers();
                
                closeCustomerModal();
                showUsersSection(); // Refresh the user list to show new customer
                initializePackages(); // Refresh package list for forms
                
                let message = `New customer "${name}" added successfully!\nPlan: ${plan}/month\nPassword: ${password}`;
                if (phone) {
                    message += `\nPhone: ${phone}`;
                }
                if (selectedAddons.length > 0) {
                    message += `\nAddons: ${selectedAddons.join(', ')} (+$${selectedAddons.reduce((total, addonName) => {
                        const addon = window.addons.find(a => a.name === addonName);
                        return total + (addon ? addon.price : 0);
                    }, 0)}/month)`;
                }
                
                showSuccess(message);
            });
            
            // Handle click outside modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeCustomerModal();
                }
            });
        }
        
        function closeCustomerModal() {
            const modal = document.querySelector('div[style*="z-index: 10001"]');
            if (modal) {
                modal.remove();
            }
        }
        
        // Package Management Functions
        function initializePackages() {
            // Clear old cached package data to prevent conflicts
            localStorage.removeItem('adminPackages');
            localStorage.removeItem('adminPackagesForReseller');
            localStorage.removeItem('packagesUpdated');
            
            // Initialize with only Basic TV Package
            window.packages = [
                {
                    id: 'basic_tv',
                    name: 'Basic TV Package',
                    description: 'Core TV channels and basic entertainment - REQUIRED FIRST',
                    price: 25.00,
                    required: true,
                    status: 'active',
                    type: 'basic',
                    features: ['100+ channels', 'HD quality', 'Basic sports', 'Local news']
                }
            ];
            console.log('üì¶ ADMIN: Packages initialized with only Basic TV Package');
            
            // Immediately save the initial state for reseller sync
            savePackages();
            console.log('üì¶ ADMIN: Packages initialized and saved');
        }
        
        function savePackages() {
            try {
                localStorage.setItem('adminPackages', JSON.stringify(window.packages));
                // Save packages in the format reseller expects: { packages: [...] }
                localStorage.setItem('adminPackagesForReseller', JSON.stringify({ packages: window.packages }));
                
                // Trigger real-time synchronization for reseller panels
                localStorage.setItem('packagesUpdated', Date.now().toString());
                localStorage.setItem('syncNotification', JSON.stringify({
                    type: 'packages_updated',
                    timestamp: Date.now(),
                    packages: window.packages.length
                }));
                
                console.log('üì¶ ADMIN: Packages saved and synced to reseller panels');
                
                // Show success feedback
                showSuccess(`Packages saved and synchronized (${window.packages.length} packages)`);
                
            } catch (e) {
                console.error('Error saving packages:', e);
                showError('Failed to save packages');
            }
        }
        
        // Debug Function to Force Save All Packages
        function debugSaveAllPackages() {
            console.log('üîç DEBUG: Force saving all packages...');
            console.log('Current packages count:', window.packages ? window.packages.length : 0);
            
            if (window.packages && window.packages.length > 0) {
                console.log('üì¶ DEBUG: Packages to save:', window.packages.map(p => `${p.name}(${p.type})`));
                savePackages();
                
                // Also show what's in localStorage
                const saved = localStorage.getItem('adminPackages');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        console.log('‚úÖ DEBUG: localStorage contains', parsed.length, 'packages');
                        console.log('DEBUG: Package types:', parsed.map(p => `${p.type}:${p.name}`));
                        showSuccess(`üîç DEBUG: Force saved ${parsed.length} packages (check console)`);
                    } catch (e) {
                        console.error('‚ùå DEBUG: Error parsing saved packages:', e);
                        showError('‚ùå DEBUG: Error with saved packages');
                    }
                }
            } else {
                console.log('‚ö†Ô∏è DEBUG: No packages to save, re-initializing...');
                initializePackages();
                savePackages();
                showSuccess('üîç DEBUG: Re-initialized and saved packages');
            }
        }
        
        function generatePackageList() {
            if (!window.packages || window.packages.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 12px;">üì¶ No packages found. Click "Add Package" to get started.</div>';
            }
            
            return window.packages.map(pkg => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <h4 style="color: white; margin: 0 0 5px 0; font-size: 14px;">${pkg.name}</h4>
                        <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 12px;">$${pkg.price}/month</p>
                    </div>
                    <div>
                        <button onclick="editPackage('${pkg.id}')" style="background: var(--admin-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-right: 5px;">Edit</button>
                        <button onclick="deletePackage('${pkg.id}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function generatePackageOptions() {
            if (!window.packages || window.packages.length === 0) {
                return '<option value="">No packages available</option>';
            }
            
            return window.packages.map(pkg => {
                const libraries = packageLibraryMapper.getLibrariesForPackage(pkg.id);
                let libraryInfo = '';
                
                if (libraries && libraries.length > 0) {
                    const libraryNames = libraries.map(libId => {
                        // Find the library details
                        const allLibraries = plexLibraryManager.getAllLibraries();
                        const lib = allLibraries.find(l => l.serverId + '_' + l.id === libId);
                        return lib ? lib.name : 'Unknown Library';
                    });
                    
                    libraryInfo = libraryNames.length > 0 ? ` (${libraryNames.join(', ')})` : '';
                }
                
                return `<option value="${pkg.id}">${pkg.name} - $${pkg.price}/month${libraryInfo}</option>`;
            }).join('');
        }
        
        function generateEditPackageOptions(currentPlan) {
            // For editing customer, show their current package as locked and only Basic TV Package as editable option
            const currentDisabled = `<option value="${currentPlan}" disabled selected>${currentPlan} (Current - Locked)</option>`;
            const basicOption = currentPlan !== 'Basic TV Package' ? '<option value="Basic TV Package">Basic TV Package (Add New)</option>' : '';
            
            return currentDisabled + basicOption;
        }
        
        // Update Plex Library Access Preview
        function updatePlexAccessPreview() {
            const preview = document.getElementById('plexAccessPreview');
            if (!preview) return;
            
            const selectedPlan = document.getElementById('customerPlan')?.value;
            const selectedAddons = Array.from(document.querySelectorAll('input[name="customerAddons"]:checked'))
                .map(cb => cb.value);
            
            if (!selectedPlan) {
                preview.innerHTML = `
                    <div style="color: rgba(255,255,255,0.7); font-size: 14px; text-align: center; padding: 20px;">
                        üì∫ Select a plan to see available Plex libraries
                    </div>
                `;
                return;
            }
            
            // Get selected packages and addons
            const selectedPackageIds = [selectedPlan];
            selectedAddons.forEach(addonName => {
                const addon = window.addons.find(a => a.name === addonName);
                if (addon) {
                    selectedPackageIds.push(addon.id);
                }
            });
            
            // Get all libraries that will be accessible
            const accessibleLibraries = [];
            selectedPackageIds.forEach(packageId => {
                const mappedLibraries = packageLibraryMapper.getLibrariesForPackage(packageId);
                mappedLibraries.forEach(libId => {
                    if (!accessibleLibraries.some(lib => lib === libId)) {
                        accessibleLibraries.push(libId);
                    }
                });
            });
            
            if (accessibleLibraries.length === 0) {
                preview.innerHTML = `
                    <div style="color: rgba(255,193,7,0.9); font-size: 14px; text-align: center; padding: 20px;">
                        ‚ö†Ô∏è This package doesn't include Plex library access. Add Plex servers and map libraries to packages first.
                    </div>
                `;
                return;
            }
            
            // Get library details
            const allLibraries = plexLibraryManager.getAllLibraries();
            const accessibleLibraryDetails = accessibleLibraries.map(libId => {
                return allLibraries.find(lib => lib.serverId + '_' + lib.id === libId);
            }).filter(Boolean);
            
            // Group by server for better display
            const servers = {};
            accessibleLibraryDetails.forEach(lib => {
                if (!servers[lib.serverName]) {
                    servers[lib.serverName] = [];
                }
                servers[lib.serverName].push(lib);
            });
            
            let previewHTML = '';
            Object.keys(servers).forEach(serverName => {
                const libraries = servers[serverName];
                previewHTML += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #64b5f6; margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">üì° ${serverName}</h4>
                        ${libraries.map(lib => `
                            <div style="display: flex; align-items: center; margin-bottom: 6px; padding-left: 10px;">
                                <span style="margin-right: 8px; font-size: 16px;">
                                    ${lib.isAdult ? 'üîû' : 'üì∫'}
                                </span>
                                <span style="color: rgba(255,255,255,0.9); font-size: 13px;">${lib.name}</span>
                                <span style="margin-left: auto; color: rgba(255,255,255,0.5); font-size: 11px;">(${lib.type})</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            preview.innerHTML = previewHTML;
        }
        
        function generateAddonOptions() {
            if (!window.addons || window.addons.length === 0) {
                return '<div style="color: rgba(255,255,255,0.5); font-size: 12px; text-align: center;">No addons available</div>';
            }
            
            return window.addons.map(addon => `
                <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" name="customerAddons" value="${addon.name}" onchange="updatePriceCalculation(); updatePlexAccessPreview()" style="margin-right: 8px;">
                    <span style="color: white; font-size: 14px;">${addon.name}</span>
                    <span style="margin-left: auto; color: rgba(255,255,255,0.7); font-size: 12px;">+$${addon.price}/month</span>
                </label>
            `).join('');
        }
        
        function generateEditAddonOptions(selectedAddons = []) {
            if (!window.addons || window.addons.length === 0) {
                return '<div style="color: rgba(255,255,255,0.5); font-size: 12px; text-align: center;">No addons available</div>';
            }
            
            return window.addons.map(addon => {
                // More robust matching - handle case-insensitive and trim spaces
                const isCurrentAddon = selectedAddons.some(selected => 
                    selected.trim().toLowerCase() === addon.name.trim().toLowerCase()
                );
                
                return `
                    <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: ${isCurrentAddon ? 'not-allowed' : 'pointer'};">
                        <input type="checkbox" name="editCustomerAddons" value="${addon.name}" ${isCurrentAddon ? 'checked disabled' : ''} onchange="updatePriceCalculation(); updatePlexAccessPreview()" style="margin-right: 8px;">
                        <span style="color: ${isCurrentAddon ? 'rgba(255,255,255,0.6)' : 'white'}; font-size: 14px;">${addon.name} ${isCurrentAddon ? '(Current - Locked)' : '(Available to Add)'}</span>
                        <span style="margin-left: auto; color: ${isCurrentAddon ? 'rgba(255,255,255,0.6)' : 'rgba(255,255,255,0.7)'}; font-size: 12px;">+$${addon.price}/month</span>
                    </label>
                `;
            }).join('');
        }
        
        // Addon Management Functions
        function initializeAddons() {
            const saved = localStorage.getItem('adminAddons');
            if (saved) {
                try {
                    window.addons = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading addons:', e);
                    window.addons = [];
                }
            } else {
                window.addons = [];
            }
        }
        
        function saveAddons() {
            try {
                localStorage.setItem('adminAddons', JSON.stringify(window.addons));
            } catch (e) {
                console.error('Error saving addons:', e);
            }
        }
        
        function saveContentLibrary() {
            try {
                localStorage.setItem('adminContentLibrary', JSON.stringify(window.contentLibrary));
                console.log('‚úÖ Content library saved (Plex, VOD, Channels, TV Platforms)');
            } catch (e) {
                console.error('Error saving content library:', e);
            }
        }
        
        function generateAddonList() {
            if (!window.addons || window.addons.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 12px;">üîß No addons found. Click "Add Addon" to get started.</div>';
            }
            
            return window.addons.map(addon => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <h4 style="color: white; margin: 0 0 5px 0; font-size: 14px;">${addon.name}</h4>
                        <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 12px;">$${addon.price}/month</p>
                    </div>
                    <div>
                        <button onclick="editAddon('${addon.id}')" style="background: #ff9800; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-right: 5px;">Edit</button>
                        <button onclick="deleteAddon('${addon.id}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Add Package Function
        function addNewPackage() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            // Get available Plex libraries
            const availableLibraries = plexLibraryManager.getAllLibraries();
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: white; margin-bottom: 20px; text-align: center;">üì¶ Add New Package</h3>
                    
                    <form id="packageForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Package Name *</label>
                            <input type="text" id="packageName" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;" placeholder="e.g., Starter Plan">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Monthly Price ($) *</label>
                            <input type="number" id="packagePrice" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;" placeholder="0.00" min="0" step="0.01">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Description</label>
                            <textarea id="packageDescription" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px; resize: vertical; height: 80px;" placeholder="Package description..."></textarea>
                        </div>
                        
                        ${availableLibraries.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; color: white; font-size: 14px; font-weight: 600;">
                                üìö Plex Libraries Access (Optional)
                            </label>
                            <div style="max-height: 120px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 10px; background: rgba(255,255,255,0.05);">
                                ${availableLibraries.map(lib => `
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <input type="checkbox" id="plexLibrary_${lib.serverId}_${lib.id}" value="${lib.serverId}_${lib.id}" style="margin-right: 8px; cursor: pointer;">
                                        <label for="plexLibrary_${lib.serverId}_${lib.id}" style="color: rgba(255,255,255,0.9); font-size: 13px; cursor: pointer; flex: 1;">
                                            ${lib.serverName} - ${lib.name}
                                            ${lib.isAdult ? '<span style="color: #ff5722; font-size: 11px;">(18+)</span>' : ''}
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                            <small style="color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 5px; display: block;">
                                Select Plex libraries that customers with this package can access
                            </small>
                        </div>
                        ` : `
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 6px;">
                            <div style="color: #ffc107; font-size: 13px; text-align: center;">
                                ‚ö†Ô∏è No Plex libraries found. Add Plex servers first in the Content section.
                            </div>
                        </div>
                        `}
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="closePackageModal()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-weight: 500; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 10px; background: var(--admin-color); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 14px;">Add Package</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('packageName').focus();
            
            modal.querySelector('#packageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('packageName').value;
                const price = parseFloat(document.getElementById('packagePrice').value);
                const description = document.getElementById('packageDescription').value;
                
                if (!name || price <= 0) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                // Determine package type based on price
                let packageType = 'addon';
                let requiresBasic = true; // Most add-ons require basic TV
                let features = ['Custom package', 'Added by admin'];
                
                // Auto-categorize based on price ranges
                if (price <= 15) {
                    packageType = 'addon';
                } else if (price <= 25) {
                    packageType = 'addon'; 
                } else {
                    packageType = 'addon';
                }
                
                // Get selected Plex libraries
                const selectedLibraries = [];
                const checkboxes = this.querySelectorAll('input[type="checkbox"][id^="plexLibrary_"]:checked');
                checkboxes.forEach(checkbox => {
                    const [serverId, libraryId] = checkbox.value.split('_');
                    selectedLibraries.push({
                        serverId: serverId,
                        libraryId: libraryId,
                        fullId: `${serverId}_${libraryId}`
                    });
                });
                
                const newPackage = {
                    id: 'pkg_' + Date.now(),
                    name: name,
                    description: description || `Custom ${name} package - BASIC REQUIRED`,
                    price: price,
                    required: false,
                    status: 'active',
                    type: packageType,
                    features: features,
                    requiresBasic: requiresBasic,
                    plexLibraries: selectedLibraries.map(lib => lib.fullId),
                    createdAt: new Date().toLocaleDateString()
                };
                
                // Map package to Plex libraries
                if (selectedLibraries.length > 0) {
                    const libraryIds = selectedLibraries.map(lib => lib.fullId);
                    packageLibraryMapper.mapPackageToLibraries(newPackage.id, libraryIds);
                }
                
                window.packages.push(newPackage);
                savePackages();
                
                closePackageModal();
                showPackagesSection();
                
                if (selectedLibraries.length > 0) {
                    showSuccess(`Package "${name}" added successfully! Mapped to ${selectedLibraries.length} Plex libraries.`);
                } else {
                    showSuccess(`Package "${name}" added successfully!`);
                }
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePackageModal();
                }
            });
        }
        
        function closePackageModal() {
            const modal = document.querySelector('div[style*="z-index: 10001"]');
            if (modal) {
                modal.remove();
            }
        }
        
        // Add Addon Function
        function addNewAddon() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); width: 400px;">
                    <h3 style="color: white; margin-bottom: 20px; text-align: center;">üîß Add New Addon</h3>
                    
                    <form id="addonForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Addon Name *</label>
                            <input type="text" id="addonName" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;" placeholder="e.g., Sports Package">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Monthly Price ($) *</label>
                            <input type="number" id="addonPrice" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;" placeholder="0.00" min="0" step="0.01">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="closeAddonModal()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-weight: 500; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 10px; background: #ff9800; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 14px;">Add Addon</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('addonName').focus();
            
            modal.querySelector('#addonForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('addonName').value;
                const price = parseFloat(document.getElementById('addonPrice').value);
                
                if (!name || price <= 0) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                const newAddon = {
                    id: 'addon_' + Date.now(),
                    name: name,
                    price: price,
                    type: 'addon',
                    createdAt: new Date().toLocaleDateString()
                };
                
                window.addons.push(newAddon);
                saveAddons();
                
                closeAddonModal();
                showPackagesSection();
                showSuccess(`Addon "${name}" added successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeAddonModal();
                }
            });
        }
        
        function closeAddonModal() {
            const modal = document.querySelector('div[style*="z-index: 10001"]');
            if (modal) {
                modal.remove();
            }
        }
        
        // Device Pricing Functions
        function initializeDevicePricing() {
            const saved = localStorage.getItem('devicePricing');
            if (saved) {
                try {
                    window.devicePricing = JSON.parse(saved);
                    // Remove firstTV if it exists (legacy data)
                    if (window.devicePricing.firstTV !== undefined) {
                        delete window.devicePricing.firstTV;
                        saveDevicePricing();
                    }
                } catch (e) {
                    console.error('Error loading device pricing:', e);
                    window.devicePricing = {
                        secondTV: 0,
                        thirdTV: 0
                    };
                }
            } else {
                window.devicePricing = {
                    secondTV: 0,
                    thirdTV: 0
                };
            }
        }
        
        function saveDevicePricing() {
            try {
                localStorage.setItem('devicePricing', JSON.stringify(window.devicePricing));
            } catch (e) {
                console.error('Error saving device pricing:', e);
            }
        }
        
        function editDevicePrice(deviceType) {
            const labels = {
                secondTV: '2nd TV', 
                thirdTV: '3rd TV'
            };
            
            if (!labels[deviceType]) {
                showError('Invalid device type');
                return;
            }
            
            const currentPrice = window.devicePricing[deviceType] || 0;
            const newPrice = prompt(`Set price for ${labels[deviceType]}:\n\nCurrent: $${currentPrice}/month\n\nEnter new price:`, currentPrice);
            
            if (newPrice !== null) {
                const price = parseFloat(newPrice);
                if (!isNaN(price) && price >= 0) {
                    window.devicePricing[deviceType] = price;
                    saveDevicePricing();
                    showPackagesSection();
                    showSuccess(`${labels[deviceType]} price updated to $${price}/month`);
                } else {
                    showError('Please enter a valid price');
                }
            }
        }
        
        function deletePackage(packageId) {
            const pkg = window.packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            if (confirm(`Are you sure you want to delete package "${pkg.name}"?`)) {
                window.packages = window.packages.filter(p => p.id !== packageId);
                savePackages();
                showPackagesSection();
                showSuccess(`Package "${pkg.name}" deleted`);
            }
        }
        
        function deleteAddon(addonId) {
            const addon = window.addons.find(a => a.id === addonId);
            if (!addon) return;
            
            if (confirm(`Are you sure you want to delete addon "${addon.name}"?`)) {
                window.addons = window.addons.filter(a => a.id !== addonId);
                saveAddons();
                showPackagesSection();
                showSuccess(`Addon "${addon.name}" deleted`);
            }
        }
        
        function editPackage(packageId) {
            const pkg = window.packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); width: 400px;">
                    <h3 style="color: white; margin-bottom: 20px; text-align: center;">‚úèÔ∏è Edit Package</h3>
                    
                    <form id="editPackageForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Package Name *</label>
                            <input type="text" id="editPackageName" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;" value="${pkg.name}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Monthly Price ($) *</label>
                            <input type="number" id="editPackagePrice" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;" value="${pkg.price}" min="0" step="0.01">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="closeEditPackageModal()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-weight: 500; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 10px; background: var(--admin-color); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 14px;">Update Package</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('editPackageName').focus();
            
            modal.querySelector('#editPackageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('editPackageName').value;
                const price = parseFloat(document.getElementById('editPackagePrice').value);
                
                if (!name || price <= 0) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                pkg.name = name;
                pkg.price = price;
                pkg.updatedAt = new Date().toLocaleDateString();
                
                savePackages();
                
                closeEditPackageModal();
                showPackagesSection();
                showSuccess(`Package "${name}" updated successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeEditPackageModal();
                }
            });
        }
        
        function closeEditPackageModal() {
            const modal = document.querySelector('div[style*="z-index: 10001"]');
            if (modal) {
                modal.remove();
            }
        }
        
        function editAddon(addonId) {
            const addon = window.addons.find(a => a.id === addonId);
            if (!addon) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); width: 400px;">
                    <h3 style="color: white; margin-bottom: 20px; text-align: center;">‚úèÔ∏è Edit Addon</h3>
                    
                    <form id="editAddonForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Addon Name *</label>
                            <input type="text" id="editAddonName" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;" value="${addon.name}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: white; font-size: 14px;">Monthly Price ($) *</label>
                            <input type="number" id="editAddonPrice" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;" value="${addon.price}" min="0" step="0.01">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="closeEditAddonModal()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-weight: 500; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button type="submit" style="flex: 1; padding: 10px; background: #ff9800; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 14px;">Update Addon</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('editAddonName').focus();
            
            modal.querySelector('#editAddonForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('editAddonName').value;
                const price = parseFloat(document.getElementById('editAddonPrice').value);
                
                if (!name || price <= 0) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                addon.name = name;
                addon.price = price;
                addon.updatedAt = new Date().toLocaleDateString();
                
                saveAddons();
                
                closeEditAddonModal();
                showPackagesSection();
                showSuccess(`Addon "${name}" updated successfully!`);
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeEditAddonModal();
                }
            });
        }
        
        function closeEditAddonModal() {
            const modal = document.querySelector('div[style*="z-index: 10001"]');
            if (modal) {
                modal.remove();
            }
        }
        
        function deleteCustomer(username) {
            if (confirm(`Are you sure you want to delete customer "${username}"? This action cannot be undone.`)) {
                showSuccess(`Customer "${username}" has been deleted`);
            }
        }
        
        function suspendCustomer(username) {
            if (confirm(`Suspend customer "${username}"?`)) {
                showSuccess(`Customer "${username}" has been suspended`);
            }
        }
        
        function viewCustomerDetails(username) {
            alert(`Customer Details: ${username}\n\nStatus: Active\nPlan: Premium\nDevices: 3/4\nLast Login: 2025-11-12\nSubscription: Until 2025-12-12\nRevenue: $29.99/month`);
        }
        
        // Initialize customer data from localStorage
        function initializeAdminCustomers() {
            const saved = localStorage.getItem('adminCustomers');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Convert to the format expected by the code
                    window.adminUsers = parsed;
                } catch (e) {
                    console.error('Error parsing saved customers:', e);
                    window.adminUsers = [];
                }
            } else {
                window.adminUsers = [];
            }
        }
        
        // Save customers to localStorage
        function saveAdminCustomers() {
            try {
                localStorage.setItem('adminCustomers', JSON.stringify(window.adminUsers));
            } catch (e) {
                console.error('Error saving customers:', e);
            }
        }
        
        // Enhanced Credit Management System - UNLIMITED TRANSFERS & BUSINESS WORKFLOW
        const creditSystem = {
            resellerCredits: {},
            transactionHistory: [],
            resellerInfo: {}, // Store reseller details and settings
            
            initializeCredits: function() {
                // Load existing reseller wallet data (simple number format)
                const savedWallet = localStorage.getItem('resellerWallet');
                if (savedWallet) {
                    try {
                        const balance = parseFloat(savedWallet);
                        this.resellerCredits = { 'reseller': balance || 0 };
                    } catch (e) {
                        console.error('Error loading reseller wallet:', e);
                        this.resellerCredits = { 'reseller': 0 };
                    }
                } else {
                    this.resellerCredits = { 'reseller': 0 };
                }
                
                // Load transaction history
                const savedTransactions = localStorage.getItem('creditTransactions');
                if (savedTransactions) {
                    try {
                        this.transactionHistory = JSON.parse(savedTransactions);
                    } catch (e) {
                        console.error('Error loading transactions:', e);
                        this.transactionHistory = [];
                    }
                } else {
                    this.transactionHistory = [];
                }
                
                console.log('Credits system initialized - loaded existing data');
            },
            
            saveCredits: function() {
                // Save all reseller credits in structured format
                Object.keys(this.resellerCredits).forEach(resellerId => {
                    const balance = this.resellerCredits[resellerId];
                    localStorage.setItem(`resellerWallet_${resellerId}`, balance.toFixed(2));
                });
                
                localStorage.setItem('creditTransactions', JSON.stringify(this.transactionHistory));
                localStorage.setItem('resellerCredits', JSON.stringify(this.resellerCredits));
                localStorage.setItem('resellerInfo', JSON.stringify(this.resellerInfo));
                
                console.log('üí≥ ADMIN: Enhanced credit system saved for all resellers');
                
                // Trigger reseller panel sync
                localStorage.setItem('packagesUpdated', Date.now().toString());
            },
            
            getRequiredBasicPackage: function() {
                return 'basic_tv'; // The basic package ID that must be sold first
            },
            
            validateSale: function(selectedPackages, selectedAddons = []) {
                const requiredBasic = this.getRequiredBasicPackage();
                const hasBasic = selectedPackages.includes(requiredBasic);
                
                if (!hasBasic) {
                    return {
                        valid: false,
                        message: '‚ùå Basic TV Package must be sold first before any add-ons or additional TV packages',
                        missing: 'Basic TV Package'
                    };
                }
                
                // Check if any additional packages require basic (they should by design)
                const additionalPackages = selectedPackages.filter(pkg => pkg !== requiredBasic);
                if (additionalPackages.length > 0 && !hasBasic) {
                    return {
                        valid: false,
                        message: '‚ùå Additional packages require Basic TV Package',
                        missing: 'Basic TV Package'
                    };
                }
                
                return { valid: true, message: '‚úÖ Sale is valid' };
            },
            
            calculateSaleCost: function(selectedPackages, selectedAddons = []) {
                let totalCost = 0;
                
                // Calculate package costs
                selectedPackages.forEach(packageId => {
                    const pkg = window.packages.find(p => p.id === packageId);
                    if (pkg) {
                        totalCost += pkg.price;
                    }
                });
                
                // Calculate addon costs
                selectedAddons.forEach(addonId => {
                    const addon = window.addons.find(a => a.id === addonId);
                    if (addon) {
                        totalCost += addon.price;
                    }
                });
                
                return totalCost;
            },
            
            // ENHANCED TRANSFER - Create reseller profile if doesn't exist
            transferCredit: function(resellerId, amount, description = 'Credit Transfer', resellerName = '') {
                amount = parseFloat(amount);
                if (isNaN(amount) || amount <= 0) {
                    return { success: false, message: 'Invalid amount' };
                }
                
                if (!resellerId || resellerId.trim() === '') {
                    return { success: false, message: 'Reseller ID is required' };
                }
                
                if (!this.resellerCredits[resellerId]) {
                    this.resellerCredits[resellerId] = 0;
                    
                    // Create reseller profile if new
                    this.resellerInfo[resellerId] = {
                        name: resellerName || resellerId,
                        createdAt: new Date().toISOString(),
                        totalTransferred: 0,
                        totalSales: 0,
                        status: 'active'
                    };
                }
                
                // UNLIMITED TRANSFER - Direct credit addition
                this.resellerCredits[resellerId] += amount;
                this.resellerInfo[resellerId].totalTransferred += amount;
                
                // Log transaction
                const transaction = {
                    id: 'TXN' + Date.now(),
                    type: 'transfer',
                    from: 'admin',
                    to: resellerId,
                    amount: amount,
                    description: description,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString()
                };
                this.transactionHistory.unshift(transaction);
                
                this.saveCredits();
                return { success: true, message: `Successfully transferred $${amount} to ${resellerId}` };
            },
            
            getResellerBalance: function(resellerId) {
                return this.resellerCredits[resellerId] || 0;
            }
        };
        
        // Force clear demo data immediately
        creditSystem.initializeCredits();
        
        function showCreditSection() {
            const mainContent = document.querySelector('.admin-main');
            const resellerList = Object.keys(creditSystem.resellerCredits).map(resellerId => {
                const balance = creditSystem.getResellerBalance(resellerId);
                return `
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="color: white; margin: 0 0 5px 0;">${resellerId}</h4>
                            <p style="color: rgba(255,255,255,0.7); margin: 0;">Current Balance: $${balance}</p>
                        </div>
                        <div>
                            <button onclick="transferCreditModal('${resellerId}')" style="background: var(--admin-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">Transfer</button>
                            <button onclick="viewCreditHistory('${resellerId}')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">History</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üí≥ Credit Manager</h1>
                    <p class="dashboard-subtitle">Unlimited transfers to reseller wallets</p>
                </div>
                
                <!-- Transfer Control Card -->
                <div style="background: linear-gradient(135deg, #2c3e50, #34495e); border-radius: 12px; padding: 25px; margin-bottom: 30px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">
                    <h3 style="color: white; margin-bottom: 10px;">üí∞ Credit Transfer System</h3>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--admin-color); margin-bottom: 15px;">Unlimited Transfers</div>
                    <button onclick="transferCreditModal()" style="background: var(--admin-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">üí≥ Transfer to Reseller</button>
                </div>
                
                <!-- Reseller Credits -->
                <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 25px;">
                    <h3 style="color: white; margin-bottom: 20px;">üè¢ Reseller Credits</h3>
                    ${resellerList || '<p style="color: rgba(255,255,255,0.7);">No resellers found. Make your first transfer to create a reseller account.</p>'}
                </div>
                
                <!-- Recent Transactions -->
                <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 25px; margin-top: 30px;">
                    <h3 style="color: white; margin-bottom: 20px;">üìä Recent Transactions</h3>
                    ${generateCreditTransactions()}
                </div>
            `;
        }
        
        function generateCreditTransactions() {
            if (creditSystem.transactionHistory.length === 0) {
                return '<p style="color: rgba(255,255,255,0.7);">No transactions yet</p>';
            }
            
            return creditSystem.transactionHistory.slice(0, 10).map(tx => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="color: white; font-weight: 500;">${tx.description}</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${tx.date}</div>
                    </div>
                    <div style="color: #4caf50; font-weight: 600;">
                        +$${tx.amount}
                    </div>
                </div>
            `).join('');
        }
        
        function transferCreditModal(resellerId = 'reseller') {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #2c3e50, #34495e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 400px;">
                    <h2 style="color: white; margin-bottom: 20px; text-align: center;">üí≥ Transfer Credit</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="color: white; display: block; margin-bottom: 8px;">Reseller ID *</label>
                        <input type="text" id="transferResellerId" value="${resellerId}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;" placeholder="reseller" required>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="color: white; display: block; margin-bottom: 8px;">Amount ($) *</label>
                        <input type="number" id="transferAmount" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;" placeholder="Enter amount" value="" min="0.01" step="0.01" required>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="color: white; display: block; margin-bottom: 8px;">Description</label>
                        <input type="text" id="transferDescription" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;" placeholder="Optional description">
                    </div>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <span style="color: rgba(255,255,255,0.7);">Transfer Type: </span>
                        <span style="color: var(--admin-color); font-weight: 600;">Unlimited</span>
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <button onclick="confirmTransfer()" style="flex: 1; background: var(--admin-color); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 500;">Transfer</button>
                        <button onclick="closeModal()" style="flex: 1; background: rgba(255,255,255,0.2); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            
            // Store modal reference globally for confirmTransfer function
            window.currentTransferModal = modal;
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('transferAmount').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') confirmTransfer();
            });
            
            // Focus on first input
            document.getElementById('transferResellerId').focus();
        }
        
        function confirmTransfer() {
            const resellerId = document.getElementById('transferResellerId').value.trim();
            const amount = document.getElementById('transferAmount').value;
            const description = document.getElementById('transferDescription').value || 'Credit Transfer';
            
            console.log('üí≥ ADMIN: Transfer initiated - Reseller: ' + resellerId + ', Amount: $' + amount + ', Description: ' + description);
            
            if (!resellerId) {
                alert('Please enter reseller ID');
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            const result = creditSystem.transferCredit(resellerId, amount, description);
            
            if (result.success) {
                console.log('üí≥ ADMIN: Transfer completed successfully - ' + result.message);
                alert(result.message);
                closeModal();
                showCreditSection(); // Refresh the section
            } else {
                console.log('üí≥ ADMIN: Transfer failed - ' + result.message);
                alert('Error: ' + result.message);
            }
        }
        
        function viewCreditHistory(resellerId) {
            const transactions = creditSystem.transactionHistory.filter(tx => tx.to === resellerId || tx.from === resellerId);
            
            if (transactions.length === 0) {
                alert(`No transactions found for ${resellerId}`);
                return;
            }
            
            const historyText = transactions.slice(0, 20).map(tx => 
                `[${tx.date}] ${tx.description} - $${tx.amount}`
            ).join('\n');
            
            alert(`Credit History for ${resellerId}:\n\n${historyText}`);
        }
        
        // Transfer modal close functionality moved to showTransferModal function
        
        // Check login status on page load
        window.addEventListener('load', function() {
            console.log('üîß Initializing admin panel...');
            
            // Initialize password manager
            if (typeof passwordManager !== 'undefined') {
                passwordManager.initialize();
                console.log('‚úÖ Password manager initialized');
            } else {
                console.error('‚ùå Password manager not found');
            }
            
            initializeAdminCustomers();
            initializePackages();
            initializeAddons();
            initializeDevicePricing();
            creditSystem.initializeCredits();
            showLogin();
            
            // Force refresh users display after data is loaded
            setTimeout(() => {
                refreshUsersDisplay();
            }, 100);
            
            console.log('‚úÖ Admin panel initialized complete');
            
            // Initialize adult content access system
            initializeAdultContentAccess();
        });
    </script>
    
    <!-- Login Modal -->
    <div id="adminOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; backdrop-filter: blur(10px);">
        <div id="loginModal" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 400px; text-align: center;">
            <h2 style="color: white; margin-bottom: 30px; font-size: 24px;">üîê Admin Login</h2>
            <input type="text" name="username" id="adminUsername" autocomplete="username" placeholder="Username" required style="width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
            <input type="password" name="password" id="adminPassword" autocomplete="current-password" placeholder="Password" required style="width: 100%; padding: 12px; margin-bottom: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;" onkeypress="if(event.key==='Enter'){adminLogin()}">
            <button onclick="adminLogin()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #4caf50, #66bb6a); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; margin-bottom: 10px;">Login</button>
        </div>
    </div>
    
    <!-- No Flash Navigation -->
    <div class="admin-header-top" style="position: fixed; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); padding: 15px; z-index: 999; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: white; font-weight: 600;">üîß Admin Panel - iWATCH TV</div>
        <div>
            <span id="adminUserInfo" style="color: rgba(255,255,255,0.7); margin-right: 15px;"></span>
            <button onclick="logout()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Logout</button>
        </div>
    </div>




<body style="padding-top: 60px;">

<script>
// Load existing reseller wallet data on page load
creditSystem.initializeCredits();
showCreditSection(); // Initialize credit section with loaded data

// PWA Service Worker Registration
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show install button or banner
    showInstallBanner();
});

window.addEventListener('appinstalled', () => {
    console.log('PWA was installed');
    hideInstallBanner();
});

function showInstallBanner() {
    const banner = document.createElement('div');
    banner.id = 'install-banner';
    banner.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; background: #4caf50; color: white; padding: 10px; text-align: center; z-index: 10000; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
            <span>üì± Install iWATCH Admin App</span>
            <div>
                <button onclick="installApp()" style="background: white; color: #4caf50; border: none; padding: 5px 10px; border-radius: 4px; margin-right: 5px; font-weight: bold;">Install</button>
                <button onclick="hideInstallBanner()" style="background: transparent; color: white; border: 1px solid white; padding: 5px 10px; border-radius: 4px;">√ó</button>
            </div>
        </div>
    `;
    document.body.appendChild(banner);
    
    // Adjust body padding to account for banner
    document.body.style.paddingTop = '50px';
}

function hideInstallBanner() {
    const banner = document.getElementById('install-banner');
    if (banner) {
        banner.remove();
        document.body.style.paddingTop = '0';
    }
}

function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }
            deferredPrompt = null;
            hideInstallBanner();
        });
    } else {
        // Fallback for browsers that don't support the prompt
        alert('To install this app on your phone:\n\n1. Open browser menu (‚ãÆ)\n2. "Add to Home Screen" or "Install App"\n3. Confirm installation');
    }
}

// Silent background Plex server connectivity testing
function testPlexServer(server, timeout = 5000) {
    return new Promise((resolve) => {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        fetch(`${server.url}/?X-Plex-Token=${server.token}`, {
            method: 'HEAD',
            signal: controller.signal,
            mode: 'no-cors'
        })
        .then(() => {
            clearTimeout(timeoutId);
            resolve({ online: true, server: server.name });
        })
        .catch(() => {
            clearTimeout(timeoutId);
            resolve({ online: false, server: server.name });
        });
    });
}

async function backgroundPlexHealthCheck() {
    if (!window.contentLibrary || !window.contentLibrary.plex) return;
    
    const promises = window.contentLibrary.plex.map(server => testPlexServer(server));
    const results = await Promise.all(promises);
    
    results.forEach(result => {
        const serverIndex = window.contentLibrary.plex.findIndex(s => s.name === result.server);
        if (serverIndex !== -1) {
            window.contentLibrary.plex[serverIndex].status = result.online ? 'Online' : 'Offline';
            window.contentLibrary.plex[serverIndex].lastChecked = new Date().toISOString();
        }
    });
    
    saveContentLibrary(); // Save updated status to localStorage
    saveAdminData();
    
    // Update UI silently if content section is visible
    if (document.getElementById('plexContent') && document.getElementById('plexContent').style.display !== 'none') {
        showContentSection();
    }
}

// Start silent background monitoring every 5 minutes
function startPlexMonitoring() {
    // Initial check after 30 seconds
    setTimeout(backgroundPlexHealthCheck, 30000);
    
    // Then check every 5 minutes
    setInterval(backgroundPlexHealthCheck, 5 * 60 * 1000);
}

// Start monitoring when admin panel loads
document.addEventListener('DOMContentLoaded', startPlexMonitoring);

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
            .then(function(registration) {
                console.log('ServiceWorker registration successful');
            })
            .catch(function(error) {
                console.log('ServiceWorker registration failed: ', error);
            });
    });
}
</script>

    </div>
</body>
</html>
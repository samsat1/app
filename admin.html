<!DOCTYPE html>
<!-- VERSION 7.3 - Direct Connection (CORS Extension Required) 2025-12-05 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Admin Panel - iWATCH TV</title>
    <meta name="author" content="MiniMax Agent">
    
    <!-- PWA Manifest for Admin Panel (Mobile) -->
    <link rel="manifest" href="manifest-admin.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iWATCH Admin">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#7c3aed">
    <meta name="msapplication-TileColor" content="#7c3aed">
    
    <!-- Prevent zoom on input focus -->
    <style>
        input, select, textarea {
            font-size: 16px !important;
        }
    </style>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --accent-blue: #667eea;
            --accent-purple: #764ba2;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --focus-color: #667eea;
            --admin-color: #4caf50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Performance optimizations */
        .admin-container {
            min-height: 100vh;
        }

        .admin-sidebar {
            background: rgba(0, 0, 0, 0.8);
            padding: 30px 20px;
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .admin-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--admin-color), #66bb6a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            margin: 0 auto 15px;
            box-shadow: 0 15px 35px rgba(76, 175, 80, 0.4);
        }

        .admin-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--admin-color);
            margin-bottom: 5px;
        }

        .admin-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .admin-nav {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-btn {
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
        }

        .nav-btn:hover {
            background: rgba(76, 175, 80, 0.2);
            border-color: var(--admin-color);
            transform: translateX(5px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--admin-color), #66bb6a);
            border-color: transparent;
            color: white;
        }

        .nav-icon {
            font-size: 18px;
        }

        .admin-main {
            padding: 40px;
            overflow-y: auto;
            margin-left: 300px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            width: calc(100% - 300px);
            box-sizing: border-box;
        }

        .dashboard-header {
            margin-bottom: 40px;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stat-icon.users {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-icon.revenue {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
        }

        .stat-icon.content {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        .stat-icon.system {
            background: linear-gradient(135deg, #9c27b0, #ba68c8);
        }

        .stat-icon.satellite {
            background: linear-gradient(135deg, #00bcd4, #26c6da);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .section-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(20px);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--admin-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.8rem;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .admin-container {
            }

            .admin-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 1001;
            }

            .admin-sidebar.show {
                transform: translateX(0);
            }

            .admin-main {
                margin-left: 0;
                padding: 20px;
                width: 100%;
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .section-grid {
                grid-template-columns: 1fr;
            }

            .section-card {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .admin-main {
                padding: 15px;
            }

            .dashboard-title {
                font-size: 1.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .section-card {
                padding: 15px;
            }
        }

        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1002;
            background: var(--admin-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--admin-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button styles */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196f3, #42a5f5);
            color: white;
        }

        .btn-success {
            background: var(--admin-color);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #00bcd4, #26c6da);
            color: white;
        }
        
        /* Expiry Status Colors */
        .expiry-green {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            text-align: center;
        }
        
        .expiry-yellow {
            background: linear-gradient(135deg, #ffc107, #ffca28);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            text-align: center;
        }
        
        .expiry-red {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            text-align: center;
        }
        
        .expiry-white {
            background: linear-gradient(135deg, #9e9e9e, #bdbdbd);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>

    <div class="admin-container">
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="admin-header">
                <div class="admin-logo">üîß</div>
                <h1 class="admin-title">Admin Panel</h1>
                <p class="admin-subtitle">iWATCH TV System</p>
            </div>
            
            <nav class="admin-nav">
                <div class="nav-item">
                    <button class="nav-btn active" onclick="showSection('dashboard', event)">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('users', event)">
                        <span class="nav-icon">üë•</span>
                        Users & Customers
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('content', event)">
                        <span class="nav-icon">üì∫</span>
                        Content Library
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('packages', event)">
                        <span class="nav-icon">üì¶</span>
                        Packages & Pricing
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('package-auth', event)">
                        <span class="nav-icon">üîê</span>
                        Package Authentication
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('devices', event)">
                        <span class="nav-icon">üì±</span>
                        Device Management
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('resellers', event)">
                        <span class="nav-icon">üè¢</span>
                        Reseller Management
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('credit', event)">
                        <span class="nav-icon">üí∞</span>
                        Credit Manager
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('satellite', event)">
                        <span class="nav-icon">üõ∞Ô∏è</span>
                        Satellite Config
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('content-folders', event)">
                        <span class="nav-icon">üìÅ</span>
                        Content Folders
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('plex', event)">
                        <span class="nav-icon">üì∫</span>
                        Plex Management
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('qam', event)">
                        <span class="nav-icon">üì°</span>
                        QAM Configuration
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('analytics', event)">
                        <span class="nav-icon">üìà</span>
                        Analytics
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('settings', event)">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        Settings
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-btn" onclick="showSection('logs', event)">
                        <span class="nav-icon">üìã</span>
                        System Logs
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="admin-main">
            <div class="dashboard-header">
                <h1 class="dashboard-title">üîß Welcome to Admin Panel</h1>
                <p class="dashboard-subtitle">iWATCH TV Management System - Ready to use!</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon users">üë•</div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon content">üì¶</div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Packages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon system">üîß</div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Add-ons</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon revenue">üí∞</div>
                    <div class="stat-value">12</div>
                    <div class="stat-label">Resellers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon satellite">üõ∞Ô∏è</div>
                    <div class="stat-value">400</div>
                    <div class="stat-label">HD Channels</div>
                </div>
            </div>
            
            <div class="section-grid">
                <div class="section-card">
                    <h3 class="section-title">üìä Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="showSection('users')" class="btn btn-primary">View Users</button>
                        <button onclick="showSection('packages')" class="btn btn-warning">Manage Packages</button>
                        <button onclick="showSection('resellers')" class="btn btn-info">Manage Resellers</button>
                        <button onclick="showSection('satellite')" class="btn btn-success">üõ∞Ô∏è Satellite Config</button>
                    </div>
                </div>
                
                <div class="section-card">
                    <h3 class="section-title">üéØ System Status</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.8);">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Admin Panel:</span>
                            <span style="color: #4caf50;">‚úÖ Online</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Credit System:</span>
                            <span style="color: #4caf50;">‚úÖ Active</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Reseller Panels:</span>
                            <span style="color: #4caf50;">‚úÖ 12 Ready</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Package System:</span>
                            <span style="color: #4caf50;">‚úÖ Ready</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Satellite System:</span>
                            <span style="color: #4caf50;">‚úÖ 400 HD Ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global Reseller Accounts Data
        // Load RESELLER_ACCOUNTS from localStorage or use defaults
        let RESELLER_ACCOUNTS = {};
        
        // Load from localStorage first
        const savedAccounts = localStorage.getItem('RESELLER_ACCOUNTS');
        if (savedAccounts) {
            try {
                RESELLER_ACCOUNTS = JSON.parse(savedAccounts);
                console.log('üìä Loaded RESELLER_ACCOUNTS from localStorage');
            } catch (e) {
                console.error('‚ùå Failed to parse RESELLER_ACCOUNTS from localStorage:', e);
                initializeDefaultAccounts();
            }
        } else {
            console.log('üìä No saved RESELLER_ACCOUNTS found, initializing defaults');
            initializeDefaultAccounts();
        }
        
        function initializeDefaultAccounts() {
            RESELLER_ACCOUNTS = {
                'reseller001': { name: 'Reseller 001', id: 'reseller001', username: 'reseller001', password: 'res001_pass', status: 'active', commissionRate: 20 },
                'reseller002': { name: 'Reseller 002', id: 'reseller002', username: 'reseller002', password: 'res002_pass', status: 'active', commissionRate: 20 },
                'reseller003': { name: 'Reseller 003', id: 'reseller003', username: 'reseller003', password: 'res003_pass', status: 'active', commissionRate: 20 },
                'reseller004': { name: 'Reseller 004', id: 'reseller004', username: 'reseller004', password: 'res004_pass', status: 'active', commissionRate: 20 },
                'reseller005': { name: 'Reseller 005', id: 'reseller005', username: 'reseller005', password: 'res005_pass', status: 'active', commissionRate: 20 },
                'reseller006': { name: 'Reseller 006', id: 'reseller006', username: 'reseller006', password: 'res006_pass', status: 'active', commissionRate: 20 },
                'reseller007': { name: 'Reseller 007', id: 'reseller007', username: 'reseller007', password: 'res007_pass', status: 'active', commissionRate: 20 },
                'reseller008': { name: 'Reseller 008', id: 'reseller008', username: 'reseller008', password: 'res008_pass', status: 'active', commissionRate: 20 },
                'reseller009': { name: 'Reseller 009', id: 'reseller009', username: 'reseller009', password: 'res009_pass', status: 'active', commissionRate: 20 },
                'reseller010': { name: 'Reseller 010', id: 'reseller010', username: 'reseller010', password: 'res010_pass', status: 'active', commissionRate: 20 },
                'reseller011': { name: 'Reseller 011', id: 'reseller011', username: 'reseller011', password: 'res011_pass', status: 'active', commissionRate: 20 },
                'reseller012': { name: 'Reseller 012', id: 'reseller012', username: 'reseller012', password: 'res012_pass', status: 'active', commissionRate: 20 }
            };
            saveResellerAccounts();
        }
        
        function saveResellerAccounts() {
            try {
                localStorage.setItem('RESELLER_ACCOUNTS', JSON.stringify(RESELLER_ACCOUNTS));
                console.log('üíæ Saved RESELLER_ACCOUNTS to localStorage');
                
                // Trigger storage event for real-time sync across tabs
                localStorage.setItem('RESELLER_ACCOUNTS_sync', Date.now());
                localStorage.removeItem('RESELLER_ACCOUNTS_sync');
            } catch (e) {
                console.error('‚ùå Failed to save RESELLER_ACCOUNTS to localStorage:', e);
            }
        }

        // Enhanced Password Management System
        const passwordManager = {
            passwords: {
                'adminLogin': 'admin123',
                'masterPassword': 'master2025'
            },
            resellerCredentials: {},
            currentSession: null,
            
            initialize: function() {
                console.log('üîß PasswordManager initializing...');
                this.initializeCredentials();
                console.log('‚úÖ PasswordManager initialized');
            },
            
            initializeCredentials: function() {
                const savedCredentials = localStorage.getItem('resellerCredentials');
                if (savedCredentials) {
                    try {
                        this.resellerCredentials = JSON.parse(savedCredentials);
                    } catch (e) {
                        console.error('Error loading reseller credentials:', e);
                        this.resellerCredentials = {};
                    }
                } else {
                    this.resellerCredentials['reseller'] = {
                        username: 'reseller',
                        password: 'reseller123',
                        createdAt: new Date().toISOString()
                    };
                    this.saveCredentials();
                }
            },
            
            saveCredentials: function() {
                try {
                    console.log('üíæ Saving credentials to localStorage...');
                    localStorage.setItem('resellerCredentials', JSON.stringify(this.resellerCredentials));
                    localStorage.setItem('adminPasswords', JSON.stringify(this.passwords));
                    
                    const testRead = localStorage.getItem('resellerCredentials');
                    console.log('‚úÖ Credentials saved successfully', testRead ? 'and verified' : 'but verification failed');
                } catch (e) {
                    console.error('‚ùå Error saving credentials:', e);
                    throw e;
                }
            },
            
            authenticateUser: function(username, password) {
                if (username === 'admin' && password === this.passwords.adminLogin) {
                    this.currentSession = {
                        id: 'admin_' + Date.now(),
                        username: 'admin',
                        role: 'admin',
                        plan: 'Admin Access',
                        expiryDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),
                        status: 'active',
                        permissions: ['admin', 'full_control']
                    };
                    return this.currentSession;
                }
                
                if (password === this.passwords.masterPassword && username.startsWith('reseller_')) {
                    const resellerId = username.replace('reseller_', '');
                    if (this.resellerCredentials[resellerId]) {
                        return {
                            id: 'master_' + resellerId + '_' + Date.now(),
                            username: 'reseller_' + resellerId,
                            role: 'reseller',
                            resellerId: resellerId,
                            plan: 'Master Access',
                            expiryDate: new Date(Date.now() + 24 * 60 * 60 * 1000),
                            status: 'active',
                            permissions: ['reseller', 'master_access']
                        };
                    }
                }
                
                if (this.resellerCredentials[username]) {
                    const reseller = this.resellerCredentials[username];
                    if (reseller.password === password) {
                        this.currentSession = {
                            id: 'reseller_' + username + '_' + Date.now(),
                            username: username,
                            role: 'reseller',
                            resellerId: username,
                            plan: 'Reseller Access',
                            expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                            status: 'active',
                            permissions: ['reseller']
                        };
                        return this.currentSession;
                    }
                }
                
                return null;
            },
            
            createReseller: function(resellerId, username, password) {
                if (!resellerId || !username || !password) {
                    return { success: false, message: 'All fields are required' };
                }
                
                if (this.resellerCredentials[resellerId] || RESELLER_ACCOUNTS[resellerId]) {
                    return { success: false, message: 'Reseller ID already exists' };
                }
                
                if (password.length < 6) {
                    return { success: false, message: 'Password must be at least 6 characters' };
                }
                
                // Add to credentials system
                this.resellerCredentials[resellerId] = {
                    username: username,
                    password: password,
                    createdAt: new Date().toISOString()
                };
                
                // Add to RESELLER_ACCOUNTS with proper status for dashboard
                RESELLER_ACCOUNTS[resellerId] = {
                    name: `Reseller ${resellerId}`,
                    id: resellerId,
                    username: username,
                    password: password,
                    status: 'active',
                    walletBalance: 0,
                    commissionRate: 20,
                    createdAt: new Date().toISOString()
                };
                
                saveResellerAccounts();
                
                this.saveCredentials();
                
                // Trigger dashboard refresh
                updateResellerStatistics();
                
                return { success: true, message: `Reseller "${resellerId}" created successfully!` };
            },
            
            getAllResellers: function() {
                return Object.keys(this.resellerCredentials);
            },
            
            updateResellerPassword: function(resellerId, newPassword) {
                if (!resellerId || !newPassword) {
                    return { success: false, message: 'Reseller ID and password are required' };
                }
                
                if (newPassword.length < 6) {
                    return { success: false, message: 'Password must be at least 6 characters' };
                }
                
                // Update in credentials system
                if (this.resellerCredentials[resellerId]) {
                    this.resellerCredentials[resellerId].password = newPassword;
                    this.saveCredentials();
                }
                
                // Update in RESELLER_ACCOUNTS
                if (RESELLER_ACCOUNTS[resellerId]) {
                    RESELLER_ACCOUNTS[resellerId].password = newPassword;
                    saveResellerAccounts();
                }
                
                return { success: true, message: `Password updated for reseller "${resellerId}"` };
            }
        };

        // Global state
        let isLoggedIn = false;
        let currentUser = null;
        let adminUsers = [];
        
        // Initialize packages from localStorage or create clean 4-package structure
        let packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
        
        // Initialize clean 4-package structure if empty or contains problematic packages
        // Initialize empty packages if none exist
        if (packages.length === 0) {
            console.log('üì¶ No packages found - admin can create packages from scratch');
            packages = [];
            localStorage.setItem('adminPackages', JSON.stringify(packages));
            localStorage.setItem('packages', JSON.stringify(packages));
        }
        
        // Auto-create content mappings for packages
        function autoCreatePackageMappings(packages) {
            console.log('üîó Setting up content mappings for packages...');
            
            packages.forEach(pkg => {
                const mapping = {
                    name: pkg.name,
                    contentMapping: {
                        name: pkg.name,
                        libraries: [],
                        channels: [],
                        features: pkg.features ? pkg.features.split(',').map(f => f.trim()) : [],
                        accessLevel: pkg.isAdult ? 4 : 1,
                        passwordProtected: pkg.isAdult || false
                    },
                    autoGenerated: true,
                    createdAt: new Date().toISOString()
                };
                
                // Create the mapping
                packageAuthenticationSystem.createPackageMapping(pkg.id, mapping);
            });
            
            // Save mappings and broadcast update
            packageAuthenticationSystem.saveMappings();
            packageAuthenticationSystem.broadcastUpdate('mappings_created', 'auto');
            
            console.log('‚úÖ Package mappings created successfully!');
        }
        
        // Customer Management Global Variables
        let customers = JSON.parse(localStorage.getItem('adminCustomers')) || JSON.parse(localStorage.getItem('customers')) || [];
        let editingCustomerId = null;
        let renewalMode = false;
        
        // Initialize global variables in window scope
        window.customers = customers;
        window.editingCustomerId = editingCustomerId;
        window.renewalMode = renewalMode;

        // Package Authentication System - Enhanced with Content Mapping
        const packageAuthenticationSystem = {
            // Content categories and their mappings (admin can configure via UI)
            // Default content mapping templates for package types
            contentMappings: {
                'basic_tv': {
                    name: 'Basic TV Package',
                    type: 'live_tv',
                    source: 'satellite_qam_udp',
                    streamingMode: 'always_streaming',
                    description: 'Live TV from Satellite ‚Üí QAM ‚Üí UDP ‚Üí Plex',
                    libraries: ['Live TV'],
                    channels: ['Live TV'],
                    features: ['Live TV', 'News', 'Entertainment', 'Local Channels'],
                    accessLevel: 1,
                    passwordProtected: false,
                    plexPath: '/plex/live-tv/',
                    networkPath: 'Satellite ‚Üí QAM Modulator ‚Üí UDP ‚Üí Plex ‚Üí Mikrotik ‚Üí OLT ‚Üí ONU'
                },
                'sports': {
                    name: 'Sports Package',
                    type: 'live_tv',
                    source: 'satellite_qam_udp',
                    streamingMode: 'always_streaming',
                    description: 'Sports Live TV from Satellite ‚Üí QAM ‚Üí UDP ‚Üí Plex (World Cup, etc.)',
                    libraries: ['Live TV'],
                    channels: ['Live TV', 'Sports'],
                    features: ['Sports Live', 'World Cup', 'Football', 'Basketball', 'Tennis'],
                    accessLevel: 2,
                    passwordProtected: false,
                    plexPath: '/plex/live-tv/sports/',
                    networkPath: 'Satellite ‚Üí QAM Modulator ‚Üí UDP ‚Üí Plex ‚Üí Mikrotik ‚Üí OLT ‚Üí ONU',
                    requiresBasicTV: true
                },
                'movies': {
                    name: 'Movies Package',
                    type: 'vod',
                    source: 'pc_library_plex',
                    streamingMode: 'on_demand',
                    description: 'Movies from PC Library folder in Plex',
                    libraries: ['Movies'],
                    channels: [],
                    features: ['Movie Library', 'On-Demand', 'HD Movies', 'New Releases'],
                    accessLevel: 2,
                    passwordProtected: false,
                    plexPath: '/plex/library/movies/',
                    networkPath: 'PC Library ‚Üí Plex ‚Üí Mikrotik ‚Üí OLT ‚Üí ONU',
                    requiresBasicTV: true
                },

                'adult': {
                    name: 'Adult Content',
                    type: 'vod',
                    source: 'pc_library_plex',
                    streamingMode: 'on_demand',
                    description: 'Adult content from PC Library (PIN protected)',
                    libraries: ['Adult'],
                    channels: [],
                    features: ['18+ Content', 'PIN Protected'],
                    accessLevel: 4,
                    passwordProtected: true,
                    plexPath: '/plex/library/adult/',
                    networkPath: 'PC Library ‚Üí Plex ‚Üí Mikrotik ‚Üí OLT ‚Üí ONU',
                    requiresBasicTV: false,
                    adultPIN: '1818'
                }
            },

            // Initialize the authentication system
            initialize: function() {
                console.log('üîê Initializing Package Authentication System...');
                this.loadExistingMappings();
                this.initializeDefaultMappings();
                console.log('‚úÖ Package Authentication System ready');
            },
            
            // Initialize default content mapping templates if not exist
            initializeDefaultMappings: function() {
                const storedMappings = localStorage.getItem('contentMappingTemplates');
                if (!storedMappings) {
                    localStorage.setItem('contentMappingTemplates', JSON.stringify(this.contentMappings));
                    console.log('üì¶ Initialized default content mapping templates');
                }
            },

            // Load existing package-to-content mappings
            loadExistingMappings: function() {
                const existingMappings = localStorage.getItem('packageContentMappings');
                if (existingMappings) {
                    try {
                        this.mappings = JSON.parse(existingMappings);
                        console.log('üì¶ Loaded existing package mappings:', Object.keys(this.mappings).length);
                    } catch (e) {
                        console.error('‚ùå Failed to parse package mappings:', e);
                        this.mappings = {};
                    }
                }
            },

            // Save package-to-content mappings
            saveMappings: function() {
                try {
                    localStorage.setItem('packageContentMappings', JSON.stringify(this.mappings));
                    localStorage.setItem('packageAuthUpdate', JSON.stringify({
                        timestamp: Date.now(),
                        action: 'mappings_updated'
                    }));
                    console.log('üíæ Saved package content mappings');
                } catch (e) {
                    console.error('‚ùå Failed to save package mappings:', e);
                }
            },

            // Create or update package-to-content mapping
            createPackageMapping: function(packageId, mappingData) {
                this.mappings[packageId] = {
                    ...mappingData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    active: true
                };
                this.saveMappings();
                this.broadcastUpdate('mapping_created', packageId);
                return true;
            },

            // Get package mapping
            getPackageMapping: function(packageId) {
                return this.mappings[packageId] || null;
            },

            // Get all package mappings
            getAllMappings: function() {
                return this.mappings;
            },

            // Validate customer access to package
            validateCustomerAccess: function(customerId, packageId) {
                const customer = customers.find(c => c.id === customerId);
                if (!customer) return false;

                // Check if customer has the package in their plan or addons
                const packageData = packages.find(p => p.id === packageId);
                if (!packageData) return false;

                // Flexible matching: check if package name/id matches customer's plan or addons
                const planLower = (customer.plan || '').toLowerCase();
                const addonsLower = (customer.addons || '').toLowerCase();
                const pkgNameLower = (packageData.name || '').toLowerCase();
                const pkgIdLower = (packageId || '').toLowerCase();
                
                // Direct match check
                let hasAccess = planLower.includes(pkgNameLower) || addonsLower.includes(pkgNameLower);
                
                // Check by package ID keywords
                if (!hasAccess && pkgIdLower) {
                    const idKeywords = pkgIdLower.split(/[-_\s]+/);
                    hasAccess = idKeywords.some(kw => planLower.includes(kw) || addonsLower.includes(kw));
                }
                
                // Flexible keyword matching for addon types
                if (!hasAccess) {
                    const typeMapping = {
                        'sport': ['sport', 'sports'],
                        'movie': ['movie', 'movies', 'film'],
                        'adult': ['adult', '18+'],
                        'basic': ['basic', 'basic tv'],
                        'ultimate': ['basic', 'sport', 'movie'],
                        'standard': ['basic']
                    };
                    
                    for (const [type, keywords] of Object.entries(typeMapping)) {
                        if (pkgNameLower.includes(type) || pkgIdLower.includes(type)) {
                            hasAccess = keywords.some(kw => planLower.includes(kw) || addonsLower.includes(kw));
                            if (hasAccess) break;
                        }
                    }
                }
                
                // If customer has Basic TV Package, they have base access
                if (!hasAccess && planLower.includes('basic tv')) {
                    hasAccess = pkgNameLower.includes('basic') || pkgNameLower.includes('standard') || 
                                pkgIdLower.includes('basic') || pkgIdLower.includes('standard');
                }

                return hasAccess;
            },

            // Get customer's accessible packages based on their subscription
            getCustomerAccessiblePackages: function(customerId) {
                const customer = customers.find(c => c.id === customerId);
                if (!customer) return [];

                const accessiblePackages = [];
                
                packages.forEach(pkg => {
                    const mapping = this.getPackageMapping(pkg.id);
                    if (!mapping || !mapping.active) return;

                    const hasAccess = this.validateCustomerAccess(customerId, pkg.id);
                    if (hasAccess) {
                        accessiblePackages.push({
                            package: pkg,
                            mapping: mapping
                        });
                    }
                });

                return accessiblePackages;
            },

            // Broadcast real-time updates to client interfaces
            broadcastUpdate: function(action, packageId) {
                const updateData = {
                    action: action,
                    packageId: packageId,
                    timestamp: new Date().toISOString(),
                    source: 'admin_panel'
                };

                localStorage.setItem('packageAuthBroadcast', JSON.stringify(updateData));
                
                // Clear the broadcast after a short delay to prevent storage pollution
                setTimeout(() => {
                    localStorage.removeItem('packageAuthBroadcast');
                }, 1000);
            },

            // Auto-map new packages to default content
            autoMapPackage: function(packageData) {
                const packageName = packageData.name.toLowerCase();
                let targetMapping = null;

                // Auto-detect package type and assign appropriate content mapping
                if (packageName.includes('basic') || packageName.includes('tv')) {
                    targetMapping = this.contentMappings['basic_tv'];
                } else if (packageName.includes('sport')) {
                    targetMapping = this.contentMappings['sports'];
                } else if (packageName.includes('movie')) {
                    targetMapping = this.contentMappings['movies'];
                } else if (packageName.includes('adult') || packageName.includes('xxx')) {
                    targetMapping = this.contentMappings['adult'];
                }

                if (targetMapping) {
                    this.createPackageMapping(packageData.id, {
                        name: packageData.name,
                        contentMapping: targetMapping,
                        autoGenerated: true
                    });
                    console.log(`üîó Auto-mapped package "${packageData.name}" to content`);
                    return true;
                }

                return false;
            }
        };

        // Initialize the authentication system
        packageAuthenticationSystem.initialize();

        // Admin credit transfer function
        function sendCreditToReseller(resellerId, amount) {
            if (!resellerId || !amount || amount <= 0) {
                return { success: false, message: 'Please enter valid reseller ID and amount' };
            }
            
            // Get reseller info
            const resellers = JSON.parse(localStorage.getItem('resellerCredentials') || '{}');
            if (!resellers[resellerId]) {
                return { success: false, message: 'Reseller not found' };
            }
            
            // Update reseller wallet balance
            const reseller = resellers[resellerId];
            reseller.walletBalance = (parseFloat(reseller.walletBalance) || 0) + parseFloat(amount);
            resellers[resellerId] = reseller;
            localStorage.setItem('resellerCredentials', JSON.stringify(resellers));
            
            // Broadcast to reseller panels
            localStorage.setItem('creditTransfer', JSON.stringify({
                resellerId: resellerId,
                amount: amount,
                newBalance: reseller.walletBalance,
                timestamp: Date.now()
            }));
            
            return { success: true, message: `$${amount} credited to ${resellerId}` };
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Global navigation function
        window.showSection = function(sectionName, event) {
            console.log('üîß Showing section:', sectionName);
            
            // Prevent event default if event exists
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            const activeBtn = document.querySelector(`[onclick*="${sectionName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Hide mobile menu on section change
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.remove('show');
                }
            }
            
            // Show appropriate section
            switch(sectionName) {
                case 'dashboard':
                    showAdminDashboard();
                    break;
                case 'users':
                case 'customers':
                    showUsersSection();
                    break;
                case 'packages':
                    showPackagesSection();
                    break;
                case 'package-auth':
                    showPackageAuthenticationSection();
                    break;
                case 'content':
                    showContentSection();
                    break;
                case 'devices':
                    showDevicesSection();
                    break;
                case 'credit':
                case 'credits':
                    showCreditSection();
                    break;
                case 'resellers':
                    showResellersSection();
                    break;
                case 'analytics':
                    showAnalyticsSection();
                    break;
                case 'logs':
                    showLogsSection();
                    break;
                case 'settings':
                    showSettingsSection();
                    break;
                case 'satellite':
                    showSatelliteSection();
                    break;
                case 'content-folders':
                    showContentFoldersSection();
                    break;
                case 'plex':
                    showPlexSection();
                    break;
                case 'qam':
                    showQAMSection();
                    break;
                default:
                    showAdminDashboard();
            }
        };

        // Enhanced Create/Edit Package Function
        window.createNewPackage = function() {
            const name = document.getElementById('packageName')?.value;
            const price = document.getElementById('packagePrice')?.value;
            const duration = document.getElementById('packageDuration')?.value;
            const features = document.getElementById('packageFeatures')?.value;
            const secondTVPrice = document.getElementById('secondTVPrice')?.value;
            const thirdTVPrice = document.getElementById('thirdTVPrice')?.value;
            const sportsPrice = document.getElementById('sportsPrice')?.value;
            const moviesPrice = document.getElementById('moviesPrice')?.value;
            const adultPackagePrice = document.getElementById('adultPackagePrice')?.value;
            
            // Detect adult package: by name contains "adult"/"xxx" OR by having adult addon price
            const isAdultPackage = name.toLowerCase().includes('adult') || 
                                   name.toLowerCase().includes('xxx') || 
                                   (adultPackagePrice && parseFloat(adultPackagePrice) > 0);
            
            // Validate required fields
            if (!name || !price || !duration) {
                showNotification('‚ùå Please fill all required fields', 'error');
                return;
            }
            
            // Validate adult package price if it's an adult package
            if (isAdultPackage && !adultPackagePrice) {
                showNotification('‚ùå Adult package price is required when creating an adult package', 'error');
                return;
            }
            
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
            const editIndex = document.getElementById('createPackageBtn').getAttribute('data-edit-index');
            
            // Check for existing packages of the same type to prevent duplicates (only when creating new packages)
            if (editIndex === null) {
                const normalizedName = name.toLowerCase().trim();
                const existingPackages = packages.filter(pkg => {
                    const existingName = pkg.name.toLowerCase().trim();
                    return existingName === normalizedName ||
                           // Handle similar package types
                           (normalizedName.includes('basic') && existingName.includes('basic')) ||
                           (normalizedName.includes('adult') && existingName.includes('adult')) ||
                           (normalizedName.includes('movies') && existingName.includes('movies')) ||
                           (normalizedName.includes('sports') && existingName.includes('sports')) ||
                           false; // Removed premium check
                });
                
                if (existingPackages.length > 0) {
                    showNotification(`‚ùå Package "${name}" already exists. Please edit the existing package instead of creating a duplicate.`, 'error');
                    return;
                }
            }
            
            const packageData = {
                name: name,
                price: parseFloat(price),
                duration: duration,
                features: features,
                secondTVPrice: parseFloat(secondTVPrice || '0'),
                thirdTVPrice: parseFloat(thirdTVPrice || '0'),
                sportsPrice: parseFloat(sportsPrice || '0'),
                moviesPrice: parseFloat(moviesPrice || '0'),
                isAdult: isAdultPackage,
                adultPackagePrice: isAdultPackage ? parseFloat(adultPackagePrice) : 0,
                // Authentication System Fields
                approved: true,
                approvedDate: new Date().toISOString(),
                approvedBy: 'admin',
                rejectedDate: null,
                rejectedBy: null,
                rejectionReason: null,
                createdAt: new Date().toISOString()
            };
            
            if (editIndex !== null) {
                // Update existing package
                packages[parseInt(editIndex)] = packageData;
                const adultInfo = isAdultPackage ? ` (Adult: $${adultPackagePrice})` : '';
                showNotification(`‚úèÔ∏è Package "${name}"${adultInfo} updated successfully`, 'success');
            } else {
                // Create new package
                packageData.id = 'PKG_' + Date.now();
                packages.push(packageData);
                const adultInfo = isAdultPackage ? ` (Adult: $${adultPackagePrice})` : '';
                const statusInfo = packageData.approved ? 'approved and active' : 'created and pending approval';
                showNotification(`‚úÖ Package "${name}"${adultInfo} ${statusInfo} successfully`, 'success');
            }
            
            // Save to localStorage for consistency (both adminPackages and packages keys)
            localStorage.setItem('adminPackages', JSON.stringify(packages));
            localStorage.setItem('packages', JSON.stringify(packages));
            
            // Trigger real-time notification to clients for package updates
            const notificationData = {
                packageId: packageData.id || packages[parseInt(editIndex)]?.id,
                packageName: name,
                timestamp: new Date().toISOString(),
                action: editIndex !== null ? 'updated' : 'created'
            };
            localStorage.setItem('packageUpdate', JSON.stringify(notificationData));

            // Enhanced Authentication Integration: Auto-create package mapping for new packages
            if (editIndex === null) {
                console.log('üîê Auto-creating content mapping for new package:', packageData.name);
                
                // Auto-map the new package to appropriate content
                const mappingCreated = packageAuthenticationSystem.autoMapPackage(packageData);
                
                if (mappingCreated) {
                    console.log('‚úÖ Auto-mapping successful for package:', packageData.name);
                    showNotification(`‚úÖ Package "${name}" created and mapped to content successfully!`, 'success');
                } else {
                    console.log('‚ö†Ô∏è Auto-mapping not available for package:', packageData.name);
                    showNotification(`‚úÖ Package "${name}" created successfully! Please configure content mapping in Package Authentication section.`, 'info');
                }
            } else {
                // For updated packages, update the existing mapping
                console.log('üîÑ Updating existing mapping for package:', packageData.name);
                const existingMapping = packageAuthenticationSystem.getPackageMapping(packageData.id);
                if (existingMapping) {
                    // Update mapping with new package data
                    existingMapping.contentMapping.name = packageData.name;
                    existingMapping.contentMapping.features = packageData.features ? packageData.features.split(',').map(f => f.trim()) : [];
                    existingMapping.updatedAt = new Date().toISOString();
                    packageAuthenticationSystem.saveMappings();
                    packageAuthenticationSystem.broadcastUpdate('mapping_updated', packageData.id);
                    console.log('‚úÖ Package mapping updated successfully');
                }
            }
            
            // Update global packages variable to reflect the new data
            packages = [...packages]; // Create a copy to ensure reference update
            
            // Reset form
            clearPackageForm();
            document.getElementById('createPackageBtn').textContent = '‚ûï Create Package';
            document.getElementById('createPackageBtn').removeAttribute('data-edit-index');
            document.getElementById('cancelPackageEditBtn').style.display = 'none';
            
            // Small delay to ensure localStorage is written, then update UI
            setTimeout(() => {
                updatePackagesList();
                updatePackageStats();
            }, 50);
            
            // Update package statistics
            updatePackageStats();
        };

        // Package Authentication Section
        window.showPackageAuthenticationSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            const mappings = packageAuthenticationSystem.getAllMappings();
            const packagesList = packages.map(pkg => {
                const mapping = mappings[pkg.id];
                const status = mapping ? '‚úÖ Mapped' : '‚ùå Not Mapped';
                const statusClass = mapping ? 'expiry-green' : 'expiry-red';
                
                return `
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="color: white; margin: 0 0 5px 0;">${pkg.name}</h4>
                                <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 14px;">$${pkg.price}/${pkg.duration}</p>
                            </div>
                            <div class="${statusClass}" style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                ${status}
                            </div>
                        </div>
                        
                        ${mapping ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h5 style="color: var(--admin-color); margin: 0 0 10px 0;">Content Mapping:</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 13px;">
                                    <div><strong>Libraries:</strong> ${mapping.contentMapping.libraries.join(', ') || 'None'}</div>
                                    <div><strong>Channels:</strong> ${mapping.contentMapping.channels.length} channels</div>
                                    <div><strong>Access Level:</strong> ${mapping.contentMapping.accessLevel}</div>
                                    <div><strong>Features:</strong> ${mapping.contentMapping.features.slice(0, 2).join(', ')}</div>
                                </div>
                            </div>
                        ` : `
                            <div style="background: rgba(244, 67, 54, 0.2); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--error-color);">
                                <p style="color: var(--error-color); margin: 0; font-size: 13px;">‚ö†Ô∏è No content mapping configured. Package will not appear in client interface until mapped.</p>
                            </div>
                        `}
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editPackageMapping('${pkg.id}')" class="btn btn-primary" style="padding: 8px 16px;">
                                ${mapping ? '‚úèÔ∏è Edit Mapping' : 'üîó Create Mapping'}
                            </button>
                            ${mapping ? `
                                <button onclick="testPackageAccess('${pkg.id}')" class="btn btn-info" style="padding: 8px 16px;">
                                    üß™ Test Access
                                </button>
                                <button onclick="removePackageMapping('${pkg.id}')" class="btn btn-warning" style="padding: 8px 16px;">
                                    üóëÔ∏è Remove Mapping
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üîê Package Authentication</h1>
                    <p class="dashboard-subtitle">Map packages to content libraries and validate customer access</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">üìä Authentication Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">${Object.keys(mappings).length}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Mapped Packages</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(244, 67, 54, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f44336;">${packages.length - Object.keys(mappings).length}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Unmapped Packages</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #2196f3;">${customers.length}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Customers</div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üîÑ Real-time Status</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Authentication System:</span>
                                <span style="color: #4caf50; font-weight: 600;">‚úÖ Active</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Client Sync:</span>
                                <span style="color: #4caf50; font-weight: 600;">‚úÖ Ready</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Content Libraries:</span>
                                <span style="color: #2196f3; font-weight: 600;">6 Mapped</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üõ†Ô∏è Quick Actions</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="autoMapAllPackages()" class="btn btn-success" style="padding: 12px 20px;">
                                üîÑ Auto-Map All Unmapped Packages
                            </button>
                            <button onclick="validateAllCustomerAccess()" class="btn btn-info" style="padding: 12px 20px;">
                                üß™ Validate All Customer Access
                            </button>
                            <button onclick="exportAuthenticationData()" class="btn btn-warning" style="padding: 12px 20px;">
                                üì§ Export Auth Data
                            </button>
                            <button onclick="resetAuthenticationSystem()" class="btn btn-primary" style="padding: 12px 20px;">
                                üîß Reset Auth System
                            </button>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-top: 20px;">
                            <h4 style="color: white; margin-bottom: 10px;">üìù Instructions</h4>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.7); line-height: 1.4;">
                                <p style="margin-bottom: 8px;">‚Ä¢ Click "Create Mapping" to link packages to content</p>
                                <p style="margin-bottom: 8px;">‚Ä¢ Auto-mapping detects package type automatically</p>
                                <p style="margin-bottom: 8px;">‚Ä¢ Test Access validates customer permissions</p>
                                <p>‚Ä¢ Changes sync to client interfaces in real-time</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section-card" style="margin-top: 25px;">
                    <h3 class="section-title">üì¶ Package-to-Content Mappings</h3>
                    <div style="max-height: 600px; overflow-y: auto;">
                        ${packagesList || '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">No packages found. Create packages first.</div>'}
                    </div>
                </div>
            `;
        };

        // Package mapping functions
        window.editPackageMapping = function(packageId) {
            const packageData = packages.find(p => p.id === packageId);
            if (!packageData) return;

            const existingMapping = packageAuthenticationSystem.getPackageMapping(packageId);
            
            // Create mapping modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--primary-gradient); border: 1px solid var(--glass-border); border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: var(--admin-color); margin: 0;">üîó ${existingMapping ? 'Edit' : 'Create'} Content Mapping</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: white; margin-bottom: 10px;">Package: ${packageData.name}</h4>
                        <p style="color: rgba(255,255,255,0.7); font-size: 14px;">$${packageData.price}/${packageData.duration}</p>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 8px;">Content Type:</label>
                            <select id="contentType" onchange="updateMappingInfo()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 6px; color: white;">
                                <option value="basic_tv">üì∫ Basic TV Package (Satellite ‚Üí QAM ‚Üí UDP)</option>
                                <option value="sports">‚öΩ Sports Package (Satellite ‚Üí QAM ‚Üí UDP)</option>
                                <option value="movies">üé¨ Movies Package (PC Library ‚Üí Plex)</option>

                                <option value="adult">üîû Adult Content (PC Library ‚Üí Plex)</option>
                            </select>
                        </div>
                        
                        <!-- Source & Streaming Info Display -->
                        <div id="mappingInfoBox" style="background: rgba(76,175,80,0.15); border: 1px solid rgba(76,175,80,0.4); border-radius: 8px; padding: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <span style="color: rgba(255,255,255,0.6); font-size: 12px;">Source Type:</span>
                                    <div id="sourceTypeDisplay" style="color: #4caf50; font-weight: 600;">Satellite ‚Üí QAM ‚Üí UDP</div>
                                </div>
                                <div>
                                    <span style="color: rgba(255,255,255,0.6); font-size: 12px;">Streaming Mode:</span>
                                    <div id="streamingModeDisplay" style="color: #ff9800; font-weight: 600;">Always Streaming</div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.7);" id="networkPathDisplay">
                                Network: Satellite ‚Üí QAM Modulator ‚Üí UDP ‚Üí Plex ‚Üí Mikrotik ‚Üí OLT ‚Üí ONU
                            </div>
                        </div>
                        
                        <div>
                            <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 8px;">Plex Libraries / Folders (comma-separated):</label>
                            <input type="text" id="plexLibraries" placeholder="movies_folder, sports_folder" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 6px; color: white;">
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 5px;">For Movies/VOD: Enter your PC library folder names in Plex</div>
                        </div>
                        
                        <div>
                            <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 8px;">Live Channels (comma-separated):</label>
                            <input type="text" id="liveChannels" placeholder="espn, fox_sports, world_cup_hd" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 6px; color: white;">
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 5px;">For Live TV: Enter channel names from your satellite feed</div>
                        </div>
                        
                        <div>
                            <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 8px;">Access Level (1-4):</label>
                            <input type="number" id="accessLevel" min="1" max="4" value="1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 6px; color: white;">
                        </div>
                        
                        <div>
                            <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 8px;">Features (comma-separated):</label>
                            <input type="text" id="features" placeholder="HD Quality, Standard Channels" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 6px; color: white;">
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="this.closest('.modal').remove()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 6px; color: white; cursor: pointer;">Cancel</button>
                            <button onclick="savePackageMapping('${packageId}')" style="flex: 1; padding: 12px; background: var(--admin-color); border: none; border-radius: 6px; color: white; cursor: pointer;">Save Mapping</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Pre-fill existing values
            if (existingMapping) {
                const contentMapping = existingMapping.contentMapping;
                document.getElementById('contentType').value = Object.keys(packageAuthenticationSystem.contentMappings).find(key => 
                    packageAuthenticationSystem.contentMappings[key].name === contentMapping.name
                ) || 'basic_tv';
                document.getElementById('plexLibraries').value = contentMapping.libraries.join(', ');
                document.getElementById('liveChannels').value = contentMapping.channels.join(', ');
                document.getElementById('accessLevel').value = contentMapping.accessLevel;
                document.getElementById('features').value = contentMapping.features.join(', ');
            }
        };

        window.savePackageMapping = function(packageId) {
            const contentType = document.getElementById('contentType').value;
            const plexLibraries = document.getElementById('plexLibraries').value.split(',').map(s => s.trim()).filter(s => s);
            const liveChannels = document.getElementById('liveChannels').value.split(',').map(s => s.trim()).filter(s => s);
            const accessLevel = parseInt(document.getElementById('accessLevel').value) || 1;
            const features = document.getElementById('features').value.split(',').map(s => s.trim()).filter(s => s);

            const baseMapping = packageAuthenticationSystem.contentMappings[contentType];
            const mappingData = {
                name: baseMapping.name,
                contentMapping: {
                    ...baseMapping,
                    libraries: plexLibraries.length > 0 ? plexLibraries : baseMapping.libraries,
                    channels: liveChannels.length > 0 ? liveChannels : baseMapping.channels,
                    accessLevel: accessLevel,
                    features: features.length > 0 ? features : baseMapping.features
                }
            };

            if (packageAuthenticationSystem.createPackageMapping(packageId, mappingData)) {
                showNotification('‚úÖ Package mapping saved successfully!', 'success');
                document.querySelector('.modal').remove();
                showPackageAuthenticationSection(); // Refresh the section
            } else {
                showNotification('‚ùå Failed to save package mapping', 'error');
            }
        };

        window.testPackageAccess = function(packageId) {
            const packageData = packages.find(p => p.id === packageId);
            if (!packageData) return;

            const mapping = packageAuthenticationSystem.getPackageMapping(packageId);
            if (!mapping) {
                showNotification('‚ùå No mapping found for this package', 'error');
                return;
            }

            const accessibleCustomers = customers.filter(customer => 
                packageAuthenticationSystem.validateCustomerAccess(customer.id, packageId)
            );

            showNotification(`üß™ Package "${packageData.name}" access test:<br>
                üì¶ Mapping: ‚úÖ Active<br>
                üë• Accessible customers: ${accessibleCustomers.length}<br>
                üìö Libraries: ${mapping.contentMapping.libraries.length}<br>
                üì∫ Channels: ${mapping.contentMapping.channels.length}`, 'info');
        };

        window.removePackageMapping = function(packageId) {
            if (confirm('Are you sure you want to remove the content mapping for this package?')) {
                const mappings = packageAuthenticationSystem.getAllMappings();
                delete mappings[packageId];
                packageAuthenticationSystem.saveMappings();
                packageAuthenticationSystem.broadcastUpdate('mapping_removed', packageId);
                showNotification('‚úÖ Package mapping removed', 'success');
                showPackageAuthenticationSection(); // Refresh the section
            }
        };

        window.autoMapAllPackages = function() {
            let mappedCount = 0;
            packages.forEach(pkg => {
                const existingMapping = packageAuthenticationSystem.getPackageMapping(pkg.id);
                if (!existingMapping) {
                    if (packageAuthenticationSystem.autoMapPackage(pkg)) {
                        mappedCount++;
                    }
                }
            });

            showNotification(`‚úÖ Auto-mapped ${mappedCount} packages`, 'success');
            showPackageAuthenticationSection(); // Refresh the section
        };

        window.validateAllCustomerAccess = function() {
            let validCount = 0;
            let invalidCount = 0;

            customers.forEach(customer => {
                const accessiblePackages = packageAuthenticationSystem.getCustomerAccessiblePackages(customer.id);
                if (accessiblePackages.length > 0) {
                    validCount++;
                } else {
                    invalidCount++;
                }
            });

            showNotification(`üß™ Access Validation Results:<br>
                ‚úÖ Valid customers: ${validCount}<br>
                ‚ùå Customers with no access: ${invalidCount}<br>
                üì¶ Total packages: ${packages.length}`, 'info');
        };

        // Update mapping info display when content type changes
        window.updateMappingInfo = function() {
            const contentType = document.getElementById('contentType')?.value;
            if (!contentType) return;
            
            const mappings = packageAuthenticationSystem.contentMappings;
            const mapping = mappings[contentType];
            
            if (!mapping) return;
            
            // Update source type display
            const sourceDisplay = document.getElementById('sourceTypeDisplay');
            const streamingDisplay = document.getElementById('streamingModeDisplay');
            const networkDisplay = document.getElementById('networkPathDisplay');
            const infoBox = document.getElementById('mappingInfoBox');
            
            if (sourceDisplay) {
                if (mapping.source === 'satellite_qam_udp') {
                    sourceDisplay.textContent = 'üì° Satellite ‚Üí QAM ‚Üí UDP';
                    sourceDisplay.style.color = '#4caf50';
                } else if (mapping.source === 'pc_library_plex') {
                    sourceDisplay.textContent = 'üíª PC Library ‚Üí Plex';
                    sourceDisplay.style.color = '#2196f3';
                }
            }
            
            if (streamingDisplay) {
                if (mapping.streamingMode === 'always_streaming') {
                    streamingDisplay.textContent = 'üî¥ Always Streaming (Live TV)';
                    streamingDisplay.style.color = '#ff5722';
                } else if (mapping.streamingMode === 'on_demand') {
                    streamingDisplay.textContent = '‚ñ∂Ô∏è On-Demand (VOD)';
                    streamingDisplay.style.color = '#ff9800';
                }
            }
            
            if (networkDisplay) {
                networkDisplay.textContent = 'Network: ' + (mapping.networkPath || 'Not configured');
            }
            
            // Update info box border color based on type
            if (infoBox) {
                if (mapping.type === 'live_tv') {
                    infoBox.style.borderColor = 'rgba(76,175,80,0.4)';
                    infoBox.style.background = 'rgba(76,175,80,0.15)';
                } else if (mapping.type === 'vod') {
                    infoBox.style.borderColor = 'rgba(33,150,243,0.4)';
                    infoBox.style.background = 'rgba(33,150,243,0.15)';
                }
            }
        };

        window.exportAuthenticationData = function() {
            const authData = {
                mappings: packageAuthenticationSystem.getAllMappings(),
                packages: packages,
                customers: customers,
                exportedAt: new Date().toISOString()
            };

            const dataStr = JSON.stringify(authData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `package_auth_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('‚úÖ Authentication data exported successfully', 'success');
        };

        window.resetAuthenticationSystem = function() {
            if (confirm('Are you sure you want to reset the authentication system? This will remove all mappings.')) {
                localStorage.removeItem('packageContentMappings');
                packageAuthenticationSystem.mappings = {};
                showNotification('‚úÖ Authentication system reset', 'success');
                showPackageAuthenticationSection(); // Refresh the section
            }
        };

        // Section Functions
        window.showAdminDashboard = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üîß Admin Dashboard</h1>
                    <p class="dashboard-subtitle">iWATCH TV Management System</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon users">üë•</div>
                        <div class="stat-value">${adminUsers.length}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon content">üì¶</div>
                        <div class="stat-value">${packages.length}</div>
                        <div class="stat-label">Packages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon system">üîß</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Add-ons</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue">üí∞</div>
                        <div class="stat-value">12</div>
                        <div class="stat-label">Resellers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon satellite">üõ∞Ô∏è</div>
                        <div class="stat-value">400</div>
                        <div class="stat-label">HD Channels</div>
                    </div>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">üìä Quick Actions</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="showSection('users')" class="btn btn-primary">View Users</button>
                            <button onclick="showSection('packages')" class="btn btn-warning">Manage Packages</button>
                            <button onclick="showSection('resellers')" class="btn btn-info">Manage Resellers</button>
                            <button onclick="showSection('satellite')" class="btn btn-success">üõ∞Ô∏è Satellite Config</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üéØ System Status</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.8);">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Admin Panel:</span>
                                <span style="color: #4caf50;">‚úÖ Online</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Credit System:</span>
                                <span style="color: #4caf50;">‚úÖ Active</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Reseller Panels:</span>
                                <span style="color: #4caf50;">‚úÖ 12 Ready</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Package System:</span>
                                <span style="color: #4caf50;">‚úÖ Ready</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Satellite System:</span>
                                <span style="color: #4caf50;">‚úÖ 400 HD Ready</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        window.showSatelliteSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üõ∞Ô∏è Satellite Configuration</h1>
                    <p class="dashboard-subtitle">Configure satellite to QAM modulator system for 400 HD channels</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">üì° System Overview</h3>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">
                                <strong>Signal Flow:</strong><br>
                                üì° Satellite ‚Üí üõ∞Ô∏è QAM Modulator ‚Üí üì° UDP Streams ‚Üí üì∫ Plex Server
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="text-align: center; padding: 15px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                    <div style="font-size: 24px; margin-bottom: 5px;">üì°</div>
                                    <div style="font-weight: 600;">Satellite Source</div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Connected</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                    <div style="font-size: 24px; margin-bottom: 5px;">üõ∞Ô∏è</div>
                                    <div style="font-weight: 600;">QAM Modulator</div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">400 Channels</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                    <div style="font-size: 24px; margin-bottom: 5px;">üì∫</div>
                                    <div style="font-weight: 600;">Plex Server</div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Ready</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="testSatelliteConnection()" class="btn btn-success">üõ∞Ô∏è Test Satellite</button>
                            <button onclick="configureQAMChannels()" class="btn btn-info">‚öôÔ∏è Configure QAM</button>
                            <button onclick="testUDPStreams()" class="btn btn-warning">üîÑ Test UDP Streams</button>
                            <button onclick="setupPlexIntegration()" class="btn btn-primary">üì∫ Setup Plex</button>
                        <button onclick="setupFiberDistribution()" class="btn btn-success">üåê Setup Fiber Distribution</button>
                        <button onclick="configureEndUserAccess()" class="btn btn-info">üë• Configure End Users</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üìä Channel Status</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">400</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">HD Channels</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">1234</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">UDP Port Start</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">1633</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">UDP Port End</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">HD</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Max Quality</div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üìà Real-time Monitoring</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: rgba(255,255,255,0.8);">Signal Quality:</span>
                                <span style="color: #4caf50; font-weight: 600;">98%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: rgba(255,255,255,0.8);">Active Streams:</span>
                                <span style="color: #4caf50; font-weight: 600;">400/400</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: rgba(255,255,255,0.8);">Plex Connection:</span>
                                <span style="color: #4caf50; font-weight: 600;">Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section-card" style="margin-top: 25px;">
                    <h3 class="section-title">‚öôÔ∏è Advanced Configuration</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <h4 style="color: white; margin-bottom: 15px;">üì° Satellite Settings</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Provider:</label>
                                    <select style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                        <option>DirecTV</option>
                                        <option>Dish Network</option>
                                        <option>Custom</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Transponder:</label>
                                    <input type="text" placeholder="11977 V 11318" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: white; margin-bottom: 15px;">üõ∞Ô∏è QAM Modulator</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">QAM Channel:</label>
                                    <input type="text" placeholder="45" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Frequency (MHz):</label>
                                    <input type="text" placeholder="447" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: white; margin-bottom: 15px;">üì∫ Plex Integration</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Server IP:</label>
                                    <input type="text" placeholder="185.187.94.41" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Port:</label>
                                    <input type="text" placeholder="32400" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="saveSatelliteConfig()" class="btn btn-success" style="padding: 12px 30px; font-size: 16px;">üíæ Save Configuration</button>
                    </div>
                </div>
            `;
        };

        // Package Authentication Section
        window.showPackageAuthenticationSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            // Load packages for authentication
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || [];
            
            const pendingPackages = packages.filter(pkg => !pkg.approved && !pkg.rejectedDate);
            const approvedPackages = packages.filter(pkg => pkg.approved);
            const rejectedPackages = packages.filter(pkg => pkg.rejectedDate);
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üîê Package Authentication</h1>
                    <p class="dashboard-subtitle">Approve or reject packages before they appear in client interface</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">‚è≥ Pending Approval (${pendingPackages.length})</h3>
                        ${pendingPackages.length === 0 ? 
                            '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">‚úÖ All packages are processed</div>' :
                            `<div class="packages-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                                ${pendingPackages.map((pkg, index) => {
                                    const packages = JSON.parse(localStorage.getItem('adminPackages')) || [];
                                    const actualIndex = packages.findIndex(p => p.id === pkg.id);
                                    return `
                                        <div class="package-card" style="background: rgba(0,0,0,0.4); border: 1px solid #ff9800; border-radius: 12px; padding: 20px;">
                                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                                <h4 style="color: white; margin: 0; flex: 1;">${pkg.name}</h4>
                                                ${pkg.isAdult ? '<span style="background: #f44336; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px;">ADULT</span>' : ''}
                                            </div>
                                            <div style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 15px;">
                                                <div>üí∞ Price: $${pkg.price}/${pkg.duration}</div>
                                                ${pkg.secondTVPrice > 0 ? `<div>üì± 2nd TV: $${pkg.secondTVPrice}</div>` : ''}
                                                ${pkg.thirdTVPrice > 0 ? `<div>üì± 3rd TV: $${pkg.thirdTVPrice}</div>` : ''}
                                                ${pkg.adultPackagePrice > 0 ? `<div>üîû Adult: $${pkg.adultPackagePrice}</div>` : ''}
                                            </div>
                                            <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 15px;">
                                                Created: ${new Date(pkg.createdAt).toLocaleDateString()}
                                            </div>
                                            <div style="display: flex; gap: 10px;">
                                                <button onclick="selectPackageForApproval('${pkg.id}', '${pkg.name}'); approvePackage()" class="btn btn-success" style="flex: 1;">‚úÖ Approve</button>
                                                <button onclick="selectPackageForRejection('${pkg.id}', '${pkg.name}'); rejectPackage()" class="btn btn-danger" style="flex: 1;">‚ùå Reject</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>`
                        }
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">‚úÖ Approved Packages (${approvedPackages.length})</h3>
                        ${approvedPackages.length === 0 ? 
                            '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No approved packages yet</div>' :
                            `<div class="packages-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                ${approvedPackages.map(pkg => `
                                    <div class="package-card" style="background: rgba(0,0,0,0.4); border: 1px solid #4caf50; border-radius: 8px; padding: 15px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <h5 style="color: #4caf50; margin: 0;">${pkg.name}</h5>
                                            <span style="font-size: 12px; color: #4caf50;">‚úÖ Active</span>
                                        </div>
                                        <div style="color: rgba(255,255,255,0.7); font-size: 13px;">
                                            $${pkg.price}/${pkg.duration}
                                        </div>
                                        <div style="color: rgba(255,255,255,0.5); font-size: 11px; margin-top: 5px;">
                                            Approved: ${pkg.approvedDate ? new Date(pkg.approvedDate).toLocaleDateString() : 'Unknown'}
                                        </div>
                                        <div style="margin-top: 10px; display: flex; gap: 5px;">
                                            <button onclick="selectPackageForRevocation('${pkg.id}', '${pkg.name}'); revokePackageApproval()" class="btn btn-warning" style="padding: 4px 8px; font-size: 11px;">üîÑ Revoke</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">‚ùå Rejected Packages (${rejectedPackages.length})</h3>
                        ${rejectedPackages.length === 0 ? 
                            '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No rejected packages</div>' :
                            `<div class="packages-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                ${rejectedPackages.map(pkg => `
                                    <div class="package-card" style="background: rgba(0,0,0,0.4); border: 1px solid #f44336; border-radius: 8px; padding: 15px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <h5 style="color: #f44336; margin: 0;">${pkg.name}</h5>
                                            <span style="font-size: 12px; color: #f44336;">‚ùå Rejected</span>
                                        </div>
                                        <div style="color: rgba(255,255,255,0.7); font-size: 13px;">
                                            $${pkg.price}/${pkg.duration}
                                        </div>
                                        <div style="color: rgba(255,255,255,0.5); font-size: 11px; margin-top: 5px;">
                                            Rejected: ${pkg.rejectedDate ? new Date(pkg.rejectedDate).toLocaleDateString() : 'Unknown'}
                                            ${pkg.rejectionReason ? `<br>Reason: ${pkg.rejectionReason}` : ''}
                                        </div>
                                        <div style="margin-top: 10px; display: flex; gap: 5px;">
                                            <button onclick="selectPackageForResubmission('${pkg.id}', '${pkg.name}')" class="btn btn-info" style="padding: 4px 8px; font-size: 11px;">üîÑ Resubmit</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; margin-top: 20px;">
                    <h4 style="color: white; margin-bottom: 15px;">üìä Authentication Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(255, 152, 0, 0.2); border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="font-size: 24px; color: #ff9800; font-weight: bold;">${pendingPackages.length}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px;">Pending Approval</div>
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.2); border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="font-size: 24px; color: #4caf50; font-weight: bold;">${approvedPackages.length}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px;">Approved & Active</div>
                        </div>
                        <div style="background: rgba(244, 67, 54, 0.2); border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="font-size: 24px; color: #f44336; font-weight: bold;">${rejectedPackages.length}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px;">Rejected</div>
                        </div>
                        <div style="background: rgba(33, 150, 243, 0.2); border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="font-size: 24px; color: #2196f3; font-weight: bold;">${packages.length}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px;">Total Packages</div>
                        </div>
                    </div>
                </div>
            `;
        };

        // QAM Configuration Section
        window.showQAMSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            // Load existing QAM configurations
            let qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [
                {
                    id: 1,
                    name: 'QAM Modulator 1',
                    ipAddress: '239.255.1.1',
                    portStart: 5004,
                    portEnd: 5403,
                    frequencies: 16,
                    channels: 400,
                    status: 'active'
                }
            ];
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üì° QAM Configuration</h1>
                    <p class="dashboard-subtitle">Configure multiple QAM modulators with flexible IP and port settings</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">‚ûï Add New QAM Modulator</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Modulator Name:</label>
                                <input type="text" id="qamName" placeholder="QAM Modulator 1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">IP Address:</label>
                                <input type="text" id="qamIP" placeholder="239.255.1.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Port Range:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="qamPortStart" placeholder="5004" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    <span style="color: white; align-self: center;">to</span>
                                    <input type="number" id="qamPortEnd" placeholder="5403" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                </div>
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Number of Frequencies:</label>
                                <select id="qamFrequencies" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    <option value="4">4 Frequencies</option>
                                    <option value="8">8 Frequencies</option>
                                    <option value="12">12 Frequencies</option>
                                    <option value="16" selected>16 Frequencies</option>
                                    <option value="20">20 Frequencies</option>
                                    <option value="24">24 Frequencies</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Total Channels:</label>
                                <input type="number" id="qamChannels" placeholder="400" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                        </div>
                        <button onclick="addQAMModulator()" class="btn btn-success" style="padding: 12px 30px; font-size: 16px;">‚ûï Add QAM Modulator</button>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üìä Current QAM Configurations</h3>
                        <div id="qamConfigsList" style="display: flex; flex-direction: column; gap: 15px;">
                            ${qamConfigs.map(config => `
                                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; border: 2px solid ${config.status === 'active' ? '#4caf50' : '#ff9800'};">
                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                        <div>
                                            <h4 style="color: white; margin-bottom: 5px;">${config.name}</h4>
                                            <div style="display: flex; gap: 20px; font-size: 14px; color: rgba(255,255,255,0.8);">
                                                <span>üì° IP: ${config.ipAddress}</span>
                                                <span>üîå Ports: ${config.portStart}-${config.portEnd}</span>
                                                <span>üì∫ ${config.frequencies} Freq, ${config.channels} Ch</span>
                                                <span style="color: ${config.status === 'active' ? '#4caf50' : '#ff9800'};">‚óè ${config.status}</span>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="editQAMModulator(${config.id})" class="btn btn-info" style="padding: 8px 15px; font-size: 12px;">‚úèÔ∏è Edit</button>
                                            <button onclick="testQAMModulator(${config.id})" class="btn btn-warning" style="padding: 8px 15px; font-size: 12px;">üß™ Test</button>
                                            <button onclick="removeQAMModulator(${config.id})" class="btn btn-danger" style="padding: 8px 15px; font-size: 12px;">üóëÔ∏è Remove</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: rgba(33, 150, 243, 0.2); border-radius: 8px;">
                            <h4 style="color: white; margin-bottom: 10px;">üìã Bulk Configuration Options</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="generateSequentialQAMs()" class="btn btn-info" style="padding: 10px 20px;">üî¢ Generate Sequential IPs</button>
                                <button onclick="exportQAMConfig()" class="btn btn-success" style="padding: 10px 20px;">üì§ Export Config</button>
                                <button onclick="importQAMConfig()" class="btn btn-warning" style="padding: 10px 20px;">üì• Import Config</button>
                                <button onclick="updateAllUDPSettings()" class="btn btn-primary" style="padding: 10px 20px;">üîÑ Update UDP Settings</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section-card" style="margin-top: 25px;">
                    <h3 class="section-title">‚öôÔ∏è Advanced QAM Settings</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <h4 style="color: white; margin-bottom: 15px;">üåê Network Configuration</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Base IP Range:</label>
                                    <input type="text" id="baseIPRange" value="239.255.1" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Port Increment:</label>
                                    <input type="number" id="portIncrement" value="400" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Channels per Frequency:</label>
                                    <input type="number" id="channelsPerFreq" value="25" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: white; margin-bottom: 15px;">üîß Optimization Settings</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Buffer Size (ms):</label>
                                    <input type="number" id="bufferSize" value="2000" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Timeout (seconds):</label>
                                    <input type="number" id="timeoutSeconds" value="30" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Max Concurrent Streams:</label>
                                    <input type="number" id="maxStreams" value="100" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="saveQAMSettings()" class="btn btn-success" style="padding: 12px 30px; font-size: 16px;">üíæ Save Settings</button>
                    </div>
                </div>
            `;
        };

        // Package Authentication Functions
        // Package Authentication Functions
        let currentSelectedPackageId = null;
        let currentSelectedPackageName = null;
        
        window.selectPackageForApproval = function(packageId, packageName) {
            currentSelectedPackageId = packageId;
            currentSelectedPackageName = packageName;
            approvePackage();
        };
        
        window.selectPackageForRejection = function(packageId, packageName) {
            currentSelectedPackageId = packageId;
            currentSelectedPackageName = packageName;
            rejectPackage();
        };
        
        window.selectPackageForRevocation = function(packageId, packageName) {
            currentSelectedPackageId = packageId;
            currentSelectedPackageName = packageName;
            revokePackageApproval();
        };
        
        window.selectPackageForResubmission = function(packageId, packageName) {
            currentSelectedPackageId = packageId;
            currentSelectedPackageName = packageName;
            resubmitPackage();
        };
        
        window.approvePackage = function() {
            if (!currentSelectedPackageId) {
                showNotification('‚ùå No package selected', 'error');
                return;
            }
            
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || [];
            const packageIndex = packages.findIndex(pkg => pkg.id === currentSelectedPackageId);
            
            if (packageIndex === -1) {
                showNotification(`‚ùå Package "${currentSelectedPackageName}" not found`, 'error');
                return;
            }
            
            packages[packageIndex].approved = true;
            packages[packageIndex].approvedDate = new Date().toISOString();
            packages[packageIndex].approvedBy = 'admin';
            packages[packageIndex].rejectedDate = null;
            packages[packageIndex].rejectedBy = null;
            packages[packageIndex].rejectionReason = null;
            
            localStorage.setItem('adminPackages', JSON.stringify(packages));
            localStorage.setItem('packages', JSON.stringify(packages));
            
            // Trigger real-time notification to clients
            localStorage.setItem('packageApproved', JSON.stringify({
                packageId: packages[packageIndex].id,
                packageName: packages[packageIndex].name,
                timestamp: new Date().toISOString(),
                action: 'approved'
            }));
            
            // Clear selection
            currentSelectedPackageId = null;
            currentSelectedPackageName = null;
            
            showNotification(`‚úÖ Package "${packages[packageIndex].name}" approved successfully`, 'success');
            showPackageAuthenticationSection();
        };

        window.rejectPackage = function() {
            if (!currentSelectedPackageId) {
                showNotification('‚ùå No package selected', 'error');
                return;
            }
            
            const reason = prompt('Please enter rejection reason (optional):', '');
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || [];
            const packageIndex = packages.findIndex(pkg => pkg.id === currentSelectedPackageId);
            
            if (packageIndex === -1) {
                showNotification(`‚ùå Package "${currentSelectedPackageName}" not found`, 'error');
                return;
            }
            
            packages[packageIndex].approved = false;
            packages[packageIndex].rejectedDate = new Date().toISOString();
            packages[packageIndex].rejectedBy = 'admin';
            packages[packageIndex].rejectionReason = reason || 'No reason provided';
            
            localStorage.setItem('adminPackages', JSON.stringify(packages));
            localStorage.setItem('packages', JSON.stringify(packages));
            
            // Trigger real-time notification to clients
            localStorage.setItem('packageRejected', JSON.stringify({
                packageId: packages[packageIndex].id,
                packageName: packages[packageIndex].name,
                timestamp: new Date().toISOString(),
                reason: reason || 'No reason provided',
                action: 'rejected'
            }));
            
            // Clear selection
            currentSelectedPackageId = null;
            currentSelectedPackageName = null;
            
            showNotification(`‚ùå Package "${packages[packageIndex].name}" rejected`, 'info');
            showPackageAuthenticationSection();
        };

        window.revokePackageApproval = function() {
            if (!currentSelectedPackageId) {
                showNotification('‚ùå No package selected', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to revoke approval for this package? It will no longer be visible to clients.')) {
                return;
            }
            
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || [];
            const packageIndex = packages.findIndex(pkg => pkg.id === currentSelectedPackageId);
            
            if (packageIndex === -1) {
                showNotification(`‚ùå Package "${currentSelectedPackageName}" not found`, 'error');
                return;
            }
            
            packages[packageIndex].approved = false;
            packages[packageIndex].approvedDate = null;
            packages[packageIndex].approvedBy = null;
            
            localStorage.setItem('adminPackages', JSON.stringify(packages));
            localStorage.setItem('packages', JSON.stringify(packages));
            
            // Trigger real-time notification to clients
            localStorage.setItem('packageApprovalRevoked', JSON.stringify({
                packageId: packages[packageIndex].id,
                packageName: packages[packageIndex].name,
                timestamp: new Date().toISOString(),
                action: 'approval_revoked'
            }));
            
            // Clear selection
            currentSelectedPackageId = null;
            currentSelectedPackageName = null;
            
            showNotification(`üîÑ Package "${packages[packageIndex].name}" approval revoked`, 'warning');
            showPackageAuthenticationSection();
        };

        window.resubmitPackage = function() {
            if (!currentSelectedPackageId) {
                showNotification('‚ùå No package selected', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to resubmit this package for approval?')) {
                return;
            }
            
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || [];
            const packageIndex = packages.findIndex(pkg => pkg.id === currentSelectedPackageId);
            
            if (packageIndex === -1) {
                showNotification(`‚ùå Package "${currentSelectedPackageName}" not found`, 'error');
                return;
            }
            
            packages[packageIndex].approved = false;
            packages[packageIndex].rejectedDate = null;
            packages[packageIndex].rejectedBy = null;
            packages[packageIndex].rejectionReason = null;
            
            localStorage.setItem('adminPackages', JSON.stringify(packages));
            localStorage.setItem('packages', JSON.stringify(packages));
            
            // Trigger real-time notification to clients
            localStorage.setItem('packageResubmitted', JSON.stringify({
                packageId: packages[packageIndex].id,
                packageName: packages[packageIndex].name,
                timestamp: new Date().toISOString(),
                action: 'resubmitted'
            }));
            
            // Clear selection
            currentSelectedPackageId = null;
            currentSelectedPackageName = null;
            
            showNotification(`üîÑ Package "${packages[packageIndex].name}" resubmitted for approval`, 'info');
            showPackageAuthenticationSection();
        };

        // QAM Management Functions
        window.addQAMModulator = function() {
            const name = document.getElementById('qamName').value;
            const ipAddress = document.getElementById('qamIP').value;
            const portStart = parseInt(document.getElementById('qamPortStart').value);
            const portEnd = parseInt(document.getElementById('qamPortEnd').value);
            const frequencies = parseInt(document.getElementById('qamFrequencies').value);
            const channels = parseInt(document.getElementById('qamChannels').value);
            
            if (!name || !ipAddress || !portStart || !portEnd || !frequencies || !channels) {
                showNotification('‚ùå Please fill all fields', 'error');
                return;
            }
            
            if (portEnd <= portStart) {
                showNotification('‚ùå End port must be greater than start port', 'error');
                return;
            }
            
            let qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [];
            const newConfig = {
                id: Date.now(),
                name: name,
                ipAddress: ipAddress,
                portStart: portStart,
                portEnd: portEnd,
                frequencies: frequencies,
                channels: channels,
                status: 'active'
            };
            
            qamConfigs.push(newConfig);
            localStorage.setItem('qamConfigurations', JSON.stringify(qamConfigs));
            
            showNotification(`‚úÖ QAM Modulator "${name}" added successfully`, 'success');
            showQAMSection(); // Refresh the section
        };

        window.editQAMModulator = function(id) {
            let qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [];
            const config = qamConfigs.find(c => c.id === id);
            
            if (!config) {
                showNotification('‚ùå QAM configuration not found', 'error');
                return;
            }
            
            // Simple edit - in a real implementation, you'd create a proper edit form
            const newName = prompt('Enter new name:', config.name);
            const newIP = prompt('Enter new IP address:', config.ipAddress);
            
            if (newName) config.name = newName;
            if (newIP) config.ipAddress = newIP;
            
            localStorage.setItem('qamConfigurations', JSON.stringify(qamConfigs));
            showNotification('‚úÖ QAM configuration updated', 'success');
            showQAMSection();
        };

        window.testQAMModulator = function(id) {
            let qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [];
            const config = qamConfigs.find(c => c.id === id);
            
            if (!config) return;
            
            showNotification(`üß™ Testing QAM ${config.name} (${config.ipAddress}:${config.portStart}-${config.portEnd})...`, 'info');
            
            setTimeout(() => {
                // Simulate testing all frequencies
                let successCount = 0;
                for (let i = 1; i <= config.frequencies; i++) {
                    const testIP = config.ipAddress.replace(/\.\d+$/, `.${i}`);
                    if (Math.random() > 0.1) { // 90% success rate
                        successCount++;
                    }
                }
                
                showNotification(`‚úÖ Test complete: ${successCount}/${config.frequencies} frequencies working`, 'success');
            }, 3000);
        };

        window.removeQAMModulator = function(id) {
            if (!confirm('Are you sure you want to remove this QAM modulator?')) return;
            
            let qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [];
            qamConfigs = qamConfigs.filter(c => c.id !== id);
            
            localStorage.setItem('qamConfigurations', JSON.stringify(qamConfigs));
            showNotification('‚úÖ QAM modulator removed', 'success');
            showQAMSection();
        };

        window.generateSequentialQAMs = function() {
            const count = prompt('How many QAM modulators to generate?', '3');
            const baseIP = document.getElementById('baseIPRange').value || '239.255.1';
            const portStart = 5004;
            const portIncrement = parseInt(document.getElementById('portIncrement').value) || 400;
            const frequencies = parseInt(document.getElementById('qamFrequencies').value) || 16;
            const channels = parseInt(document.getElementById('qamChannels').value) || 400;
            
            let qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [];
            
            for (let i = 1; i <= count; i++) {
                const newConfig = {
                    id: Date.now() + i,
                    name: `QAM Modulator ${i}`,
                    ipAddress: `${baseIP}.${i}`,
                    portStart: portStart + (i - 1) * portIncrement,
                    portEnd: portStart + (i - 1) * portIncrement + portIncrement - 1,
                    frequencies: frequencies,
                    channels: channels,
                    status: 'active'
                };
                qamConfigs.push(newConfig);
            }
            
            localStorage.setItem('qamConfigurations', JSON.stringify(qamConfigs));
            showNotification(`‚úÖ Generated ${count} sequential QAM modulators`, 'success');
            showQAMSection();
        };

        window.exportQAMConfig = function() {
            const qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [];
            const dataStr = JSON.stringify(qamConfigs, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'qam-configurations.json';
            link.click();
            
            showNotification('üì§ QAM configuration exported', 'success');
        };

        window.importQAMConfig = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const configs = JSON.parse(e.target.result);
                        localStorage.setItem('qamConfigurations', JSON.stringify(configs));
                        showNotification('üì• QAM configuration imported', 'success');
                        showQAMSection();
                    } catch (error) {
                        showNotification('‚ùå Invalid configuration file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        };

        window.updateAllUDPSettings = function() {
            // Update the generateUDPStreams function to use dynamic configurations
            showNotification('üîÑ Updating UDP settings for all modulators...', 'info');
            
            setTimeout(() => {
                showNotification('‚úÖ UDP settings updated across all packages', 'success');
            }, 2000);
        };

        window.saveQAMSettings = function() {
            const settings = {
                baseIPRange: document.getElementById('baseIPRange').value,
                portIncrement: parseInt(document.getElementById('portIncrement').value),
                channelsPerFreq: parseInt(document.getElementById('channelsPerFreq').value),
                bufferSize: parseInt(document.getElementById('bufferSize').value),
                timeoutSeconds: parseInt(document.getElementById('timeoutSeconds').value),
                maxStreams: parseInt(document.getElementById('maxStreams').value)
            };
            
            localStorage.setItem('qamSettings', JSON.stringify(settings));
            showNotification('üíæ QAM settings saved', 'success');
        };

        // Content Folders Management Section
        window.showContentFoldersSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            // Load existing folder configurations
            let folderConfigs = JSON.parse(localStorage.getItem('contentFolders')) || getDefaultFolderStructure();
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üìÅ Content Folders Management</h1>
                    <p class="dashboard-subtitle">Create hierarchical folder structure with per-channel granularity for organized IPTV packages</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">üèóÔ∏è Main Package Structure</h3>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <div style="border: 2px solid #4caf50; border-radius: 8px; padding: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <span style="font-size: 32px; margin-right: 15px;">üì¶</span>
                                    <div>
                                        <h3 style="color: #4caf50; margin: 0;">Basic Package</h3>
                                        <p style="color: rgba(255,255,255,0.8); margin: 5px 0 0 0; font-size: 14px;">Main subscription folder - contains all subcategories</p>
                                    </div>
                                </div>
                                
                                <div style="padding-left: 20px;">
                                    <div style="background: rgba(33, 150, 243, 0.2); border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center;">
                                            <span style="font-size: 24px; margin-right: 10px;">üì∞</span>
                                            <div style="flex: 1;">
                                                <h4 style="color: white; margin: 0 0 5px 0;">News Channels</h4>
                                                <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 13px;">Mix of channels from different IPs - Channels: 1-10 per IP</p>
                                            </div>
                                            <button onclick="editFolder('news')" class="btn btn-info" style="padding: 5px 10px; font-size: 11px;">‚úèÔ∏è Edit</button>
                                        </div>
                                    </div>
                                    
                                    <div style="background: rgba(76, 175, 80, 0.2); border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center;">
                                            <span style="font-size: 24px; margin-right: 10px;">üé¨</span>
                                            <div style="flex: 1;">
                                                <h4 style="color: white; margin: 0 0 5px 0;">Movies Channels</h4>
                                                <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 13px;">Mix of channels from different IPs - Channels: 11-20 per IP</p>
                                            </div>
                                            <button onclick="editFolder('movies')" class="btn btn-info" style="padding: 5px 10px; font-size: 11px;">‚úèÔ∏è Edit</button>
                                        </div>
                                    </div>
                                    
                                    <div style="background: rgba(255, 152, 0, 0.2); border-radius: 6px; padding: 15px;">
                                        <div style="display: flex; align-items: center;">
                                            <span style="font-size: 24px; margin-right: 10px;">‚öΩ</span>
                                            <div style="flex: 1;">
                                                <h4 style="color: white; margin: 0 0 5px 0;">Sports Channels</h4>
                                                <p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 13px;">Mix of channels from different IPs - Channels: 21-30 per IP</p>
                                            </div>
                                            <button onclick="editFolder('sports')" class="btn btn-info" style="padding: 5px 10px; font-size: 11px;">‚úèÔ∏è Edit</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="addNewSubFolder()" class="btn btn-success">‚ûï Add Subfolder</button>
                            <button onclick="importChannelMapping()" class="btn btn-warning">üì• Import Channels</button>
                            <button onclick="exportFolderStructure()" class="btn btn-info">üì§ Export Structure</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üìä Channel Distribution Overview</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                                <h4 style="color: #2196f3; margin-bottom: 10px;">üì∞ News Folder</h4>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                                    <div>Channels: 1-30 (3 IPs √ó 10 ch)</div>
                                    <div>IPs: 239.255.1.1, 1.2, 1.3</div>
                                    <div>Individual channels in client</div>
                                </div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                                <h4 style="color: #4caf50; margin-bottom: 10px;">üé¨ Movies Folder</h4>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                                    <div>Channels: 31-60 (3 IPs √ó 10 ch)</div>
                                    <div>IPs: 239.255.1.1, 1.2, 1.3</div>
                                    <div>Individual channels in client</div>
                                </div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                                <h4 style="color: #ff9800; margin-bottom: 10px;">‚öΩ Sports Folder</h4>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                                    <div>Channels: 61-90 (3 IPs √ó 10 ch)</div>
                                    <div>IPs: 239.255.1.1, 1.2, 1.3</div>
                                    <div>Individual channels in client</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section-card" style="margin-top: 25px;">
                    <h3 class="section-title">‚öôÔ∏è Advanced Folder Configuration</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <h4 style="color: white; margin-bottom: 15px;">üéØ Channel Assignment Rules</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Channels per IP:</label>
                                    <input type="number" id="channelsPerIP" value="10" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Base Channel Number:</label>
                                    <input type="number" id="baseChannelNumber" value="1" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Show channels individually:</label>
                                    <input type="checkbox" id="individualChannels" checked style="margin-right: 8px;">
                                    <span style="color: rgba(255,255,255,0.8);">Each channel as separate entry</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: white; margin-bottom: 15px;">üì¶ Package Configuration</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Main Package Name:</label>
                                    <input type="text" id="mainPackageName" value="Basic" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Subscription Type:</label>
                                    <select id="subscriptionType" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                                        <option value="all-subfolders">Complete Package (All Subfolders)</option>
                                        <option value="custom-selection">Custom Channel Selection</option>
                                        <option value="tiered">Tiered Access</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Customer Sees:</label>
                                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-top: 5px;">
                                        <div style="color: white; font-weight: bold;">Basic Package</div>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">‚Üí News (30 channels)</div>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">‚Üí Movies (30 channels)</div>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">‚Üí Sports (30 channels)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="saveFolderConfiguration()" class="btn btn-success" style="padding: 12px 30px; font-size: 16px; margin-right: 10px;">üíæ Save Configuration</button>
                        <button onclick="generatePlexStructure()" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px;">üì∫ Generate Plex Structure</button>
                    </div>
                </div>
            `;
        };

        // Folder Management Functions
        function getDefaultFolderStructure() {
            return {
                mainPackage: {
                    name: "Basic",
                    description: "Complete IPTV package",
                    subscriptionType: "complete",
                    subfolders: [
                        {
                            id: "news",
                            name: "News Channels",
                            icon: "üì∞",
                            color: "#2196f3",
                            channels: []
                        },
                        {
                            id: "movies",
                            name: "Movies Channels",
                            icon: "üé¨",
                            color: "#4caf50",
                            channels: []
                        },
                        {
                            id: "sports",
                            name: "Sports Channels",
                            icon: "‚öΩ",
                            color: "#ff9800",
                            channels: []
                        }
                    ]
                }
            };
        }

        window.editFolder = function(folderId) {
            const folderConfigs = JSON.parse(localStorage.getItem('contentFolders')) || getDefaultFolderStructure();
            const folder = folderConfigs.mainPackage.subfolders.find(f => f.id === folderId);
            
            if (!folder) {
                showNotification('‚ùå Folder not found', 'error');
                return;
            }
            
            const newName = prompt(`Edit folder name:`, folder.name);
            if (newName) {
                folder.name = newName;
                localStorage.setItem('contentFolders', JSON.stringify(folderConfigs));
                showNotification('‚úÖ Folder updated', 'success');
                showContentFoldersSection();
            }
        };

        window.addNewSubFolder = function() {
            const folderName = prompt('Enter new subfolder name:');
            if (!folderName) return;
            
            const folderConfigs = JSON.parse(localStorage.getItem('contentFolders')) || getDefaultFolderStructure();
            const newFolder = {
                id: folderName.toLowerCase().replace(/\s+/g, '-'),
                name: folderName,
                icon: "üì∫",
                color: "#9c27b0",
                channels: []
            };
            
            folderConfigs.mainPackage.subfolders.push(newFolder);
            localStorage.setItem('contentFolders', JSON.stringify(folderConfigs));
            showNotification(`‚úÖ Added folder "${folderName}"`, 'success');
            showContentFoldersSection();
        };

        window.importChannelMapping = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        localStorage.setItem('contentFolders', JSON.stringify(data));
                        showNotification('üì• Channel mapping imported', 'success');
                        showContentFoldersSection();
                    } catch (error) {
                        showNotification('‚ùå Invalid mapping file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        };

        window.exportFolderStructure = function() {
            const folderConfigs = JSON.parse(localStorage.getItem('contentFolders')) || getDefaultFolderStructure();
            const dataStr = JSON.stringify(folderConfigs, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'content-folders.json';
            link.click();
            
            showNotification('üì§ Folder structure exported', 'success');
        };

        window.saveFolderConfiguration = function() {
            const settings = {
                channelsPerIP: parseInt(document.getElementById('channelsPerIP').value),
                baseChannelNumber: parseInt(document.getElementById('baseChannelNumber').value),
                individualChannels: document.getElementById('individualChannels').checked,
                mainPackageName: document.getElementById('mainPackageName').value,
                subscriptionType: document.getElementById('subscriptionType').value
            };
            
            localStorage.setItem('folderSettings', JSON.stringify(settings));
            showNotification('üíæ Folder configuration saved', 'success');
        };

        window.generatePlexStructure = function() {
            const folderConfigs = JSON.parse(localStorage.getItem('contentFolders')) || getDefaultFolderStructure();
            const settings = JSON.parse(localStorage.getItem('folderSettings')) || {};
            
            // Generate Plex-compatible structure
            const plexStructure = {
                mainPackage: folderConfigs.mainPackage.name,
                subscriptionAccess: "Complete package - all subfolders included",
                folderStructure: folderConfigs.mainPackage.subfolders.map(folder => ({
                    name: folder.name,
                    channels: folder.channels.length,
                    ipSources: [...new Set(folder.channels.map(ch => ch.ip))],
                    clientDisplay: "Individual channels (not bulk IPs)"
                })),
                totalChannels: folderConfigs.mainPackage.subfolders.reduce((sum, folder) => sum + folder.channels.length, 0),
                adminSubscription: "Offer 'Basic Package' - includes all subfolders automatically"
            };
            
            console.log('Generated Plex Structure:', plexStructure);
            showNotification('üì∫ Plex structure generated - Ready for customer subscriptions', 'success');
        };

        // Satellite functions
        function testSatelliteConnection() {
            showNotification('üõ∞Ô∏è Testing satellite connection...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ Satellite connection successful - 400 channels detected', 'success');
            }, 2000);
        }

        function configureQAMChannels() {
            showNotification('‚öôÔ∏è Configuring QAM modulator for 400 channels...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ QAM configuration complete - All channels ready', 'success');
            }, 3000);
        }

        function testUDPStreams() {
            // Load dynamic QAM configurations
            const qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [];
            
            if (qamConfigs.length === 0) {
                showNotification('‚ùå No QAM configurations found. Please add QAM modulators first.', 'error');
                return;
            }
            
            const config = qamConfigs[0]; // Test first configured QAM
            showNotification(`üîÑ Testing UDP streams (${config.ipAddress}:${config.portStart}-${config.portEnd})...`, 'info');
            
            setTimeout(() => {
                showNotification(`‚úÖ All ${config.channels} UDP streams tested successfully on ${config.name}`, 'success');
            }, 4000);
        }

        function setupPlexIntegration() {
            showNotification('üì∫ Setting up Plex integration...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ Plex integration configured - Ready for streaming', 'success');
            }, 2500);
        }
        
        function setupFiberDistribution() {
            showNotification('üåê Setting up fiber optic distribution network...', 'info');
            
            setTimeout(() => {
                showNotification('üåê Fiber network configured - Ready for ONU distribution', 'success');
                
                // Initialize fiber network configuration
                initializeFiberNetwork();
            }, 3000);
        }
        
        function configureEndUserAccess() {
            showNotification('üë• Configuring end user access for quota-free viewing...', 'info');
            
            setTimeout(() => {
                showNotification('‚úÖ End user access configured - No internet quota required', 'success');
            }, 2500);
        }
        
        function configureONUDistribution() {
            showNotification('üåê Configuring ONU for fiber distribution...', 'info');
            
            setTimeout(() => {
                showNotification('‚úÖ ONU configured - Ready for UDP streaming to end users', 'success');
                
                // Show ONU configuration summary
                showONUConfigurationSummary();
            }, 3000);
        }
        
        function initializeFiberNetwork() {
            const fiberConfig = {
                networkType: 'GPON/EPON',
                udpMulticast: true,
                vlanId: 100,
                qos: 'high_priority',
                bandwidth: 'unlimited',
                quotaFree: true,
                streamingReady: true,
                createdAt: new Date().toISOString()
            };
            
            // Save fiber network configuration
            localStorage.setItem('fiberNetworkConfig', JSON.stringify(fiberConfig));
            
            console.log('üåê Fiber network initialized:', fiberConfig);
        }
        
        function showONUConfigurationSummary() {
            const onuSummary = `
                üìã ONU Configuration Summary:
                
                üåê Network: GPON/EPON Fiber
                üì° VLAN: 100 (IPTV Traffic)
                üîÑ IGMP Proxy: Enabled
                üì∫ Multicast: UDP 239.255.1.0/24
                ‚ö° QoS: High Priority
                üìä Bandwidth: Unlimited
                üö´ Data Quota: Not Required
                üì∫ Streaming: Direct UDP Access
                
                ‚úÖ Ready for End Users
            `;
            
            console.log('ONU Configuration:', onuSummary);
            
            // Display in a notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: rgba(76, 175, 80, 0.9); 
                color: white; padding: 20px; 
                border-radius: 10px; 
                z-index: 10000; 
                max-width: 400px;
                font-family: monospace;
                font-size: 12px;
                line-height: 1.4;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            notification.textContent = onuSummary;
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 10000);
        }

        function saveSatelliteConfig() {
            showNotification('üíæ Saving satellite configuration...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ Configuration saved successfully', 'success');
            }, 1500);
        }

        // Content management functions
        function addContentSource() {
            const name = document.getElementById('contentName')?.value;
            const type = document.getElementById('contentType')?.value;
            const url = document.getElementById('contentURL')?.value;
            const quality = document.getElementById('contentQuality')?.value;
            
            if (!name || !url) {
                showNotification('‚ùå Please fill required fields (Name and URL)', 'error');
                return;
            }
            
            showNotification('üì∫ Adding content source...', 'info');
            setTimeout(() => {
                showNotification(`‚úÖ "${name}" (${type}) added successfully - ${quality}`, 'success');
                // Clear form
                if (document.getElementById('contentName')) document.getElementById('contentName').value = '';
                if (document.getElementById('contentURL')) document.getElementById('contentURL').value = '';
            }, 2000);
        }

        // Settings management functions
        function saveSecuritySettings() {
            const adminPass = document.getElementById('adminPassword')?.value;
            const masterPass = document.getElementById('masterPassword')?.value;
            const timeout = document.getElementById('sessionTimeout')?.value;
            
            showNotification('üîí Saving security settings...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ Security settings saved successfully', 'success');
            }, 2000);
        }

        function saveSystemSettings() {
            const systemName = document.getElementById('systemName')?.value;
            const apiEndpoint = document.getElementById('apiEndpoint')?.value;
            const timeZone = document.getElementById('timeZone')?.value;
            
            showNotification('‚öôÔ∏è Saving system settings...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ System settings saved successfully', 'success');
            }, 2000);
        }

        // Save GitHub Settings
        window.saveGithubSettings = function() {
            const username = document.getElementById('githubUsername')?.value || '';
            const repo = document.getElementById('githubRepo')?.value || '';
            const token = document.getElementById('githubToken')?.value || '';
            
            localStorage.setItem('githubUsername', username);
            localStorage.setItem('githubRepo', repo);
            localStorage.setItem('githubToken', token);
            
            // Auto-generate sync URL
            if (username && repo) {
                const syncUrl = `https://raw.githubusercontent.com/${username}/${repo}/main/admin_data.json`;
                localStorage.setItem('tvSyncUrl', syncUrl);
            }
            
            showNotification('‚úÖ GitHub settings saved!', 'success');
        };
        
        // Load GitHub Settings
        window.loadGithubSettings = function() {
            const usernameInput = document.getElementById('githubUsername');
            const repoInput = document.getElementById('githubRepo');
            const tokenInput = document.getElementById('githubToken');
            
            if (usernameInput) usernameInput.value = localStorage.getItem('githubUsername') || '';
            if (repoInput) repoInput.value = localStorage.getItem('githubRepo') || '';
            if (tokenInput) tokenInput.value = localStorage.getItem('githubToken') || '';
        };
        
        // Mobile-compatible base64 encoding
        function safeBase64Encode(str) {
            try {
                // Method 1: Standard approach
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e1) {
                try {
                    // Method 2: TextEncoder approach (mobile-friendly)
                    const bytes = new TextEncoder().encode(str);
                    let binary = '';
                    bytes.forEach(b => binary += String.fromCharCode(b));
                    return btoa(binary);
                } catch (e2) {
                    // Method 3: Manual UTF-8 encoding
                    const utf8 = unescape(encodeURIComponent(str));
                    return btoa(utf8);
                }
            }
        }
        
        // Upload to GitHub with one click
        window.uploadToGithub = async function() {
            const username = localStorage.getItem('githubUsername');
            const repo = localStorage.getItem('githubRepo');
            const token = localStorage.getItem('githubToken');
            
            if (!username || !repo || !token) {
                showNotification('‚ö†Ô∏è Please configure GitHub settings first!', 'error');
                return;
            }
            
            // Validate token format
            if (token.length < 30 || token.includes(' ')) {
                showNotification('‚ö†Ô∏è Invalid GitHub token format!', 'error');
                return;
            }
            
            const btn = document.getElementById('uploadGithubBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Uploading...';
            
            try {
                // Build resellers object with wallet balances
                const resellersData = {};
                const resellerAccounts = JSON.parse(localStorage.getItem('RESELLER_ACCOUNTS') || '{}');
                
                // Add all reseller accounts with wallet balances
                Object.keys(resellerAccounts).forEach(resellerId => {
                    const reseller = resellerAccounts[resellerId];
                    const walletBalance = parseFloat(localStorage.getItem(`resellerWallet_${resellerId}`) || '0');
                    resellersData[resellerId] = {
                        ...reseller,
                        walletBalance: walletBalance
                    };
                });
                
                // Get credit transfers history
                const creditTransfers = JSON.parse(localStorage.getItem('creditTransfers') || '[]');
                
                // Get reseller transactions
                const resellerTransactions = JSON.parse(localStorage.getItem('resellerTransactions') || '[]');
                
                // Prepare data (clean JSON without special characters)
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    customers: JSON.parse(localStorage.getItem('adminCustomers') || '[]'),
                    packages: JSON.parse(localStorage.getItem('adminPackages') || '[]'),
                    resellers: resellersData,
                    creditTransfers: creditTransfers,
                    resellerTransactions: resellerTransactions,
                    plexServerUrl: localStorage.getItem('plexServerUrl') || '',
                    plexToken: localStorage.getItem('plexToken') || '',
                    plexMoviesSection: localStorage.getItem('plexMoviesSection') || '',
                    plexAdultSection: localStorage.getItem('plexAdultSection') || '',
                    tvSyncUrl: `https://raw.githubusercontent.com/${username}/${repo}/main/admin_data.json`,
                    githubToken: token,
                    githubUsername: username,
                    githubRepo: repo
                };
                
                // Use mobile-compatible base64 encoding
                const jsonString = JSON.stringify(exportData, null, 2);
                const content = safeBase64Encode(jsonString);
                const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/admin_data.json`;
                
                // Function to get fresh SHA with aggressive cache-busting
                const getFreshSHA = async () => {
                    try {
                        // Use unique timestamp to prevent any caching
                        const noCacheUrl = apiUrl + '?_=' + Date.now() + Math.random();
                        const checkRes = await fetch(noCacheUrl, {
                            method: 'GET',
                            headers: { 
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            },
                            cache: 'no-store'
                        });
                        if (checkRes.ok) {
                            const fileData = await checkRes.json();
                            console.log('Got SHA:', fileData.sha);
                            return fileData.sha;
                        } else if (checkRes.status === 404) {
                            console.log('File does not exist, will create new');
                            return null;
                        }
                    } catch (e) {
                        console.log('Error getting SHA:', e);
                    }
                    return null;
                };
                
                // Upload with retry logic for 409/422 errors
                const uploadWithRetry = async (retries = 5) => {
                    let lastError = null;
                    
                    for (let attempt = 1; attempt <= retries; attempt++) {
                        console.log(`Upload attempt ${attempt}/${retries}`);
                        btn.innerHTML = `‚è≥ Uploading... (${attempt}/${retries})`;
                        
                        // Get fresh SHA for each attempt
                        const sha = await getFreshSHA();
                        
                        const body = {
                            message: `Update admin_data.json - ${new Date().toISOString()}`,
                            content: content
                        };
                        
                        // Only include SHA if file exists
                        if (sha) {
                            body.sha = sha;
                        }
                        
                        try {
                            const response = await fetch(apiUrl, {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${token}`,
                                    'Accept': 'application/vnd.github.v3+json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(body)
                            });
                            
                            if (response.ok) {
                                console.log('Upload successful!');
                                return response;
                            }
                            
                            const errorData = await response.json().catch(() => ({}));
                            console.log('Error response:', response.status, errorData);
                            
                            // Retry on 409 (conflict) or 422 (validation error)
                            if ((response.status === 409 || response.status === 422) && attempt < retries) {
                                console.log(`Error ${response.status}, waiting and retrying...`);
                                await new Promise(r => setTimeout(r, 1500 * attempt)); // Increasing delay
                                continue;
                            }
                            
                            lastError = `Error ${response.status}: ${errorData.message || 'Unknown error'}`;
                        } catch (fetchError) {
                            console.log('Fetch error:', fetchError);
                            lastError = fetchError.message;
                            if (attempt < retries) {
                                await new Promise(r => setTimeout(r, 1000));
                                continue;
                            }
                        }
                    }
                    
                    throw new Error(lastError || 'Upload failed after all retries');
                };
                
                await uploadWithRetry();
                
                showNotification('‚úÖ Uploaded to GitHub! TVs will auto-sync.', 'success');
                btn.innerHTML = '‚úÖ Uploaded!';
                setTimeout(() => {
                    btn.innerHTML = 'üöÄ Upload to GitHub (One-Click)';
                    btn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('GitHub upload error:', error);
                showNotification('‚ùå Upload failed: ' + error.message, 'error');
                btn.innerHTML = 'üöÄ Upload to GitHub (One-Click)';
                btn.disabled = false;
            }
        };
        
        function backupData() {
            // Export all data to a JSON file
            try {
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    customers: JSON.parse(localStorage.getItem('adminCustomers') || '[]'),
                    packages: JSON.parse(localStorage.getItem('adminPackages') || '[]'),
                    resellers: JSON.parse(localStorage.getItem('RESELLER_ACCOUNTS') || '{}'),
                    plexConfig: {
                        serverUrl: localStorage.getItem('plexServerUrl') || '',
                        token: localStorage.getItem('plexToken') || '',
                        moviesSection: localStorage.getItem('plexMoviesSection') || '',
                        adultSection: localStorage.getItem('plexAdultSection') || ''
                    },
                    contentMappings: JSON.parse(localStorage.getItem('packageContentMappings') || '{}'),
                    adminCredentials: JSON.parse(localStorage.getItem('adminPasswords') || '{}'),
                    tvSyncUrl: localStorage.getItem('tvSyncUrl') || ''
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `iwatch_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('‚úÖ Data exported successfully! Check your downloads.', 'success');
            } catch (e) {
                console.error('Export failed:', e);
                showNotification('‚ùå Export failed: ' + e.message, 'error');
            }
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.version || !data.customers) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Confirm before importing
                    if (!confirm(`Import backup from ${data.exportDate}?\n\nThis will replace:\n- ${data.customers?.length || 0} customers\n- ${data.packages?.length || 0} packages\n- Plex configuration\n\nContinue?`)) {
                        return;
                    }
                    
                    // Import all data
                    if (data.customers) {
                        localStorage.setItem('adminCustomers', JSON.stringify(data.customers));
                        localStorage.setItem('customers', JSON.stringify(data.customers));
                        window.customers = data.customers;
                    }
                    if (data.packages) {
                        localStorage.setItem('adminPackages', JSON.stringify(data.packages));
                        localStorage.setItem('packages', JSON.stringify(data.packages));
                    }
                    if (data.resellers) {
                        localStorage.setItem('RESELLER_ACCOUNTS', JSON.stringify(data.resellers));
                    }
                    if (data.plexConfig) {
                        if (data.plexConfig.serverUrl) localStorage.setItem('plexServerUrl', data.plexConfig.serverUrl);
                        if (data.plexConfig.token) localStorage.setItem('plexToken', data.plexConfig.token);
                        if (data.plexConfig.moviesSection) localStorage.setItem('plexMoviesSection', data.plexConfig.moviesSection);
                        if (data.plexConfig.adultSection) localStorage.setItem('plexAdultSection', data.plexConfig.adultSection);
                    }
                    if (data.contentMappings) {
                        localStorage.setItem('packageContentMappings', JSON.stringify(data.contentMappings));
                    }
                    if (data.adminCredentials) {
                        localStorage.setItem('adminPasswords', JSON.stringify(data.adminCredentials));
                    }
                    
                    showNotification('‚úÖ Data imported successfully! Refreshing...', 'success');
                    
                    // Refresh the page to load new data
                    setTimeout(() => location.reload(), 1500);
                    
                } catch (e) {
                    console.error('Import failed:', e);
                    showNotification('‚ùå Import failed: ' + e.message, 'error');
                }
            };
            input.click();
        }

        function clearCache() {
            showNotification('üóëÔ∏è Clearing system cache...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ Cache cleared successfully', 'success');
            }, 1500);
        }

        function restartServices() {
            showNotification('üîÑ Restarting system services...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ All services restarted successfully', 'success');
            }, 3000);
        }

        function updateSystem() {
            showNotification('‚¨ÜÔ∏è Checking for system updates...', 'info');
            setTimeout(() => {
                showNotification('‚úÖ System is up to date', 'success');
            }, 2000);
        }

        // Credit management functions
        function transferCredits() {
            const reseller = document.getElementById('creditReseller')?.value;
            const amount = parseFloat(document.getElementById('creditAmount')?.value);
            const note = document.getElementById('creditNote')?.value;
            
            if (!reseller || !amount || amount <= 0) {
                showNotification('‚ùå Please select reseller and enter valid amount', 'error');
                return;
            }
            
            try {
                console.log('üí∞ Starting credit transfer to:', reseller, 'Amount:', amount);
                
                showNotification('üí∞ Processing credit transfer...', 'info');
                
                // Get reseller's current wallet balance
                const walletKey = `resellerWallet_${reseller}`;
                const currentBalance = parseFloat(localStorage.getItem(walletKey)) || 0;
                const newBalance = currentBalance + amount;
                
                // Update reseller's wallet balance
                localStorage.setItem(walletKey, newBalance.toString());
                console.log('üí∞ Updated wallet balance for', reseller, ':', newBalance);
                
                // Get current transaction history
                const transactionHistory = JSON.parse(localStorage.getItem('transactionHistory') || '{}');
                
                // Add new transaction record
                const transactionRecord = {
                    dateTime: new Date().toLocaleString(),
                    timestamp: Date.now(),
                    type: 'credit',
                    amount: amount,
                    previousBalance: currentBalance,
                    newBalance: newBalance,
                    resellerId: reseller,
                    adminId: 'admin',
                    status: 'completed',
                    description: note || 'Admin credit transfer'
                };
                
                // Initialize reseller transactions array if it doesn't exist
                if (!transactionHistory[reseller]) {
                    transactionHistory[reseller] = [];
                }
                
                // Add transaction to history
                transactionHistory[reseller].push(transactionRecord);
                
                // Save updated transaction history
                localStorage.setItem('transactionHistory', JSON.stringify(transactionHistory));
                console.log('üí∞ Added transaction record:', transactionRecord);
                
                // Add to creditTransfers for overview display and GitHub sync
                const creditTransfers = JSON.parse(localStorage.getItem('creditTransfers') || '[]');
                const transferRecord = {
                    id: 'credit_' + Date.now(),
                    resellerId: reseller,
                    amount: amount,
                    type: 'credit',
                    date: new Date().toISOString(),
                    note: note || 'Admin credit transfer',
                    timestamp: Date.now(),
                    previousBalance: currentBalance,
                    newBalance: newBalance
                };
                creditTransfers.push(transferRecord);
                localStorage.setItem('creditTransfers', JSON.stringify(creditTransfers));
                
                // Also update RESELLER_ACCOUNTS with new balance
                const resellerAccounts = JSON.parse(localStorage.getItem('RESELLER_ACCOUNTS') || '{}');
                if (resellerAccounts[reseller]) {
                    resellerAccounts[reseller].walletBalance = newBalance;
                    localStorage.setItem('RESELLER_ACCOUNTS', JSON.stringify(resellerAccounts));
                }
                
                // Trigger storage events for real-time updates
                localStorage.setItem('creditTransfer_sync', Date.now());
                localStorage.removeItem('creditTransfer_sync');
                
                // Clear form
                if (document.getElementById('creditAmount')) document.getElementById('creditAmount').value = '';
                if (document.getElementById('creditNote')) document.getElementById('creditNote').value = '';
                
                // Update display if credit overview is visible
                updateCreditOverview();
                
                // Notify success
                setTimeout(() => {
                    showNotification(`‚úÖ $${amount.toFixed(2)} transferred to "${reseller}" successfully${note ? ' - ' + note : ''}`, 'success');
                }, 500);
                
                console.log('‚úÖ Credit transfer completed successfully');
                
            } catch (error) {
                console.error('‚ùå Credit transfer failed:', error);
                showNotification('‚ùå Credit transfer failed. Please try again.', 'error');
            }
        }

        // Reseller management functions
        function createNewReseller() {
            const resellerId = document.getElementById('resellerId')?.value;
            const username = document.getElementById('resellerUsername')?.value;
            const password = document.getElementById('resellerPassword')?.value;
            const commission = document.getElementById('resellerCommission')?.value;
            
            if (!resellerId || !username || !password) {
                showNotification('‚ùå Please fill all required fields', 'error');
                return;
            }
            
            // Use the password manager to create the reseller
            const result = passwordManager.createReseller(resellerId, username, password);
            
            if (result.success) {
                showNotification(`üè¢ Reseller "${resellerId}" created successfully with ${commission || 20}% commission`, 'success');
                // Clear form
                if (document.getElementById('resellerId')) document.getElementById('resellerId').value = '';
                if (document.getElementById('resellerUsername')) document.getElementById('resellerUsername').value = '';
                if (document.getElementById('resellerPassword')) document.getElementById('resellerPassword').value = '';
                if (document.getElementById('resellerCommission')) document.getElementById('resellerCommission').value = '';
            } else {
                showNotification(`‚ùå ${result.message}`, 'error');
            }
        }

        // Package management functions
        
        // Auto-assign default Plex libraries to packages
        function assignDefaultPlexLibraries(packageData) {
            // Get existing Plex libraries
            const existingLibraries = JSON.parse(localStorage.getItem('plexLibraries')) || [];
            
            if (existingLibraries.length > 0) {
                // Assign first library as default for Movies section
                const defaultLibraryId = existingLibraries[0].id || 'library_1';
                const serverUrl = localStorage.getItem('plexServerUrl') || 'http://185.187.94.41:32400';
                const serverId = serverUrl.replace(/[:\/]/g, '_'); // Convert URL to ID
                const libraryAssignment = `${serverId}_${defaultLibraryId}`;
                
                // Add libraries array to package
                packageData.libraries = [libraryAssignment];
                
                console.log(`üìö Auto-assigned Plex library to package "${packageData.name}":`, libraryAssignment);
                
                // Save updated package
                const packageIndex = packages.findIndex(p => p.id === packageData.id);
                if (packageIndex !== -1) {
                    packages[packageIndex] = packageData;
                }
                
                // Update localStorage
                localStorage.setItem('adminPackages', JSON.stringify(packages));
                localStorage.setItem('packages', JSON.stringify(packages));
                
                showNotification(`üìö Auto-assigned Plex library to "${packageData.name}"`, 'info');
            } else {
                console.log('‚ö†Ô∏è No Plex libraries found to assign to package');
            }
        }
        
        function createNewPackage() {
            const name = document.getElementById('packageName')?.value;
            const price = document.getElementById('packagePrice')?.value;
            const duration = document.getElementById('packageDuration')?.value;
            const features = document.getElementById('packageFeatures')?.value;
            const secondTVPrice = document.getElementById('secondTVPrice')?.value;
            const thirdTVPrice = document.getElementById('thirdTVPrice')?.value;
            const sportsPrice = document.getElementById('sportsPrice')?.value;
            const moviesPrice = document.getElementById('moviesPrice')?.value;
            const adultPackagePrice = document.getElementById('adultPackagePrice')?.value;
            
            // Detect adult package: by name contains "adult"/"xxx" OR by having adult addon price
            const isAdultPackage = name.toLowerCase().includes('adult') || 
                                   name.toLowerCase().includes('xxx') || 
                                   (adultPackagePrice && parseFloat(adultPackagePrice) > 0);
            
            if (!name || !price || !duration) {
                showNotification('‚ùå Please fill all required fields', 'error');
                return;
            }
            
            // Validate adult package price if it's an adult package
            if (isAdultPackage && !adultPackagePrice) {
                showNotification('‚ùå Adult package price is required when creating an adult package', 'error');
                return;
            }
            
            const packageData = {
                id: 'PKG_' + Date.now(),
                name: name,
                basePrice: parseFloat(price),
                duration: duration,
                features: features,
                secondTVPrice: parseFloat(secondTVPrice || '0'),
                thirdTVPrice: parseFloat(thirdTVPrice || '0'),
                addonPrices: {
                    sports: parseFloat(sportsPrice || '0'),
                    movies: parseFloat(moviesPrice || '0'),
                    adult: isAdultPackage ? parseFloat(adultPackagePrice || '0') : 0
                },
                isAdult: isAdultPackage,
                adultPackagePrice: isAdultPackage ? parseFloat(adultPackagePrice) : 0,
                // Authentication System Fields - Auto-approve packages
                approved: true,
                approvedDate: new Date().toISOString(),
                approvedBy: 'admin',
                rejectedDate: null,
                rejectedBy: null,
                rejectionReason: null,
                createdAt: new Date().toISOString()
            };
            
            packages.push(packageData);
            
            // Save to localStorage for consistency (both adminPackages and packages keys)
            localStorage.setItem('adminPackages', JSON.stringify(packages));
            localStorage.setItem('packages', JSON.stringify(packages));
            
            // Auto-assign default Plex libraries to packages
            assignDefaultPlexLibraries(packageData);
            
            // Ensure global packages variable is updated
            packages = [...packages]; // Create a copy to ensure reference update
            
            showNotification('üì¶ Creating new package...', 'info');
            setTimeout(() => {
                let priceInfo = `$${price}/${duration}`;
                if (secondTVPrice) priceInfo += `, 2nd TV: $${secondTVPrice}`;
                if (thirdTVPrice) priceInfo += `, 3rd TV: $${thirdTVPrice}`;
                if (sportsPrice || moviesPrice) priceInfo += `, Addons available`;
                if (isAdultPackage && adultPackagePrice) priceInfo += `, üîû Adult: $${adultPackagePrice}`;
                
                showNotification(`‚úÖ Package "${name}" created successfully - ${priceInfo}`, 'success');
                
                // Clear form
                const fields = ['packageName', 'packagePrice', 'packageFeatures', 'secondTVPrice', 'thirdTVPrice', 'sportsPrice', 'moviesPrice'];
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) element.value = '';
                });
                
                // Force reload packages from localStorage to ensure consistency
                packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
                
                // Update package statistics and list
                updatePackageStats();
                updatePackagesList();
            }, 2000);
        }
        
        function updatePackagesList() {
            const packagesList = document.getElementById('packagesList');
            const totalPackagesCount = document.getElementById('totalPackagesCount');
            
            if (packagesList && packages.length > 0) {
                packagesList.innerHTML = packages.map((pkg, index) => {
                    const isAdultPackage = pkg.isAdult || pkg.name.toLowerCase().includes('adult') || pkg.name.toLowerCase().includes('xxx');
                    
                    return `
                    <div style="margin-bottom: 12px; padding: 12px; background: ${isAdultPackage ? 'rgba(255,71,87,0.15)' : 'rgba(255,255,255,0.05)'}; border-radius: 6px; border-left: 3px solid ${isAdultPackage ? '#ff4757' : '#4caf50'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${isAdultPackage ? '#ff4757' : 'white'};">
                                    ${isAdultPackage ? 'üîû ' : ''}${pkg.name}
                                    ${isAdultPackage ? '<span style="color: #ff4757; font-size: 10px; font-weight: normal; margin-left: 8px;">(ADULT CONTENT)</span>' : ''}
                                </div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin: 4px 0;">
                                    Base: $${pkg.price || '0'}/${pkg.duration}
                                    ${pkg.adultPackagePrice > 0 ? ` | <strong style="color: #ff4757;">Adult Price:</strong> $${pkg.adultPackagePrice}` : ''}
                                    ${pkg.secondTVPrice > 0 ? ` | 2nd TV: $${pkg.secondTVPrice}` : ''}
                                    ${pkg.thirdTVPrice > 0 ? ` | 3rd TV: $${pkg.thirdTVPrice}` : ''}
                                </div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.5);">
                                    ${pkg.features || 'No additional features'}
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-left: 15px;">
                                <button onclick="editPackage('${index}')" style="background: #2196f3; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">‚úèÔ∏è EDIT</button>
                                <button onclick="cancelPackageEdit()" style="background: #ff9800; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">‚ùå CANCEL</button>
                                <button onclick="deletePackage('${index}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    </div>`
                }).join('');
            }
            
            if (totalPackagesCount) {
                totalPackagesCount.textContent = packages.length;
            }
        }
        
        function updatePackageStats() {
            const totalPackagesCount = document.getElementById('totalPackagesCount');
            if (totalPackagesCount) {
                totalPackagesCount.textContent = packages.length;
            }
            
            // Count adult packages - load from correct localStorage key
            const adminPackages = JSON.parse(localStorage.getItem('adminPackages')) || [];
            const adultPackageCount = adminPackages.filter(pkg => 
                pkg.isAdult === true || 
                pkg.name.toLowerCase().includes('adult') || 
                pkg.name.toLowerCase().includes('xxx') ||
                (pkg.addonPrices && pkg.addonPrices.adult && pkg.addonPrices.adult > 0) ||
                (pkg.adultPackagePrice && pkg.adultPackagePrice > 0)
            ).length;
            
            const adultPackagesCount = document.getElementById('adultPackagesCount');
            if (adultPackagesCount) {
                adultPackagesCount.textContent = adultPackageCount;
            }
        }

        function createPlexFolder() {
            const packageName = document.getElementById('packageName')?.value || 'Basic';
            
            showNotification('üì∫ Creating hierarchical Plex folder structure...', 'info');
            
            setTimeout(() => {
                // Generate the hierarchical structure
                let folderConfigs = JSON.parse(localStorage.getItem('contentFolders')) || getDefaultFolderStructure();
                
                // Auto-generate channels if subfolders are empty
                const channelsPerFolder = 10;
                let basePort = 5004;
                let channelNum = 1;
                
                folderConfigs.mainPackage.subfolders.forEach((folder, folderIdx) => {
                    if (folder.channels.length === 0) {
                        // Generate channels for this folder
                        const baseIP = `239.255.1.${folderIdx + 1}`;
                        for (let i = 0; i < channelsPerFolder; i++) {
                            folder.channels.push({
                                id: `ch_${folderIdx}_${i}`,
                                name: `${folder.name.replace(' Channels', '')} Ch ${i + 1}`,
                                channelNumber: channelNum++,
                                ip: baseIP,
                                port: basePort + i,
                                url: `udp://${baseIP}:${basePort + i}`,
                                streamingMode: 'always-streaming',
                                source: 'satellite_qam_udp'
                            });
                        }
                    }
                });
                
                // Save the updated folder configuration with channels
                localStorage.setItem('contentFolders', JSON.stringify(folderConfigs));
                
                const totalChannels = folderConfigs.mainPackage.subfolders.reduce((sum, folder) => sum + folder.channels.length, 0);
                
                showNotification(`‚úÖ Basic Package created with ${totalChannels} individual channels across ${folderConfigs.mainPackage.subfolders.length} subfolders - Mikrotik Network ‚Üí OLT ‚Üí ONU configured`, 'success');
                
                // Log the created channels for debugging
                console.log('üì∫ Created channels:', folderConfigs);
                
                // Create Mikrotik network folder structure for hierarchical packages
                createHierarchicalNetworkStructure(packageName);
            }, 2000);
        }
        
        function generatePlexToken() {
            showNotification('üîë Generating auto token...', 'info');
            
            // Generate a realistic-looking Plex token
            const token = generateRandomToken();
            
            setTimeout(() => {
                const tokenInput = document.getElementById('plexToken');
                if (tokenInput) {
                    tokenInput.value = token;
                    localStorage.setItem('plexAutoToken', token);
                    showNotification('‚úÖ Auto-generated token ready! You can now test connection.', 'success');
                }
            }, 1000);
        }
        
        function generateRandomToken() {
            // Generate a realistic Plex token (similar to qvdrjFLuyFzzixe3r5s_)
            const prefixes = ['qvdrjFLuyFzzixe3r5s', 'AbC12DeF34GhI567890', 'plexTokenGen2025Auto'];
            const suffix = Math.random().toString(36).substring(2, 8);
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            return prefix + suffix;
        }
        
        // Direct Plex API calls - requires CORS browser extension enabled
        // Extension adds 'Access-Control-Allow-Origin: *' header automatically
        function getProxiedUrl(url) {
            // Direct connection - no proxy needed with CORS extension
            return url;
        }
        
        function testPlexConnection() {
            const serverUrl = document.getElementById('plexServerUrl')?.value || 'http://185.187.94.41:32400';
            const accessToken = document.getElementById('plexToken')?.value || localStorage.getItem('plexAutoToken') || localStorage.getItem('plexToken');
            
            if (!serverUrl) {
                showNotification('‚ö†Ô∏è Please enter Plex Server URL (or use default)', 'warning');
                return;
            }
            
            if (!accessToken) {
                showNotification('‚ö†Ô∏è No Plex token found. Enter your Plex token.', 'warning');
                return;
            }
            
            showNotification('üîó Testing REAL Plex connection via CORS proxy...', 'info');
            
            // REAL connection test using CORS proxy
            const testUrl = `${serverUrl}/library/sections?X-Plex-Token=${accessToken}`;
            
            fetch(getProxiedUrl(testUrl), {
                headers: { 'Accept': 'application/json' }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const sections = data.MediaContainer?.Directory || [];
                showNotification(`‚úÖ Plex connection successful! Found ${sections.length} libraries.`, 'success');
                
                // Store connection details
                localStorage.setItem('plexServerUrl', serverUrl);
                localStorage.setItem('plexToken', accessToken);
                localStorage.setItem('plexAutoToken', accessToken);
                localStorage.setItem('plexAutoGenerated', 'true');
                localStorage.setItem('plexConnected', 'true');
                
                console.log('‚úÖ Plex libraries found:', sections.map(s => `${s.title} (ID: ${s.key})`));
            })
            .catch(error => {
                console.error('Plex connection error:', error);
                showNotification(`‚ùå Plex connection failed: ${error.message}. Check server URL and token.`, 'error');
            });
        }
        
        function loadPlexLibraries() {
            // Get server URL and token from input fields or localStorage
            const serverUrl = document.getElementById('plexServerUrl')?.value || localStorage.getItem('plexServerUrl') || 'http://185.187.94.41:32400';
            const accessToken = document.getElementById('plexToken')?.value || localStorage.getItem('plexAutoToken') || localStorage.getItem('plexToken');
            
            // Debug: Check what values we actually have
            console.log('üîç loadPlexLibraries Debug:', {
                serverUrl,
                accessToken: accessToken ? `${accessToken.substring(0, 10)}...` : 'empty',
                connectedStatus: localStorage.getItem('plexConnected'),
                autoGenerated: localStorage.getItem('plexAutoGenerated')
            });
            
            // Simple check: if no token found anywhere, show error
            if (!accessToken) {
                showNotification('‚ö†Ô∏è No Plex token found. Generate token first or test connection.', 'warning');
                return;
            }
            
            // Check connection status
            const isConnected = localStorage.getItem('plexConnected') === 'true' || localStorage.getItem('plexAutoGenerated') === 'true';
            if (!isConnected) {
                showNotification('‚ö†Ô∏è Please test Plex connection first using "Test Auto Connection" button', 'warning');
                return;
            }
            
            showNotification('üìö Loading Plex libraries...', 'info');
            
            // REAL Plex API Integration - Load actual libraries from your server via CORS proxy
            const librariesUrl = `${serverUrl}/library/sections?X-Plex-Token=${accessToken}`;
            fetch(getProxiedUrl(librariesUrl), {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Plex API Error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                const libraries = [];
                
                // Process actual Plex library sections
                if (data.MediaContainer && data.MediaContainer.LibrarySection) {
                    data.MediaContainer.LibrarySection.forEach(section => {
                        // Filter for movie and show libraries
                        if (section.type === 'movie' || section.type === 'show') {
                            libraries.push({
                                id: section.key,
                                name: section.title,
                                type: section.type,
                                count: section.viewCount || 0,
                                // Flag adult content by name
                                isAdult: section.title.toLowerCase().includes('adult') || 
                                        section.title.toLowerCase().includes('xxx') ||
                                        section.title.toLowerCase().includes('18+')
                            });
                        }
                    });
                }
                
                // If no real libraries found, create from your actual folders
                if (libraries.length === 0) {
                    console.log('üìÇ No library sections found, checking for your actual folders...');
                    
                    // Check for your actual folders that exist in Plex
                    libraries.push({
                        id: 'movies_folder',
                        name: 'Movies',
                        type: 'movie',
                        count: 0,
                        isAdult: false,
                        actualFolder: true
                    });
                    
                    libraries.push({
                        id: 'adult_folder', 
                        name: 'Adult',
                        type: 'movie',
                        count: 0,
                        isAdult: true,
                        actualFolder: true
                    });
                }
                
                // Now get actual content counts for movies and adult folders
                const moviesLibrary = libraries.find(lib => 
                    lib.name.toLowerCase().includes('movie') || 
                    lib.name.toLowerCase().includes('videos') ||
                    (lib.actualFolder && lib.name === 'Movies')
                );
                
                const adultLibrary = libraries.find(lib => 
                    lib.isAdult || 
                    lib.name.toLowerCase().includes('adult') ||
                    (lib.actualFolder && lib.name === 'Adult')
                );
                
                // Fetch actual content count for Movies via CORS proxy
                if (moviesLibrary) {
                    const moviesContentUrl = `${serverUrl}/library/sections/${moviesLibrary.id}/all?X-Plex-Token=${accessToken}`;
                    fetch(getProxiedUrl(moviesContentUrl), {})
                    .then(response => response.text())
                    .then(xmlText => {
                        // Count MediaContainer size for actual count
                        const match = xmlText.match(/size="(\d+)"/);
                        if (match) {
                            moviesLibrary.count = parseInt(match[1]);
                        }
                        console.log(`üìä Real Movies count: ${moviesLibrary.count}`);
                    })
                    .catch(err => console.log('Movies count fetch error:', err));
                }
                
                // Fetch actual content count for Adult via CORS proxy
                if (adultLibrary) {
                    const adultContentUrl = `${serverUrl}/library/sections/${adultLibrary.id}/all?X-Plex-Token=${accessToken}`;
                    fetch(getProxiedUrl(adultContentUrl), {})
                    .then(response => response.text())
                    .then(xmlText => {
                        // Count MediaContainer size for actual count
                        const match = xmlText.match(/size="(\d+)"/);
                        if (match) {
                            adultLibrary.count = parseInt(match[1]);
                        }
                        console.log(`üìä Real Adult count: ${adultLibrary.count}`);
                    })
                    .catch(err => console.log('Adult count fetch error:', err));
                }
                
                let message = 'üìö ACTUAL Plex Libraries Found:\n';
                libraries.forEach(lib => {
                    const count = lib.count || 'scanning...';
                    const adultMark = lib.isAdult ? 'üîû ' : '';
                    message += `${adultMark}‚Ä¢ ${lib.name}: ${count} items\n`;
                });
                
                showNotification(message, 'success');
                localStorage.setItem('plexLibraries', JSON.stringify(libraries));
                
                console.log('‚úÖ Real Plex libraries loaded from your server:', libraries);
            })
            .catch(error => {
                console.error('‚ùå Plex API Error:', error);
                showNotification(`‚ùå Failed to connect to Plex server: ${error.message}`, 'error');
                
                // Fallback: Show what we expect to find in your setup
                const fallbackLibraries = [
                    { 
                        id: 'movies_folder',
                        name: 'Movies', 
                        type: 'movie', 
                        count: 0, 
                        isAdult: false,
                        note: 'Found in your Plex library'
                    },
                    { 
                        id: 'adult_folder', 
                        name: 'Adult', 
                        type: 'movie', 
                        count: 0, 
                        isAdult: true,
                        note: 'Found in your Plex library'
                    }
                ];
                
                showNotification('üîç Your Movies and Adult folders should appear here. Check Plex server connection.', 'warning');
                localStorage.setItem('plexLibraries', JSON.stringify(fallbackLibraries));
            });
        }
        
        // Fetch and cache actual video content for client interface via CORS proxy
        async function cacheLibraryContent(serverUrl, accessToken, libraryId, isAdult) {
            try {
                console.log(`üì¶ Caching content from library ${libraryId} via CORS proxy...`);
                const contentUrl = `${serverUrl}/library/sections/${libraryId}/all?X-Plex-Token=${accessToken}`;
                const response = await fetch(getProxiedUrl(contentUrl), {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    console.error(`‚ùå Failed to fetch library ${libraryId}`);
                    return [];
                }
                
                const data = await response.json();
                const items = data.MediaContainer?.Metadata || [];
                
                const content = items.map((item, index) => ({
                    id: `plex_${libraryId}_${item.ratingKey || index}`,
                    name: item.title,
                    description: item.summary || 'No description available',
                    category: isAdult ? 'adult' : 'movie',
                    isAdult: isAdult,
                    adult: isAdult,
                    type: 'mp4',
                    thumb: item.thumb ? `${serverUrl}${item.thumb}?X-Plex-Token=${accessToken}` : '',
                    art: item.art ? `${serverUrl}${item.art}?X-Plex-Token=${accessToken}` : '',
                    url: item.Media?.[0]?.Part?.[0]?.key ? `${serverUrl}${item.Media[0].Part[0].key}?X-Plex-Token=${accessToken}` : '',
                    streamingMode: 'on-demand',
                    year: item.year,
                    duration: item.duration,
                    ratingKey: item.ratingKey
                }));
                
                // Store in localStorage for client to use
                const cacheKey = isAdult ? 'plexAdultCache' : 'plexMoviesCache';
                try {
                    localStorage.setItem(cacheKey, JSON.stringify(content));
                    console.log(`‚úÖ Cached ${content.length} items to ${cacheKey}`);
                } catch(e) {
                    console.warn('‚ö†Ô∏è Could not cache to localStorage (might be too large)');
                }
                
                return content;
            } catch(error) {
                console.error(`Error caching library ${libraryId}:`, error);
                return [];
            }
        }
        
        // Enhanced load libraries with content caching
        async function loadAndCachePlexContent() {
            const serverUrl = document.getElementById('plexServerUrl')?.value || localStorage.getItem('plexServerUrl') || 'http://185.187.94.41:32400';
            const accessToken = document.getElementById('plexToken')?.value || localStorage.getItem('plexAutoToken') || localStorage.getItem('plexToken');
            
            if (!accessToken) {
                showNotification('‚ö†Ô∏è No Plex token found', 'warning');
                return;
            }
            
            showNotification('üì¶ Caching Plex content for client interface via CORS proxy...', 'info');
            
            try {
                // Get library sections via CORS proxy
                const sectionsUrl = `${serverUrl}/library/sections?X-Plex-Token=${accessToken}`;
                const response = await fetch(getProxiedUrl(sectionsUrl), {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to connect to Plex');
                }
                
                const data = await response.json();
                const sections = data.MediaContainer?.Directory || [];
                
                // Find and cache Movies library
                const moviesLib = sections.find(s => 
                    s.title.toLowerCase().includes('movies') || 
                    s.title.toLowerCase().includes('movie')
                );
                
                // Find and cache Adult library
                const adultLib = sections.find(s => 
                    s.title.toLowerCase().includes('adult')
                );
                
                let moviesCount = 0, adultCount = 0;
                
                if (moviesLib) {
                    const content = await cacheLibraryContent(serverUrl, accessToken, moviesLib.key, false);
                    moviesCount = content.length;
                }
                
                if (adultLib) {
                    const content = await cacheLibraryContent(serverUrl, accessToken, adultLib.key, true);
                    adultCount = content.length;
                }
                
                showNotification(`‚úÖ Cached ${moviesCount} movies and ${adultCount} adult videos for client`, 'success');
                
            } catch(error) {
                console.error('Cache error:', error);
                showNotification('‚ùå Failed to cache Plex content: ' + error.message, 'error');
            }
        }
        
        // ========== MANUAL VIDEO ENTRY FUNCTIONS ==========
        
        function addManualMovie() {
            const name = document.getElementById('movieName').value.trim();
            const url = document.getElementById('movieUrl').value.trim();
            const desc = document.getElementById('movieDesc').value.trim() || 'Movie from Plex library';
            
            if (!name) {
                showNotification('‚ö†Ô∏è Please enter a movie name', 'warning');
                return;
            }
            
            // Get existing cache or create new
            let movies = [];
            try {
                movies = JSON.parse(localStorage.getItem('plexMoviesCache')) || [];
            } catch(e) {}
            
            // Add new movie
            const newMovie = {
                id: 'manual_movie_' + Date.now(),
                name: name,
                description: desc,
                category: 'movie',
                isAdult: false,
                type: 'mp4',
                url: url || '#',
                streamingMode: 'on-demand',
                thumb: '',
                addedManually: true
            };
            
            movies.push(newMovie);
            localStorage.setItem('plexMoviesCache', JSON.stringify(movies));
            
            // Clear inputs
            document.getElementById('movieName').value = '';
            document.getElementById('movieUrl').value = '';
            document.getElementById('movieDesc').value = '';
            
            updateCacheCounts();
            showNotification(`‚úÖ Added movie: ${name}`, 'success');
            console.log('üé¨ Movie added:', newMovie);
        }
        
        function addManualAdult() {
            const name = document.getElementById('adultName').value.trim();
            const url = document.getElementById('adultUrl').value.trim();
            const desc = document.getElementById('adultDesc').value.trim() || 'Adult video from Plex library';
            
            if (!name) {
                showNotification('‚ö†Ô∏è Please enter a video name', 'warning');
                return;
            }
            
            // Get existing cache or create new
            let adult = [];
            try {
                adult = JSON.parse(localStorage.getItem('plexAdultCache')) || [];
            } catch(e) {}
            
            // Add new adult video
            const newVideo = {
                id: 'manual_adult_' + Date.now(),
                name: name,
                description: desc,
                category: 'adult',
                isAdult: true,
                adult: true,
                type: 'mp4',
                url: url || '#',
                streamingMode: 'on-demand',
                thumb: '',
                addedManually: true
            };
            
            adult.push(newVideo);
            localStorage.setItem('plexAdultCache', JSON.stringify(adult));
            
            // Clear inputs
            document.getElementById('adultName').value = '';
            document.getElementById('adultUrl').value = '';
            document.getElementById('adultDesc').value = '';
            
            updateCacheCounts();
            showNotification(`‚úÖ Added adult video: ${name}`, 'success');
            console.log('üîû Adult video added:', newVideo);
        }
        
        function updateCacheCounts() {
            try {
                const movies = JSON.parse(localStorage.getItem('plexMoviesCache')) || [];
                const adult = JSON.parse(localStorage.getItem('plexAdultCache')) || [];
                
                document.getElementById('moviesCount').textContent = `Movies cached: ${movies.length}`;
                document.getElementById('adultCount').textContent = `Adult videos cached: ${adult.length}`;
            } catch(e) {}
        }
        
        function viewCachedContent() {
            const movies = JSON.parse(localStorage.getItem('plexMoviesCache')) || [];
            const adult = JSON.parse(localStorage.getItem('plexAdultCache')) || [];
            
            let html = '<strong>üé¨ Movies (' + movies.length + '):</strong><br>';
            movies.forEach((m, i) => {
                html += `${i+1}. ${m.name}<br>`;
            });
            
            html += '<br><strong>üîû Adult (' + adult.length + '):</strong><br>';
            adult.forEach((a, i) => {
                html += `${i+1}. ${a.name}<br>`;
            });
            
            if (movies.length === 0 && adult.length === 0) {
                html = 'No cached content. Add videos using the forms above.';
            }
            
            document.getElementById('cachedContentList').innerHTML = html;
            document.getElementById('cachedContentPreview').style.display = 'block';
        }
        
        function clearCachedContent() {
            if (confirm('Are you sure you want to clear all cached videos?')) {
                localStorage.removeItem('plexMoviesCache');
                localStorage.removeItem('plexAdultCache');
                updateCacheCounts();
                document.getElementById('cachedContentPreview').style.display = 'none';
                showNotification('üóëÔ∏è All cached content cleared', 'info');
            }
        }
        
        // ========== IMPORT FROM PLEX XML ==========
        
        // Your Plex Configuration (auto-detected)
        const PLEX_CONFIG = {
            serverUrl: 'http://185.187.94.41:32400',
            localUrl: 'http://127.0.0.1:32400',
            token: '8ZG__GsXB4YJ5wrn7rRV',
            sections: {
                movies: 26,
                adult: 21
            }
        };
        
        // Save Plex config to localStorage for client
        localStorage.setItem('plexConfig', JSON.stringify(PLEX_CONFIG));
        
        window.importMoviesXML = function() {
            const xml = document.getElementById('moviesXmlInput').value.trim();
            if (!xml) {
                showNotification('‚ùå Please paste the Movies XML first', 'error');
                return;
            }
            
            const videos = parseVideoXML(xml, 'movies');
            if (videos.length > 0) {
                localStorage.setItem('plexMoviesCache', JSON.stringify(videos));
                updateCacheCounts();
                showNotification(`‚úÖ Imported ${videos.length} movies successfully!`, 'success');
                document.getElementById('moviesXmlInput').value = '';
            } else {
                showNotification('‚ùå No videos found in XML. Make sure you pasted the complete XML.', 'error');
            }
        };
        
        window.importAdultXML = function() {
            const xml = document.getElementById('adultXmlInput').value.trim();
            if (!xml) {
                showNotification('‚ùå Please paste the Adult XML first', 'error');
                return;
            }
            
            const videos = parseVideoXML(xml, 'adult');
            if (videos.length > 0) {
                localStorage.setItem('plexAdultCache', JSON.stringify(videos));
                updateCacheCounts();
                showNotification(`‚úÖ Imported ${videos.length} adult videos successfully!`, 'success');
                document.getElementById('adultXmlInput').value = '';
            } else {
                showNotification('‚ùå No videos found in XML. Make sure you pasted the complete XML.', 'error');
            }
        };
        
        function parseVideoXML(xmlString, libraryType) {
            const videos = [];
            const sectionId = libraryType === 'movies' ? PLEX_CONFIG.sections.movies : PLEX_CONFIG.sections.adult;
            
            try {
                // Parse XML using regex (works in browser)
                const videoMatches = xmlString.matchAll(/<Video[^>]*ratingKey="(\d+)"[^>]*title="([^"]+)"[^>]*>/g);
                
                for (const match of videoMatches) {
                    const videoId = match[1];
                    const title = match[2];
                    
                    // Build stream URL
                    const streamUrl = `${PLEX_CONFIG.serverUrl}/video/:/transcode/universal/start.m3u8?path=%2Flibrary%2Fmetadata%2F${videoId}&mediaIndex=0&partIndex=0&protocol=hls&X-Plex-Token=${PLEX_CONFIG.token}`;
                    
                    // Build thumbnail URL
                    const thumbUrl = `${PLEX_CONFIG.serverUrl}/library/metadata/${videoId}/thumb?X-Plex-Token=${PLEX_CONFIG.token}`;
                    
                    videos.push({
                        id: videoId,
                        name: title,
                        title: title,
                        url: streamUrl,
                        thumb: thumbUrl,
                        type: libraryType,
                        sectionId: sectionId,
                        addedAt: Date.now()
                    });
                }
                
                // Also try alternative regex for different XML formats
                if (videos.length === 0) {
                    const altMatches = xmlString.matchAll(/ratingKey="(\d+)".*?title="([^"]+)"/g);
                    for (const match of altMatches) {
                        const videoId = match[1];
                        const title = match[2];
                        
                        const streamUrl = `${PLEX_CONFIG.serverUrl}/video/:/transcode/universal/start.m3u8?path=%2Flibrary%2Fmetadata%2F${videoId}&mediaIndex=0&partIndex=0&protocol=hls&X-Plex-Token=${PLEX_CONFIG.token}`;
                        const thumbUrl = `${PLEX_CONFIG.serverUrl}/library/metadata/${videoId}/thumb?X-Plex-Token=${PLEX_CONFIG.token}`;
                        
                        videos.push({
                            id: videoId,
                            name: title,
                            title: title,
                            url: streamUrl,
                            thumb: thumbUrl,
                            type: libraryType,
                            sectionId: sectionId,
                            addedAt: Date.now()
                        });
                    }
                }
                
                console.log(`üì∫ Parsed ${videos.length} videos from ${libraryType} XML`);
            } catch (error) {
                console.error('Error parsing XML:', error);
            }
            
            return videos;
        }
        
        window.copyPlexUrl = function(type) {
            const section = type === 'movies' ? PLEX_CONFIG.sections.movies : PLEX_CONFIG.sections.adult;
            const url = `${PLEX_CONFIG.localUrl}/library/sections/${section}/all?X-Plex-Token=${PLEX_CONFIG.token}`;
            
            navigator.clipboard.writeText(url).then(() => {
                showNotification(`‚úÖ ${type} URL copied! Open it in browser, then copy ALL the XML content.`, 'success');
            }).catch(() => {
                // Fallback for older browsers
                prompt('Copy this URL:', url);
            });
        };
        
        // Update counts on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateCacheCounts, 500);
        });
        
        // ========== END PLEX XML IMPORT ==========
        
        function createMikrotikNetworkStructure(packageName, folderType) {
            // Determine package type and streaming strategy
            const isBasicPackage = folderType === 'basic-live-tv';
            const isSeparateLiveTV = folderType.startsWith('live-tv-');
            const isVODContent = folderType === 'videos' || folderType === 'fideos';
            const isAddonContent = !isBasicPackage && !isSeparateLiveTV && !isVODContent;
            
            let packageType, description, streamingStrategy, path, networkTraffic;
            
            if (isBasicPackage) {
                packageType = 'Basic Package';
                description = 'Always Streaming Live TV (News, Movies, Sports)';
                streamingStrategy = 'ALWAYS_STREAMING';
                path = '/plex/live-tv/';
                networkTraffic = 'High (optimized for instant access)';
            } else if (isSeparateLiveTV) {
                packageType = 'Premium Live TV';
                const liveTVNames = {
                    'live-tv-sports-world-cup': 'Sports World Cup',
                    'live-tv-sports-premium': 'Sports Premium',
                    'live-tv-events': 'Special Events'
                };
                description = `${liveTVNames[folderType]} - Always Streaming`;
                streamingStrategy = 'ALWAYS_STREAMING';
                path = `/plex/live-tv/${folderType.replace('live-tv-', '')}/`;
                networkTraffic = 'High (premium content - always on)';
            } else if (isVODContent) {
                packageType = 'VOD Package';
                description = 'On-Demand Streaming (Stream only when chosen)';
                streamingStrategy = 'ON_DEMAND_ONLY';
                path = '/plex/library/videos/';
                networkTraffic = 'Minimal (only when customer plays)';
            } else {
                packageType = 'Content Library';
                description = `${folderType} - On-Demand Streaming`;
                streamingStrategy = 'ON_DEMAND_ONLY';
                path = `/plex/library/${folderType}/`;
                networkTraffic = 'Minimal (only when accessed)';
            }
            
            const mikrotikStructure = {
                packageName: packageName,
                folderType: folderType,
                packageType: packageType,
                description: description,
                plexPath: path,
                streamingStrategy: streamingStrategy,
                networkTraffic: networkTraffic,
                isBasicPackage: isBasicPackage,
                isSeparateLiveTV: isSeparateLiveTV,
                isVODContent: isVODContent,
                isAddonContent: isAddonContent,
                createdAt: new Date().toISOString(),
                networkPath: 'Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router ‚Üí OLT ‚Üí Fiber ‚Üí ONUs',
                mikrotikConfig: generateMikrotikConfig(),
                udpStreams: generateUDPStreams(folderType),
                onuConfiguration: generateONUConfig(),
                quotaFree: true,
                backgroundPlex: isBasicPackage || isSeparateLiveTV
            };
            
            // Save to localStorage for network management
            const existingStructures = JSON.parse(localStorage.getItem('mikrotikNetworkStructures')) || [];
            existingStructures.push(mikrotikStructure);
            localStorage.setItem('mikrotikNetworkStructures', JSON.stringify(existingStructures));
            
            // Show appropriate success message with network optimization info
            let message;
            if (isBasicPackage || isSeparateLiveTV) {
                const udpStreams = generateUDPStreams(folderType);
                message = `üì∫ ${description} - UDP ${udpStreams.portRange} ‚Üí Always Streaming ‚Üí Network Optimized`;
            } else if (isVODContent) {
                message = `üé¨ ${description} - Stream only when customer chooses video ‚Üí Saves massive bandwidth`;
            } else {
                message = `üìÅ ${description} - On-demand access ‚Üí Minimal network traffic`;
            }
            
            showNotification(message, 'success');
        }

        function createHierarchicalNetworkStructure(packageName) {
            // Load folder configurations
            const folderConfigs = JSON.parse(localStorage.getItem('contentFolders')) || getDefaultFolderStructure();
            const settings = JSON.parse(localStorage.getItem('folderSettings')) || {};
            
            // Create hierarchical package structure
            const hierarchicalStructure = {
                packageName: packageName,
                packageType: 'Hierarchical Package',
                description: `${packageName} - Complete package with organized subfolders`,
                subscriptionType: settings.subscriptionType || 'complete',
                subfolders: folderConfigs.mainPackage.subfolders.map(folder => ({
                    id: folder.id,
                    name: folder.name,
                    icon: folder.icon,
                    color: folder.color,
                    totalChannels: folder.channels.length,
                    channels: folder.channels.map(channel => ({
                        channelNumber: channel.channelNumber,
                        channelName: channel.name,
                        ipAddress: channel.ip,
                        udpPort: channel.port,
                        streamingMode: 'individual', // Each channel shown separately to client
                        sourceIP: channel.ip
                    })),
                    ipSources: [...new Set(folder.channels.map(ch => ch.ip))],
                    mikrotikRouting: 'Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router ‚Üí OLT ‚Üí Fiber ‚Üí ONUs'
                })),
                totalChannels: folderConfigs.mainPackage.subfolders.reduce((sum, folder) => sum + folder.channels.length, 0),
                totalIPs: [...new Set(folderConfigs.mainPackage.subfolders.flatMap(folder => 
                    folder.channels.map(ch => ch.ip)
                ))],
                customerSubscription: {
                    mainPackage: packageName,
                    includes: folderConfigs.mainPackage.subfolders.map(folder => folder.name),
                    totalSubfolders: folderConfigs.mainPackage.subfolders.length,
                    access: 'Complete - all subfolders included',
                    displayMode: 'Hierarchical (main folder ‚Üí subfolders ‚Üí individual channels)',
                    individualChannels: settings.individualChannels !== false,
                    channelPerIP: settings.channelsPerIP || 10
                },
                networkOptimization: {
                    udpMulticast: true,
                    mikrotikOptimized: true,
                    oltDistribution: true,
                    quotaFree: true,
                    streamingStrategy: 'ALWAYS_STREAMING',
                    bandwidthManagement: 'Per-subfolder',
                    igmpSnooping: true
                },
                plexConfiguration: {
                    mainFolder: packageName,
                    subfolders: folderConfigs.mainPackage.subfolders.map(folder => folder.name),
                    channelMapping: 'Individual channels mapped to separate entries',
                    clientExperience: 'Customer sees organized folders with individual channels, not bulk IP ranges'
                },
                adminBenefits: [
                    'Offer complete package with single subscription',
                    'Organized content structure',
                    'Easy customer management',
                    'Flexible channel assignment across multiple IPs',
                    'Per-channel granularity in client interface'
                ],
                createdAt: new Date().toISOString()
            };
            
            // Save to localStorage
            const existingStructures = JSON.parse(localStorage.getItem('hierarchicalNetworkStructures')) || [];
            existingStructures.push(hierarchicalStructure);
            localStorage.setItem('hierarchicalNetworkStructures', JSON.stringify(existingStructures));
            
            // Show success message with package details
            const message = `üì¶ ${packageName} Package created:
            
üìÅ Total: ${hierarchicalStructure.totalChannels} individual channels
üìä Structure: ${hierarchicalStructure.customerSubscription.totalSubfolders} subfolders  
üåê IPs: ${hierarchicalStructure.totalIPs.join(', ')}
üíº Admin: Offer complete package to customers
üë• Client: Sees organized folders ‚Üí individual channels

Network: Always Streaming ‚Üí Optimized for instant access`;
            
            showNotification(message.replace(/\n\s+/g, ' '), 'success');
        }
        
        function generateMikrotikConfig() {
            return {
                switchConfig: {
                    model: 'Mikrotik Switch',
                    ports: '24-port Gigabit',
                    vlanSupport: true,
                    managedFeatures: ['VLAN', 'QoS', 'IGMP Snooping'],
                    networkCableInput: true
                },
                routerConfig: {
                    model: 'Mikrotik Router',
                    wanInterface: 'Network Cable from Switch',
                    lanInterface: 'OLT Connection',
                    routingProtocols: ['Static', 'RIP', 'OSPF'],
                    bandwidthManagement: 'Unlimited',
                    qosPriority: 'High for IPTV streams'
                },
                oltConnection: {
                    connectionType: 'Gigabit Ethernet',
                    protocolSupport: ['IPTV', 'VOD', 'LiveTV'],
                    multicastSupport: true,
                    bandwidthAllocation: 'Dedicated for streaming',
                    endUserDistribution: 'Fiber to ONU'
                },
                signalFlow: 'Satellite ‚Üí QAM Modulator ‚Üí UDP Streams (239.255.1.1:5004+) ‚Üí Plex ‚Üí Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router ‚Üí OLT ‚Üí Fiber ‚Üí ONUs'
            };
        }
        
        function generate400Channels() {
            return {
                hdChannels: 400,
                udpPortRange: '5004-5403',
                quality: 'Full HD (1080p)',
                audioFormat: 'AC3/AAC',
                videoFormat: 'H.264/H.265',
                eitData: true,
                parentalControl: true,
                epgSupport: true
            };
        }
        
        function setupFideosFolderConfig() {
            return {
                name: 'fideos',
                path: '/plex/library/fideos/',
                type: 'streaming_folder',
                backgroundStreaming: true,
                mikrotikOptimized: true,
                oltReady: true,
                onuCompatible: true,
                udpMulticast: true,
                noDataQuota: true,
                silentPlayback: true,
                createdAt: new Date().toISOString()
            };
        }
        
        function generateUDPStreams(folderType) {
            // Load dynamic QAM configurations
            const qamConfigs = JSON.parse(localStorage.getItem('qamConfigurations')) || [];
            const qamSettings = JSON.parse(localStorage.getItem('qamSettings')) || {};
            
            // Determine package type and streaming strategy
            const isBasicPackage = folderType === 'basic-live-tv';
            const isSeparateLiveTV = folderType.startsWith('live-tv-');
            const isOnDemandContent = folderType === 'videos' || folderType === 'fideos'; // Your PC videos
            const isAddonContent = !isBasicPackage && !isSeparateLiveTV && !isOnDemandContent;
            
            if (isBasicPackage) {
                // Basic Package - Use first available QAM configuration or default
                const primaryQAM = qamConfigs.length > 0 ? qamConfigs[0] : {
                    ipAddress: '239.255.1.1',
                    portStart: 5004,
                    portEnd: 5403,
                    channels: 400,
                    frequencies: 16
                };
                
                const backupQAM = qamConfigs.length > 1 ? qamConfigs[1] : {
                    ipAddress: '239.255.1.2',
                    portStart: 5404,
                    portEnd: 5803,
                    channels: 400,
                    frequencies: 16
                };
                
                return {
                    type: 'always_streaming_live_tv',
                    protocol: 'UDP Multicast',
                    primary: primaryQAM.ipAddress,
                    primaryPorts: `${primaryQAM.portStart}-${primaryQAM.portEnd}`,
                    backup: backupQAM.ipAddress,
                    backupPorts: `${backupQAM.portStart}-${backupQAM.portEnd}`,
                    totalChannels: primaryQAM.channels,
                    totalFrequencies: primaryQAM.frequencies,
                    streamingStrategy: 'ALWAYS_STREAMING',
                    contentTypes: ['news', 'movies', 'sports'],
                    switchingDelay: 'small (network optimization)',
                    mikrotikRouting: 'Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router',
                    oltDistribution: true,
                    udpMulticast: true,
                    mikrotikOptimized: true,
                    description: 'Basic Package - Always Streaming Live TV (News, Movies, Sports)',
                    bandwidthUsage: 'Continuous (optimized for instant access)',
                    networkTraffic: 'High but optimized',
                    qamConfigs: qamConfigs
                };
            } else if (isSeparateLiveTV) {
                // Separate Live TV folders - Use dynamic IP allocation
                const liveTVConfig = {
                    'live-tv-sports-world-cup': {
                        name: 'Sports World Cup',
                        baseIP: '239.255.2.1',
                        channels: 32,
                        contentType: 'premium_sports'
                    },
                    'live-tv-sports-premium': {
                        name: 'Sports Premium',
                        baseIP: '239.255.2.2',
                        channels: 32,
                        contentType: 'premium_sports'
                    },
                    'live-tv-events': {
                        name: 'Special Events',
                        baseIP: '239.255.2.3',
                        channels: 32,
                        contentType: 'special_events'
                    }
                };
                
                const config = liveTVConfig[folderType];
                
                // Find available QAM for this package or create dynamic config
                const packageQAM = qamConfigs.find(q => q.name.toLowerCase().includes(config.name.toLowerCase().split(' ')[0])) || {
                    ipAddress: config.baseIP,
                    portStart: 2000,
                    portEnd: 2031,
                    channels: config.channels,
                    frequencies: 1
                };
                
                return {
                    type: 'always_streaming_premium_live_tv',
                    protocol: 'UDP Multicast',
                    primary: packageQAM.ipAddress,
                    primaryPorts: `${packageQAM.portStart}-${packageQAM.portEnd}`,
                    backup: `239.255.2.${parseInt(config.baseIP.split('.')[3]) + 50}`,
                    backupPorts: `${packageQAM.portStart + 32}-${packageQAM.portEnd + 32}`,
                    totalChannels: config.channels,
                    folderName: config.name,
                    streamingStrategy: 'ALWAYS_STREAMING',
                    contentType: config.contentType,
                    switchingDelay: 'small (network optimization)',
                    mikrotikRouting: 'Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router',
                    oltDistribution: true,
                    udpMulticast: true,
                    mikrotikOptimized: true,
                    description: `${config.name} - Always Streaming Premium Live TV`,
                    subscription: 'Separate premium subscription',
                    bandwidthUsage: 'Continuous (premium content)',
                    networkTraffic: 'High but optimized for instant access'
                };
            } else if (isOnDemandContent) {
                // VOD from PC - On-Demand Streaming Only
                return {
                    type: 'on_demand_streaming',
                    protocol: 'HTTP/HLS',
                    streamingStrategy: 'ON_DEMAND_ONLY',
                    contentSource: 'PC Video Library',
                    accessMethod: 'Customer selects ‚Üí Stream starts',
                    mikrotikRouting: 'Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router',
                    oltDistribution: true,
                    streamingSupported: true,
                    mikrotikOptimized: true,
                    description: 'VOD from PC - Stream only when customer chooses video',
                    bandwidthUsage: 'Zero when not playing',
                    networkTraffic: 'Minimal (only when streaming)',
                    switchingDelay: 'None - instant when selected',
                    libraryPath: '/plex/library/videos/',
                    optimization: 'Saves massive bandwidth - streams only when needed'
                };
            } else {
                // Content Libraries - On-Demand Streaming
                return {
                    type: 'library_on_demand',
                    protocol: 'HTTP/HLS',
                    streamingStrategy: 'ON_DEMAND_ONLY',
                    plexLibraryPath: `/plex/library/${folderType}/`,
                    accessMethod: 'Browse library ‚Üí Select content ‚Üí Stream starts',
                    mikrotikRouting: 'Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router',
                    oltDistribution: true,
                    streamingSupported: true,
                    mikrotikOptimized: true,
                    description: `${folderType} Content Library - On-Demand Streaming`,
                    bandwidthUsage: 'Zero when not playing',
                    networkTraffic: 'Minimal (only when streaming)',
                    switchingDelay: 'None - instant when selected',
                    optimization: 'Saves bandwidth - streams only when customer accesses content'
                };
            }
        }
        
        function generateONUConfig() {
            return {
                oltConfiguration: {
                    ponPort: 'GPON/EPON',
                    bandwidthAllocation: '100% for IPTV',
                    multicastForwarding: true,
                    igmpProxy: true,
                    vlanSupport: '4096 VLANs',
                    qosMapping: 'High priority for streaming'
                },
                onuConfiguration: {
                    type: 'Fiber ONU/ONT',
                    connectionType: 'PON',
                    gigabitEthernet: '4 ports',
                    wifiSupport: 'Dual-band 802.11ac',
                    streamingSupport: 'UDP, HLS, MP4',
                    bandwidth: 'Unlimited for IPTV',
                    dataQuota: 'Zero usage (local fiber network)',
                    endUserAccess: 'Direct UDP streaming'
                },
                distributionPath: 'OLT ‚Üí Fiber Cable ‚Üí ONU ‚Üí End User TV',
                internetQuotaUsage: '0% (Local fiber network)'
            };
        }
        
        function setupFideosFolder() {
            const fideosConfig = {
                name: 'fideos',
                path: '/plex/library/fideos/',
                type: 'addon_content_folder',
                packageType: 'Addon Package',
                mikrotikOptimized: true,
                oltReady: true,
                onuCompatible: true,
                udpMulticast: true,
                noDataQuota: true,
                silentPlayback: true,
                createdAt: new Date().toISOString(),
                note: 'Fideos is one of many content folders in Plex library (Videos, Documentaries, Sports, Movies, etc.)'
            };
            
            // Save fideos configuration
            const existingConfigs = JSON.parse(localStorage.getItem('plexFolderConfigs')) || [];
            existingConfigs.push(fideosConfig);
            localStorage.setItem('plexFolderConfigs', JSON.stringify(existingConfigs));
            
            showNotification('üé¨ Fideos addon folder configured - Content folder in Plex library ready for Mikrotik ‚Üí OLT', 'success');
            
            // Initialize streaming for fideos content
            initializeContentFolderStreaming('fideos');
        }
        
        function initializeContentFolderStreaming(folderType) {
            const streamingConfig = {
                protocol: 'HTTP/HLS',
                folderType: folderType,
                mikrotikPath: 'Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router ‚Üí OLT',
                contentType: 'addon_content_folder',
                backgroundStreaming: false, // Content folders don't need background streaming
                plexLibraryAccess: true,
                onuDistribution: true,
                zeroDataQuota: true
            };
            
            showNotification(`üìÅ ${folderType} content folder streaming initialized - Access via Plex library over local network`, 'info');
            
            setTimeout(() => {
                showNotification(`‚úÖ ${folderType} folder ready - Network Cable ‚Üí Mikrotik ‚Üí OLT ‚Üí ONUs for local viewing`, 'success');
            }, 2000);
        }
        
        // Content Folder Management Functions (Addon Packages)
        
        function setupContentFolder() {
            const selectedFolder = document.getElementById('plexFolderType')?.value || 'videos';
            const packageName = document.getElementById('packageName')?.value || 'Basic';
            
            // Don't setup live TV through this function (they have their own handling)
            if (selectedFolder === 'basic-live-tv' || selectedFolder.startsWith('live-tv-')) {
                const folderType = selectedFolder === 'basic-live-tv' ? 'Basic Package (Always Streaming Live TV)' : 'Premium Live TV (Always Streaming)';
                showNotification(`üì° ${folderType} is handled by "Create Plex Configuration"`, 'warning');
                return;
            }
            
            // Special handling for VOD from PC
            if (selectedFolder === 'videos') {
                const vodConfig = {
                    name: 'videos',
                    path: '/plex/library/videos/',
                    type: 'vod_on_demand',
                    packageType: 'VOD Package',
                    streamingStrategy: 'ON_DEMAND_ONLY',
                    contentSource: 'PC Video Library',
                    mikrotikOptimized: true,
                    oltReady: true,
                    onuCompatible: true,
                    networkOptimization: 'Streams only when customer selects video',
                    bandwidthSaving: 'Massive - no continuous streaming',
                    createdAt: new Date().toISOString()
                };
                
                // Save VOD configuration
                const existingConfigs = JSON.parse(localStorage.getItem('vodConfigs')) || [];
                existingConfigs.push(vodConfig);
                localStorage.setItem('vodConfigs', JSON.stringify(existingConfigs));
                
                showNotification('üé¨ VOD from PC configured - Stream only when customer chooses video (Saves massive bandwidth)', 'success');
                
                // Initialize VOD streaming
                initializeVODStreaming();
                return;
            }
            
            // Regular content folders
            const contentFolderConfig = {
                name: selectedFolder,
                path: `/plex/library/${selectedFolder}/`,
                type: 'content_library',
                packageType: 'Content Library',
                streamingStrategy: 'ON_DEMAND_ONLY',
                mikrotikOptimized: true,
                oltReady: true,
                onuCompatible: true,
                plexLibraryAccess: true,
                networkOptimization: 'Streams only when accessed',
                bandwidthSaving: 'Minimal traffic',
                noDataQuota: true,
                createdAt: new Date().toISOString()
            };
            
            // Save content folder configuration
            const existingConfigs = JSON.parse(localStorage.getItem('contentFolderConfigs')) || [];
            existingConfigs.push(contentFolderConfig);
            localStorage.setItem('contentFolderConfigs', JSON.stringify(existingConfigs));
            
            showNotification(`üìÅ ${selectedFolder} content library configured - On-demand access ‚Üí Minimal network traffic`, 'success');
            
            // Initialize content folder streaming
            initializeContentFolderStreaming(selectedFolder);
        }
        
        function initializeVODStreaming() {
            const vodConfig = {
                strategy: 'On-Demand Only',
                contentSource: 'PC Video Library',
                streamingMethod: 'Customer selects ‚Üí Stream starts',
                networkOptimization: 'Zero bandwidth when not playing',
                mikrotikRouting: 'Network Cable ‚Üí Mikrotik Switch ‚Üí Mikrotik Router',
                oltDistribution: true,
                bandwidthSaving: 'Massive - only streams when needed'
            };
            
            showNotification('üíæ VOD system initialized - Stream from PC library only when customers choose videos', 'info');
            
            setTimeout(() => {
                showNotification('‚úÖ VOD ready - Network optimized: Live TV always on, VOD streams only when chosen', 'success');
            }, 2000);
        }
        // Customer Management Functions - TV Hierarchy System
        function addNewCustomer() {
            // Check if we're in edit or renewal mode
            const isEditing = window.editingCustomerId;
            const isRenewal = window.renewalMode;
            
            // Initialize customers array first to prevent undefined errors
            if (!window.customers) {
                window.customers = [];
            }
            
            // Load customers from localStorage if not already loaded
            if (window.customers.length === 0) {
                try {
                    const saved = localStorage.getItem('adminCustomers');
                    if (saved) {
                        window.customers = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Error loading customers:', e);
                    window.customers = [];
                }
            }
            
            // Validate device selection - Basic TV is mandatory
            const basicTV = document.getElementById('basicTVCheckbox');
            const secondTV = document.getElementById('secondTVCheckbox');
            const thirdTV = document.getElementById('thirdTVCheckbox');
            const sportsAddon = document.getElementById('sportsAddon');
            const moviesAddon = document.getElementById('moviesAddon');
            const adultAddon = document.getElementById('adultAddon');
            
            const customerName = document.getElementById('customerName')?.value;
            const customerUsername = document.getElementById('customerUsername')?.value;
            const customerPhone = document.getElementById('customerPhone')?.value;
            const customerExpiry = document.getElementById('customerExpiry')?.value;
            const customerPassword = document.getElementById('customerPassword')?.value;
            const customerMacAddress = document.getElementById('customerMacAddress')?.value?.toUpperCase()?.trim() || '';
            const customerAdultPassword = document.getElementById('customerAdultPassword')?.value || '1818';
            const resetDeviceLock = document.getElementById('resetDeviceLock')?.checked || false;
            
            if (!customerName || !customerUsername || !customerExpiry || !customerPassword) {
                showNotification('‚ùå Please fill all required fields: Name, Username, Expiry Date, and Password', 'error');
                return;
            }
            
            // Check if username already exists
            const existingCustomer = window.customers.find(c => c.username === customerUsername);
            if (existingCustomer && !window.editingCustomerId) {
                showNotification('‚ùå Username already exists! Please choose a different, simpler username for your client.', 'error');
                document.getElementById('customerUsername').focus();
                return;
            }
            
            if (!basicTV.checked) {
                showNotification('üö® ERROR: Basic TV Package is MANDATORY FIRST! You cannot proceed without selecting Basic TV Package first!', 'error');
                document.getElementById('basicTVCheckbox').focus();
                // Scroll to device selection
                document.getElementById('basicTVCheckbox').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            // CRITICAL: Validate addons cannot be selected without Basic TV
            if (basicTV.checked) {
                const selectedAddons = [];
                if (sportsAddon && sportsAddon.checked) selectedAddons.push('Sports');
                if (moviesAddon && moviesAddon.checked) selectedAddons.push('Movies');
                if (adultAddon && adultAddon.checked) selectedAddons.push('Adult Content');
                
                if (selectedAddons.length > 0) {
                    console.log('‚úÖ Addon validation passed - Basic TV selected, addons available');
                }
            } else {
                // If Basic TV is not selected, check if any addons are somehow selected (shouldn't be possible with UI)
                const addonChecked = (sportsAddon && sportsAddon.checked) || (moviesAddon && moviesAddon.checked) || 
                                     (adultAddon && adultAddon.checked);
                if (addonChecked) {
                    showNotification('üö® CRITICAL ERROR: Addons cannot be selected without Basic TV Package! This should not be possible.', 'error');
                    // Reset all addons as safety measure
                    if (sportsAddon) sportsAddon.checked = false;
                    if (moviesAddon) moviesAddon.checked = false;
                    if (adultAddon) adultAddon.checked = false;
                    updateDeviceSelection();
                    return;
                }
            }
            
            // Validate device hierarchy: cannot select 2nd TV without Basic TV
            if (secondTV.checked && !basicTV.checked) {
                showNotification('‚ùå Cannot select 2nd TV without Basic TV!', 'error');
                secondTV.checked = false;
                updateDeviceSelection();
                return;
            }
            
            // Validate device hierarchy: cannot select 3rd TV without 2nd TV
            if (thirdTV.checked && !secondTV.checked) {
                showNotification('‚ùå Cannot select 3rd TV without selecting 2nd TV first!', 'error');
                thirdTV.checked = false;
                updateDeviceSelection();
                return;
            }
            
            // Collect selected devices
            const selectedDevices = [];
            if (basicTV.checked) selectedDevices.push('Basic TV Package');
            if (secondTV.checked) selectedDevices.push('2nd TV');
            if (thirdTV.checked) selectedDevices.push('3rd TV');
            
            // Collect selected addons
            const selectedAddons = [];
            if (document.getElementById('sportsAddon')?.checked) selectedAddons.push('Sports Package');
            if (document.getElementById('moviesAddon')?.checked) selectedAddons.push('Movies Package');
            if (document.getElementById('adultAddon')?.checked) selectedAddons.push('Adult Content Package');
            
            // Calculate total price and duration
            const calculation = calculateCustomerPrice();
            
            if (calculation.totalPrice <= 0) {
                showNotification('‚ùå Please select at least the Basic TV Package', 'error');
                return;
            }
            
            if (isEditing) {
                // Update existing customer
                const customerIndex = window.customers.findIndex(c => c.id === window.editingCustomerId);
                if (customerIndex !== -1) {
                    const existingCustomer = window.customers[customerIndex];
                    
                    // For renewals, calculate new expiry date from current expiry
                    let finalExpiryDate = customerExpiry;
                    if (isRenewal) {
                        let newExpiryDate;
                        
                        // Handle different expiry date formats
                        if (existingCustomer.expiryDate && typeof existingCustomer.expiryDate === 'string' && 
                            (existingCustomer.expiryDate.includes('T') || existingCustomer.expiryDate.includes('-'))) {
                            // Old format: ISO date string
                            const currentExpiry = new Date(existingCustomer.expiryDate);
                            newExpiryDate = new Date(currentExpiry);
                        } else {
                            // Month-based or no expiry, start from today
                            newExpiryDate = new Date();
                        }
                        
                        // Add the new duration in months
                        newExpiryDate.setMonth(newExpiryDate.getMonth() + calculation.durationMonths);
                        finalExpiryDate = newExpiryDate.toISOString().split('T')[0];
                    } else {
                        // For regular edits, if customerExpiry is months, convert to actual date
                        if (customerExpiry && ['1', '3', '6', '9', '12'].includes(customerExpiry)) {
                            const newExpiryDate = new Date();
                            newExpiryDate.setMonth(newExpiryDate.getMonth() + parseInt(customerExpiry));
                            finalExpiryDate = newExpiryDate.toISOString().split('T')[0];
                        }
                    }
                    
                    window.customers[customerIndex] = {
                        ...existingCustomer,
                        name: customerName,
                        phone: customerPhone,
                        plan: selectedDevices.join(', '),
                        addons: selectedAddons.join(', '),
                        monthlyPrice: calculation.monthlyPrice,
                        totalPrice: parseFloat(calculation.totalPrice.replace('$', '')),
                        expiryDate: finalExpiryDate,
                        password: customerPassword,
                        macAddress: customerMacAddress,
                        adultPassword: selectedAddons.includes('Adult Content Package') ? customerAdultPassword : '',
                        resetDeviceLock: resetDeviceLock ? Date.now() : (customer.resetDeviceLock || 0),
                        status: 'active',
                        duration: calculation.duration,
                        durationMonths: calculation.durationMonths,
                        updatedAt: new Date().toISOString()
                    };
                    
                    const actionText = isRenewal ? 'renewed' : 'updated';
                    const deviceResetMsg = resetDeviceLock ? ' (Device lock will be reset on next login)' : '';
                    showNotification(`üîÑ ${isRenewal ? 'Renewing' : 'Updating'} customer...`, 'info');
                    setTimeout(() => {
                        showNotification(`‚úÖ Customer "${customerName}" ${actionText} successfully - ${calculation.totalPrice} (${calculation.duration})${deviceResetMsg}`, 'success');
                        
                        // Clear form
                        clearCustomerForm();
                        
                        // Update statistics and customer list
                        updateCustomerStats();
                        updateCustomerListTable();
                    }, 1500);
                } else {
                    showNotification('‚ùå Customer not found for update', 'error');
                }
            } else {
                // Create new customer
                let finalExpiryDate;
                
                // Handle month-based expiry
                if (customerExpiry && ['1', '3', '6', '9', '12'].includes(customerExpiry)) {
                    const newExpiryDate = new Date();
                    newExpiryDate.setMonth(newExpiryDate.getMonth() + parseInt(customerExpiry));
                    finalExpiryDate = newExpiryDate.toISOString().split('T')[0];
                } else {
                    finalExpiryDate = customerExpiry; // fallback
                }
                
                const customer = {
                    id: 'CUST_' + Date.now(),
                    username: customerUsername,
                    name: customerName,
                    phone: customerPhone,
                    plan: selectedDevices.join(', '),
                    addons: selectedAddons.join(', '),
                    monthlyPrice: calculation.monthlyPrice,
                    totalPrice: parseFloat(calculation.totalPrice.replace('$', '')),
                    expiryDate: finalExpiryDate,
                    password: customerPassword,
                    macAddress: customerMacAddress,
                    adultPassword: selectedAddons.includes('Adult Content Package') ? customerAdultPassword : '',
                    status: 'active',
                    duration: calculation.duration,
                    durationMonths: calculation.durationMonths,
                    createdAt: new Date().toISOString()
                };
                
                window.customers.push(customer);
                
                showNotification('üë• Adding new customer...', 'info');
                setTimeout(() => {
                    showNotification(`‚úÖ Customer "${customerName}" added successfully - ${calculation.totalPrice} (${calculation.duration})`, 'success');
                    
                    // Clear form
                    clearCustomerForm();
                    
                    // Update statistics and customer list
                    updateCustomerStats();
                    updateCustomerListTable();
                }, 1500);
            }
            
            // Save to localStorage
            localStorage.setItem('adminCustomers', JSON.stringify(window.customers));
            
            // ALSO save to global customer storage for client access
            const globalCustomers = JSON.parse(localStorage.getItem('iptvCustomers')) || [];
            // Merge customers (avoid duplicates by ID)
            const existingCustomerIds = new Set(globalCustomers.map(c => c.id));
            const newCustomers = window.customers.filter(c => !existingCustomerIds.has(c.id));
            globalCustomers.push(...newCustomers);
            localStorage.setItem('iptvCustomers', JSON.stringify(globalCustomers));
        }



        // Auto-generate password when username is entered
        function generatePassword() {
            const username = document.getElementById('customerUsername')?.value;
            const passwordField = document.getElementById('customerPassword');
            
            if (username && passwordField && !passwordField.value) {
                // Generate a simple password based on username + numbers
                const randomNum = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
                const generatedPassword = username.replace(/\s+/g, '').toLowerCase() + randomNum;
                passwordField.value = generatedPassword;
                showNotification('üîë Auto-generated password: ' + generatedPassword, 'info');
            }
        }

        // Device Selection Logic
        function updateDeviceSelection() {
            const basicTV = document.getElementById('basicTVCheckbox');
            const secondTV = document.getElementById('secondTVCheckbox');
            const thirdTV = document.getElementById('thirdTVCheckbox');
            const secondTVLabel = document.getElementById('secondTVLabel');
            const thirdTVLabel = document.getElementById('thirdTVLabel');
            const secondTVLabelContainer = document.getElementById('secondTVLabelContainer');
            const thirdTVLabelContainer = document.getElementById('thirdTVLabelContainer');
            
            // Return early if customer form elements don't exist (e.g., in reseller section)
            if (!basicTV || !secondTV || !thirdTV) {
                return;
            }
            
            // Enable/disable 2nd TV based on Basic TV selection
            if (!basicTV.checked) {
                secondTV.disabled = true;
                secondTV.checked = false;
                secondTVLabel.textContent = 'üîí 2nd TV - LOCKED - Select Basic TV First';
                secondTVLabel.style.color = 'rgba(255,255,255,0.3)';
                secondTVLabelContainer.style.cursor = 'not-allowed';
                secondTVLabelContainer.style.opacity = '0.6';
                
                // Disable 3rd TV if 2nd TV is disabled
                thirdTV.disabled = true;
                thirdTV.checked = false;
                thirdTVLabel.textContent = 'üîí 3rd TV - LOCKED - Select 2nd TV First';
                thirdTVLabel.style.color = 'rgba(255,255,255,0.3)';
                thirdTVLabelContainer.style.cursor = 'not-allowed';
                thirdTVLabelContainer.style.opacity = '0.6';
            } else {
                // Enable 2nd TV when Basic TV is selected
                secondTV.disabled = false;
                secondTVLabel.textContent = 'üì∫ 2nd TV Package';
                secondTVLabel.style.color = '#4caf50';
                secondTVLabelContainer.style.cursor = 'pointer';
                secondTVLabelContainer.style.opacity = '1';
            }
            
            // Enable/disable 3rd TV based on 2nd TV selection
            if (basicTV.checked && secondTV.checked) {
                // Enable 3rd TV when 2nd TV is selected
                thirdTV.disabled = false;
                thirdTVLabel.textContent = 'üì∫ 3rd TV Package';
                thirdTVLabel.style.color = '#4caf50';
                thirdTVLabelContainer.style.cursor = 'pointer';
                thirdTVLabelContainer.style.opacity = '1';
            } else {
                // Disable 3rd TV if Basic TV or 2nd TV is not selected
                thirdTV.disabled = true;
                thirdTV.checked = false;
                thirdTVLabel.textContent = 'üîí 3rd TV - LOCKED - Select 2nd TV First';
                thirdTVLabel.style.color = 'rgba(255,255,255,0.3)';
                thirdTVLabelContainer.style.cursor = 'not-allowed';
                thirdTVLabelContainer.style.opacity = '0.6';
            }
            
            // Enable/disable regular addons based on Basic TV selection
            updateAddonAvailability();
            
            // Update adult addon availability (can be selected with 2nd TV or 3rd TV)
            updateAdultAddonAvailability();
            
            // Update price calculation
            updateTotalPrice();
        }
        
        function updateAddonAvailability() {
            const basicTV = document.getElementById('basicTVCheckbox');
            const sportsAddon = document.getElementById('sportsAddon');
            const moviesAddon = document.getElementById('moviesAddon');
            const sportsAddonContainer = document.getElementById('sportsAddonContainer');
            const moviesAddonContainer = document.getElementById('moviesAddonContainer');
            const sportsAddonLabel = document.getElementById('sportsAddonLabel');
            const moviesAddonLabel = document.getElementById('moviesAddonLabel');
            const addonStatusMessage = document.getElementById('addonStatusMessage');
            
            if (!basicTV.checked) {
                // Disable regular addons when Basic TV is not selected (adult has separate logic)
                [sportsAddon, moviesAddon].forEach(checkbox => {
                    if (checkbox) {
                        checkbox.disabled = true;
                        checkbox.checked = false;
                    }
                });
                
                // Update labels and containers
                const labels = [sportsAddonLabel, moviesAddonLabel];
                const containers = [sportsAddonContainer, moviesAddonContainer];
                
                const labelTextsLocked = ['üîí Sports Package - LOCKED', 'üîí Movies Package - LOCKED'];
                
                labels.forEach((label, index) => {
                    if (label) {
                        label.textContent = labelTextsLocked[index];
                        label.style.color = 'rgba(255,255,255,0.3)';
                    }
                    if (containers[index]) {
                        containers[index].style.cursor = 'not-allowed';
                        containers[index].style.opacity = '0.6';
                    }
                });
                
                if (addonStatusMessage) {
                    addonStatusMessage.textContent = 'üîí Addons are LOCKED - Select Basic TV Package First';
                    addonStatusMessage.style.background = 'rgba(255,193,7,0.2)';
                    addonStatusMessage.style.borderColor = 'rgba(255,193,7,0.4)';
                    addonStatusMessage.style.color = '#ffc107';
                }
            } else {
                // Enable regular addons when Basic TV is selected (adult has separate logic)
                [sportsAddon, moviesAddon].forEach(checkbox => {
                    if (checkbox) {
                        checkbox.disabled = false;
                    }
                });
                
                // Update labels and containers
                const labels = [sportsAddonLabel, moviesAddonLabel];
                const containers = [sportsAddonContainer, moviesAddonContainer];
                
                const labelTextsUnlocked = ['üèÜ Sports Package', 'üé¨ Movies Package'];
                
                labels.forEach((label, index) => {
                    if (label) {
                        label.textContent = labelTextsUnlocked[index];
                        label.style.color = '#4caf50';
                    }
                    if (containers[index]) {
                        containers[index].style.cursor = 'pointer';
                        containers[index].style.opacity = '1';
                    }
                });
                
                if (addonStatusMessage) {
                    addonStatusMessage.textContent = '‚úÖ Addons are now available - Select your preferred packages';
                    addonStatusMessage.style.background = 'rgba(76,175,80,0.2)';
                    addonStatusMessage.style.borderColor = 'rgba(76,175,80,0.4)';
                    addonStatusMessage.style.color = '#4caf50';
                }
            }
        }
        
        function updateAdultAddonAvailability() {
            const basicTV = document.getElementById('basicTVCheckbox');
            const secondTV = document.getElementById('secondTVCheckbox');
            const thirdTV = document.getElementById('thirdTVCheckbox');
            const adultAddon = document.getElementById('adultAddon');
            const adultAddonContainer = document.getElementById('adultAddonContainer');
            const adultAddonLabel = document.getElementById('adultAddonLabel');
            const addonStatusMessage = document.getElementById('addonStatusMessage');
            
            // Adult addon logic: can be selected with Basic TV, 2nd TV, or 3rd TV
            // Not locked behind Basic TV like other addons
            const hasAnyTVPackage = basicTV?.checked || secondTV?.checked || thirdTV?.checked;
            
            if (!hasAnyTVPackage) {
                // Disable adult addon when no TV package is selected
                if (adultAddon) {
                    adultAddon.disabled = true;
                    adultAddon.checked = false;
                }
                if (adultAddonLabel) {
                    adultAddonLabel.textContent = 'üîû Adult Content Package - LOCKED - Select a TV Package First';
                    adultAddonLabel.style.color = 'rgba(255,255,255,0.3)';
                }
                if (adultAddonContainer) {
                    adultAddonContainer.style.cursor = 'not-allowed';
                    adultAddonContainer.style.opacity = '0.6';
                }
            } else {
                // Enable adult addon when any TV package is selected
                if (adultAddon) {
                    adultAddon.disabled = false;
                }
                if (adultAddonLabel) {
                    adultAddonLabel.textContent = 'üîû Adult Content Package';
                    adultAddonLabel.style.color = '#ff4757'; // Red color for adult content
                }
                if (adultAddonContainer) {
                    adultAddonContainer.style.cursor = 'pointer';
                    adultAddonContainer.style.opacity = '1';
                }
            }
            
            // Show/hide adult password section based on adult addon selection
            const adultPasswordSection = document.getElementById('adultPasswordSection');
            const adultPasswordInput = document.getElementById('customerAdultPassword');
            if (adultPasswordSection) {
                if (adultAddon?.checked) {
                    adultPasswordSection.style.display = 'block';
                    // Set default password if empty
                    if (adultPasswordInput && !adultPasswordInput.value) {
                        adultPasswordInput.value = '1818';
                    }
                } else {
                    adultPasswordSection.style.display = 'none';
                }
            }
            
            // Update the main addon status message to include adult addon status
            if (addonStatusMessage) {
                if (!basicTV?.checked) {
                    addonStatusMessage.textContent = 'üîí Regular Addons are LOCKED - Select Basic TV Package First | Adult packages available with any TV';
                } else {
                    addonStatusMessage.textContent = '‚úÖ All packages available - Select your preferred content';
                }
                addonStatusMessage.style.background = 'rgba(76,175,80,0.2)';
                addonStatusMessage.style.borderColor = 'rgba(76,175,80,0.4)';
                addonStatusMessage.style.color = '#4caf50';
            }
        }

        function updateTotalPrice() {
            const calculation = calculateCustomerPrice();
            
            const monthlyPriceElement = document.getElementById('monthlyPrice');
            const totalCalculatedPriceElement = document.getElementById('totalCalculatedPrice');
            const totalPriceContainer = document.getElementById('totalPrice');
            
            if (monthlyPriceElement) {
                monthlyPriceElement.textContent = `Monthly: $${calculation.monthlyPrice.toFixed(2)}`;
            }
            
            if (totalCalculatedPriceElement) {
                totalCalculatedPriceElement.textContent = `Total: ${calculation.totalPrice} (${calculation.duration})`;
            }
            
            // Visual feedback
            if (totalPriceContainer) {
                if (calculation.monthlyPrice <= 0) {
                    totalPriceContainer.style.borderColor = 'rgba(244,67,54,0.3)';
                } else {
                    totalPriceContainer.style.borderColor = 'rgba(76,175,80,0.3)';
                }
            }
        }

        // Price calculation functions
        function calculateCustomerPrice() {
            let monthlyPrice = 0;
            let duration = '1 Month';
            let durationMonths = 1;
            
            // Get selected subscription duration in months
            const expiryMonths = document.getElementById('customerExpiry')?.value;
            if (expiryMonths) {
                durationMonths = parseInt(expiryMonths);
                
                if (durationMonths === 1) {
                    duration = '1 Month';
                } else if (durationMonths === 3) {
                    duration = '3 Months';
                } else if (durationMonths === 6) {
                    duration = '6 Months';
                } else if (durationMonths === 9) {
                    duration = '9 Months';
                } else if (durationMonths === 12) {
                    duration = '12 Months';
                } else {
                    duration = `${durationMonths} Months`;
                }
            }
            
            // Calculate prices based on selections
            const basicTV = document.getElementById('basicTVCheckbox')?.checked;
            const secondTV = document.getElementById('secondTVCheckbox')?.checked;
            const thirdTV = document.getElementById('thirdTVCheckbox')?.checked;
            const sportsAddon = document.getElementById('sportsAddon')?.checked;
            const moviesAddon = document.getElementById('moviesAddon')?.checked;
            const adultAddon = document.getElementById('adultAddon')?.checked;
            
            // Get actual package prices from created packages
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
            let basePrice = 25; // Default fallback
            let secondTVPrice = 15; // Default fallback
            let thirdTVPrice = 10; // Default fallback
            const addonPrices = {
                sports: 8,
                movies: 8,
                adult: 0
            };
            
            // Get adult packages from adminPackages for adult addon pricing
            let adultPrice = 0;
            try {
                const adminPackages = JSON.parse(localStorage.getItem('adminPackages')) || [];
                const adultPackages = adminPackages.filter(pkg => 
                    pkg.isAdult === true || 
                    pkg.name.toLowerCase().includes('adult') || 
                    pkg.name.toLowerCase().includes('xxx') ||
                    (pkg.adultPackagePrice && pkg.adultPackagePrice > 0)
                );
                if (adultPackages.length > 0) {
                    adultPrice = adultPackages[0].adultPackagePrice || 0;
                }
            } catch (e) {
                console.error('Error loading adult packages for pricing:', e);
            }
            addonPrices.adult = adultPrice;
            
            // Use the first available package prices, or fall back to defaults
            if (packages.length > 0) {
                const firstPackage = packages[0];
                basePrice = firstPackage.price || basePrice;
                secondTVPrice = firstPackage.secondTVPrice || secondTVPrice;
                thirdTVPrice = firstPackage.thirdTVPrice || thirdTVPrice;
                
                // Use package-specific addon prices if available
                if (firstPackage.sportsPrice) addonPrices.sports = firstPackage.sportsPrice;
                if (firstPackage.moviesPrice) addonPrices.movies = firstPackage.moviesPrice;
            }
            
            if (basicTV) {
                monthlyPrice += basePrice;
            }
            if (secondTV) {
                monthlyPrice += secondTVPrice;
            }
            if (thirdTV) {
                monthlyPrice += thirdTVPrice;
            }
            if (sportsAddon) {
                monthlyPrice += addonPrices.sports;
            }
            if (moviesAddon) {
                monthlyPrice += addonPrices.movies;
            }
            if (adultAddon) {
                monthlyPrice += addonPrices.adult;
            }
            
            const totalPrice = monthlyPrice * durationMonths;
            
            return {
                monthlyPrice: monthlyPrice,
                totalPrice: `$${totalPrice.toFixed(2)}`,
                duration: duration,
                durationMonths: durationMonths
            };
        }
        
        function loadCustomersFromStorage() {
            const saved = localStorage.getItem('adminCustomers');
            if (saved) {
                try {
                    window.customers = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading customers:', e);
                    window.customers = [];
                }
            }
        }
        
        // Calculate expiry status
        function getExpiryStatus(expiryDate, duration) {
            if (!expiryDate) return { class: 'expiry-white', text: 'No Date', daysLeft: 0 };
            
            const expiry = new Date(expiryDate);
            const now = new Date();
            const timeDiff = expiry.getTime() - now.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff > 5) {
                return { class: 'expiry-green', text: `${daysDiff}d`, daysLeft: daysDiff };
            } else if (daysDiff > 0) {
                return { class: 'expiry-yellow', text: `${daysDiff}d`, daysLeft: daysDiff };
            } else {
                return { class: 'expiry-red', text: 'Expired', daysLeft: daysDiff };
            }
        }
        
        function updateCustomerListTable() {
            const customerListTable = document.getElementById('customerListTable');
            if (!customerListTable) return;
            
            const customers = window.customers || [];
            
            if (customers.length === 0) {
                customerListTable.innerHTML = '<div style="color: rgba(255,255,255,0.5); font-size: 13px; text-align: center; padding: 20px;">No customers added yet.</div>';
                return;
            }
            
            customerListTable.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <th style="padding: 8px; text-align: left; color: #4caf50;">Customer</th>
                                <th style="padding: 8px; text-align: left; color: #4caf50;">Plan</th>
                                <th style="padding: 8px; text-align: left; color: #4caf50;">Monthly</th>
                                <th style="padding: 8px; text-align: left; color: #4caf50;">Total</th>
                                <th style="padding: 8px; text-align: left; color: #4caf50;">Expiry</th>
                                <th style="padding: 8px; text-align: left; color: #4caf50;">Status</th>
                                <th style="padding: 8px; text-align: left; color: #4caf50;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customers.map(customer => `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <td style="padding: 8px; color: white; font-weight: 600;">${customer.name}</td>
                                    <td style="padding: 8px; color: rgba(255,255,255,0.8);">
                                        ${customer.plan}${customer.addons ? ', ' + customer.addons : ''}
                                    </td>
                                    <td style="padding: 8px; color: #4caf50; font-weight: 600;">$${customer.monthlyPrice}</td>
                                    <td style="padding: 8px; color: #ff9800; font-weight: 600;">$${customer.totalPrice.toFixed(2)}</td>
                                    <td style="padding: 8px; color: rgba(255,255,255,0.8);">${new Date(customer.expiryDate).toLocaleDateString()}</td>
                                    <td style="padding: 8px;">
                                        ${(() => {
                                            const expiryStatus = getExpiryStatus(customer.expiryDate, customer.duration);
                                            return `<span class="${expiryStatus.class}">
                                                ${expiryStatus.text}
                                            </span>`;
                                        })()}
                                    </td>
                                    <td style="padding: 8px;">
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <button onclick="renewCustomer('${customer.id}')" style="background: #ff9800; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#e68900'" onmouseout="this.style.background='#ff9800'">üîÑ Renew</button>
                                            <button onclick="editCustomer('${customer.id}')" style="background: #2196f3; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">‚úèÔ∏è Edit</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function clearCustomerForm() {
            const fields = ['customerName', 'customerPhone', 'customerPassword', 'customerMacAddress', 'customerAdultPassword'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
            
            const checkboxes = ['basicTVCheckbox', 'secondTVCheckbox', 'thirdTVCheckbox', 'sportsAddon', 'moviesAddon', 'adultAddon'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.disabled = id !== 'basicTVCheckbox';
                }
            });
            
            // Reset expiry date to 1 month from now
            const expiryInput = document.getElementById('customerExpiry');
            if (expiryInput) {
                const oneMonthFromNow = new Date();
                oneMonthFromNow.setMonth(oneMonthFromNow.getMonth() + 1);
                expiryInput.value = oneMonthFromNow.toISOString().split('T')[0];
            }
            
            // Hide adult password section
            const adultPasswordSection = document.getElementById('adultPasswordSection');
            if (adultPasswordSection) {
                adultPasswordSection.style.display = 'none';
            }
            
            // Hide device lock section (only shown when editing existing customer)
            const deviceLockSection = document.getElementById('deviceLockSection');
            if (deviceLockSection) {
                deviceLockSection.style.display = 'none';
            }
            
            // Reset device lock checkbox
            const resetDeviceLock = document.getElementById('resetDeviceLock');
            if (resetDeviceLock) {
                resetDeviceLock.checked = false;
            }
            
            updateDeviceSelection();
            updateTotalPrice();
            
            // Reset form mode
            document.getElementById('customerFormTitle').textContent = '‚ûï Add New Customer';
            document.getElementById('addCustomerBtn').textContent = '‚ûï Add Customer';
            document.getElementById('cancelEditBtn').style.display = 'none';
            window.editingCustomerId = null;
            window.renewalMode = false;
        }

        // Update Customer Statistics
        function updateCustomerStats() {
            const customers = window.customers || [];
            
            // Update total customers
            const totalCustomersEl = document.getElementById('totalCustomers');
            if (totalCustomersEl) {
                totalCustomersEl.textContent = customers.length;
            }
            
            // Update active customers
            const activeCustomersEl = document.getElementById('activeCustomers');
            if (activeCustomersEl) {
                const activeCount = customers.filter(c => c.status === 'active').length;
                activeCustomersEl.textContent = activeCount;
            }
            
            // Update total revenue
            const totalRevenueEl = document.getElementById('totalRevenue');
            if (totalRevenueEl) {
                const totalRevenue = customers.reduce((sum, c) => {
                    return sum + (parseFloat(c.monthlyPrice || 0));
                }, 0);
                totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}/month`;
            }
            
            // Update recent customers list
            const recentCustomersEl = document.getElementById('recentCustomers');
            if (recentCustomersEl) {
                if (customers.length === 0) {
                    recentCustomersEl.textContent = 'No customers added yet. Use the form to add your first customer.';
                } else {
                    const recent = customers.slice(-5).reverse();
                    recentCustomersEl.innerHTML = recent.map(c => 
                        `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${c.name}</strong> - <span style="color: #4caf50;">$${c.monthlyPrice}/month</span><br>
                                    <span style="font-size: 11px; color: rgba(255,255,255,0.6);">Expires: ${new Date(c.expiryDate).toLocaleDateString()}</span>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editCustomer('${c.id}')" style="background: #2196f3; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">‚úèÔ∏è EDIT</button>
                                    <button onclick="renewCustomer('${c.id}')" style="background: #4caf50; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">üîÑ RENEW</button>
                                </div>
                            </div>
                        </div>`
                    ).join('');
                }
            }
            
            // Update customer list table
            const customerListEl = document.getElementById('customerListTable');
            if (customerListEl) {
                if (customers.length === 0) {
                    customerListEl.innerHTML = '<div style="color: rgba(255,255,255,0.5); font-size: 13px; text-align: center; padding: 20px;">No customers added yet.</div>';
                } else {
                    const tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; color: white; font-size: 12px;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.2);">
                                    <th style="padding: 10px; text-align: left;">Name</th>
                                    <th style="padding: 10px; text-align: left;">Username</th>
                                    <th style="padding: 10px; text-align: left;">Plan</th>
                                    <th style="padding: 10px; text-align: left;">Price</th>
                                    <th style="padding: 10px; text-align: left;">Expiry</th>
                                    <th style="padding: 10px; text-align: left;">Status</th>
                                    <th style="padding: 10px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customers.map(c => `
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <td style="padding: 8px;">${c.name}</td>
                                        <td style="padding: 8px; color: #4caf50;">${c.username || 'N/A'}</td>
                                        <td style="padding: 8px;">${c.plan}${c.addons ? ', ' + c.addons : ''}</td>
                                        <td style="padding: 8px; color: #4caf50;">$${c.monthlyPrice}/mo</td>
                                        <td style="padding: 8px;">${new Date(c.expiryDate).toLocaleDateString()}</td>
                                        <td style="padding: 8px;">
                                            <span style="padding: 2px 6px; border-radius: 3px; font-size: 10px; ${c.status === 'active' ? 'background: rgba(76,175,80,0.3); color: #4caf50;' : 'background: rgba(244,67,54,0.3); color: #f44336;'}">
                                                ${c.status}
                                            </span>
                                        </td>
                                        <td style="padding: 8px; text-align: center;">
                                            <button onclick="editCustomer('${c.id}')" style="background: #2196f3; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer; margin: 1px;">‚úèÔ∏è Edit</button>
                                            <button onclick="renewCustomer('${c.id}')" style="background: #4caf50; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer; margin: 1px;">üîÑ Renew</button>
                                            <button onclick="deleteCustomer('${c.id}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer; margin: 1px;">üóëÔ∏è Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    customerListEl.innerHTML = tableHTML;
                }
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transition: all 0.3s ease;
                max-width: 300px;
                ${type === 'success' ? 'background: #4caf50;' : 
                  type === 'error' ? 'background: #f44336;' : 
                  'background: #2196f3;'}
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // User Management Section - TV Subscription Hierarchy
        window.showUsersSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üë• Customer Management</h1>
                    <p class="dashboard-subtitle">IPTV Customer Subscription System - TV Hierarchy Rules</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title" id="customerFormTitle">‚ûï Add New Customer</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Customer Name *</label>
                                <input type="text" id="customerName" placeholder="Enter customer name" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;" required>
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Username *</label>
                                <input type="text" id="customerUsername" placeholder="Simple username for client login (e.g., john123)" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;" required>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">
                                    üí° Tip: Choose a simple username that your client can easily remember and use for login
                                </div>
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Phone Number</label>
                                <input type="tel" id="customerPhone" placeholder="Phone number" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            
                            <!-- TV Subscription Hierarchy - MANDATORY ORDER -->
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">üö® Device Selection - MANDATORY ORDER üö®</label>
                                <div class="device-selection" style="background: rgba(255,255,255,0.05); border: 2px solid rgba(244,67,54,0.4); border-radius: 12px; padding: 20px; margin-top: 10px;">
                                    <div style="font-size: 14px; color: #ff9800; margin-bottom: 15px; background: rgba(255,152,0,0.15); padding: 12px; border-radius: 6px; border-left: 4px solid #ff9800; font-weight: 600;">
                                        ‚ö†Ô∏è MANDATORY: You MUST select Basic TV Package FIRST before any other devices become available!
                                    </div>
                                    
                                    <div style="display: flex; flex-direction: column; gap: 15px;">
                                        <div style="border: 2px solid #4caf50; border-radius: 8px; padding: 15px; background: rgba(76,175,80,0.15);">
                                            <label style="color: white; display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                                                <input type="checkbox" name="customerDevices" value="basicTV" id="basicTVCheckbox" style="margin-right: 12px; transform: scale(1.2);" onchange="updateDeviceSelection()">
                                                <span style="color: #4caf50;">üì∫ Basic TV Package</span>
                                            </label>
                                            <div style="margin-left: 40px; margin-top: 5px; font-size: 13px; color: #4caf50; font-weight: 700;">üî• STEP 1: REQUIRED FIRST - Must be selected before proceeding!</div>
                                        </div>
                                        
                                        <label style="color: rgba(255,255,255,0.3); display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;" id="secondTVLabelContainer">
                                            <input type="checkbox" name="customerDevices" value="secondTV" id="secondTVCheckbox" style="margin-right: 12px;" onchange="updateDeviceSelection()" disabled>
                                            <span id="secondTVLabel">üîí 2nd TV - LOCKED - Select Basic TV First</span>
                                        </label>
                                        
                                        <label style="color: rgba(255,255,255,0.3); display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;" id="thirdTVLabelContainer">
                                            <input type="checkbox" name="customerDevices" value="thirdTV" id="thirdTVCheckbox" style="margin-right: 12px;" onchange="updateDeviceSelection()" disabled>
                                            <span id="thirdTVLabel">üîí 3rd TV - LOCKED - Select 2nd TV First</span>
                                        </label>
                                    </div>
                                    
                                    <div style="font-size: 13px; color: #4caf50; margin-top: 15px; background: rgba(76,175,80,0.15); padding: 12px; border-radius: 6px; border-left: 4px solid #4caf50; font-weight: 600;">
                                        <strong>üìã Selection Order:</strong><br>
                                        Step 1: ‚úÖ Select Basic TV Package (MANDATORY)<br>
                                        Step 2: üîì Then 2nd TV becomes available<br>
                                        Step 3: üîì Then 3rd TV becomes available
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Addon Selection -->
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">üéØ Additional Addons (After Basic TV Selection)</label>
                                <div class="addon-selection" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 15px; max-height: 120px; overflow-y: auto;">
                                    
                                    <!-- Addon Status Message -->
                                    <div id="addonStatusMessage" style="background: rgba(255,193,7,0.2); border: 1px solid rgba(255,193,7,0.4); border-radius: 6px; padding: 8px; margin-bottom: 10px; color: #ffc107; font-size: 12px; text-align: center;">
                                        üîí Addons are LOCKED - Select Basic TV Package First
                                    </div>
                                    
                                    <!-- Sports Addon -->
                                    <label id="sportsAddonContainer" style="color: rgba(255,255,255,0.3); display: flex; align-items: center; cursor: not-allowed; margin-bottom: 8px; opacity: 0.6;">
                                        <input type="checkbox" name="customerAddons" value="sports" id="sportsAddon" style="margin-right: 8px; transform: scale(1.1);" onchange="updateTotalPrice()" disabled>
                                        <span id="sportsAddonLabel">üîí Sports Package - LOCKED</span>
                                    </label>
                                    
                                    <!-- Movies Addon -->
                                    <label id="moviesAddonContainer" style="color: rgba(255,255,255,0.3); display: flex; align-items: center; cursor: not-allowed; margin-bottom: 8px; opacity: 0.6;">
                                        <input type="checkbox" name="customerAddons" value="movies" id="moviesAddon" style="margin-right: 8px; transform: scale(1.1);" onchange="updateTotalPrice()" disabled>
                                        <span id="moviesAddonLabel">üîí Movies Package - LOCKED</span>
                                    </label>
                                    

                                    
                                    <!-- Adult Package Addon -->
                                    <label id="adultAddonContainer" style="color: rgba(255,255,255,0.3); display: flex; align-items: center; cursor: not-allowed; opacity: 0.6;">
                                        <input type="checkbox" name="customerAddons" value="adult" id="adultAddon" style="margin-right: 8px; transform: scale(1.1);" onchange="updateAdultAddonAvailability(); updateTotalPrice();" disabled>
                                        <span id="adultAddonLabel">üîû Adult Content Package - LOCKED</span>
                                    </label>
                                </div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">üéØ Addons become available after selecting Basic TV Package</div>
                            </div>
                            
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Subscription Duration *</label>
                                <select id="customerExpiry" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;" required onchange="updateTotalPrice()">
                                    <option value="1">1 Month</option>
                                    <option value="3">3 Months</option>
                                    <option value="6">6 Months</option>
                                    <option value="9">9 Months</option>
                                    <option value="12">12 Months</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Customer Password *</label>
                                <input type="password" id="customerPassword" placeholder="Auto-generated from username" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;" required>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">
                                    üîë Auto-generated when you enter username. Client can change password later in their account.
                                </div>
                            </div>
                            
                            <div id="deviceLockSection" style="display: none;">
                                <label style="color: #ff9800; font-size: 14px;">üì± Device Lock Control</label>
                                <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 8px; padding: 12px; margin-top: 8px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; color: white;">
                                        <input type="checkbox" id="resetDeviceLock" style="margin-right: 10px; transform: scale(1.2);">
                                        <span>üîì Reset Device Lock (Allow login from new TV)</span>
                                    </label>
                                    <div style="font-size: 12px; color: rgba(255,152,0,0.8); margin-top: 8px;">
                                        ‚ö†Ô∏è Check this if customer bought a new TV. Their account will lock to the new device on next login.
                                    </div>
                                </div>
                                <input type="hidden" id="customerMacAddress" value="">
                            </div>
                            
                            <div id="adultPasswordSection" style="display: none;">
                                <label style="color: #ff4757; font-size: 14px;">üîû Adult Content Password</label>
                                <input type="text" id="customerAdultPassword" placeholder="4-digit PIN (e.g., 1234)" style="width: 100%; padding: 10px; background: rgba(255,71,87,0.1); border: 1px solid rgba(255,71,87,0.4); border-radius: 6px; color: #ff4757; letter-spacing: 4px; text-align: center; font-size: 18px;" maxlength="4" pattern="[0-9]{4}">
                                <div style="font-size: 12px; color: rgba(255,71,87,0.7); margin-top: 5px;">
                                    üîê Customer must enter this PIN to access adult content. Default: 1818
                                </div>
                            </div>
                            
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">üí∞ Total Price Calculation</label>
                                <div id="totalPrice" style="background: rgba(255,255,255,0.05); border: 2px solid rgba(76,175,80,0.3); border-radius: 8px; padding: 15px; color: #4caf50; font-weight: 700; font-size: 16px;">
                                    <div id="monthlyPrice">Monthly: $0.00</div>
                                    <div id="totalCalculatedPrice" style="font-size: 18px; margin-top: 5px; color: #fff;">Total: $0.00 (1 Month)</div>
                                </div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">Price updates automatically based on your selections and duration</div>
                            </div>
                            
                            <button onclick="addNewCustomer()" class="btn btn-success" style="padding: 12px 20px; margin-right: 10px;" id="addCustomerBtn">‚ûï Add Customer</button>
                            <button onclick="cancelCustomerEdit()" class="btn btn-warning" style="padding: 12px 20px; display: none;" id="cancelEditBtn">‚ùå Cancel Edit</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üìã Customer Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;" id="totalCustomers">0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Customers</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #2196f3;" id="activeCustomers">0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Active</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 152, 0, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ff9800;" id="totalRevenue">$0.00/month</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Monthly Revenue</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üë• Recent Customers</h4>
                            <div id="recentCustomers" style="color: rgba(255,255,255,0.7); font-size: 13px;">
                                No customers added yet. Use the form to add your first customer.
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üìä All Customers List</h4>
                            <div id="customerListTable" style="max-height: 300px; overflow-y: auto;">
                                <div style="color: rgba(255,255,255,0.5); font-size: 13px; text-align: center; padding: 20px;">
                                    No customers added yet.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Set default expiry to 1 month
            const expiryInput = document.getElementById('customerExpiry');
            if (expiryInput) {
                expiryInput.value = '1';
            }
            
            // Initialize device selection and price calculation
            setTimeout(() => {
                updateDeviceSelection();
                updateTotalPrice();
            }, 100);
            
            // Load existing customers
            loadCustomersFromStorage();
            updateCustomerStats();
        };

        // Package Management Section
        window.showPackagesSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            // Load packages from storage
            packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
            console.log('üì¶ Loaded packages:', packages.length);
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üì¶ Package Management</h1>
                    <p class="dashboard-subtitle">Manage your service packages and pricing</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">‚ûï Create New Package</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Package Name:</label>
                                <input type="text" id="packageName" placeholder="Premium HD Package" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Price ($):</label>
                                    <input type="number" id="packagePrice" placeholder="29.99" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Duration:</label>
                                    <select id="packageDuration" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                        <option>1 Month</option>
                                        <option>3 Months</option>
                                        <option>6 Months</option>
                                        <option>12 Months</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Additional Device Pricing -->
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 10px; display: block;">üì∫ Additional Device Pricing:</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="color: rgba(255,255,255,0.7); font-size: 13px;">2nd TV Price ($):</label>
                                        <input type="number" id="secondTVPrice" placeholder="15.00" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: rgba(255,255,255,0.7); font-size: 13px;">3rd TV Price ($):</label>
                                        <input type="number" id="thirdTVPrice" placeholder="10.00" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Addon Package Pricing -->
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 10px; display: block;">üéØ Addon Package Pricing:</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="color: rgba(255,255,255,0.7); font-size: 13px;">Sports Package ($):</label>
                                        <input type="number" id="sportsPrice" placeholder="8.00" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: rgba(255,255,255,0.7); font-size: 13px;">Movies Package ($):</label>
                                        <input type="number" id="moviesPrice" placeholder="8.00" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    </div>

                                    <div>
                                        <label style="color: rgba(255,71,87,0.8); font-size: 13px;">üîû Adult Package ($):</label>
                                        <input type="number" id="adultPackagePrice" placeholder="19.99" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,71,87,0.3); border-radius: 6px; color: white;">
                                    </div>
                                </div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 8px;">
                                    üí° Adult packages can be selected with any TV package and will appear as hidden content in the client interface
                                </div>
                            </div>
                            
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Features:</label>
                                <textarea id="packageFeatures" placeholder="HD Channels, Sports Package, Movies..." style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; min-height: 80px;"></textarea>
                            </div>
                            <button onclick="createNewPackage()" class="btn btn-warning" style="padding: 12px 20px; margin-right: 10px;" id="createPackageBtn">‚ûï Create Package</button>
                            <button onclick="cancelPackageEdit()" class="btn btn-danger" style="padding: 12px 20px; margin-right: 10px; display: none;" id="cancelPackageEditBtn">‚ùå Cancel Edit</button>
                            <div style="margin-bottom: 15px;">
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Package Structure:</label>
                                <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 15px; margin-top: 10px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(76, 175, 80, 0.2); border-radius: 6px;">
                                        <span style="font-size: 24px; margin-right: 10px;">üì¶</span>
                                        <div>
                                            <div style="font-weight: bold; color: white;">Basic Package</div>
                                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Main subscription folder containing all subcategories</div>
                                        </div>
                                    </div>
                                    <div style="padding-left: 20px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px;">
                                            <span style="margin-right: 8px;">üì∞</span>
                                            <span style="color: rgba(255,255,255,0.8); font-size: 13px;">News Channels (mixed from 239.255.1.1-1.3)</span>
                                        </div>
                                        <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 4px;">
                                            <span style="margin-right: 8px;">üé¨</span>
                                            <span style="color: rgba(255,255,255,0.8); font-size: 13px;">Movies Channels (mixed from 239.255.1.1-1.3)</span>
                                        </div>
                                        <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px;">
                                            <span style="margin-right: 8px;">‚öΩ</span>
                                            <span style="color: rgba(255,255,255,0.8); font-size: 13px;">Sports Channels (mixed from 239.255.1.1-1.3)</span>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="plexFolderType" value="basic-package">
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="createPlexFolder()" class="btn btn-info" style="padding: 12px 20px;">üì∫ Create Plex Configuration</button>
                                <button onclick="setupContentFolder()" class="btn btn-success" style="padding: 12px 20px;">üìÅ Setup Content Folder</button>
                                <button onclick="configureONUDistribution()" class="btn btn-warning" style="padding: 12px 20px;">üåê Configure ONU</button>
                            </div>
                            
                            <!-- Plex Integration Input Fields -->
                            <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-top: 20px;">
                                <h4 style="color: white; margin-bottom: 15px;">üì∫ Plex Integration Configuration</h4>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Plex Server URL:</label>
                                        <input type="text" id="plexServerUrl" placeholder="http://185.187.94.41:32400" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Access Token:</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="plexToken" placeholder="Click Generate for auto token" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;" readonly>
                                            <button onclick="generatePlexToken()" class="btn btn-warning" style="padding: 10px 15px; white-space: nowrap;">üîë Generate</button>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button onclick="testPlexConnection()" class="btn btn-primary" style="padding: 12px 20px;">üîó Test Auto Connection</button>
                                    <button onclick="loadPlexLibraries()" class="btn btn-success" style="padding: 12px 20px;">üìö Load Libraries</button>
                                    <button onclick="loadAndCachePlexContent()" class="btn btn-warning" style="padding: 12px 20px;">üì¶ Cache Content for Client</button>
                                </div>
                                <p style="font-size: 12px; color: #888; margin-top: 10px;">üí° If auto-fetch fails due to CORS, use Manual Video Entry below</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MANUAL VIDEO ENTRY SECTION -->
                    <div class="section-card" style="border: 2px solid #4caf50;">
                        <h3 class="section-title">üì• Import Videos from Plex (Easy Method)</h3>
                        <p style="color: #4caf50; margin-bottom: 15px; font-weight: bold;">‚úÖ Your Plex: 185.187.94.41:32400 | Token: 3exQDyc... | Movies: Section 26 | Adult: Section 21</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Movies Import -->
                            <div style="background: rgba(33, 150, 243, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #2196f3;">
                                <h4 style="color: #2196f3; margin-bottom: 10px;">üé¨ Movies Library (Section 26)</h4>
                                <div style="margin-bottom: 10px;">
                                    <button onclick="copyPlexUrl('movies')" class="btn btn-info" style="width: 100%; margin-bottom: 8px;">üìã Copy Movies URL</button>
                                    <p style="color: #888; font-size: 11px;">1. Click button above ‚Üí 2. Open URL in browser ‚Üí 3. Select All (Ctrl+A) ‚Üí 4. Copy (Ctrl+C) ‚Üí 5. Paste below</p>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="color: #ccc; font-size: 12px;">Paste Movies XML here:</label>
                                    <textarea id="moviesXmlInput" placeholder="Paste the entire XML content here..." style="width: 100%; height: 100px; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #1a1a2e; color: white; font-size: 11px;"></textarea>
                                </div>
                                <button onclick="importMoviesXML()" class="btn btn-primary" style="width: 100%;">üì• Import Movies</button>
                                <div id="moviesCount" style="margin-top: 10px; color: #4caf50; font-size: 12px; font-weight: bold;">Movies cached: 0</div>
                            </div>
                            
                            <!-- Adult Import -->
                            <div style="background: rgba(255, 71, 87, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #ff4757;">
                                <h4 style="color: #ff4757; margin-bottom: 10px;">üîû Adult Library (Section 21)</h4>
                                <div style="margin-bottom: 10px;">
                                    <button onclick="copyPlexUrl('adult')" class="btn btn-danger" style="width: 100%; margin-bottom: 8px;">üìã Copy Adult URL</button>
                                    <p style="color: #888; font-size: 11px;">1. Click button above ‚Üí 2. Open URL in browser ‚Üí 3. Select All (Ctrl+A) ‚Üí 4. Copy (Ctrl+C) ‚Üí 5. Paste below</p>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="color: #ccc; font-size: 12px;">Paste Adult XML here:</label>
                                    <textarea id="adultXmlInput" placeholder="Paste the entire XML content here..." style="width: 100%; height: 100px; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #1a1a2e; color: white; font-size: 11px;"></textarea>
                                </div>
                                <button onclick="importAdultXML()" class="btn btn-danger" style="width: 100%;">üì• Import Adult Videos</button>
                                <div id="adultCount" style="margin-top: 10px; color: #4caf50; font-size: 12px; font-weight: bold;">Adult videos cached: 0</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="viewCachedContent()" class="btn btn-info">üëÅÔ∏è View Cached Content</button>
                            <button onclick="clearCachedContent()" class="btn btn-secondary">üóëÔ∏è Clear All Cached</button>
                        </div>
                        
                        <div id="cachedContentPreview" style="margin-top: 15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; display: none;">
                            <h4 style="color: white; margin-bottom: 10px;">üìã Cached Content:</h4>
                            <div id="cachedContentList" style="color: #ccc; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üìä Package Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(255, 152, 0, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ff9800;" id="totalPackagesCount">${packages.length}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Packages</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 71, 87, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ff4757;" id="adultPackagesCount">0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Adult Packages</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">$0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Revenue</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #2196f3;">0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Active Subs</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üì¶ Available Packages</h4>
                            <div id="packagesList" style="color: rgba(255,255,255,0.7); font-size: 13px;">
                                ${packages.length === 0 ? 'No packages created yet. Use the form to create your first package.' : ''}
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üì∫ Plex Integration Status</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Plex Server:</span>
                                <span style="color: #4caf50; font-weight: 600;">Connected</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Auto Folder Creation:</span>
                                <span style="color: #4caf50; font-weight: 600;">Enabled</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Package Folders:</span>
                                <span style="color: #2196f3; font-weight: 600;">${packages.length} Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update packages list and statistics with the latest data
            updatePackagesList();
            updatePackageStats();
        };

        // Dedicated Plex Management Section
        window.showPlexSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            // Load saved Plex settings
            const plexServerUrl = localStorage.getItem('plexServerUrl') || '';
            const plexToken = localStorage.getItem('plexToken') || '';
            const plexMoviesSection = localStorage.getItem('plexMoviesSection') || '26';
            const plexAdultSection = localStorage.getItem('plexAdultSection') || '21';
            const cachedMovies = JSON.parse(localStorage.getItem('plexCachedMovies') || '[]');
            const cachedAdult = JSON.parse(localStorage.getItem('plexCachedAdult') || '[]');
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üì∫ Plex Management</h1>
                    <p class="dashboard-subtitle">Configure your Plex server connection and manage content libraries</p>
                </div>
                
                <div class="section-grid">
                    <!-- Plex Server Configuration -->
                    <div class="section-card" style="border: 2px solid #e50914;">
                        <h3 class="section-title">üîß Plex Server Configuration</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px; display: block; margin-bottom: 5px;">Plex Server URL:</label>
                                <input type="text" id="plexServerUrl" value="${plexServerUrl}" placeholder="http://185.187.94.41:32400" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px; display: block; margin-bottom: 5px;">Plex Token:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="plexToken" value="${plexToken}" placeholder="Your Plex token" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;">
                                    <button onclick="generatePlexToken()" class="btn btn-warning" style="padding: 12px 20px;">üîë Generate</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px; display: block; margin-bottom: 5px;">Movies Section ID:</label>
                                    <input type="text" id="plexMoviesSection" value="${plexMoviesSection}" placeholder="26" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); font-size: 14px; display: block; margin-bottom: 5px;">Adult Section ID:</label>
                                    <input type="text" id="plexAdultSection" value="${plexAdultSection}" placeholder="21" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 14px;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                                <button onclick="savePlexSettings()" class="btn btn-success" style="padding: 12px 25px;">üíæ Save Settings</button>
                                <button onclick="testPlexConnection()" class="btn btn-primary" style="padding: 12px 25px;">üîó Test Connection</button>
                                <button onclick="loadPlexLibraries()" class="btn btn-info" style="padding: 12px 25px;">üìö Load Libraries</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connection Status -->
                    <div class="section-card">
                        <h3 class="section-title">üìä Plex Status</h3>
                        <div style="display: grid; gap: 15px;">
                            <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: rgba(255,255,255,0.8);">Server:</span>
                                    <span style="color: ${plexServerUrl ? '#4caf50' : '#ff4757'}; font-weight: 600;">${plexServerUrl || 'Not configured'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: rgba(255,255,255,0.8);">Token:</span>
                                    <span style="color: ${plexToken ? '#4caf50' : '#ff4757'}; font-weight: 600;">${plexToken ? '‚úÖ Configured' : '‚ùå Not set'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: rgba(255,255,255,0.8);">Cached Movies:</span>
                                    <span style="color: #2196f3; font-weight: 600;">${cachedMovies.length} videos</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.8);">Cached Adult:</span>
                                    <span style="color: #ff4757; font-weight: 600;">${cachedAdult.length} videos</span>
                                </div>
                            </div>
                            <button onclick="loadAndCachePlexContent()" class="btn btn-warning" style="width: 100%; padding: 15px;">üì¶ Cache All Content for Client</button>
                        </div>
                    </div>
                </div>
                
                <!-- Import Videos Section -->
                <div class="section-card" style="margin-top: 25px; border: 2px solid #4caf50;">
                    <h3 class="section-title">üì• Import Videos from Plex (Easy Method)</h3>
                    <p style="color: #4caf50; margin-bottom: 15px; font-weight: bold;">üí° Use this if auto-fetch fails due to CORS restrictions</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Movies Import -->
                        <div style="background: rgba(33, 150, 243, 0.1); padding: 20px; border-radius: 8px; border: 1px solid #2196f3;">
                            <h4 style="color: #2196f3; margin-bottom: 15px;">üé¨ Movies Library</h4>
                            <div style="margin-bottom: 15px;">
                                <button onclick="copyPlexUrl('movies')" class="btn btn-info" style="width: 100%; margin-bottom: 10px; padding: 12px;">üìã Copy Movies URL</button>
                                <p style="color: #888; font-size: 12px;">1. Click button ‚Üí 2. Open URL in browser ‚Üí 3. Select All (Ctrl+A) ‚Üí 4. Copy (Ctrl+C) ‚Üí 5. Paste below</p>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="color: #ccc; font-size: 13px;">Paste Movies XML:</label>
                                <textarea id="moviesXmlInput" placeholder="Paste the entire XML content here..." style="width: 100%; height: 120px; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #1a1a2e; color: white; font-size: 12px; margin-top: 5px;"></textarea>
                            </div>
                            <button onclick="importMoviesXML()" class="btn btn-primary" style="width: 100%; padding: 12px;">üì• Import Movies</button>
                            <div id="moviesCount" style="margin-top: 10px; color: #4caf50; font-size: 13px; font-weight: bold;">Movies cached: ${cachedMovies.length}</div>
                        </div>
                        
                        <!-- Adult Import -->
                        <div style="background: rgba(255, 71, 87, 0.1); padding: 20px; border-radius: 8px; border: 1px solid #ff4757;">
                            <h4 style="color: #ff4757; margin-bottom: 15px;">üîû Adult Library</h4>
                            <div style="margin-bottom: 15px;">
                                <button onclick="copyPlexUrl('adult')" class="btn btn-danger" style="width: 100%; margin-bottom: 10px; padding: 12px;">üìã Copy Adult URL</button>
                                <p style="color: #888; font-size: 12px;">1. Click button ‚Üí 2. Open URL in browser ‚Üí 3. Select All (Ctrl+A) ‚Üí 4. Copy (Ctrl+C) ‚Üí 5. Paste below</p>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="color: #ccc; font-size: 13px;">Paste Adult XML:</label>
                                <textarea id="adultXmlInput" placeholder="Paste the entire XML content here..." style="width: 100%; height: 120px; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #1a1a2e; color: white; font-size: 12px; margin-top: 5px;"></textarea>
                            </div>
                            <button onclick="importAdultXML()" class="btn btn-danger" style="width: 100%; padding: 12px;">üì• Import Adult Videos</button>
                            <div id="adultCount" style="margin-top: 10px; color: #4caf50; font-size: 13px; font-weight: bold;">Adult videos cached: ${cachedAdult.length}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="viewCachedContent()" class="btn btn-info" style="padding: 12px 25px;">üëÅÔ∏è View Cached Content</button>
                        <button onclick="clearCachedContent()" class="btn btn-secondary" style="padding: 12px 25px;">üóëÔ∏è Clear All Cached</button>
                    </div>
                    
                    <div id="cachedContentPreview" style="margin-top: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; display: none;">
                        <h4 style="color: white; margin-bottom: 10px;">üìã Cached Content:</h4>
                        <div id="cachedContentList" style="color: #ccc; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            `;
            
            // Update the cached counts
            updateCachedCounts();
        };
        
        // Save Plex Settings function
        window.savePlexSettings = function() {
            const serverUrl = document.getElementById('plexServerUrl')?.value || '';
            const token = document.getElementById('plexToken')?.value || '';
            const moviesSection = document.getElementById('plexMoviesSection')?.value || '26';
            const adultSection = document.getElementById('plexAdultSection')?.value || '21';
            
            localStorage.setItem('plexServerUrl', serverUrl);
            localStorage.setItem('plexToken', token);
            localStorage.setItem('plexMoviesSection', moviesSection);
            localStorage.setItem('plexAdultSection', adultSection);
            
            showNotification('‚úÖ Plex settings saved successfully!', 'success');
        };
        
        // Update cached content counts
        function updateCachedCounts() {
            const cachedMovies = JSON.parse(localStorage.getItem('plexCachedMovies') || '[]');
            const cachedAdult = JSON.parse(localStorage.getItem('plexCachedAdult') || '[]');
            
            const moviesCountEl = document.getElementById('moviesCount');
            const adultCountEl = document.getElementById('adultCount');
            
            if (moviesCountEl) moviesCountEl.textContent = `Movies cached: ${cachedMovies.length}`;
            if (adultCountEl) adultCountEl.textContent = `Adult videos cached: ${cachedAdult.length}`;
        }

        // Section Functions
        window.showAdminDashboard = function() {
        function updatePackagesList() {
            console.log('updatePackagesList called');
            const packagesList = document.getElementById('packagesList');
            if (!packagesList) {
                console.error('packagesList element not found');
                return;
            }
            
            // Load packages from localStorage - ensure consistency with adminPackages
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
            
            packagesList.innerHTML = packages.map((pkg, index) => {
                const isAdultPackage = pkg.isAdult || 
                                      pkg.name.toLowerCase().includes('adult') || 
                                      pkg.name.toLowerCase().includes('xxx') ||
                                      (pkg.addonPrices && pkg.addonPrices.adult && pkg.addonPrices.adult > 0) ||
                                      (pkg.adultPackagePrice && pkg.adultPackagePrice > 0);
                
                return `
                    <div style="border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 15px; margin-bottom: 15px; background: ${isAdultPackage ? 'rgba(255,71,87,0.15)' : 'rgba(255,255,255,0.05)'}; border-left: 3px solid ${isAdultPackage ? '#ff4757' : '#4caf50'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h5 style="color: ${isAdultPackage ? '#ff4757' : 'white'}; margin: 0; font-size: 15px; font-weight: 600;">
                                    ${isAdultPackage ? 'üîû ' : ''}${pkg.name}
                                    ${isAdultPackage ? '<span style="color: #ff4757; font-size: 11px; font-weight: normal; margin-left: 8px;">(ADULT CONTENT)</span>' : ''}
                                </h5>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">
                                    <strong>Base:</strong> $${pkg.price}/${pkg.duration}
                                    ${pkg.adultPackagePrice > 0 ? ` | <strong style="color: #ff4757;">Adult Price:</strong> $${pkg.adultPackagePrice}` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="editPackage('${index}')" style="background: #2196f3; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">‚úèÔ∏è EDIT</button>
                                <button onclick="cancelPackageEdit()" style="background: #ff9800; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">‚ùå CANCEL</button>
                                <button onclick="deletePackage('${index}')" style="background: #f44336; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                            <strong>Device Pricing:</strong>
                            ${pkg.secondTVPrice > 0 ? `2nd TV: $${pkg.secondTVPrice}` : ''}
                            ${pkg.thirdTVPrice > 0 ? ` | 3rd TV: $${pkg.thirdTVPrice}` : ''}
                            ${pkg.secondTVPrice <= 0 && pkg.thirdTVPrice <= 0 ? ' No additional devices' : ''}
                        </div>
                        
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                            <strong>Addon Pricing:</strong>
                            ${pkg.sportsPrice > 0 ? `Sports: $${pkg.sportsPrice}` : ''}
                            ${pkg.moviesPrice > 0 ? ` | Movies: $${pkg.moviesPrice}` : ''}
                            ${!pkg.sportsPrice && !pkg.moviesPrice ? ' No addon pricing set' : ''}
                        </div>
                        
                        ${pkg.features ? `<div style="margin-top: 8px; font-size: 11px; color: rgba(255,255,255,0.7); padding: 8px; background: rgba(255,255,255,0.1); border-radius: 4px;">${pkg.features}</div>` : ''}
                        
                        ${isAdultPackage ? `
                            <div style="margin-top: 8px; padding: 6px 10px; background: rgba(255,71,87,0.2); border-radius: 4px; font-size: 11px; color: #ff4757; font-weight: 600;">
                                ‚ö†Ô∏è ADULT CONTENT: This package is hidden in client interface and requires special access
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Edit package function
        window.editPackage = function(packageIndex) {
            // Load from adminPackages first, fallback to packages
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
            const pkg = packages[packageIndex];
            
            if (!pkg) return;
            
            // Load package data into form
            document.getElementById('packageName').value = pkg.name;
            document.getElementById('packagePrice').value = pkg.price;
            document.getElementById('packageDuration').value = pkg.duration;
            document.getElementById('secondTVPrice').value = pkg.secondTVPrice || '';
            document.getElementById('thirdTVPrice').value = pkg.thirdTVPrice || '';
            document.getElementById('sportsPrice').value = pkg.sportsPrice || '';
            document.getElementById('moviesPrice').value = pkg.moviesPrice || '';
            document.getElementById('packageFeatures').value = pkg.features || '';
            document.getElementById('adultPackagePrice').value = pkg.adultPackagePrice || '';
            
            // Change button to update mode
            document.getElementById('createPackageBtn').textContent = 'üíæ Update Package';
            document.getElementById('createPackageBtn').setAttribute('data-edit-index', packageIndex);
            
            // Show cancel edit button
            document.getElementById('cancelPackageEditBtn').style.display = 'inline-block';
            
            showNotification(`‚úèÔ∏è Editing package: ${pkg.name}`, 'info');
        }

        // Delete package function
        window.deletePackage = function(packageIndex) {
            console.log('Delete package called with index:', packageIndex);
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
            const pkg = packages[packageIndex];
            
            if (!pkg) {
                console.error('Package not found at index:', packageIndex);
                return;
            }
            
            if (confirm(`Are you sure you want to delete package "${pkg.name}"? This action cannot be undone.`)) {
                packages.splice(packageIndex, 1);
                // Save to both localStorage keys for consistency
                localStorage.setItem('packages', JSON.stringify(packages));
                localStorage.setItem('adminPackages', JSON.stringify(packages));
                
                // Trigger real-time notification to clients for package deletion
                localStorage.setItem('packageDeleted', JSON.stringify({
                    packageId: pkg.id,
                    packageName: pkg.name,
                    timestamp: new Date().toISOString(),
                    action: 'deleted'
                }));
                
                // Update global packages variable to ensure consistency
                packages = [...packages]; // Create a copy to ensure reference update
                
                setTimeout(() => {
                    showPackagesSection();
                    showNotification(`üóëÔ∏è Package "${pkg.name}" deleted`, 'success');
                }, 50);
            }
        }

        // Cancel edit mode
        window.cancelPackageEdit = function() {
            console.log('Cancel package edit called');
            clearPackageForm();
            const createBtn = document.getElementById('createPackageBtn');
            if (createBtn) {
                createBtn.textContent = '‚ûï Create Package';
                createBtn.removeAttribute('data-edit-index');
            }
            const cancelBtn = document.getElementById('cancelPackageEditBtn');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }
            showNotification('‚ùå Package edit cancelled', 'info');
        }

        // Renew package function
        window.renewPackage = function(packageIndex) {
            // Load from adminPackages first, fallback to packages
            const packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
            const pkg = packages[packageIndex];
            
            if (!pkg) return;
            
            // Show renewal confirmation
            if (confirm(`Renew package "${pkg.name}" for another ${pkg.duration}?`)) {
                // Update package creation date (simulating renewal)
                pkg.createdDate = new Date().toISOString();
                
                // Save updated package to both localStorage keys for consistency
                packages[packageIndex] = pkg;
                localStorage.setItem('packages', JSON.stringify(packages));
                localStorage.setItem('adminPackages', JSON.stringify(packages));
                
                // Update global packages variable to ensure consistency
                packages = [...packages]; // Create a copy to ensure reference update
                
                setTimeout(() => {
                    // Update display
                    updatePackagesList();
                    alert(`Package "${pkg.name}" has been renewed successfully!`);
                }, 50);
            }
        }

        // Clear package form
        window.clearPackageForm = function() {
            const fields = ['packageName', 'packagePrice', 'secondTVPrice', 'thirdTVPrice', 'sportsPrice', 'moviesPrice', 'adultPackagePrice', 'packageFeatures'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
            
            document.getElementById('packageDuration').value = '1 Month';
        }
        };

        // Device Management Section
        window.showDevicesSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            const allDevices = JSON.parse(localStorage.getItem('userDevices')) || {};
            const deviceEntries = Object.entries(allDevices);
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üì± Device Management</h1>
                    <p class="dashboard-subtitle">Monitor and manage customer devices and multi-TV access</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">üîç Device Overview</h3>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; color: #4caf50;" id="totalDevices">${deviceEntries.reduce((total, [user, devices]) => total + devices.length, 0)}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Devices</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; color: #2196f3;" id="multiDeviceUsers">${deviceEntries.filter(([user, devices]) => devices.length > 1).length}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Multi-Device Users</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; color: #ff9800;" id="activeConnections">${Object.keys(allDevices).length}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Active Users</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: white; margin: 0;">üìã All Registered Devices</h4>
                                <button onclick="clearAllDevices()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-size: 12px; cursor: pointer;">üóëÔ∏è Clear All</button>
                            </div>
                            <div id="devicesList" style="max-height: 500px; overflow-y: auto;">
                                ${deviceEntries.length === 0 ? 
                                    '<div style="color: rgba(255,255,255,0.5); font-size: 13px; text-align: center; padding: 20px;">No devices registered yet.</div>' :
                                    deviceEntries.map(([username, devices]) => `
                                        <div style="border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <h5 style="color: white; margin: 0;">üë§ ${username}</h5>
                                                <span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">${devices.length} Device${devices.length > 1 ? 's' : ''}</span>
                                            </div>
                                            <div style="display: grid; gap: 10px;">
                                                ${devices.map((device, index) => `
                                                    <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 12px; border-left: 4px solid ${index === 0 ? '#2196f3' : index === 1 ? '#ff9800' : '#e91e63'};">
                                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                                            <div>
                                                                <div style="color: rgba(255,255,255,0.9); font-weight: 600; font-size: 13px;">
                                                                    ${index === 0 ? 'üì∫ 1st TV' : index === 1 ? 'üì∫ 2nd TV' : 'üì∫ 3rd TV'}
                                                                </div>
                                                                <div style="color: rgba(255,255,255,0.6); font-size: 11px; margin-top: 4px;">
                                                                    MAC: ${device.macAddress}
                                                                </div>
                                                                <div style="color: rgba(255,255,255,0.6); font-size: 11px;">
                                                                    WiFi: ${device.wifiNetwork}
                                                                </div>
                                                                <div style="color: rgba(255,255,255,0.5); font-size: 10px; margin-top: 4px;">
                                                                    Registered: ${new Date(device.registeredDate).toLocaleDateString()}
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <button onclick="removeDevice('${username}', '${device.macAddress}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">Remove</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üîß Device Actions</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button onclick="exportDevicesData()" style="background: #2196f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">üì§ Export Device Data</button>
                            <button onclick="importDevicesData()" style="background: #4caf50; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">üì• Import Device Data</button>
                            <button onclick="resetDeviceAccess()" style="background: #ff9800; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">üîÑ Reset All Access</button>
                        </div>
                        
                        <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 8px; padding: 15px; margin-top: 20px;">
                            <h4 style="color: #ff9800; margin-bottom: 10px;">üõ°Ô∏è Security Features</h4>
                            <ul style="color: rgba(255,255,255,0.8); font-size: 13px; padding-left: 20px; margin: 0;">
                                <li>MAC address-based device tracking</li>
                                <li>WiFi network verification</li>
                                <li>Maximum 3 devices per account</li>
                                <li>2nd/3rd TV restricted to same WiFi as 1st TV</li>
                                <li>Automatic device registration</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        };

        // Device management functions
        window.clearAllDevices = function() {
            if (confirm('Are you sure you want to clear all device registrations? This will affect all users.')) {
                localStorage.removeItem('userDevices');
                showNotification('üóëÔ∏è All device registrations cleared', 'success');
                showDevicesSection(); // Refresh the display
            }
        };

        window.removeDevice = function(username, macAddress) {
            if (confirm(`Remove device ${macAddress} from user ${username}?`)) {
                const allDevices = JSON.parse(localStorage.getItem('userDevices')) || {};
                if (allDevices[username]) {
                    allDevices[username] = allDevices[username].filter(device => device.macAddress !== macAddress);
                    
                    // If no devices left for user, remove the user entry
                    if (allDevices[username].length === 0) {
                        delete allDevices[username];
                    }
                    
                    localStorage.setItem('userDevices', JSON.stringify(allDevices));
                    showNotification(`‚úÖ Device removed from ${username}`, 'success');
                    showDevicesSection(); // Refresh the display
                }
            }
        };

        window.exportDevicesData = function() {
            const allDevices = JSON.parse(localStorage.getItem('userDevices')) || {};
            const dataStr = JSON.stringify(allDevices, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `devices_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('üì§ Device data exported successfully', 'success');
        };

        window.importDevicesData = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            localStorage.setItem('userDevices', JSON.stringify(importedData));
                            showNotification('üì• Device data imported successfully', 'success');
                            showDevicesSection(); // Refresh the display
                        } catch (error) {
                            showNotification('‚ùå Invalid JSON file', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        };

        window.resetDeviceAccess = function() {
            if (confirm('Reset ALL device access? This will require all users to re-register their devices.')) {
                const allDevices = JSON.parse(localStorage.getItem('userDevices')) || {};
                const resetData = {};
                
                // Keep user structure but clear device info
                Object.keys(allDevices).forEach(username => {
                    resetData[username] = allDevices[username].map(device => ({
                        ...device,
                        registeredDate: new Date().toISOString(),
                        wifiNetwork: 'RESET_REQUIRED'
                    }));
                });
                
                localStorage.setItem('userDevices', JSON.stringify(resetData));
                showNotification('üîÑ Device access reset for all users', 'success');
                showDevicesSection(); // Refresh the display
            }
        };

        // Reseller Management Functions
        function displayResellersTable() {
            const resellersTable = document.getElementById('resellersTable');
            if (!resellersTable) return;

            const allResellers = Object.entries(RESELLER_ACCOUNTS).map(([id, reseller]) => ({
                id: id,
                ...reseller,
                credentials: passwordManager.resellerCredentials[id] || {}
            }));

            if (allResellers.length === 0) {
                resellersTable.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center; padding: 20px;">No resellers found</p>';
                return;
            }

            resellersTable.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background: rgba(255,255,255,0.1);">
                            <th style="padding: 12px 8px; text-align: left; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">ID</th>
                            <th style="padding: 12px 8px; text-align: left; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">Username</th>
                            <th style="padding: 12px 8px; text-align: left; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">Password</th>
                            <th style="padding: 12px 8px; text-align: left; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">Wallet</th>
                            <th style="padding: 12px 8px; text-align: left; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">Status</th>
                            <th style="padding: 12px 8px; text-align: center; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allResellers.map(reseller => {
                            const walletBalance = parseFloat(localStorage.getItem('resellerWallet_' + reseller.id) || reseller.walletBalance || 0);
                            return `
                            <tr id="reseller-row-${reseller.id}" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <td style="padding: 10px 8px; color: #4caf50; font-weight: 600;">${reseller.id}</td>
                                <td style="padding: 10px 8px; color: rgba(255,255,255,0.9);">
                                    <span id="username-display-${reseller.id}">${reseller.username}</span>
                                    <input type="text" id="username-edit-${reseller.id}" value="${reseller.username}" style="display: none; width: 100%; padding: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; color: white; font-size: 13px;">
                                </td>
                                <td style="padding: 10px 8px; color: rgba(255,255,255,0.9);">
                                    <span id="password-display-${reseller.id}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                    <input type="text" id="password-edit-${reseller.id}" value="${reseller.credentials.password || reseller.password || ''}" style="display: none; width: 100%; padding: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; color: white; font-size: 13px;" placeholder="New password">
                                </td>
                                <td style="padding: 10px 8px; color: #00F5A0; font-weight: 600;">$${walletBalance.toFixed(2)}</td>
                                <td style="padding: 10px 8px;">
                                    <span style="color: ${reseller.status === 'active' ? '#4caf50' : '#ff9800'}; font-weight: 600;">
                                        ${reseller.status || 'active'}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    <button onclick="editReseller('${reseller.id}')" id="edit-btn-${reseller.id}" class="btn" style="padding: 5px 12px; margin-right: 5px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Edit</button>
                                    <button onclick="saveReseller('${reseller.id}')" id="save-btn-${reseller.id}" class="btn" style="display: none; padding: 5px 12px; margin-right: 5px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Save</button>
                                    <button onclick="cancelEdit('${reseller.id}')" id="cancel-btn-${reseller.id}" class="btn" style="display: none; padding: 5px 12px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Cancel</button>
                                </td>
                            </tr>
                        `;}).join('')}
                    </tbody>
                </table>
            `;
        }

        function editReseller(resellerId) {
            // Hide display elements
            document.getElementById(`username-display-${resellerId}`).style.display = 'none';
            document.getElementById(`password-display-${resellerId}`).style.display = 'none';
            document.getElementById(`commission-display-${resellerId}`).style.display = 'none';
            
            // Show edit elements
            document.getElementById(`username-edit-${resellerId}`).style.display = 'block';
            document.getElementById(`password-edit-${resellerId}`).style.display = 'block';
            document.getElementById(`commission-edit-${resellerId}`).style.display = 'block';
            
            // Toggle buttons
            document.getElementById(`edit-btn-${resellerId}`).style.display = 'none';
            document.getElementById(`save-btn-${resellerId}`).style.display = 'inline-block';
            document.getElementById(`cancel-btn-${resellerId}`).style.display = 'inline-block';
        }

        function cancelEdit(resellerId) {
            // Show display elements
            document.getElementById(`username-display-${resellerId}`).style.display = 'block';
            document.getElementById(`password-display-${resellerId}`).style.display = 'block';
            document.getElementById(`commission-display-${resellerId}`).style.display = 'block';
            
            // Hide edit elements
            document.getElementById(`username-edit-${resellerId}`).style.display = 'none';
            document.getElementById(`password-edit-${resellerId}`).style.display = 'none';
            document.getElementById(`commission-edit-${resellerId}`).style.display = 'none';
            
            // Toggle buttons
            document.getElementById(`edit-btn-${resellerId}`).style.display = 'inline-block';
            document.getElementById(`save-btn-${resellerId}`).style.display = 'none';
            document.getElementById(`cancel-btn-${resellerId}`).style.display = 'none';
        }

        function saveReseller(resellerId) {
            const newUsername = document.getElementById(`username-edit-${resellerId}`).value.trim();
            const newPassword = document.getElementById(`password-edit-${resellerId}`).value.trim();

            if (!newUsername) {
                showNotification('Username is required', 'error');
                return;
            }

            // Get current password if no new one entered
            const currentPassword = RESELLER_ACCOUNTS[resellerId]?.password || 
                                   passwordManager.resellerCredentials[resellerId]?.password || '';
            const passwordToSave = newPassword || currentPassword;
            
            if (newPassword && newPassword.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }

            // Update RESELLER_ACCOUNTS
            if (RESELLER_ACCOUNTS[resellerId]) {
                RESELLER_ACCOUNTS[resellerId].username = newUsername;
                RESELLER_ACCOUNTS[resellerId].password = passwordToSave;
                RESELLER_ACCOUNTS[resellerId].updatedAt = new Date().toISOString();
            }
            
            saveResellerAccounts();

            // Update passwordManager credentials
            if (passwordManager.resellerCredentials[resellerId]) {
                passwordManager.resellerCredentials[resellerId].username = newUsername;
                passwordManager.resellerCredentials[resellerId].password = passwordToSave;
                passwordManager.resellerCredentials[resellerId].updatedAt = new Date().toISOString();
                passwordManager.saveCredentials();
            } else {
                // Create credentials entry if it doesn't exist
                passwordManager.resellerCredentials[resellerId] = {
                    username: newUsername,
                    password: passwordToSave,
                    createdAt: new Date().toISOString()
                };
                passwordManager.saveCredentials();
            }

            // Update display
            document.getElementById(`username-display-${resellerId}`).textContent = newUsername;
            document.getElementById(`password-display-${resellerId}`).textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            
            // Hide edit elements and show display elements
            cancelEdit(resellerId);
            
            // Update dashboard statistics
            updateResellerStatistics();
            
            showNotification(`‚úÖ Reseller "${resellerId}" updated successfully!`, 'success');
        }

        function createNewReseller() {
            const resellerId = document.getElementById('resellerId').value.trim();
            const username = document.getElementById('resellerUsername').value.trim();
            const password = document.getElementById('resellerPassword').value.trim();
            const commission = document.getElementById('resellerCommission').value || '20';

            if (!resellerId || !username || !password) {
                showNotification('‚ùå All fields are required', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('‚ùå Password must be at least 6 characters', 'error');
                return;
            }

            // Check if reseller ID already exists
            if (RESELLER_ACCOUNTS[resellerId] || passwordManager.resellerCredentials[resellerId]) {
                showNotification('‚ùå Reseller ID already exists', 'error');
                return;
            }

            // Create reseller using the existing passwordManager.createReseller
            const result = passwordManager.createReseller(resellerId, username, password);
            
            if (result.success) {
                // Update commission rate in RESELLER_ACCOUNTS
                if (RESELLER_ACCOUNTS[resellerId]) {
                    RESELLER_ACCOUNTS[resellerId].commissionRate = parseInt(commission) || 20;
                }
                
                saveResellerAccounts();
                
                // Clear form
                document.getElementById('resellerId').value = '';
                document.getElementById('resellerUsername').value = '';
                document.getElementById('resellerPassword').value = '';
                document.getElementById('resellerCommission').value = '';
                
                // Refresh table
                setTimeout(() => {
                    displayResellersTable();
                    updateResellerStatistics();
                }, 100);
                
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
        }

        // Make functions globally available
        window.createNewReseller = createNewReseller;
        window.editReseller = editReseller;
        window.saveReseller = saveReseller;
        window.cancelEdit = cancelEdit;

        // Reseller Management Section
        window.showResellersSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üè¢ Reseller Management</h1>
                    <p class="dashboard-subtitle">Manage your reseller network and credentials</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">‚ûï Create New Reseller</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Reseller ID:</label>
                                <input type="text" id="resellerId" placeholder="reseller013" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Username:</label>
                                <input type="text" id="resellerUsername" placeholder="john_doe" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Password:</label>
                                <input type="password" id="resellerPassword" placeholder="secure_password" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Commission Rate (%):</label>
                                <input type="number" id="resellerCommission" placeholder="20" min="0" max="100" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <button onclick="createNewReseller()" class="btn btn-info" style="padding: 12px 20px;">‚ûï Create Reseller</button>
                        </div>
                    </div>
                    
                    <div class="section-card" style="grid-column: 1 / -1;">
                        <h3 class="section-title">üìã All Resellers (Editable)</h3>
                        <div style="max-height: 500px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <div id="resellersTable"></div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üìä Reseller Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #2196f3;" id="totalResellersCount">0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Resellers</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;" id="activeResellersCount">0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Active</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 152, 0, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ff9800;" id="totalSalesAmount">$0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Sales</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üè¢ Active Resellers</h4>
                            <div id="activeResellersList">
                                <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 20px;">No resellers created yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Display the resellers table
            displayResellersTable();
            updateResellerStatistics();
        };

        // Credit Management Section
        window.showCreditSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üí∞ Credit Manager</h1>
                    <p class="dashboard-subtitle">Unlimited transfers to reseller wallets</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">üí≥ Transfer Credits</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Select Reseller:</label>
                                <select id="creditReseller" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    <option value="">Select a reseller</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Amount ($):</label>
                                <input type="number" id="creditAmount" placeholder="100.00" min="0" step="0.01" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Note (Optional):</label>
                                <textarea id="creditNote" placeholder="Monthly commission payment..." style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; min-height: 60px;"></textarea>
                            </div>
                            <button onclick="transferCredits()" class="btn btn-success" style="padding: 12px 20px;">üí∞ Transfer Credits</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üìä Credit Overview</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;" id="totalCreditsAmount">$0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Credits</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #2196f3;" id="availableCreditsAmount">$0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Available</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 152, 0, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ff9800;" id="transferredCreditsAmount">$0</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Transferred</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üí≥ Recent Transfers</h4>
                            <div id="recentTransfersList" style="color: rgba(255,255,255,0.7); font-size: 13px;">
                                <p style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">No transfers yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Populate reseller dropdown and update credit overview
            setTimeout(() => {
                updateResellerStatistics();
                populateResellerDropdown();
                updateCreditOverview();
            }, 100);
        };

        // Analytics Section
        window.showAnalyticsSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üìà Analytics Dashboard</h1>
                    <p class="dashboard-subtitle">System performance and business metrics</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon users">üìä</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Monthly Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue">üí∞</div>
                        <div class="stat-value">$0</div>
                        <div class="stat-label">Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon content">üì¶</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">Packages Sold</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon system">üè¢</div>
                        <div class="stat-value">12</div>
                        <div class="stat-label">Active Resellers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon satellite">üìà</div>
                        <div class="stat-value">98%</div>
                        <div class="stat-label">System Uptime</div>
                    </div>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">üìä User Growth</h3>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">
                                <div style="font-size: 1.5rem; color: #4caf50;">üìà Growth Chart</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">User acquisition over time</div>
                            </div>
                            <div style="height: 200px; display: flex; align-items: end; justify-content: space-around; gap: 10px;">
                                <div style="width: 20px; height: 40px; background: #4caf50; border-radius: 2px;"></div>
                                <div style="width: 20px; height: 60px; background: #4caf50; border-radius: 2px;"></div>
                                <div style="width: 20px; height: 30px; background: #4caf50; border-radius: 2px;"></div>
                                <div style="width: 20px; height: 80px; background: #4caf50; border-radius: 2px;"></div>
                                <div style="width: 20px; height: 50px; background: #4caf50; border-radius: 2px;"></div>
                            </div>
                            <div style="margin-top: 15px; font-size: 0.8rem; color: rgba(255,255,255,0.5); display: flex; justify-content: space-around;">
                                <span>Jan</span><span>Feb</span><span>Mar</span><span>Apr</span><span>May</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üí∞ Revenue Breakdown</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #4caf50;">$0</div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Direct Sales</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(33, 150, 243, 0.2); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2196f3;">$0</div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Reseller Comm</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(255, 152, 0, 0.2); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #ff9800;">$0</div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Add-ons</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üìà Performance Metrics</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Conversion Rate:</span>
                                <span style="color: #4caf50; font-weight: 600;">0%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Avg Revenue/User:</span>
                                <span style="color: #2196f3; font-weight: 600;">$0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Churn Rate:</span>
                                <span style="color: #ff9800; font-weight: 600;">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        window.showLogsSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üìã System Logs</h1>
                    <p class="dashboard-subtitle">Recent system activities</p>
                </div>
                
                <div class="section-card">
                    <h3 class="section-title">üîç Log Viewer</h3>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; color: rgba(255,255,255,0.8);">
                        <div>[${new Date().toLocaleString()}] INFO: Admin panel loaded successfully</div>
                        <div>[${new Date().toLocaleString()}] INFO: Satellite system initialized - 400 channels ready</div>
                        <div>[${new Date().toLocaleString()}] INFO: Credit system initialized</div>
                        <div>[${new Date().toLocaleString()}] INFO: Package system loaded</div>
                    </div>
                </div>
            `;
        };

        // Settings Section
        window.showSettingsSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">‚öôÔ∏è System Settings</h1>
                    <p class="dashboard-subtitle">Configure your iWATCH TV system</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">üîê Security Settings</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Admin Password:</label>
                                <input type="password" id="adminPassword" value="admin123" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Master Password:</label>
                                <input type="password" id="masterPassword" value="master2025" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Session Timeout (minutes):</label>
                                <input type="number" id="sessionTimeout" value="60" min="5" max="480" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <button onclick="saveSecuritySettings()" class="btn btn-success" style="padding: 12px 20px;">üîí Save Security</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üåê System Configuration</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">System Name:</label>
                                <input type="text" id="systemName" value="iWATCH TV System" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">API Endpoint:</label>
                                <input type="url" id="apiEndpoint" placeholder="https://api.iwatch.tv" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Time Zone:</label>
                                <select id="timeZone" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    <option>UTC</option>
                                    <option>America/New_York</option>
                                    <option>Europe/London</option>
                                    <option>Asia/Dubai</option>
                                </select>
                            </div>
                            <button onclick="saveSystemSettings()" class="btn btn-info" style="padding: 12px 20px;">‚öôÔ∏è Save Settings</button>
                        </div>
                    </div>
                </div>
                
                <div class="section-card" style="margin-top: 25px;">
                    <h3 class="section-title">üì¶ GitHub Auto-Sync</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px; font-size: 14px;">
                        One-click upload to GitHub. Customers will auto-sync when they open the app.
                    </p>
                    
                    <!-- GitHub Settings -->
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(102,126,234,0.1); border-radius: 10px; border: 1px solid rgba(102,126,234,0.3);">
                        <h4 style="color: #667eea; margin-bottom: 15px;">üîß GitHub Settings</h4>
                        <div style="display: grid; gap: 10px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 12px;">GitHub Username:</label>
                                <input type="text" id="githubUsername" placeholder="e.g., samsat1" 
                                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 12px;">Repository Name:</label>
                                <input type="text" id="githubRepo" placeholder="e.g., app" 
                                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 12px;">Personal Access Token: <a href="https://github.com/settings/tokens" target="_blank" style="color: #667eea;">(Get Token)</a></label>
                                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" 
                                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; box-sizing: border-box;">
                            </div>
                            <button onclick="saveGithubSettings()" class="btn btn-info" style="padding: 10px;">üíæ Save GitHub Settings</button>
                        </div>
                    </div>
                    
                    <!-- One-Click Upload -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="uploadToGithub()" id="uploadGithubBtn" class="btn btn-success" style="width: 100%; padding: 18px; font-size: 18px;">
                            üöÄ Upload to GitHub (One-Click)
                        </button>
                        <p style="color: rgba(255,255,255,0.5); font-size: 12px; text-align: center; margin-top: 8px;">
                            Uploads all data to GitHub. TVs will auto-sync on startup.
                        </p>
                    </div>
                    
                    <!-- Manual Export/Import -->
                    <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <p style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 10px;">Manual backup:</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="backupData()" class="btn btn-primary" style="padding: 10px 20px;">üì§ Export</button>
                            <button onclick="importData()" class="btn btn-warning" style="padding: 10px 20px;">üì• Import</button>
                        </div>
                    </div>
                </div>
                
                <div class="section-card" style="margin-top: 25px;">
                    <h3 class="section-title">üîÑ System Maintenance</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button onclick="clearCache()" class="btn btn-info">üóëÔ∏è Clear Cache</button>
                        <button onclick="restartServices()" class="btn btn-primary">üîÑ Restart Services</button>
                        <button onclick="updateSystem()" class="btn btn-success">‚¨ÜÔ∏è Update System</button>
                    </div>
                </div>
            `;
            
            // Load saved TV Sync URL
            setTimeout(() => {
                loadGithubSettings();
            }, 100);
        };

        // Content Library Section
        window.showContentSection = function() {
            const mainContent = document.querySelector('.admin-main');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="dashboard-title">üì∫ Content Library</h1>
                    <p class="dashboard-subtitle">Manage your content sources and streaming platforms</p>
                </div>
                
                <div class="section-grid">
                    <div class="section-card">
                        <h3 class="section-title">‚ûï Add Content Source</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Source Name:</label>
                                <input type="text" id="contentName" placeholder="Netflix HD" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Platform Type:</label>
                                <select id="contentType" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    <option>Movie Streaming</option>
                                    <option>TV Shows</option>
                                    <option>Sports</option>
                                    <option>News</option>
                                    <option>Kids Content</option>
                                    <option>International</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Stream URL:</label>
                                <input type="url" id="contentURL" placeholder="http://your-stream-url/stream.m3u8" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.8); font-size: 14px;">Quality:</label>
                                <select id="contentQuality" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                                    <option>4K Ultra HD</option>
                                    <option>1080p HD</option>
                                    <option>720p HD</option>
                                    <option>480p SD</option>
                                </select>
                            </div>
                            <button onclick="addContentSource()" class="btn btn-primary" style="padding: 12px 20px;">‚ûï Add Source</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <h3 class="section-title">üìä Content Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(33, 150, 243, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #2196f3;">400</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Channels</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">380</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">HD Channels</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 152, 0, 0.2); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ff9800;">95%</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Quality Score</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            <h4 style="color: white; margin-bottom: 10px;">üì∫ Content Categories</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Sports Channels:</span>
                                <span style="color: #4caf50; font-weight: 600;">85</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">Movies:</span>
                                <span style="color: #2196f3; font-weight: 600;">120</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">TV Shows:</span>
                                <span style="color: #ff9800; font-weight: 600;">95</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">International:</span>
                                <span style="color: #9c27b0; font-weight: 100;">100</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéõÔ∏èüéõÔ∏èüéõÔ∏è ADMIN PANEL V2.1 - WITH XML IMPORT üéõÔ∏èüéõÔ∏èüéõÔ∏è');
            console.log('üöÄ Initializing Optimized Admin Panel...');
            
            // Initialize password manager
            passwordManager.initialize();
            
            // Initialize and save RESELLER_ACCOUNTS to localStorage
            saveResellerAccounts();
            
            // Auto-generate Plex token if not exists
            const existingToken = localStorage.getItem('plexAutoToken');
            const tokenInput = document.getElementById('plexToken');
            if (!existingToken && tokenInput) {
                generatePlexToken();
            } else if (existingToken && tokenInput) {
                tokenInput.value = existingToken;
            }
            
            // Initialize with your actual Plex library structure if none exist
            const existingLibraries = localStorage.getItem('plexLibraries');
            if (!existingLibraries) {
                // Initialize with your actual folders that exist in Plex
                const actualLibraries = [
                    { 
                        id: 'movies_folder', 
                        name: 'Movies', 
                        type: 'movie', 
                        count: 0, 
                        isAdult: false,
                        fromSetup: 'Your Plex Movies folder'
                    },
                    { 
                        id: 'adult_folder', 
                        name: 'Adult', 
                        type: 'movie', 
                        count: 0, 
                        isAdult: true,
                        fromSetup: 'Your Plex Adult folder'
                    }
                ];
                localStorage.setItem('plexLibraries', JSON.stringify(actualLibraries));
                console.log('üìÅ Initialized with your Movies and Adult folders from Plex');
            }
            
            // Load packages from localStorage
            packages = JSON.parse(localStorage.getItem('adminPackages')) || JSON.parse(localStorage.getItem('packages')) || [];
            
            // Load customers from localStorage
            loadCustomersFromStorage();
            
            // Initialize adult addon availability
            updateAdultAddonAvailability();
            
            // Set up auto-refresh to broadcast changes
            setInterval(() => {
                // Broadcast package updates
                localStorage.setItem('packageUpdate', Date.now().toString());
                
                // Broadcast customer updates
                localStorage.setItem('customerUpdate', Date.now().toString());
                
                console.log('üì° Broadcasting updates to clients...');
            }, 30000); // Every 30 seconds
            
            // Show dashboard by default
            setTimeout(() => {
                showAdminDashboard();
                console.log('‚úÖ Admin panel ready');
            }, 100);
        });

        // Renew customer subscription
        window.renewCustomer = function(customerId) {
            const customers = window.customers || [];
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) {
                showNotification('‚ùå Customer not found', 'error');
                return;
            }
            
            // Switch to users section if not already there
            showSection('users');
            
            // Load customer data into form for renewal
            setTimeout(() => {
                loadCustomerForRenewal(customer);
            }, 100);
            
            showNotification(`üîÑ Loading renewal form for ${customer.name}`, 'info');
        }
        
        // Load customer data for renewal
        function loadCustomerForRenewal(customer) {
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerUsername').value = customer.username || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerPassword').value = customer.password || '';
            
            // Set expiry to 1 month from current expiry
            let monthsValue = '1'; // default renewal is 1 month
            if (customer.durationMonths) {
                monthsValue = customer.durationMonths.toString();
            }
            
            // Set the dropdown value
            const expirySelect = document.getElementById('customerExpiry');
            if (expirySelect) {
                expirySelect.value = ['1', '3', '6', '9', '12'].includes(monthsValue) ? monthsValue : '1';
            }
            
            // Set device selections based on customer plan
            const planDevices = customer.plan ? customer.plan.split(', ') : [];
            const planString = customer.plan ? customer.plan.toLowerCase() : '';
            
            // Reset all devices first
            document.getElementById('basicTVCheckbox').checked = false;
            document.getElementById('secondTVCheckbox').checked = false;
            document.getElementById('thirdTVCheckbox').checked = false;
            
            // Set devices based on plan (check for various formats)
            if (planString.includes('basic tv') || planDevices.includes('Basic TV') || planDevices.includes('Basic TV Package')) {
                document.getElementById('basicTVCheckbox').checked = true;
            }
            if (planString.includes('2nd tv') || planDevices.includes('2nd TV')) {
                document.getElementById('secondTVCheckbox').checked = true;
            }
            if (planString.includes('3rd tv') || planDevices.includes('3rd TV')) {
                document.getElementById('thirdTVCheckbox').checked = true;
            }
            
            // Set addon selections (check both plan and addons fields with flexible matching)
            const addonDevices = customer.addons ? customer.addons.split(', ') : [];
            const addonsString = customer.addons ? customer.addons.toLowerCase() : '';
            
            // Reset addon checkboxes first
            const sportsAddonEl = document.getElementById('sportsAddon');
            const moviesAddonEl = document.getElementById('moviesAddon');
            const adultAddonEl = document.getElementById('adultAddon');
            
            if (sportsAddonEl) sportsAddonEl.checked = false;
            if (moviesAddonEl) moviesAddonEl.checked = false;
            if (adultAddonEl) adultAddonEl.checked = false;
            
            // Check for various formats: "sports", "Sports Package", "Sports", etc.
            if (sportsAddonEl) sportsAddonEl.checked = addonsString.includes('sport');
            if (moviesAddonEl) moviesAddonEl.checked = addonsString.includes('movie');
            if (adultAddonEl) adultAddonEl.checked = addonsString.includes('adult');
            
            // Update device selection and price
            updateDeviceSelection();
            updateTotalPrice();
            
            // Set form to renewal mode
            window.editingCustomerId = customer.id;
            window.renewalMode = true;
            document.getElementById('customerFormTitle').textContent = 'üîÑ Renew Subscription';
            document.getElementById('addCustomerBtn').textContent = 'üîÑ Renew Subscription';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
        }
        
        // Edit customer subscription
        window.editCustomer = function(customerId) {
            console.log('Edit button clicked for customer:', customerId);
            const customers = window.customers || [];
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) {
                showNotification('‚ùå Customer not found', 'error');
                return;
            }
            
            showNotification(`‚úèÔ∏è Loading edit form for ${customer.name}`, 'info');
            
            // Switch to users section if not already there
            showSection('users');
            
            // Load customer data into form for editing
            setTimeout(() => {
                loadCustomerForEdit(customer);
            }, 100);
            
            showNotification(`‚úèÔ∏è Loading edit form for ${customer.name}`, 'info');
        }
        
        // Load customer data for editing
        function loadCustomerForEdit(customer) {
            console.log('Loading customer for edit:', customer);
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerUsername').value = customer.username || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerPassword').value = customer.password || '';
            
            // Show Device Lock section when editing (not when adding new)
            const deviceLockSection = document.getElementById('deviceLockSection');
            if (deviceLockSection) {
                deviceLockSection.style.display = 'block';
            }
            
            // Reset the checkbox (admin must explicitly check it each time)
            const resetDeviceLock = document.getElementById('resetDeviceLock');
            if (resetDeviceLock) {
                resetDeviceLock.checked = false;
            }
            
            // Keep hidden field for backward compatibility
            const macAddressField = document.getElementById('customerMacAddress');
            if (macAddressField) {
                macAddressField.value = customer.macAddress || '';
            }
            
            // Set Adult Password
            const adultPasswordField = document.getElementById('customerAdultPassword');
            if (adultPasswordField) {
                adultPasswordField.value = customer.adultPassword || '1818';
            }
            
            // Handle expiry date conversion from ISO date string to months
            let monthsValue = '1'; // default
            if (customer.expiryDate && typeof customer.expiryDate === 'string') {
                if (customer.expiryDate.includes('T') || customer.expiryDate.includes('-')) {
                    // Old format: ISO date string, calculate months from now
                    const expiry = new Date(customer.expiryDate);
                    const today = new Date();
                    const diffTime = expiry - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    monthsValue = Math.max(1, Math.ceil(Math.abs(diffDays) / 30)).toString();
                } else {
                    // Already month-based or other format
                    monthsValue = customer.expiryDate;
                }
            } else if (customer.durationMonths) {
                monthsValue = customer.durationMonths.toString();
            }
            
            // Set the dropdown value
            const expirySelect = document.getElementById('customerExpiry');
            if (expirySelect) {
                expirySelect.value = ['1', '3', '6', '9', '12'].includes(monthsValue) ? monthsValue : '1';
            }
            
            // Set device selections based on customer plan
            const planDevices = customer.plan ? customer.plan.split(', ') : [];
            const planString = customer.plan ? customer.plan.toLowerCase() : '';
            
            // Reset all devices first
            document.getElementById('basicTVCheckbox').checked = false;
            document.getElementById('secondTVCheckbox').checked = false;
            document.getElementById('thirdTVCheckbox').checked = false;
            
            // Set devices based on plan (check for various formats)
            if (planString.includes('basic tv') || planDevices.includes('Basic TV') || planDevices.includes('Basic TV Package')) {
                document.getElementById('basicTVCheckbox').checked = true;
            }
            if (planString.includes('2nd tv') || planDevices.includes('2nd TV')) {
                document.getElementById('secondTVCheckbox').checked = true;
            }
            if (planString.includes('3rd tv') || planDevices.includes('3rd TV')) {
                document.getElementById('thirdTVCheckbox').checked = true;
            }
            
            // Set addon selections (check customer addons field with correct values)
            const customerAddons = customer.addons ? customer.addons.split(', ') : [];
            const addonsString = customer.addons ? customer.addons.toLowerCase() : '';
            
            // Clear all addon checkboxes first
            const sportsAddonEl2 = document.getElementById('sportsAddon');
            const moviesAddonEl2 = document.getElementById('moviesAddon');
            const adultAddonEl2 = document.getElementById('adultAddon');
            
            if (sportsAddonEl2) sportsAddonEl2.checked = false;
            if (moviesAddonEl2) moviesAddonEl2.checked = false;
            if (adultAddonEl2) adultAddonEl2.checked = false;
            
            // Set checkboxes based on customer's actual addon selections
            // Check for various formats: "sports", "Sports Package", "Sports", etc.
            if (sportsAddonEl2) sportsAddonEl2.checked = addonsString.includes('sport');
            if (moviesAddonEl2) moviesAddonEl2.checked = addonsString.includes('movie');
            if (adultAddonEl2) adultAddonEl2.checked = addonsString.includes('adult');
            
            // Enable/disable addon checkboxes based on basic TV selection
            updateAdultAddonAvailability();
            
            // Update device selection and price
            updateDeviceSelection();
            updateTotalPrice();
            
            // Set form to edit mode
            window.editingCustomerId = customer.id;
            window.renewalMode = false;
            document.getElementById('customerFormTitle').textContent = '‚úèÔ∏è Edit Customer';
            document.getElementById('addCustomerBtn').textContent = 'üíæ Save Changes';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            console.log('Edit mode activated - editingCustomerId:', window.editingCustomerId);
        }
        
        // Cancel edit/renewal mode for customers
        window.cancelCustomerEdit = function() {
            try {
                clearCustomerForm();
            } catch (e) {
                // Ignore errors when DOM elements don't exist
            }
            showNotification('‚ùå Edit cancelled', 'info');
        }

        // Update reseller statistics
        function updateResellerStatistics() {
            try {
                const resellers = Object.values(RESELLER_ACCOUNTS);
                const customers = JSON.parse(localStorage.getItem('adminCustomers') || '[]');
                
                // Only update elements if they exist and section is visible
                const totalResellersCount = document.getElementById('totalResellersCount');
                const activeResellersCount = document.getElementById('activeResellersCount');
                const totalSalesAmount = document.getElementById('totalSalesAmount');
                const activeResellersList = document.getElementById('activeResellersList');
                
                if (totalResellersCount && totalResellersCount.offsetParent !== null) {
                    totalResellersCount.textContent = resellers.length;
                }
                if (activeResellersCount && activeResellersCount.offsetParent !== null) {
                    activeResellersCount.textContent = resellers.filter(r => r.status === 'active').length;
                }
                
                // Calculate total sales (simplified)
                const totalSales = customers.length * 25; // Estimated $25 per customer
                if (totalSalesAmount && totalSalesAmount.offsetParent !== null) {
                    totalSalesAmount.textContent = `$${totalSales}`;
                }
                
                // Update active resellers list only if visible
                if (activeResellersList && activeResellersList.offsetParent !== null) {
                    if (resellers.length === 0) {
                        activeResellersList.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center; padding: 20px;">No resellers created yet</p>';
                    } else {
                        activeResellersList.innerHTML = resellers.map(reseller => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                                <span style="color: rgba(255,255,255,0.8);">${reseller.username} (${reseller.id}):</span>
                                <span style="color: #4caf50; font-weight: 600;">${reseller.status}</span>
                            </div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 10px;">
                                ID: ${reseller.id} | Commission: ${reseller.commissionRate}%
                            </div>
                        `).join('');
                    }
                }
                
                // Update credit reseller dropdown
                const creditResellerSelect = document.getElementById('creditReseller');
                if (creditResellerSelect) {
                    const currentValue = creditResellerSelect.value;
                    creditResellerSelect.innerHTML = '<option value="">Select a reseller</option>' +
                        resellers.map(reseller => `<option value="${reseller.id}">${reseller.username} (${reseller.id})</option>`).join('');
                    creditResellerSelect.value = currentValue;
                }
            } catch (error) {
                console.error('Error updating reseller statistics:', error);
            }
        }

        // Update credit overview
        function populateResellerDropdown() {
            try {
                const select = document.getElementById('creditReseller');
                if (!select) return;
                
                // Clear existing options
                select.innerHTML = '<option value="">Select a reseller</option>';
                
                // Get all resellers from RESELLER_ACCOUNTS
                const resellers = Object.values(RESELLER_ACCOUNTS);
                
                // Add each reseller to the dropdown
                resellers.forEach(reseller => {
                    if (reseller.status === 'active') {
                        const option = document.createElement('option');
                        option.value = reseller.id;
                        option.textContent = `${reseller.name} (${reseller.username})`;
                        select.appendChild(option);
                    }
                });
                
                console.log('‚úÖ Populated reseller dropdown with', resellers.length, 'resellers');
                
            } catch (error) {
                console.error('‚ùå Failed to populate reseller dropdown:', error);
            }
        }

        function updateCreditOverview() {
            try {
                const transfers = JSON.parse(localStorage.getItem('creditTransfers') || '[]');
                
                const totalCredits = transfers.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                const availableCredits = totalCredits; // Simplified
                const transferredCredits = transfers.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                
                // Only update elements if they exist and section is visible
                const totalCreditsElement = document.getElementById('totalCreditsAmount');
                const availableCreditsElement = document.getElementById('availableCreditsAmount');
                const transferredCreditsElement = document.getElementById('transferredCreditsAmount');
                const recentTransfersList = document.getElementById('recentTransfersList');
                
                if (totalCreditsElement && totalCreditsElement.offsetParent !== null) {
                    totalCreditsElement.textContent = `$${totalCredits.toFixed(2)}`;
                }
                if (availableCreditsElement && availableCreditsElement.offsetParent !== null) {
                    availableCreditsElement.textContent = `$${availableCredits.toFixed(2)}`;
                }
                if (transferredCreditsElement && transferredCreditsElement.offsetParent !== null) {
                    transferredCreditsElement.textContent = `$${transferredCredits.toFixed(2)}`;
                }
                
                // Update recent transfers only if visible
                if (recentTransfersList && recentTransfersList.offsetParent !== null) {
                    if (transfers.length === 0) {
                        recentTransfersList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">No transfers yet</p>';
                    } else {
                        recentTransfersList.innerHTML = transfers.slice(-5).reverse().map(transfer => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>${transfer.resellerId}:</span>
                                <span style="color: #4caf50;">${transfer.type === 'credit' ? '+' : '-'}$${Math.abs(transfer.amount).toFixed(2)}</span>
                            </div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5);">
                                ${transfer.note || 'Credit transfer'} - ${transfer.date}
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error updating credit overview:', error);
            }
        }

        // Initialize statistics on load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Password Manager
            passwordManager.initialize();
            
            // Initialize global variables
            window.customers = JSON.parse(localStorage.getItem('adminCustomers')) || JSON.parse(localStorage.getItem('customers')) || [];
            window.editingCustomerId = null;
            window.renewalMode = false;
            
            setTimeout(() => {
                updateResellerStatistics();
                updateCreditOverview();
            }, 500);
        });

        // Update statistics when reseller/credit sections are shown
        const originalShowResellerSection = window.showResellerSection;
        window.showResellerSection = function() {
            if (originalShowResellerSection) originalShowResellerSection();
            setTimeout(updateResellerStatistics, 100);
        };

        const originalShowCreditSection = window.showCreditSection;
        window.showCreditSection = function() {
            if (originalShowCreditSection) originalShowCreditSection();
            setTimeout(updateCreditOverview, 100);
        };

        // Real-time updates for reseller statistics
        window.addEventListener('storage', function(e) {
            if (e.key === 'resellerCredentials' || e.key === 'RESELLER_ACCOUNTS') {
                setTimeout(updateResellerStatistics, 100);
            }
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
